<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>에이두 플랜 - AI 학교 운영계획서</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        html { scroll-behavior: smooth; }
        body { font-family: 'Noto Sans KR', sans-serif; }
        .plan-section {
            position: relative;
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            background-color: #f8fafc;
        }
        .plan-section h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e2e8f0;
        }
        .plan-section-content p { margin-bottom: 1rem; line-height: 1.6; }
        .plan-section-content ul {
            list-style: none;
            margin-left: 1.5rem;
            margin-bottom: 1rem;
            padding-left: 0;
        }
        .plan-section-content ul li {
            margin-bottom: 0.5rem;
            position: relative;
            padding-left: 1em;
        }
        .plan-section-content ul li::before {
            content: "○";
            position: absolute;
            left: -1em;
        }
        .plan-section-content ol {
            list-style: decimal;
            margin-left: 1.5rem;
            margin-bottom: 1rem;
            padding-left: 1.25rem;
        }
        .plan-section-content ol li {
            margin-bottom: 0.5rem;
            position: relative;
        }
        .plan-section-content ol li::before { content: none; }
        .plan-section-content ol > li > ul > li::before { content: "□"; }
        .plan-section-content ol > li > ul > li > ul > li::before { content: "○"; }
        .plan-section-content ol > li > ul > li > ul > li > ul > li::before { content: "-"; }
        .plan-section-content table { width: 100%; border-collapse: collapse; margin-bottom: 1rem; }
        .plan-section-content th,
        .plan-section-content td { border: 1px solid #cbd5e1; padding: 0.75rem; text-align: left; }
        .plan-section-content td { white-space: pre-line; }
        .plan-section-content th { background-color: #f1f5f9; font-weight: 600; }
        .plan-section-content.raw-markdown {
            white-space: pre-wrap;
            font-family: 'Noto Sans KR', sans-serif;
        }
        #generated-official-container .official-plain-text {
            white-space: normal;
            line-height: 1.7;
        }
        .edit-btn, .copy-section-btn, .copy-table-btn, .expand-btn, .detail-btn, .generate-detail-btn, .regenerate-detail-btn, .regenerate-section-btn {
            background-color: #e2e8f0;
            color: #475569;
            border: none;
            padding: 0.25rem 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .edit-btn:hover, .copy-section-btn:hover, .copy-table-btn:hover, .expand-btn:hover, .detail-btn:hover, .generate-detail-btn:hover, .regenerate-detail-btn:hover, .regenerate-section-btn:hover { background-color: #cbd5e1; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #7A9D54; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .nav-link { padding: 0.5rem 1rem; border-radius: 0.375rem; transition: background-color 0.2s, color 0.2s; }
        .nav-link.active { background-color: #7A9D54; color: white; }
        .nav-link:not(.active):hover { background-color: #f3f4f6; }
        .school-level-btn, .plan-type-btn, .outline-btn, .category-btn {
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        .school-level-btn.active, .plan-type-btn.active, .outline-btn.active, .category-btn.active {
            background-color: #84cc16; /* lime-500 */
            color: white;
            border-color: #65a30d; /* lime-600 */
            font-weight: 600;
        }
        .school-level-btn:not(.active), .plan-type-btn:not(.active), .outline-btn:not(.active), .category-btn:not(.active) {
            background-color: #f1f5f9; /* slate-100 */
            color: #475569; /* slate-600 */
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <div id="app">
        <!-- Auth View (Login/Signup) -->
        <div id="auth-view" class="min-h-screen flex items-center justify-center bg-gray-100">
            <div class="w-full max-w-md bg-white rounded-lg shadow-md p-8">
                <h2 class="text-2xl font-bold text-center text-[#7A9D54] mb-6">에이두 플랜 시작하기</h2>
                <form id="auth-form" onsubmit="return false;">
                    <div class="mb-4">
                        <label for="email" class="block text-gray-700 text-sm font-bold mb-2">이메일</label>
                        <input type="email" id="email" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                    </div>
                    <div class="mb-6">
                        <label for="password" class="block text-gray-700 text-sm font-bold mb-2">비밀번호</label>
                        <input type="password" id="password" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline" required>
                    </div>
                    <p id="auth-error" class="text-red-500 text-xs italic mb-4 hidden"></p>
                    <div class="flex items-center justify-between">
                        <button type="button" id="login-btn" class="bg-[#7A9D54] hover:bg-[#6a8a4a] text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">로그인</button>
                        <button type="button" id="signup-btn" class="inline-block align-baseline font-bold text-sm text-green-600 hover:text-green-800">계정이 없으신가요? 회원가입</button>
                    </div>
                    <div class="my-4 flex items-center">
                        <div class="flex-grow border-t border-gray-300"></div>
                        <span class="flex-shrink mx-4 text-gray-400 text-sm">또는</span>
                        <div class="flex-grow border-t border-gray-300"></div>
                    </div>
                    <button type="button" id="google-login-btn" class="w-full bg-white border border-gray-300 text-gray-700 font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline flex items-center justify-center gap-2 hover:bg-gray-50 transition-colors">
                        <svg class="w-5 h-5" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path><path fill="none" d="M0 0h48v48H0z"></path></svg>
                        Google 계정으로 로그인
                    </button>
                </form>
            </div>
        </div>

        <!-- Main App View -->
        <div id="main-app-view" class="hidden flex-col min-h-screen">
            <header class="bg-white shadow-md w-full sticky top-0 z-50">
                <div class="container mx-auto px-6 py-3 flex justify-between items-center">
                    <h1 class="text-2xl font-bold text-[#7A9D54]"><a href="#home" id="home-link">📝 에이두 플랜</a></h1>
                    <nav class="flex items-center gap-4">
                        <span id="user-email" class="text-sm text-gray-600"></span>
                        <a href="#home" id="nav-home" class="nav-link">홈</a>
                        <a href="#plan" id="nav-plan" class="nav-link">계획서</a>
                        <a href="#table" id="nav-table" class="nav-link">표 만들기(HWP)</a>
                        <a href="#official" id="nav-official" class="nav-link">기안문</a>
                        <a href="#letter" id="nav-letter" class="nav-link">가정통신문</a>
                        <a href="#community" id="nav-community" class="nav-link">커뮤니티</a>
                        <button id="my-info-btn" class="text-sm bg-blue-500 hover:bg-blue-600 text-white font-semibold py-1 px-3 rounded-md transition-colors">내 정보</button>
                        <button id="logout-btn" class="text-sm bg-red-500 hover:bg-red-600 text-white font-semibold py-1 px-3 rounded-md transition-colors">로그아웃</button>
                    </nav>
                </div>
            </header>
            <main class="flex-grow container mx-auto p-6">
                <!-- Home View -->
                <div id="home-view">
                    <h2 class="text-3xl font-bold mb-6">홈</h2>
                    <div class="space-y-6">
                        <div class="bg-white p-6 rounded-lg shadow-lg">
                            <h3 class="text-xl font-bold mb-2">안녕하세요, <span id="home-user-email"></span> 선생님!</h3>
                            <p class="text-gray-600 mb-4">에이두 플랜과 함께 학교의 업무를 간편히 관리해보세요.</p>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-lg">
                            <h3 class="text-xl font-bold mb-4">최근 생성한 계획서</h3>
                            <input type="search" id="recent-plan-search" placeholder="제목 검색" class="w-full mb-3 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                            <div id="recent-plans-list" class="space-y-3"></div>
                        </div>
                    </div>
                    <div class="mt-10">
                        <h3 class="text-2xl font-bold mb-4">최근 자료 모아보기</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6">
                            <div class="bg-white p-6 rounded-lg shadow-lg">
                                <h4 class="text-lg font-semibold mb-3">표</h4>
                                <input type="search" id="home-tables-search" placeholder="제목 검색" class="w-full mb-3 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                                <div id="home-tables-list" class="space-y-2 text-sm text-gray-700"></div>
                            </div>
                            <div class="bg-white p-6 rounded-lg shadow-lg">
                                <h4 class="text-lg font-semibold mb-3">기안문</h4>
                                <input type="search" id="home-officials-search" placeholder="제목 검색" class="w-full mb-3 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                                <div id="home-officials-list" class="space-y-2 text-sm text-gray-700"></div>
                            </div>
                            <div class="bg-white p-6 rounded-lg shadow-lg">
                                <h4 class="text-lg font-semibold mb-3">가정통신문</h4>
                                <input type="search" id="home-letters-search" placeholder="제목 검색" class="w-full mb-3 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                                <div id="home-letters-list" class="space-y-2 text-sm text-gray-700"></div>
                            </div>
                            <div class="bg-white p-6 rounded-lg shadow-lg">
                                <h4 class="text-lg font-semibold mb-3">커뮤니티</h4>
                                <input type="search" id="home-community-search" placeholder="제목 검색" class="w-full mb-3 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                                <div id="home-community-list" class="space-y-2 text-sm text-gray-700"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Plan View -->
                <div id="plan-view" class="hidden">
                    <div class="flex flex-col lg:flex-row gap-6">
                        <aside class="w-full lg:w-1/3 bg-white p-6 rounded-lg shadow-lg h-fit lg:sticky top-24">
                            <h3 class="text-lg font-semibold mb-4">메뉴얼, 지침 입력 테이블</h3>
                            <form id="plan-form" onsubmit="return false;">
                                <div class="mb-4">
                                    <button type="button" id="example-upload-btn" class="w-full bg-blue-100 text-blue-700 font-medium py-1 px-2 rounded-md">예시 파일 업로드</button>
                                    <input type="file" id="example-file-input" accept=".pdf" multiple class="hidden" />
                                    <div id="example-file-list" class="mt-2 space-y-1 text-sm text-gray-700"></div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">학교급</label>
                                    <div id="school-level-buttons" class="grid grid-cols-4 gap-1">
                                        <button type="button" data-value="초등학교" class="school-level-btn py-1 px-2 rounded text-xs active">초등학교</button>
                                        <button type="button" data-value="중학교" class="school-level-btn py-1 px-2 rounded text-xs">중학교</button>
                                        <button type="button" data-value="고등학교" class="school-level-btn py-1 px-2 rounded text-xs">고등학교</button>
                                        <button type="button" data-value="없음" class="school-level-btn py-1 px-2 rounded text-xs">없음</button>
                                    </div>
                                </div>
                                <div class="mt-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">목차</label>
                                    <div id="outline-buttons" class="flex flex-wrap gap-2">
                                        <button type="button" data-value="기본목차" class="outline-btn py-1 px-2 rounded text-xs active">기본목차</button>
                                        <button type="button" data-value="세부목차" class="outline-btn py-1 px-2 rounded text-xs">세부목차</button>
                                    </div>
                                    <div id="outline-description" class="mt-2 text-xs text-gray-600"></div>
                                </div>
                                <div class="mt-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">분류</label>
                                    <input type="hidden" id="plan-category" value="정책">
                                    <div id="category-buttons" class="flex flex-wrap gap-2">
                                        <button type="button" data-value="정책" class="category-btn py-1 px-2 rounded text-xs active">정책</button>
                                        <button type="button" data-value="교육" class="category-btn py-1 px-2 rounded text-xs">교육</button>
                                        <button type="button" data-value="지원" class="category-btn py-1 px-2 rounded text-xs">지원</button>
                                        <button type="button" data-value="기획" class="category-btn py-1 px-2 rounded text-xs">기획</button>
                                        <button type="button" data-value="기타" class="category-btn py-1 px-2 rounded text-xs">기타</button>
                                    </div>
                                    <div id="category-description" class="mt-2 text-xs text-gray-600 whitespace-pre-line"></div>
                                </div>
                                <div class="mt-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">계획서 주제</label>
                                    <input type="text" id="custom-plan-type" placeholder="0000 운영계획" class="block w-full mt-2 px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 sm:text-sm">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">핵심 키워드</label>
                                    <div id="keywords-container" class="space-y-2 mt-1">
                                        <div class="flex items-center gap-2">
                                            <input type="text" name="keywords" class="keyword-input block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 sm:text-sm" placeholder="예: AI 융합">
                                        </div>
                                    </div>
                                    <button type="button" id="add-keyword-btn" class="mt-2 text-sm text-blue-600 hover:underline flex items-center">
                                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                                        키워드 추가
                                    </button>
                                </div>

                                <p id="form-error" class="text-red-500 text-xs italic mt-2 hidden"></p>
                                <button type="submit" id="generate-btn" class="w-full bg-[#7A9D54] text-white font-bold py-3 px-4 rounded-lg hover:bg-[#6a8a4a] flex items-center justify-center">AI 운영계획서 생성</button>
                            </form>
                            <div class="bg-white p-6 rounded-lg shadow hidden" id="plan-modify-section">
                                <h3 class="text-lg font-semibold mb-2">세부 추진 계획 수정 테이블</h3>
                                <p class="text-sm text-gray-600 mb-4">수정하고자 하는 목차를 변경 목차에서 정하고, 수정 내용을 작성 후 엔터를 눌러보세요.</p>
                                <form id="plan-modify-form" class="space-y-4">
                                    <div>
                                        <label for="plan-modify-target" class="block text-sm font-medium text-gray-700">수정 목차</label>
                                        <select id="plan-modify-target" class="mt-1 block w-full border border-gray-300 rounded-md p-2">
                                            <option value="전체">전체</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="plan-modify-prompt" class="block text-sm font-medium text-gray-700">수정 내용</label>
                                        <input type="text" id="plan-modify-prompt" class="mt-1 block w-full border border-gray-300 rounded-md p-2" placeholder="수정할 내용을 입력하세요">
                                    </div>
                                    <button type="submit" id="modify-plan-btn" class="w-full bg-[#FCA5A5] text-white font-bold py-2 px-4 rounded-lg hover:bg-[#F87171]">AI 수정 적용</button>
                                </form>
                            </div>
                            <div class="mt-8">
                                <h3 class="text-lg font-bold mb-2">이전 계획서 작성 목록</h3>
                                <input type="search" id="plan-search" placeholder="제목 검색" class="w-full mb-3 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                                <div id="plan-saved-list" class="space-y-3 max-h-60 overflow-y-auto">
                                    <!-- Recent plans will be dynamically inserted here -->
                                </div>
                            </div>
                        </aside>
                        <section id="output-panel" class="w-full lg:w-2/3">
                            <h3 class="text-lg font-semibold mb-4">출력 테이블</h3>
                            <div id="initial-message" class="bg-white p-8 rounded-lg shadow-lg"><h2 class="text-2xl font-bold text-gray-800">AI 운영계획서 초안이 이곳에 표시됩니다.</h2></div>
                            <div id="loading-indicator" class="hidden flex-col items-center justify-center text-center py-16">
                                <div class="loader"></div>
                                <p class="mt-4 text-lg font-semibold text-gray-700">AI가 열심히 계획서를 작성하고 있습니다...</p>
                                <p class="text-slate-500">잠시만 기다려 주세요...</p>
                            </div>
                            
                            <div id="result-section" class="hidden">
                                <div class="flex justify-between items-center mb-6 bg-white p-6 rounded-lg shadow-lg">
                                    <div class="flex items-center gap-4">
                                        <h2 id="plan-title" class="text-2xl font-bold text-slate-800"></h2>
                                        <input type="text" id="plan-title-input" class="hidden text-2xl font-bold text-slate-800 border-b-2 border-blue-500 focus:outline-none">
                                    </div>
                                    <div class="flex gap-2">
                                        <button id="merge-plan-btn" class="copy-section-btn" title="AI가 A4 한 장 분량으로 요약합니다">요약본(AI)</button>
                                        <button id="edit-title-btn" class="edit-btn">편집</button>
                                    </div>
                                </div>
                                <div id="generated-plan-container" class="space-y-6">
                                    <!-- Generated sections will be injected here -->
                                </div>
                            </div>

                            <div id="error-message" class="hidden text-center bg-white p-8 rounded-lg shadow-lg"><h2 class="text-2xl font-bold text-red-600">오류가 발생했습니다</h2><p id="error-details" class="mt-4 text-gray-600"></p></div>
                        </section>
                    </div>
                </div>
                <!-- Table Generator View -->
                <div id="table-view" class="hidden">
                    <div class="container mx-auto p-6">
                        <h2 class="text-3xl font-bold mb-6">표 만들기(HWP)</h2>
                        <div class="flex flex-col lg:flex-row gap-6">
                            <!-- Input & Modify Section -->
                            <aside class="w-full lg:w-1/3 space-y-6">
                                <div class="bg-white p-6 rounded-lg shadow">
                                    <h3 class="text-lg font-semibold mb-4">입력 테이블</h3>
                                    <form id="table-form" class="space-y-4">
                                        <div>
                                            <label for="table-topic" class="block text-sm font-medium text-gray-700">표 주제</label>
                                            <textarea id="table-topic" rows="4" class="mt-1 block w-full border border-gray-300 rounded-md p-2" placeholder="표의 주제를 입력하세요"></textarea>
                                        </div>
                                        <button type="submit" id="generate-table-btn" class="w-full bg-[#7A9D54] text-white font-bold py-2 px-4 rounded-lg hover:bg-[#6a8a4a]">AI 표 생성</button>
                                    </form>
                                </div>

                                <!-- AI Modify Table -->
                                <div class="bg-white p-6 rounded-lg shadow hidden" id="table-modify-section">
                                    <h3 class="text-lg font-semibold mb-4">AI 수정 테이블</h3>
                                    <form id="table-modify-form" class="space-y-4">
                                        <div>
                                            <label for="table-modify-prompt" class="block text-sm font-medium text-gray-700">수정 내용</label>
                                            <input type="text" id="table-modify-prompt" class="mt-1 block w-full border border-gray-300 rounded-md p-2" placeholder="수정할 내용을 입력하세요">
                                        </div>
                                        <button type="submit" id="modify-table-btn" class="w-full bg-[#FCA5A5] text-white font-bold py-2 px-4 rounded-lg hover:bg-[#F87171]">AI 수정 적용</button>
                                    </form>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold mt-6 mb-2">저장된 목록</h3>
                                    <input type="search" id="table-search" placeholder="제목 검색" class="w-full mb-3 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                                    <div id="table-saved-list" class="space-y-3"></div>
                                </div>
                            </aside>

                            <!-- Output Section -->
                            <section class="w-full lg:w-2/3">
                                <div class="plan-section hidden" id="table-output-section">
                                    <div class="absolute top-4 right-4 flex gap-2">
                                        <button id="copy-table-btn" class="copy-section-btn">복사</button>
                                        <button id="edit-table-btn" class="edit-btn">편집</button>
                                    </div>
                                    <div id="generated-table-container" class="plan-section-content overflow-x-auto"></div>
                                </div>
                            </section>
                        </div>
                    </div>
                </div>
                <!-- Official Docs View -->
                <div id="official-view" class="hidden">
                    <div class="container mx-auto p-6">
                        <h2 class="text-3xl font-bold mb-6">기안문</h2>
                        <div class="flex flex-col lg:flex-row gap-6">
                            <!-- Input & Modify Section -->
                            <aside class="w-full lg:w-1/3 space-y-6">
                                <div class="bg-white p-6 rounded-lg shadow">
                                    <h3 class="text-lg font-semibold mb-4">입력 테이블</h3>
                                    <form id="official-form" class="space-y-4">
                                        <div>
                                            <label for="official-topic" class="block text-sm font-medium text-gray-700">주제</label>
                                            <textarea id="official-topic" rows="3" class="mt-1 block w-full border border-gray-300 rounded-md p-2" placeholder="기안문 주제를 입력하세요" required></textarea>
                                        </div>
                                        <div>
                                            <label for="official-reference" class="block text-sm font-medium text-gray-700">근거 (선택)</label>
                                            <input type="text" id="official-reference" class="mt-1 block w-full border border-gray-300 rounded-md p-2" placeholder="관련 기관 문서 번호 날짜를 입력하세요">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">첨부 파일 (선택)</label>
                                            <div id="attachments-container" class="space-y-2"></div>
                                            <button type="button" id="add-attachment-btn" class="mt-2 text-sm text-blue-600 hover:underline">+ 추가</button>
                                        </div>
                                        <button type="submit" id="generate-official-btn" class="w-full bg-[#7A9D54] text-white font-bold py-2 px-4 rounded-lg hover:bg-[#6a8a4a]">AI 기안문 생성</button>
                                    </form>
                                </div>

                                <!-- AI Modify Table -->
                                <div class="bg-white p-6 rounded-lg shadow hidden" id="official-modify-section">
                                    <h3 class="text-lg font-semibold mb-4">AI 수정 테이블</h3>
                                    <form id="official-modify-form" class="space-y-4">
                                        <div>
                                            <label for="official-modify-prompt" class="block text-sm font-medium text-gray-700">수정 내용</label>
                                            <input type="text" id="official-modify-prompt" class="mt-1 block w-full border border-gray-300 rounded-md p-2" placeholder="수정할 내용을 입력하세요">
                                        </div>
                                        <button type="submit" id="modify-official-btn" class="w-full bg-[#FCA5A5] text-white font-bold py-2 px-4 rounded-lg hover:bg-[#F87171]">AI 수정 적용</button>
                                    </form>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold mt-6 mb-2">저장된 목록</h3>
                                    <input type="search" id="official-search" placeholder="제목 검색" class="w-full mb-3 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                                    <div id="official-saved-list" class="space-y-3"></div>
                                </div>
                            </aside>

                            <!-- Output Section -->
                            <section class="w-full lg:w-2/3">
                                <div class="plan-section hidden relative" id="official-output-section">
                                    <div class="absolute top-4 right-4 flex gap-2">
                                        <button id="copy-official-btn" class="copy-section-btn">복사</button>
                                        <button id="edit-official-btn" class="edit-btn">편집</button>
                                    </div>
                                    <div class="mb-4 flex items-center gap-2">
                                        <h3 id="official-title" class="text-xl font-bold"></h3>
                                        <input type="text" id="official-title-input" class="hidden text-xl font-bold border-b border-gray-400 focus:outline-none">
                                        <button type="button" id="edit-official-title-btn" class="edit-btn">편집</button>
                                        <button type="button" id="copy-official-title-btn" class="copy-section-btn">복사</button>
                                    </div>
                                    <div id="generated-official-container" class="plan-section-content"></div>
                                </div>
                            </section>
                        </div>
                    </div>
                </div>
                <!-- Letter View -->
                <div id="letter-view" class="hidden">
                    <div class="container mx-auto p-6">
                        <h2 class="text-3xl font-bold mb-6">가정통신문</h2>
                        <div class="flex flex-col lg:flex-row gap-6">
                            <!-- Input & Modify Section -->
                            <aside class="w-full lg:w-1/3 space-y-6">
                                <div class="bg-white p-6 rounded-lg shadow">
                                    <h3 class="text-lg font-semibold mb-4">입력 테이블</h3>
                                    <form id="letter-form" class="space-y-4">
                                        <div>
                                            <label for="letter-topic" class="block text-sm font-medium text-gray-700">주제</label>
                                            <textarea id="letter-topic" rows="4" class="mt-1 block w-full border border-gray-300 rounded-md p-2" placeholder="가정통신문 주제를 입력하세요"></textarea>
                                        </div>
                                        <button type="submit" id="generate-letter-btn" class="w-full bg-[#7A9D54] text-white font-bold py-2 px-4 rounded-lg hover:bg-[#6a8a4a]">AI 가정통신문 생성</button>
                                    </form>
                                </div>

                                <!-- AI Modify Table -->
                                <div class="bg-white p-6 rounded-lg shadow hidden" id="letter-modify-section">
                                    <h3 class="text-lg font-semibold mb-4">AI 수정 테이블</h3>
                                    <form id="letter-modify-form" class="space-y-4">
                                        <div>
                                            <label for="letter-modify-prompt" class="block text-sm font-medium text-gray-700">수정 내용</label>
                                            <input type="text" id="letter-modify-prompt" class="mt-1 block w-full border border-gray-300 rounded-md p-2" placeholder="수정할 내용을 입력하세요">
                                        </div>
                                        <button type="submit" id="modify-letter-btn" class="w-full bg-[#FCA5A5] text-white font-bold py-2 px-4 rounded-lg hover:bg-[#F87171]">AI 수정 적용</button>
                                    </form>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold mt-6 mb-2">저장된 목록</h3>
                                    <input type="search" id="letter-search" placeholder="제목 검색" class="w-full mb-3 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                                    <div id="letter-saved-list" class="space-y-3"></div>
                                </div>
                            </aside>

                            <!-- Output Section -->
                            <section class="w-full lg:w-2/3">
                                <div class="plan-section hidden" id="letter-output-section">
                                    <div class="absolute top-4 right-4 flex gap-2">
                                        <button id="copy-letter-btn" class="copy-section-btn">복사</button>
                                        <button id="edit-letter-btn" class="edit-btn">편집</button>
                                    </div>
                                    <div id="generated-letter-container" class="plan-section-content"></div>
                                </div>
                            </section>
                        </div>
                    </div>
                </div>
                <!-- Community View -->
                <div id="community-view" class="hidden">
                    <div class="container mx-auto p-6">
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
                            <h2 class="text-3xl font-bold">커뮤니티</h2>
                            <button id="open-create-post-btn" class="self-start md:self-auto bg-[#7A9D54] hover:bg-[#6a8a4a] text-white font-semibold px-4 py-2 rounded-md transition-colors">글 작성</button>
                        </div>
                        <input type="search" id="community-search" placeholder="제목 검색" class="w-full mb-4 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                        <div id="community-post-list" class="space-y-4"></div>
                    </div>
                </div>
            </main>
        </div>
        <!-- Toast Message -->
        <div id="toast" class="fixed bottom-10 right-10 bg-gray-900 text-white py-2 px-5 rounded-lg shadow-lg opacity-0 transition-opacity duration-300">
            복사되었습니다!
        </div>
        <!-- Profile Modal -->
        <div id="profile-modal" class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 px-4">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
                <h3 class="text-xl font-semibold mb-2">내 정보</h3>
                <p class="text-sm text-gray-500 mb-4">로그인 계정: <span id="profile-email" class="font-medium text-gray-700"></span></p>
                <label for="profile-name-input" class="block text-sm font-medium text-gray-700 mb-1">이름</label>
                <input id="profile-name-input" type="text" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="이름을 입력하세요">
                <div class="mt-6 flex justify-end gap-2">
                    <button id="close-profile-modal" class="px-4 py-2 rounded-md border border-gray-300 text-gray-600 hover:bg-gray-100">취소</button>
                    <button id="save-profile-btn" class="px-4 py-2 rounded-md bg-[#7A9D54] text-white hover:bg-[#6a8a4a]">저장</button>
                </div>
            </div>
        </div>
        <!-- Community Post Modal -->
        <div id="community-post-modal" class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 px-4">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 id="community-modal-title" class="text-xl font-semibold">새 글 작성</h3>
                    <button id="close-community-modal" class="text-gray-500 hover:text-gray-700">✕</button>
                </div>
                <form id="community-post-form" class="space-y-4">
                    <div>
                        <label for="community-post-title" class="block text-sm font-medium text-gray-700 mb-1">제목</label>
                        <input id="community-post-title" type="text" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500" required>
                    </div>
                    <div>
                        <label for="community-post-content" class="block text-sm font-medium text-gray-700 mb-1">내용</label>
                        <textarea id="community-post-content" rows="6" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500" required></textarea>
                    </div>
                    <div class="flex justify-end gap-2">
                        <button type="button" id="cancel-community-post" class="px-4 py-2 rounded-md border border-gray-300 text-gray-600 hover:bg-gray-100">취소</button>
                        <button type="submit" id="community-post-submit" class="px-4 py-2 rounded-md bg-[#7A9D54] text-white hover:bg-[#6a8a4a]">등록</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, getDocs, doc, getDoc, deleteDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDCeJPDQUNi-KmJ9DhkTRIu-9t2PGZCpt0",
            authDomain: "mansungcoin-c6e06.firebaseapp.com",
            databaseURL: "https://mansungcoin-c6e06-default-rtdb.firebaseio.com",
            projectId: "mansungcoin-c6e06",
            storageBucket: "mansungcoin-c6e06.firebasestorage.app",
            messagingSenderId: "704809284946",
            appId: "1:704809284946:web:54e4788586e6c68de1768b"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global DOM Elements
        const authView = document.getElementById('auth-view');
        const mainAppView = document.getElementById('main-app-view');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const loginBtn = document.getElementById('login-btn');
        const signupBtn = document.getElementById('signup-btn');
        const googleLoginBtn = document.getElementById('google-login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const authError = document.getElementById('auth-error');
        const userEmailSpan = document.getElementById('user-email');
        const homeUserEmailSpan = document.getElementById('home-user-email');
        const navHome = document.getElementById('nav-home');
        const navPlan = document.getElementById('nav-plan');
        const navTable = document.getElementById('nav-table');
        const navOfficial = document.getElementById('nav-official');
        const navLetter = document.getElementById('nav-letter');
        const navCommunity = document.getElementById('nav-community');
        const myInfoBtn = document.getElementById('my-info-btn');
        const profileModal = document.getElementById('profile-modal');
        const profileNameInput = document.getElementById('profile-name-input');
        const profileEmail = document.getElementById('profile-email');
        const closeProfileModalBtn = document.getElementById('close-profile-modal');
        const saveProfileBtn = document.getElementById('save-profile-btn');
        const homeLink = document.getElementById('home-link');
        const homeView = document.getElementById('home-view');
        const planView = document.getElementById('plan-view');
        const tableView = document.getElementById('table-view');
        const officialView = document.getElementById('official-view');
        const letterView = document.getElementById('letter-view');
        const communityView = document.getElementById('community-view');
        const communityPostList = document.getElementById('community-post-list');
        const communitySearchInput = document.getElementById('community-search');
        const openCreatePostBtn = document.getElementById('open-create-post-btn');
        const communityPostModal = document.getElementById('community-post-modal');
        const communityPostForm = document.getElementById('community-post-form');
        const communityPostTitleInput = document.getElementById('community-post-title');
        const communityPostContentInput = document.getElementById('community-post-content');
        const communityModalTitle = document.getElementById('community-modal-title');
        const communityPostSubmitBtn = document.getElementById('community-post-submit');
        const closeCommunityModalBtn = document.getElementById('close-community-modal');
        const cancelCommunityPostBtn = document.getElementById('cancel-community-post');
        const homeTablesList = document.getElementById('home-tables-list');
        const homeTablesSearchInput = document.getElementById('home-tables-search');
        const homeOfficialsList = document.getElementById('home-officials-list');
        const homeOfficialsSearchInput = document.getElementById('home-officials-search');
        const homeLettersList = document.getElementById('home-letters-list');
        const homeLettersSearchInput = document.getElementById('home-letters-search');
        const homeCommunityList = document.getElementById('home-community-list');
        const homeCommunitySearchInput = document.getElementById('home-community-search');
        const planSearchInput = document.getElementById('plan-search');
        const tableSearchInput = document.getElementById('table-search');
        const officialSearchInput = document.getElementById('official-search');
        const letterSearchInput = document.getElementById('letter-search');
        const recentPlansList = document.getElementById('recent-plans-list');
        const recentPlanSearchInput = document.getElementById('recent-plan-search');
        const form = document.getElementById('plan-form');
        const GEMINI_MODEL = 'gemini-2.0-flash-lite-001';

        const generateBtn = document.getElementById('generate-btn');
        const initialMessage = document.getElementById('initial-message');
        const loadingIndicator = document.getElementById('loading-indicator');
        const resultSection = document.getElementById('result-section');
        const planContainer = document.getElementById('generated-plan-container');
        const planTitle = document.getElementById('plan-title');
        const planTitleInput = document.getElementById('plan-title-input');
        const mergePlanBtn = document.getElementById('merge-plan-btn');
        const editTitleBtn = document.getElementById('edit-title-btn');
        const errorMessageDiv = document.getElementById('error-message');
        const errorDetails = document.getElementById('error-details');
        const toast = document.getElementById('toast');
        const outputPanel = document.getElementById('output-panel');
        const schoolLevelButtons = document.getElementById('school-level-buttons');
        const outlineButtons = document.getElementById('outline-buttons');
        const categoryButtons = document.getElementById('category-buttons');
        const planCategoryInput = document.getElementById('plan-category');
        const outlineDescription = document.getElementById('outline-description');
        const categoryDescription = document.getElementById('category-description');
        const customPlanTypeInput = document.getElementById('custom-plan-type');
        const keywordsContainer = document.getElementById('keywords-container');
        const addKeywordBtn = document.getElementById('add-keyword-btn');
        const formError = document.getElementById('form-error');
        const planModifySection = document.getElementById('plan-modify-section');
        const planModifyForm = document.getElementById('plan-modify-form');
        const planModifyTarget = document.getElementById('plan-modify-target');
        const planModifyPrompt = document.getElementById('plan-modify-prompt');
        const planSavedList = document.getElementById('plan-saved-list');
        let currentPlanId = null;

        const exampleUploadBtn = document.getElementById('example-upload-btn');
        const exampleFileInput = document.getElementById('example-file-input');
        const exampleFileList = document.getElementById('example-file-list');
        let exampleFiles = [];
        let currentPlanSummaryMarkdown = null;
        let summaryPopupWindow = null;
        let isSummaryGenerating = false;

        exampleUploadBtn.addEventListener('click', () => exampleFileInput.click());

        async function extractPdfText(arrayBuffer) {
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            let text = '';
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const content = await page.getTextContent();
                text += content.items.map(item => item.str).join(' ') + '\n';
            }
            return text;
        }

        function extractOutline(text) {
            return text.split(/\r?\n/)
                       .map(l => l.trim())
                       .filter(l => /^\d+[\.\)]\s+/.test(l))
                       .map(l => l.replace(/^\d+[\.\)]\s+/, ''));
        }
        function renderExampleFileList() {
            exampleFileList.innerHTML = '';
            exampleFiles.forEach(file => {
                const item = document.createElement('div');
                item.className = 'flex items-center';
                item.dataset.name = file.name;
                item.innerHTML = `<span class="flex-1 truncate">${file.name}</span><button type="button" class="remove-example ml-2 text-red-500 text-xs">제거</button>`;
                exampleFileList.appendChild(item);
            });
        }

        exampleFileList.addEventListener('click', (e) => {
            if (e.target.classList.contains('remove-example')) {
                const name = e.target.parentElement.dataset.name;
                exampleFiles = exampleFiles.filter(f => f.name !== name);
                renderExampleFileList();
            }
        });

        exampleFileInput.addEventListener('change', async (e) => {
            const files = Array.from(e.target.files);
            if (!files.length) return;
            try {
                for (const file of files) {
                    const arrayBuffer = await file.arrayBuffer();
                    const ext = file.name.split('.').pop().toLowerCase();
                    if (ext !== 'pdf') {
                        showToast('PDF 파일만 업로드 가능합니다.');
                        continue;
                    }
                    const text = await extractPdfText(arrayBuffer);
                    const outline = extractOutline(text);
                    exampleFiles.push({ name: file.name, text, outline });
                }
                renderExampleFileList();
                e.target.value = '';
                showToast('예시 파일이 적용되었습니다.');
            } catch (err) {
                console.error('Example file error:', err);
                showToast('파일 처리 중 오류가 발생했습니다.');
            }
        });

        // Load plan examples to guide dynamic '세부 추진 계획' generation
        // First, load detailed plan examples as the primary reference
        let detailPlanExamples = '';
        fetch('/detail_plan_examples.txt')
            .then(response => response.text())
            .then(text => { detailPlanExamples = text; });

        // Load additional general plan examples
        let planExamples = '';
        fetch('/plan_examples.txt')
            .then(response => response.text())
            .then(text => { planExamples = text; });

        const planOutlineDefinitions = {
            "기본목차": [
                { title: "근거", type: "bullet" },
                { title: "목적", type: "bullet" },
                { title: "방침", type: "bullet" },
                { title: "세부 추진 계획", type: "tablePlan" },
                { title: "기대효과", type: "bullet" }
            ],
            "세부목차": [
                { title: "추진 배경", type: "bullet" },
                { title: "추진 근거", type: "bullet" },
                { title: "추진 목적", type: "bullet" },
                { title: "추진 방향", type: "bullet" },
                { title: "세부 추진 계획", type: "tablePlan" },
                { title: "추진 일정", type: "tableSchedule" },
                { title: "예산 운용 계획", type: "tableBudget" },
                { title: "기대효과", type: "bullet" }
            ]
        };

        let currentOutline = [...planOutlineDefinitions["기본목차"]];

        const categoryExamples = {
            "정책": "기존 계획에 존재하던 것에 새로운 내용이나 메뉴얼, 정책이 추가되는 정책 방향/예산/인사 계획 주제라는 것에 주안점을 두어 작성하세요.",
            "교육": "교육과정 내용과 학생 지도에 주안점을 두어 작성하세요.",
            "지원": "안전, 건강, 미래교육 지원 방안, 위기 대응, 보건에 주안점을 두어 작성하세요.",
            "기획": "기존 계획이 없고 새로운 정책을 기획해야 한다는 주제에 주안점을 두어 작성하세요.",
            "기타": "정책, 교육, 지원, 기획에 해당하지 않는 기타 주제라는 것에 주안점을 두어 작성하세요."
        };

        const categoryFocus = {
            "정책": "기존 계획에 존재하던 것에 새로운 내용이나 메뉴얼, 정책이 추가되는 정책 방향/예산/인사 계획 주제라는 것에 주안점을 두어 작성하세요.",
            "교육": "교육과정 내용과 학생 지도에 주안점을 두어 작성하세요.",
            "지원": "안전, 건강, 미래교육 지원 방안, 위기 대응, 보건에 주안점을 두어 작성하세요.",
            "기획": "기존 계획이 없고 새로운 정책을 기획해야 한다는 주제에 주안점을 두어 작성하세요.",
            "기타": "정책, 교육, 지원, 기획에 해당하지 않는 기타 주제라는 것에 주안점을 두어 작성하세요."
        };

        function updateOutlineDescription() {
            const sections = currentOutline.map(s => s.title).join(', ');
            outlineDescription.textContent = `목차 구성: ${sections}`;
        }

        function updateCategoryDescription() {
            const category = categoryButtons.querySelector('.active').dataset.value;
            categoryDescription.textContent = categoryExamples[category] || '';
        }

        updateOutlineDescription();
        updateCategoryDescription();

        const tableForm = document.getElementById('table-form');
        const tableTopic = document.getElementById('table-topic');
        const tableOutputSection = document.getElementById('table-output-section');
        let generatedTableContainer = document.getElementById('generated-table-container');
        const editTableBtn = document.getElementById('edit-table-btn');
        const copyTableBtn = document.getElementById('copy-table-btn');
        const tableModifySection = document.getElementById('table-modify-section');
        const tableModifyForm = document.getElementById('table-modify-form');
        const tableModifyPrompt = document.getElementById('table-modify-prompt');
        const tableSavedList = document.getElementById('table-saved-list');
        let currentTableMarkdown = '';
        let isEditingTable = false;
        let currentTableId = null;

        const letterForm = document.getElementById('letter-form');
        const letterTopic = document.getElementById('letter-topic');
        const letterOutputSection = document.getElementById('letter-output-section');
        let generatedLetterContainer = document.getElementById('generated-letter-container');
        const editLetterBtn = document.getElementById('edit-letter-btn');
        const copyLetterBtn = document.getElementById('copy-letter-btn');
        const letterModifySection = document.getElementById('letter-modify-section');
        const letterModifyForm = document.getElementById('letter-modify-form');
        const letterModifyPrompt = document.getElementById('letter-modify-prompt');
        const letterSavedList = document.getElementById('letter-saved-list');
        let currentLetterMarkdown = '';
        let isEditingLetter = false;
        let currentLetterId = null;

        const officialForm = document.getElementById('official-form');
        const officialTopic = document.getElementById('official-topic');
        const officialReference = document.getElementById('official-reference');
        const attachmentsContainer = document.getElementById('attachments-container');
        const addAttachmentBtn = document.getElementById('add-attachment-btn');
        const officialOutputSection = document.getElementById('official-output-section');
        let generatedOfficialContainer = document.getElementById('generated-official-container');
        const editOfficialBtn = document.getElementById('edit-official-btn');
        const copyOfficialBtn = document.getElementById('copy-official-btn');
        const officialModifySection = document.getElementById('official-modify-section');
        const officialModifyForm = document.getElementById('official-modify-form');
        const officialModifyPrompt = document.getElementById('official-modify-prompt');
        const officialTitle = document.getElementById('official-title');
        const officialTitleInput = document.getElementById('official-title-input');
        const editOfficialTitleBtn = document.getElementById('edit-official-title-btn');
        const copyOfficialTitleBtn = document.getElementById('copy-official-title-btn');
        const officialSavedList = document.getElementById('official-saved-list');
        let currentOfficialTitle = '';
        let currentOfficialMarkdown = '';
        let isEditingOfficial = false;
        let currentOfficialId = null;

        const convertTimestampToDate = (timestamp) => {
            if (!timestamp) return null;
            if (typeof timestamp.toDate === 'function') return timestamp.toDate();
            if (timestamp.seconds) return new Date(timestamp.seconds * 1000);
            return new Date(timestamp);
        };

        const formatDateTime = (timestamp, includeTime = true) => {
            const date = convertTimestampToDate(timestamp);
            if (!date || Number.isNaN(date.getTime())) return '날짜 없음';
            if (!includeTime) return date.toLocaleDateString('ko-KR');
            return date.toLocaleString('ko-KR', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
        };

        const homeListData = {
            tables: [],
            officials: [],
            letters: [],
            community: []
        };

        const homeListConfigs = {
            tables: { container: homeTablesList, searchInput: homeTablesSearchInput, emptyText: '생성된 표가 없습니다.', view: (id) => viewTable(id) },
            officials: { container: homeOfficialsList, searchInput: homeOfficialsSearchInput, emptyText: '생성된 기안문이 없습니다.', view: (id) => viewOfficial(id) },
            letters: { container: homeLettersList, searchInput: homeLettersSearchInput, emptyText: '생성된 가정통신문이 없습니다.', view: (id) => viewLetter(id) },
            community: { container: homeCommunityList, searchInput: homeCommunitySearchInput, emptyText: '작성된 커뮤니티 글이 없습니다.', view: (id) => openCommunityPost(id) }
        };

        const renderHomeList = (type) => {
            const config = homeListConfigs[type];
            if (!config || !config.container) return;
            const { container, searchInput, emptyText, view } = config;
            const items = homeListData[type] || [];
            container.innerHTML = '';
            if (!items.length) {
                container.innerHTML = `<p class="text-sm text-gray-400">${emptyText}</p>`;
                return;
            }
            const searchTerm = (searchInput?.value || '').trim().toLowerCase();
            const filteredItems = searchTerm
                ? items.filter(item => (item.title || '').toLowerCase().includes(searchTerm))
                : items;
            if (!filteredItems.length) {
                container.innerHTML = '<p class="text-sm text-gray-400">검색 결과가 없습니다.</p>';
                return;
            }
            const displayItems = searchTerm ? filteredItems : filteredItems.slice(0, 4);
            displayItems.forEach(item => {
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'w-full text-left py-2 border-b border-gray-100 last:border-b-0 focus:outline-none focus:ring-2 focus:ring-[#7A9D54]';
                const title = document.createElement('p');
                title.className = 'text-sm font-medium text-gray-800 truncate';
                title.textContent = item.title || '제목 없음';
                const date = document.createElement('p');
                date.className = 'text-xs text-gray-500 mt-1';
                date.textContent = formatDateTime(item.createdAt, false);
                button.appendChild(title);
                button.appendChild(date);
                button.addEventListener('click', () => {
                    if (typeof view === 'function' && item.id) {
                        view(item.id);
                    }
                });
                container.appendChild(button);
            });
        };

        const setHomeListData = (type, items = []) => {
            if (!(type in homeListData)) return;
            homeListData[type] = items;
            renderHomeList(type);
        };

        const openModal = (modal) => { if (modal) modal.classList.remove('hidden'); };
        const closeModal = (modal) => { if (modal) modal.classList.add('hidden'); };

        let communityPostsCache = [];
        let activePostMenu = null;
        let isEditingCommunityPost = false;
        let editingCommunityPostId = null;

        const closeActivePostMenu = () => {
            if (activePostMenu) {
                activePostMenu.classList.add('hidden');
                activePostMenu = null;
            }
        };

        if (homeTablesSearchInput) {
            homeTablesSearchInput.addEventListener('input', () => renderHomeList('tables'));
        }
        if (homeOfficialsSearchInput) {
            homeOfficialsSearchInput.addEventListener('input', () => renderHomeList('officials'));
        }
        if (homeLettersSearchInput) {
            homeLettersSearchInput.addEventListener('input', () => renderHomeList('letters'));
        }
        if (homeCommunitySearchInput) {
            homeCommunitySearchInput.addEventListener('input', () => renderHomeList('community'));
        }

        const attachModalDismiss = (modal) => {
            if (!modal) return;
            modal.addEventListener('click', (event) => {
                if (event.target === modal) {
                    if (modal === communityPostModal) {
                        closeCommunityModal();
                    } else {
                        closeModal(modal);
                    }
                }
            });
        };

        const views = { home: homeView, plan: planView, table: tableView, official: officialView, letter: letterView, community: communityView };
        const navLinks = { home: navHome, plan: navPlan, table: navTable, official: navOfficial, letter: navLetter, community: navCommunity };

        // --- AUTHENTICATION ---
        onAuthStateChanged(auth, user => {
            if (user) {
                authView.classList.add('hidden');
                mainAppView.classList.remove('hidden');
                mainAppView.classList.add('flex');
                const userEmail = user.displayName || user.email;
                userEmailSpan.textContent = userEmail;
                homeUserEmailSpan.textContent = userEmail;
                switchView('home');
                refreshHomeSummaries();
            } else {
                authView.classList.remove('hidden');
                mainAppView.classList.add('hidden');
                mainAppView.classList.remove('flex');
            }
        });

        const handleAuthError = (error) => {
            console.error("Authentication Error:", error);
            let errorMessage = "오류가 발생했습니다. 다시 시도해주세요.";
            switch (error.code) {
                case 'auth/invalid-email': errorMessage = '유효하지 않은 이메일 주소입니다.'; break;
                case 'auth/user-not-found':
                case 'auth/invalid-credential': errorMessage = '가입되지 않은 이메일이거나 비밀번호가 틀렸습니다.'; break;
                case 'auth/wrong-password': errorMessage = '비밀번호가 틀렸습니다.'; break;
                case 'auth/email-already-in-use': errorMessage = '이미 사용 중인 이메일입니다.'; break;
                case 'auth/weak-password': errorMessage = '비밀번호는 6자 이상이어야 합니다.'; break;
                case 'auth/popup-closed-by-user': errorMessage = '로그인 팝업이 닫혔습니다.'; break;
                case 'auth/unauthorized-domain': errorMessage = "로그인이 허용되지 않은 도메인입니다. Firebase 콘솔 > Authentication > 설정 > 승인된 도메인에 'googleusercontent.com'을 추가해주세요."; break;
                case 'auth/identity-toolkit-api-has-not-been-used-in-project': errorMessage = "Firebase 프로젝트의 인증 API가 활성화되지 않았습니다. Google Cloud 콘솔에서 'Identity Toolkit API'를 활성화해주세요."; break;
                default: errorMessage = `로그인에 실패했습니다. (${error.code})`; break;
            }
            authError.textContent = errorMessage;
            authError.classList.remove('hidden');
        };
        
        signupBtn.addEventListener('click', async () => {
             authError.classList.add('hidden');
             try { await createUserWithEmailAndPassword(auth, emailInput.value, passwordInput.value); } catch (error) { handleAuthError(error); }
        });

        loginBtn.addEventListener('click', async () => {
            authError.classList.add('hidden');
            try { await signInWithEmailAndPassword(auth, emailInput.value, passwordInput.value); } catch (error) { handleAuthError(error); }
        });

        googleLoginBtn.addEventListener('click', async () => {
            authError.classList.add('hidden');
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                handleAuthError(error);
            }
        });

        logoutBtn.addEventListener('click', () => signOut(auth));

        // --- APP NAVIGATION ---
        const switchView = (view) => {
            const targetView = view || 'home';
            Object.entries(views).forEach(([key, section]) => {
                section.classList.toggle('hidden', key !== targetView);
                if (navLinks[key]) {
                    navLinks[key].classList.toggle('active', key === targetView);
                }
            });
            window.location.hash = targetView;
            if (targetView === 'plan' && planModifySection) {
                planModifySection.classList.add('hidden');
            }
            if (targetView === 'home') {
                loadAndDisplayPlans();
                refreshHomeSummaries();
            }
            if (targetView === 'plan') {
                loadAndDisplayPlans();
            }
            if (targetView === 'table') {
                loadAndDisplayItems('tables', tableSavedList, viewTable);
            }
            if (targetView === 'official') {
                loadAndDisplayItems('officials', officialSavedList, viewOfficial);
            }
            if (targetView === 'letter') {
                loadAndDisplayItems('letters', letterSavedList, viewLetter);
            }
            if (targetView === 'community') {
                loadCommunityPosts();
            }
        };

        navHome.addEventListener('click', (e) => { e.preventDefault(); switchView('home'); });
        homeLink.addEventListener('click', (e) => { e.preventDefault(); switchView('home'); });
        navPlan.addEventListener('click', (e) => { e.preventDefault(); switchView('plan'); });
        navTable.addEventListener('click', (e) => { e.preventDefault(); switchView('table'); });
        navOfficial.addEventListener('click', (e) => { e.preventDefault(); switchView('official'); });
        navLetter.addEventListener('click', (e) => { e.preventDefault(); switchView('letter'); });
        if (navCommunity) {
            navCommunity.addEventListener('click', (e) => { e.preventDefault(); switchView('community'); });
        }

        if (planSearchInput) {
            planSearchInput.addEventListener('input', () => loadAndDisplayPlans());
        }
        if (recentPlanSearchInput) {
            recentPlanSearchInput.addEventListener('input', () => loadAndDisplayPlans());
        }
        if (tableSearchInput) {
            tableSearchInput.addEventListener('input', () => loadAndDisplayItems('tables', tableSavedList, viewTable));
        }
        if (officialSearchInput) {
            officialSearchInput.addEventListener('input', () => loadAndDisplayItems('officials', officialSavedList, viewOfficial));
        }
        if (letterSearchInput) {
            letterSearchInput.addEventListener('input', () => loadAndDisplayItems('letters', letterSavedList, viewLetter));
        }
        if (communitySearchInput) {
            communitySearchInput.addEventListener('input', () => loadCommunityPosts());
        }

        attachModalDismiss(profileModal);
        attachModalDismiss(communityPostModal);
        document.addEventListener('click', closeActivePostMenu);

        if (myInfoBtn) {
            myInfoBtn.addEventListener('click', () => {
                const user = auth.currentUser;
                if (!user) return;
                profileNameInput.value = user.displayName || '';
                profileEmail.textContent = user.email || '';
                openModal(profileModal);
            });
        }
        if (closeProfileModalBtn) {
            closeProfileModalBtn.addEventListener('click', () => closeModal(profileModal));
        }
        if (saveProfileBtn) {
            saveProfileBtn.addEventListener('click', async () => {
                const user = auth.currentUser;
                if (!user) return;
                const newName = profileNameInput.value.trim();
                try {
                    await updateProfile(user, { displayName: newName || null });
                    const updatedName = newName || user.email;
                    userEmailSpan.textContent = updatedName;
                    homeUserEmailSpan.textContent = updatedName;
                    closeModal(profileModal);
                    showToast('이름을 저장했습니다.');
                } catch (error) {
                    console.error('Profile update error:', error);
                }
            });
        }

        const resetCommunityModalState = () => {
            isEditingCommunityPost = false;
            editingCommunityPostId = null;
            if (communityModalTitle) communityModalTitle.textContent = '새 글 작성';
            if (communityPostSubmitBtn) communityPostSubmitBtn.textContent = '등록';
        };

        const closeCommunityModal = () => {
            if (communityPostForm) communityPostForm.reset();
            resetCommunityModalState();
            closeModal(communityPostModal);
        };
        if (openCreatePostBtn) {
            openCreatePostBtn.addEventListener('click', () => {
                resetCommunityModalState();
                if (communityPostForm) communityPostForm.reset();
                openModal(communityPostModal);
            });
        }
        if (closeCommunityModalBtn) {
            closeCommunityModalBtn.addEventListener('click', (event) => {
                event.preventDefault();
                closeCommunityModal();
            });
        }
        if (cancelCommunityPostBtn) {
            cancelCommunityPostBtn.addEventListener('click', (event) => {
                event.preventDefault();
                closeCommunityModal();
            });
        }
        if (communityPostForm) {
            communityPostForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                const user = auth.currentUser;
                if (!user) return;
                const title = communityPostTitleInput.value.trim();
                const content = communityPostContentInput.value.trim();
                if (!title || !content) return;
                try {
                    if (isEditingCommunityPost && editingCommunityPostId) {
                        await updateDoc(doc(db, 'communityPosts', editingCommunityPostId), {
                            title,
                            content,
                            updatedAt: serverTimestamp()
                        });
                        showToast('글이 수정되었습니다.');
                    } else {
                        await addDoc(collection(db, 'communityPosts'), {
                            title,
                            content,
                            authorId: user.uid,
                            authorName: user.displayName || user.email,
                            createdAt: serverTimestamp()
                        });
                        showToast('글이 등록되었습니다.');
                    }
                    closeCommunityModal();
                    loadCommunityPosts();
                } catch (error) {
                    console.error('Error saving community post:', error);
                }
            });
        }

        const loadAndRenderComments = async (postId, container) => {
            if (!container) return;
            const user = auth.currentUser;
            try {
                const commentsRef = collection(db, 'communityPosts', postId, 'comments');
                const snap = await getDocs(commentsRef);
                const comments = [];
                snap.forEach(docSnap => comments.push({ id: docSnap.id, ...docSnap.data() }));
                comments.sort((a, b) => (a.createdAt?.toMillis?.() || a.createdAt?.seconds || 0) - (b.createdAt?.toMillis?.() || b.createdAt?.seconds || 0));
                container.innerHTML = '';
                if (comments.length === 0) {
                    container.innerHTML = '<p class="text-sm text-gray-500">첫 댓글을 남겨보세요.</p>';
                    return;
                }
                comments.forEach(comment => {
                    const commentCard = document.createElement('div');
                    commentCard.className = 'bg-gray-50 border border-gray-200 rounded-md px-3 py-2';

                    const metaRow = document.createElement('div');
                    metaRow.className = 'flex flex-wrap items-center justify-between gap-2 text-xs text-gray-500';
                    const metaLeft = document.createElement('div');
                    metaLeft.className = 'flex items-center gap-2';
                    const authorSpan = document.createElement('span');
                    authorSpan.textContent = comment.authorName || '익명';
                    const timeSpan = document.createElement('span');
                    timeSpan.textContent = formatDateTime(comment.createdAt, true);
                    metaLeft.appendChild(authorSpan);
                    metaLeft.appendChild(document.createTextNode('·'));
                    metaLeft.appendChild(timeSpan);
                    metaRow.appendChild(metaLeft);

                    if (user && comment.authorId === user.uid) {
                        const actionWrap = document.createElement('div');
                        actionWrap.className = 'flex items-center gap-2';
                        const editBtn = document.createElement('button');
                        editBtn.type = 'button';
                        editBtn.className = 'text-blue-600 hover:underline';
                        editBtn.textContent = '수정';
                        const deleteBtn = document.createElement('button');
                        deleteBtn.type = 'button';
                        deleteBtn.className = 'text-red-500 hover:underline';
                        deleteBtn.textContent = '삭제';
                        actionWrap.appendChild(editBtn);
                        actionWrap.appendChild(deleteBtn);
                        metaRow.appendChild(actionWrap);

                        editBtn.addEventListener('click', async () => {
                            const updated = prompt('댓글을 수정하세요', comment.content || '');
                            if (!updated || !updated.trim()) return;
                            try {
                                await updateDoc(doc(db, 'communityPosts', postId, 'comments', comment.id), {
                                    content: updated.trim(),
                                    updatedAt: serverTimestamp()
                                });
                                showToast('댓글이 수정되었습니다.');
                                await loadAndRenderComments(postId, container);
                            } catch (error) {
                                console.error('Error updating comment:', error);
                            }
                        });

                        deleteBtn.addEventListener('click', async () => {
                            if (!confirm('댓글을 삭제하시겠습니까?')) return;
                            try {
                                await deleteDoc(doc(db, 'communityPosts', postId, 'comments', comment.id));
                                showToast('댓글이 삭제되었습니다.');
                                await loadAndRenderComments(postId, container);
                            } catch (error) {
                                console.error('Error deleting comment:', error);
                            }
                        });
                    }

                    const contentEl = document.createElement('p');
                    contentEl.className = 'mt-2 text-sm text-gray-700 whitespace-pre-wrap';
                    contentEl.textContent = comment.content || '';

                    commentCard.appendChild(metaRow);
                    commentCard.appendChild(contentEl);
                    container.appendChild(commentCard);
                });
            } catch (error) {
                console.error('Error loading comments:', error);
                container.innerHTML = '<p class="text-sm text-red-500">댓글을 불러오지 못했습니다.</p>';
            }
        };

        const renderCommunityPosts = async (posts) => {
            if (!communityPostList) return;
            closeActivePostMenu();
            communityPostList.innerHTML = '';
            if (!posts || posts.length === 0) {
                communityPostList.innerHTML = '<p class="text-gray-500 text-center py-4">등록된 글이 없습니다.</p>';
                return;
            }

            for (const post of posts) {
                const card = document.createElement('div');
                card.className = 'bg-white p-6 rounded-lg shadow-md';
                card.id = `community-post-${post.id}`;

                const header = document.createElement('div');
                header.className = 'flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3';
                const leftBox = document.createElement('div');
                const titleEl = document.createElement('h3');
                titleEl.className = 'text-xl font-semibold text-gray-800';
                titleEl.textContent = post.title || '제목 없음';
                const authorInfo = document.createElement('p');
                authorInfo.className = 'text-sm text-gray-500';
                authorInfo.textContent = `작성자 ${post.authorName || '익명'}`;
                leftBox.appendChild(titleEl);
                leftBox.appendChild(authorInfo);

                const rightBox = document.createElement('div');
                rightBox.className = 'flex items-start gap-2 relative';
                const dateEl = document.createElement('span');
                dateEl.className = 'text-sm text-gray-500 whitespace-nowrap';
                dateEl.textContent = formatDateTime(post.createdAt, true);
                rightBox.appendChild(dateEl);

                const user = auth.currentUser;
                if (user && post.authorId === user.uid) {
                    const menuWrapper = document.createElement('div');
                    menuWrapper.className = 'relative';
                    const menuBtn = document.createElement('button');
                    menuBtn.type = 'button';
                    menuBtn.className = 'text-gray-500 hover:text-gray-700 px-2';
                    menuBtn.innerHTML = '&#8942;';
                    const menu = document.createElement('div');
                    menu.className = 'hidden absolute right-0 mt-2 w-32 bg-white border border-gray-200 rounded-md shadow-lg z-20 text-sm text-left';
                    menu.addEventListener('click', (e) => e.stopPropagation());
                    const editContentBtn = document.createElement('button');
                    editContentBtn.type = 'button';
                    editContentBtn.className = 'block w-full px-4 py-2 hover:bg-gray-100 text-left';
                    editContentBtn.textContent = '글 수정';
                    const editTitleBtn = document.createElement('button');
                    editTitleBtn.type = 'button';
                    editTitleBtn.className = 'block w-full px-4 py-2 hover:bg-gray-100 text-left';
                    editTitleBtn.textContent = '제목 수정';
                    const deleteBtn = document.createElement('button');
                    deleteBtn.type = 'button';
                    deleteBtn.className = 'block w-full px-4 py-2 hover:bg-gray-100 text-left text-red-600';
                    deleteBtn.textContent = '삭제';
                    menu.appendChild(editContentBtn);
                    menu.appendChild(editTitleBtn);
                    menu.appendChild(deleteBtn);
                    menuWrapper.appendChild(menuBtn);
                    menuWrapper.appendChild(menu);
                    rightBox.appendChild(menuWrapper);

                    menuBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        if (activePostMenu && activePostMenu !== menu) {
                            activePostMenu.classList.add('hidden');
                        }
                        const willOpen = menu.classList.contains('hidden');
                        menu.classList.toggle('hidden');
                        activePostMenu = willOpen ? menu : null;
                    });

                    editTitleBtn.addEventListener('click', async () => {
                        closeActivePostMenu();
                        const newTitle = prompt('새 제목을 입력하세요', post.title || '');
                        if (!newTitle || !newTitle.trim()) return;
                        try {
                            await updateDoc(doc(db, 'communityPosts', post.id), {
                                title: newTitle.trim(),
                                updatedAt: serverTimestamp()
                            });
                            showToast('제목을 수정했습니다.');
                            loadCommunityPosts();
                        } catch (error) {
                            console.error('Error updating post title:', error);
                        }
                    });

                    editContentBtn.addEventListener('click', () => {
                        closeActivePostMenu();
                        isEditingCommunityPost = true;
                        editingCommunityPostId = post.id;
                        if (communityModalTitle) communityModalTitle.textContent = '글 수정';
                        if (communityPostSubmitBtn) communityPostSubmitBtn.textContent = '수정 완료';
                        communityPostTitleInput.value = post.title || '';
                        communityPostContentInput.value = post.content || '';
                        openModal(communityPostModal);
                    });

                    deleteBtn.addEventListener('click', async () => {
                        closeActivePostMenu();
                        if (!confirm('글을 삭제하시겠습니까?')) return;
                        try {
                            const commentsSnap = await getDocs(collection(db, 'communityPosts', post.id, 'comments'));
                            await Promise.all(commentsSnap.docs.map(commentDoc => deleteDoc(commentDoc.ref)));
                            await deleteDoc(doc(db, 'communityPosts', post.id));
                            showToast('글이 삭제되었습니다.');
                            loadCommunityPosts();
                        } catch (error) {
                            console.error('Error deleting post:', error);
                        }
                    });
                }

                header.appendChild(leftBox);
                header.appendChild(rightBox);
                card.appendChild(header);

                const contentEl = document.createElement('p');
                contentEl.className = 'mt-4 whitespace-pre-wrap text-gray-700';
                contentEl.textContent = post.content || '';
                card.appendChild(contentEl);

                const commentsSection = document.createElement('div');
                commentsSection.className = 'mt-6 border-t pt-4';
                const commentsTitle = document.createElement('h4');
                commentsTitle.className = 'font-semibold text-gray-800 mb-3';
                commentsTitle.textContent = '댓글';
                const commentsContainer = document.createElement('div');
                commentsContainer.className = 'space-y-3';
                commentsSection.appendChild(commentsTitle);
                commentsSection.appendChild(commentsContainer);

                await loadAndRenderComments(post.id, commentsContainer);

                const commentForm = document.createElement('form');
                commentForm.className = 'mt-4 space-y-2';
                const commentTextarea = document.createElement('textarea');
                commentTextarea.rows = 3;
                commentTextarea.className = 'w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500';
                commentTextarea.placeholder = '댓글을 입력하세요';
                const commentSubmit = document.createElement('button');
                commentSubmit.type = 'submit';
                commentSubmit.className = 'px-4 py-2 bg-[#7A9D54] text-white rounded-md hover:bg-[#6a8a4a]';
                commentSubmit.textContent = '등록';
                commentForm.appendChild(commentTextarea);
                commentForm.appendChild(commentSubmit);
                commentForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const user = auth.currentUser;
                    if (!user) return;
                    const content = commentTextarea.value.trim();
                    if (!content) return;
                    try {
                        await addDoc(collection(db, 'communityPosts', post.id, 'comments'), {
                            content,
                            authorId: user.uid,
                            authorName: user.displayName || user.email,
                            createdAt: serverTimestamp()
                        });
                        commentTextarea.value = '';
                        await loadAndRenderComments(post.id, commentsContainer);
                        showToast('댓글이 등록되었습니다.');
                    } catch (error) {
                        console.error('Error adding comment:', error);
                    }
                });

                commentsSection.appendChild(commentForm);
                card.appendChild(commentsSection);
                communityPostList.appendChild(card);
            }
        };

        const highlightCommunityPost = (postId) => {
            const target = document.getElementById(`community-post-${postId}`);
            if (!target) return false;
            target.scrollIntoView({ behavior: 'smooth', block: 'start' });
            target.classList.add('border-2', 'border-green-500');
            setTimeout(() => {
                target.classList.remove('border-2', 'border-green-500');
            }, 2000);
            return true;
        };

        function openCommunityPost(postId) {
            if (!postId) return;
            switchView('community');
            setTimeout(() => {
                if (!highlightCommunityPost(postId)) {
                    loadCommunityPosts().then(() => highlightCommunityPost(postId));
                }
            }, 200);
        }

        const loadCommunityPosts = async (options = {}) => {
            const { skipRender = false } = options;
            try {
                const postsRef = collection(db, 'communityPosts');
                const snap = await getDocs(postsRef);
                const posts = [];
                snap.forEach(docSnap => posts.push({ id: docSnap.id, ...docSnap.data() }));
                posts.sort((a, b) => (b.createdAt?.toMillis?.() || b.createdAt?.seconds || 0) - (a.createdAt?.toMillis?.() || a.createdAt?.seconds || 0));
                communityPostsCache = posts;
                setHomeListData('community', posts);
                if (skipRender) return;
                const searchTerm = (communitySearchInput?.value || '').trim().toLowerCase();
                let displayPosts = posts;
                if (searchTerm) {
                    displayPosts = posts
                        .filter(post => (post.title || '').toLowerCase().includes(searchTerm))
                        .sort((a, b) => (a.createdAt?.toMillis?.() || a.createdAt?.seconds || 0) - (b.createdAt?.toMillis?.() || b.createdAt?.seconds || 0));
                }
                await renderCommunityPosts(displayPosts);
            } catch (error) {
                console.error('Error loading community posts:', error);
                if (!skipRender && communityPostList) {
                    communityPostList.innerHTML = '<p class="text-red-500 text-center py-4">커뮤니티 글을 불러오지 못했습니다.</p>';
                }
            }
        };

        const fetchUserCollectionItems = async (type) => {
            const user = auth.currentUser;
            if (!user) return [];
            const colRef = collection(db, 'users', user.uid, type);
            const snap = await getDocs(query(colRef));
            const items = [];
            snap.forEach(docSnap => items.push({ id: docSnap.id, ...docSnap.data() }));
            items.sort((a, b) => (b.createdAt?.toMillis?.() || b.createdAt?.seconds || 0) - (a.createdAt?.toMillis?.() || a.createdAt?.seconds || 0));
            return items;
        };

        const refreshHomeSummaries = async () => {
            const user = auth.currentUser;
            if (!user) return;
            try {
                const [tables, officials, letters] = await Promise.all([
                    fetchUserCollectionItems('tables'),
                    fetchUserCollectionItems('officials'),
                    fetchUserCollectionItems('letters')
                ]);
                setHomeListData('tables', tables);
                setHomeListData('officials', officials);
                setHomeListData('letters', letters);
            } catch (error) {
                console.error('Home summary load error:', error);
            }
            await loadCommunityPosts({ skipRender: true });
        };

        // --- TABLE GENERATOR LOGIC ---
        if (tableForm) {
            tableForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const user = auth.currentUser;
                if (!user) return;
                let topic = tableTopic.value.trim();
                const rowMatch = topic.match(/\[행\]\s*(\d+)/);
                const colMatch = topic.match(/\[열\]\s*(\d+)/);
                const rows = rowMatch ? rowMatch[1] : null;
                const cols = colMatch ? colMatch[1] : null;
                topic = topic.replace(/\[행\]\s*\d+/, '').replace(/\[열\]\s*\d+/, '').trim();
                if (!topic) return;

                showToast('생성 중입니다..');

                let prompt = `다음 조건에 맞는 표를 마크다운 형식으로 작성해줘.\n주제: ${topic}`;
                if (rows) prompt += `\n행 수: ${rows}`;
                if (cols) prompt += `\n열 수: ${cols}`;
                prompt += `\n추가 설명 없이 표만 출력해.`;
                try {
                    const response = await fetch('/.netlify/functions/generatePlan', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt, model: GEMINI_MODEL })
                    });
                    const result = await response.json();
                    if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                        currentTableMarkdown = extractMarkdownFromText(result.candidates[0].content.parts[0].text);
                        generatedTableContainer.innerHTML = renderMarkdownTable(currentTableMarkdown);
                        tableOutputSection.classList.remove('hidden');
                        tableModifySection.classList.remove('hidden');
                        const conciseTitle = await generateConciseTitleFromInput(topic, topic);
                        const docRef = await addDoc(collection(db, "users", user.uid, "tables"), {
                            title: conciseTitle,
                            createdAt: serverTimestamp(),
                            rawContent: currentTableMarkdown
                        });
                        currentTableId = docRef.id;
                        loadAndDisplayItems('tables', tableSavedList, viewTable);
                    }
                } catch (err) {
                    console.error('Table Generation Error:', err);
                }
            });

            editTableBtn.addEventListener('click', () => {
                if (!currentTableMarkdown) return;
                if (!isEditingTable) {
                    isEditingTable = true;
                    editTableBtn.textContent = '완료';
                    editTableBtn.classList.add('bg-green-500', 'text-white');
                    const textarea = document.createElement('textarea');
                    textarea.id = 'table-editor';
                    textarea.className = 'w-full h-48 p-2 border rounded-md font-mono text-sm';
                    textarea.value = currentTableMarkdown;
                    generatedTableContainer.replaceWith(textarea);
                } else {
                    const textarea = document.getElementById('table-editor');
                    currentTableMarkdown = textarea.value;
                    const newDiv = document.createElement('div');
                    newDiv.id = 'generated-table-container';
                    newDiv.className = 'plan-section-content overflow-x-auto';
                    newDiv.innerHTML = renderMarkdownTable(currentTableMarkdown);
                    textarea.replaceWith(newDiv);
                    generatedTableContainer = newDiv;
                    isEditingTable = false;
                    editTableBtn.textContent = '편집';
                    editTableBtn.classList.remove('bg-green-500', 'text-white');
                    saveCurrentTable();
                }
            });

            copyTableBtn.addEventListener('click', () => {
                if (!currentTableMarkdown) return;
                const tableElement = generatedTableContainer?.querySelector?.('table');
                let htmlToCopy = tableElement ? htmlTableToHtmlClipboard(tableElement) : null;
                if (!htmlToCopy || !htmlToCopy.trim() || !/<table[\s>]/i.test(htmlToCopy)) {
                    htmlToCopy = markdownTableToHtmlClipboard(currentTableMarkdown);
                }
                if (!htmlToCopy || !htmlToCopy.trim() || !/<table[\s>]/i.test(htmlToCopy)) return;
                copyToClipboard(htmlToCopy, true, '표가 클립보드에 복사되었습니다.');
            });

            tableModifyForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!currentTableMarkdown) return;
                const userPrompt = tableModifyPrompt.value.trim();
                if (!userPrompt) return;
                showToast('수정 중입니다..');
                const prompt = `다음 마크다운 표를 사용자의 요청에 맞게 수정해줘.\n표:\n${currentTableMarkdown}\n\n요청: ${userPrompt}\n\n수정된 표를 마크다운 표로만 출력해줘.`;
                try {
                    const response = await fetch('/.netlify/functions/generatePlan', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt, model: GEMINI_MODEL })
                    });
                    const result = await response.json();
                    if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                        currentTableMarkdown = extractMarkdownFromText(result.candidates[0].content.parts[0].text);
                        if (isEditingTable) {
                            const textarea = document.getElementById('table-editor');
                            textarea.value = currentTableMarkdown;
                        } else {
                            generatedTableContainer.innerHTML = renderMarkdownTable(currentTableMarkdown);
                        }
                        saveCurrentTable();
                    }
                } catch (err) {
                    console.error('Table Modify Error:', err);
                }
            });
        }

        // --- OFFICIAL DOCUMENT LOGIC ---
        if (addAttachmentBtn) {
            const addAttachmentInput = () => {
                const wrapper = document.createElement('div');
                wrapper.className = 'flex items-center gap-2';
                const input = document.createElement('input');
                input.type = 'file';
                input.className = 'block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer';
                const span = document.createElement('span');
                span.className = 'text-sm text-gray-600 flex-1';
                input.addEventListener('change', () => {
                    span.textContent = input.files[0]?.name || '';
                });
                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.className = 'text-red-500 font-bold';
                removeBtn.textContent = 'X';
                removeBtn.addEventListener('click', () => wrapper.remove());
                wrapper.appendChild(input);
                wrapper.appendChild(span);
                wrapper.appendChild(removeBtn);
                attachmentsContainer.appendChild(wrapper);
            };
            addAttachmentBtn.addEventListener('click', addAttachmentInput);
        }

        if (officialForm) {
            const officialDocExamples = `제목: 2023학년도 과학의 날 주간 행사 결과 제출
1. 관련: OO초등학교-5678(2023. 10. 15.)
2023학년도 과학의 날 주간 행사 결과를 붙임과 같이 제출합니다.

붙임  2023학년도 과학의 날 주간 행사 결과 1부.  끝.
---
제목: ○○시 학교운영위원장협의회 장학생 추천 제출
1. 관련 : 교육지원과-31899(2018.10.1.)
2. ○○시 학교운영위원장협의회 장학생 추천 의뢰에 따라 붙임과 같이 제출합니다. 

붙임  ○○시 학교운영위원장협의회 장학생 학교장 추천서(○○초) 1부.  끝.
---
제목: ○○○○학년도 돌봄교실 방과후프로그램강사 채용 공고
1. 관련: 00초등학교-2141(2019. 3. 11.) 
2. ○○○○학년도 돌봄교실 프로그램강사 채용을 위하여 붙임과 같이 공고하고자 합니다. 
붙임  ○○○○ 돌봄교실 방과후프로그램강사 채용 공고 1부.  끝.
---
제목: 20xx. 전문적 학습공동체 외부 강사 초청 연수 실시
1. 관련: OO초등학교-2101(2019. 3. 11.) 
2. 교원 전문성 신장을 위한 2019. 전문적 학습공동체 외부 강사 초청 연수를 다음과 같이 실시하고자 합니다.
  가. 일시: 2019. 5. 29.(수) 13:30~15:30(3차시)
  나. 장소: 본교 라온숲(우천시 본교 전담실)
  다. 대상: 본교 전문적 학습공동체 회원 11명
  라. 주제: 숲체험 활동 체험 및 숲 밧줄놀이 지도의 실제
  마. 강사: 권금주(숲해설가, 숲밧줄놀이 지도자)
  바. 비용
    1) 강사비 : 50,000원(기타강사에 준함)
    2) 원고료 : 105,000원(한글 7.5매로 제한).  끝.
---
제목: 20xx학년도 전문적 학습공동체 연수를 위한 협조 요청
1. 관련: 00초등학교-2141(2019. 3. 11.) 
2. 교원 전문성 신장을 위한 2019. 전문적 학습공동체 연수 의뢰를 아래와 같이 보내드리오니 귀 기관의 협조를 요청합니다.  
  가. 일 시: 2019. 3. 27.(수) 14:40 ~ 16:40 (2시간)
  나. 장 소: 00초등학교 전담실
  다. 주 제: 생태감수성 함양을 위한 00교육활동의 실제
  라. 강 사: 00초등학교 000 교사
  마. 대 상: 00초 전문적 학습공동체 『0000』 회원 00명
  바. 기 타: 강사비 및 원고비 규정에 따라 지급 예정.  끝.
---
제목: 20○○학년도 00교육 성과보고 및 종합학습발표회 안내
1. 귀교(기관)의 무궁한 발전을 기원합니다.
2. 20○○ 00교육성과보고 및 종합학습발표회 꿈과 끼를 펼치는“00 한마당 축제”를 아래와 같이 개최하오니 바쁘시더라도 참석하시어 자리를 빛내주시면 감사하겠습니다.
  가. 일 시: 20○○.11.23(금) 14:00~16:30
  나. 장 소: 00초등학교 강당
  다. 내 용: 00교육 성과보고, 작품전시회 및 학습발표회

붙임  모시는 글(프로그램) 1부.  끝.
---
제목: 2019. 전문적 학습공동체 외부 강사 초청 연수 실시
1. 관련: 00초등학교-2101(2019. 3. 11.) 
2. 환경교육 관련 교원 전문성 신장을 위한 2019. 전문적 학습공동체 외부 강사 초청 연수를 다음과 같이 실시하고자 합니다.
  가. 일시: 2019. 0. 00.(수) 14:00~16:00(3차시)
  나. 장소: 본교 전담실
  다. 대상: 본교 전문적 학습공동체 『000』회원 00명
  라. 주제:‘초록식물을 늘리고, 재활용품으로 살리고’
           (스칸디아모스 토피어리 및 양말목 공예 관련 지도방안의 실제)
  마. 비용
    1) 강사비 : 90,000원(기타강사에 준함, 60분씩 2개 강좌)
    2) 원고비 : 28,000원(2매).  끝.
---
제목: 2023학년도 AI 활용 교육 연수 보고
1. 관련: OO초등학교-1234(2023. 6. 19.)
2. 2023학년도 AI 활용 교육 연수에 대하여 붙임과 같이 보고합니다.
  가. 일자: 2023. 10. 15. (일) 14:00~16:00
  나. 장소: 본교 대강당
  다. 대상: 교직원
  라. 연수 주제: AI 활용 교육 방법 및 사례 공유

붙임  1. 2023학년도 AI 활용 교육 연수 자료 1부.
      2. 2023학년도 AI 활용 교육 연수 교직원 연수 등록부 1부.  끝.
---
제목: 2024학년도 개별화교육계획 수정 회의 보고
1. 관련: OO초등학교-1234(2023. 6. 19.)
2. 2023학년도 개별화교육계획 수정 회의에 대하여 다음과 같이 보고합니다.
  가. 일자: 2023. 10. 25. (수) 14:00~15:00
  나. 장소: 본교 회의실
  다. 참석자: 교사 및 학부모
  라. 회의 주제: 개별화교육계획 수정 및 보완

붙임  1. 2023학년도 개별화교육계획 수정 회의 자료 1부.
      2. 2023학년도 개별화교육계획 수정 회의 참석자 명단 1부.  끝.
---
제목: 어린이놀이시설 중대사고 발생 보고(○○초)
1. 관련: 어린이놀이시설 안전관리법 제22조
2. 2018.XX.XX. 우리학교에서 발생한 어린이놀이시설 중대사고 건에 대하여 다음과 같이 보고합니다.
  
  가. 사고일시: 2018.XX.XX. 00:00경
  나. 놀이시설번호: XXXXX

붙임  1. 어린이놀이시설 사고보고서(OO초) 1부.
      2. 사고현장 및 조치 사진 1부.  끝.
---
제목: 2023학년도 개별화교육지원팀 회의 계획
1. 관련: OO초등학교-1234(2023. 6. 19.)
2. 2023학년도 개별화교육지원팀 회의를 다음과 같이 실시하고자 합니다.
  가. 일자: 2023. 7. 15. (토) 10:00~12:00
  나. 장소: 본교 회의실
  다. 참석자: 개별화교육지원팀 구성원
  라. 회의 주제: 개별화교육계획 수립 및 실행 전략

붙임  1. 2023학년도 개별화교육지원팀 회의록 1부.
      2. 2023학년도 개별화교육지원팀 회의 명단 1부.  끝.
---
제목: 2023학년도 교내 체육대회 계획
1. 관련: OO초등학교-1234(2023.6.19.)
2. 2023학년도 교내 체육대회 계획을 붙임과 같이 수립하여 운영하고자 합니다.

붙임  2023학년도 교내 체육대회 계획 1부.  끝.
---
제목: 2024학년도 교원 보결수업 지원 계획
1. 관련: ○○과-21○○(20○○.○○.○.), 00초-10○○(20○○.○.○.)
2. 교원의 보결수업 기피 완화 및 책무성을 강화하고 학생의 학습권 보호 및 교육과정 운영의 적정성을 확보하고자 다음과 같이 교원 보결수업 지원 계획 수립하여 운영하고자 합니다.
  가. 적용시기: 2024.3.1.부터
  나. 주요 내용
    1) 보결수업비가 남용되지 않도록‘교체수업’을 원칙으로 함
    2) 교체수업 불가시 보결수업 배정
    3) 시간당 보결수업비: 7,000원
    4) 월 최대 보결수업비: 30,000원

 붙임  2018학년도 교원 보결 수업 지원 계획 1부.  끝. 
---
제목: 20xx학년도 학부모 상담주간 운영 계획
1. 관련: OO초등학교-1234(2023. 6. 19.)
2. 학교교육계획에 의거 학부모 상담을 통한 생활지도 및 진로지도 자료 확보를 통한 바른 품성 함양과 건전한 면학 분위기 조성을 위해 20xx년도 상반기 학부모 상담주간을 아래와 같이 계획하여 실시하고자 합니다.
3. 상담기간 : 20xx. 4. 1 (월) ~ 4. 5 (금)
4. 대상 : 전교생 대상
5. 내용 : 학습환경, 생활 등 보호자 면담-생활지도, 학교폭력 예방 및 진로지도 자료 확보
6. 추진 유의 사항
  기. 희망 가정에 한하여 대면 상담, 다과(음식) 준비 금지 당부
  나. 상담 희망 날짜, 시간, 상담요청 내용 미리 파악 

붙임  20xx학년도 학부모 상담주간 운영 계획 1부. 끝
---
제목: 20○○학년도 종합 학습발표회 계획(안)
  20○○학년도 학교교육과정 운영 계획에 의거 붙임과 같이 종합 학습발표회를  실시하고자합니다.
1. 일시: 20○○. 11.23(금) 14:00 ~
2. 장소: 00관 및 운동장 주변
3. 운영프로그램 : 학예발표회, 작품전시회
4. 주제: 꿈과 끼를 펼치는 00 한마당 축제
5. 세부추진사항 : 붙임 참조

붙임   20○○ 종합학습발표회 운영 계획(안) 1부. 끝. 
---
제목: 20○○학년도 입학식 계획
  20○○ 학교 교육과정 운영 계획에 의거 아래와 같이 입학식을 운영하고자 합니다.
1. 일시: 20○○. 3. 2(금) 10:00 ~
2. 장소: 00관
3. 대상: 신입생 000명, 재학생 6학년 2학급
4. 입학식순 : 첨부
           
붙임: 1. 입학식순 1부
      2. 입학허가서 1부
      3. 재학생 환영사 1부
      4. 신입생 답사 1부. 끝.
---
제목: 귀국학생 재취학에 따른 조기진급, 졸업, 진학 평가위원회 개최
1. 관련: 초․ 중등교육법시행령 제 29조 (유예자 등의 학적관리) 2항
2. 의무교육을 유예 ․ 면제 ․ 정원외 관리 중인 학생이 재취학 하고자 하여 조기진급․졸업․진학 평가위원회의를 다음과 같이 개최하고자 합니다.
  가. 목 적 : 해외 거주로 인하여 귀국 후 교과, 언어, 학생 생활에 있어 학생의                          수준을 파악하여 학교생활에 잘 적응할 수 있도록 한다. 
  나. 내 용 
    1) 조기진급․졸업․진학 평가위원회를 구성하며, 위원은 본교에 재직 중인 교원 중 5인 이내로 구성하며, 위원장은 교장으로 한다.
    2) 평가교과는 2-3학년은 국어, 수학 교과를 4-6학년은 국어, 수학, 사회, 과학 내용             중 조기진급․졸업․진학 평가위원회의 출제 문항을 평가한다.  
    3) 교과별 이수인정 점수는 60점 이상으로 한다. 
    4) 학교장이 학생을 면담한 후 교과목별 이수인정 평가결과에 따라 학년을 결정한다. 
    5) 귀국학생이 타학교 재학 중에 유예, 면제, 정원외 관리되었을 때는 타학교에서             서류를 송부받아 생활기록부에 첨부토록 한다.
  다. 절 차
    귀국학생 접수 → 교과목별 이수인정 평가 → 조기진급․졸업․진학 평가위원회의 → 학교장 결재 → 학년반 지정 → 타학교 재학이 있는 경우 서류 송부요청
 
붙임  1. 3학년 교과목별 이수인정 평가지 1부.
      2. 4학년 교과목별 이수인정 평가지 1부. 끝.
---
제목: ○○시 학교운영위원장협의회 장학생 선발을 위한 장학생 선정위원회 개최
1. 관련 : 교육지원과-31889(2000.10.1.)
2. ○○시 학교운영위원장협의회의 장학생 추천 의뢰에 따라 장학생 선정위원회를 개최하고자 합니다.
  가. 일시 및 장소 : 2018.10.2.(화) 12:30~00:00, 교무실
  나. 참석 대상 : 시상관리위원(10명)
  다. 협의 내용 : 장학생 추천자 선정 1명
  라. 추천 대상자 선정 기준
    1) 학교발전에 이바지한 학생
    2) 학교생활이 타의 모범이 되는 학생
    3) 기타 가정 및 개인 형편상 도움이 필요한 학생
    4) 장학금 기수여자 제외.  끝.
---
제목: 20○○학년도 학부모회 총회 개최
  20○○학년도 학부모회 총회를 다음과 같이 개최하고자 합니다.
1. 일시 : 20○○. 3. 19(화). 오후 6시(시간 엄수 바랍니다.) 
2. 대상 : 학부모
3. 장소 : 본교 강당
4. 행사내용
  가. 20○○학년도 학교교육과정 설명회
  나. 녹색어머니회 발대식
  다. 위촉장수여(명예사서도우미, ‘엄마 책 읽어 주세요’ 강사)
5. 학부모 연수
  가. 학교폭력 예방 연수
  나. 교원능력 개발 평가 관련 연수 
6. 총회 안건 
  가. 20○○학년도 학부모회임원 선출(회장, 감사2)
  나. 교육 상담(담임과의 대화 시간 운영)

붙임  1. 학부모회 총회 안내장 1부.
      2. 학부모총회 회순 1부.
      3. 학부모 총회 현수막(안) 1부. 끝.
---
제목: 20○○학년도 졸업생 시상규정 개정을 위한 교무기획위원회 개최
  20○○학년도 졸업생 시상규정 개정 관련 협의를 위한 교무기획위원회를 아래와 같이 개최하고자 합니다.
1. 일시: 20○○. 3. 18(월), 15:00
2. 장소: 교무실
3. 참석대상: 교무기획위원회 위원장(교감 000), 교무부장, 6학년 각 반 담임교사, 시상관리 업무담당자 등 11명
4. 안건: 20○○학년도 졸업생 시상 규정 개정
※ 참석대상자는 20○○학년도 졸업생 시상규정(붙임문서) 숙독 후 참석

붙임   20○○학년도 졸업생 시상규정_00초 1부.  끝.`;
            officialForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const user = auth.currentUser;
                if (!user) return;
                const topic = officialTopic.value.trim();
                if (!topic) return;
                const referenceText = officialReference.value.trim();
                let agency = '', docNumber = '', date = '';
                if (referenceText) {
                    try {
                        const parsePrompt = `다음 문장에서 관련 기관, 문서 번호, 날짜를 JSON으로 추출해줘. 포맷: {"agency":"", "docNumber":"", "date":""} 문장: ${referenceText}`;
                        const parseRes = await fetch('/.netlify/functions/generatePlan', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ prompt: parsePrompt, model: GEMINI_MODEL })
                        });
                        const parseResult = await parseRes.json();
                        const text = parseResult.candidates?.[0]?.content?.parts?.[0]?.text;
                        if (text) {
                            const jsonMatch = text.match(/\{[\s\S]*\}/);
                            if (jsonMatch) {
                                const obj = JSON.parse(jsonMatch[0]);
                                agency = obj.agency || '';
                                docNumber = obj.docNumber || '';
                                date = obj.date || '';
                            }
                        }
                    } catch (err) {
                        console.error('Evidence Parse Error:', err);
                    }
                }
                const attachments = Array.from(attachmentsContainer.querySelectorAll('input[type="file"]'))
                    .map(input => input.files[0]?.name)
                    .filter(Boolean);

                let prompt = `다음 기안문 예시를 참고하여 기안문을 작성해줘.\n예시:\n${officialDocExamples}\n\n주제: ${topic}`;
                if (agency || docNumber || date) prompt += `\n근거: ${agency}-${docNumber}(${date})`;
                if (attachments.length) prompt += `\n첨부파일: ${attachments.join(', ')}`;
                prompt += `\n형식:\n제목 ${topic}\n1. 관련: [근거]\n   - 괄호 안 날짜는 'YYYY.M.D.' 형식으로 끝에 마침표를 포함해 작성해\n2. ${topic}을 반영한 내용`;
                if (attachments.length > 1) {
                    const attachmentList = attachments
                        .map((a, idx) => `${idx + 1}. ${a} 1부.`)
                        .join('\n      ');
                    prompt += `\n\n붙임  ${attachmentList}  끝.`;
                } else if (attachments.length === 1) {
                    prompt += `\n\n붙임  ${attachments[0]} 1부.  끝.`;
                } else {
                    prompt += `\n\n끝.`;
                }
                prompt += `\n근거 정보가 없으면 '1. 관련:' 항목은 생략하고, 첨부파일이 없으면 붙임 부분은 생략해.`;
                if (attachments.length > 1) {
                    prompt += ` 첨부파일이 여러 개인 경우 번호를 붙여 구분해.`;
                }
                prompt += ` 제목은 첫 줄에만 작성해. 추가 설명 없이 마크다운으로 작성해.`;
                prompt += ` 항목은 항상 '1.', '2.'와 같이 숫자 목록 형식으로 작성하고, 불릿 기호는 사용하지 마.`;
                prompt += ` '붙임' 다음에는 두 칸을 띄우고, 같은 줄에서 두 칸을 띄운 뒤 '끝.'으로 마무리해.`;

                try {
                    const response = await fetch('/.netlify/functions/generatePlan', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt, model: GEMINI_MODEL })
                    });
                    const result = await response.json();
                    if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                        const fullText = extractMarkdownFromText(result.candidates[0].content.parts[0].text);
                        const lines = fullText.split('\n');
                        currentOfficialTitle = lines.shift().trim();
                        currentOfficialMarkdown = formatOfficialMarkdown(lines.join('\n').trim());
                        officialTitle.textContent = currentOfficialTitle;
                        generatedOfficialContainer.innerHTML = renderOfficialContent(currentOfficialMarkdown);
                        officialOutputSection.classList.remove('hidden');
                        officialModifySection.classList.remove('hidden');
                        officialTopic.value = '';
                        officialReference.value = '';
                        attachmentsContainer.innerHTML = '';
                        const docRef = await addDoc(collection(db, "users", user.uid, "officials"), {
                            title: currentOfficialTitle,
                            createdAt: serverTimestamp(),
                            rawContent: currentOfficialMarkdown
                        });
                        currentOfficialId = docRef.id;
                        loadAndDisplayItems('officials', officialSavedList, viewOfficial);
                    }
                } catch (err) {
                    console.error('Official Generation Error:', err);
                }
            });

            editOfficialBtn.addEventListener('click', () => {
                if (!currentOfficialMarkdown) return;
                if (!isEditingOfficial) {
                    isEditingOfficial = true;
                    editOfficialBtn.textContent = '완료';
                    editOfficialBtn.classList.add('bg-green-500', 'text-white');
                    const textarea = document.createElement('textarea');
                    textarea.id = 'official-editor';
                    textarea.className = 'w-full h-48 p-2 border rounded-md font-mono text-sm';
                    textarea.value = currentOfficialMarkdown;
                    generatedOfficialContainer.replaceWith(textarea);
                } else {
                    const textarea = document.getElementById('official-editor');
                    currentOfficialMarkdown = formatOfficialMarkdown(textarea.value);
                    const newDiv = document.createElement('div');
                    newDiv.id = 'generated-official-container';
                    newDiv.className = 'plan-section-content';
                    newDiv.innerHTML = renderOfficialContent(currentOfficialMarkdown);
                    textarea.replaceWith(newDiv);
                    generatedOfficialContainer = newDiv;
                    isEditingOfficial = false;
                    editOfficialBtn.textContent = '편집';
                    editOfficialBtn.classList.remove('bg-green-500', 'text-white');
                    saveCurrentOfficial();
                }
            });

            copyOfficialBtn.addEventListener('click', () => {
                if (!currentOfficialMarkdown && !currentOfficialTitle) return;
                const htmlToCopy = markdownToHtml(`${currentOfficialTitle}\n${currentOfficialMarkdown}`);
                copyToClipboard(htmlToCopy, true);
            });

            editOfficialTitleBtn.addEventListener('click', () => {
                const isEditing = editOfficialTitleBtn.textContent === '완료';
                if (isEditing) {
                    officialTitle.textContent = officialTitleInput.value;
                    officialTitle.classList.remove('hidden');
                    officialTitleInput.classList.add('hidden');
                    editOfficialTitleBtn.textContent = '편집';
                    editOfficialTitleBtn.classList.remove('bg-green-500', 'text-white');
                    currentOfficialTitle = officialTitle.textContent;
                    saveCurrentOfficial();
                } else {
                    officialTitleInput.value = officialTitle.textContent;
                    officialTitle.classList.add('hidden');
                    officialTitleInput.classList.remove('hidden');
                    officialTitleInput.focus();
                    editOfficialTitleBtn.textContent = '완료';
                    editOfficialTitleBtn.classList.add('bg-green-500', 'text-white');
                }
            });

            copyOfficialTitleBtn.addEventListener('click', () => {
                if (!officialTitle.textContent) return;
                copyToClipboard(officialTitle.textContent);
            });

            officialModifyForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!currentOfficialMarkdown && !currentOfficialTitle) return;
                const userPrompt = officialModifyPrompt.value.trim();
                if (!userPrompt) return;
                const currentContent = `${currentOfficialTitle}\n${currentOfficialMarkdown}`;
                const prompt = `다음 기안문을 사용자의 요청에 맞게 수정해줘.\n기안문:\n${currentContent}\n\n요청: ${userPrompt}\n\n수정된 기안문을 동일한 형식(첫 줄은 제목)으로 마크다운으로 출력해줘.`;
                try {
                    const response = await fetch('/.netlify/functions/generatePlan', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt, model: GEMINI_MODEL })
                    });
                    const result = await response.json();
                    if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                        const fullText = extractMarkdownFromText(result.candidates[0].content.parts[0].text);
                        const lines = fullText.split('\n');
                        currentOfficialTitle = lines.shift().trim();
                        currentOfficialMarkdown = formatOfficialMarkdown(lines.join('\n').trim());
                        officialTitle.textContent = currentOfficialTitle;
                        if (isEditingOfficial) {
                            const textarea = document.getElementById('official-editor');
                            textarea.value = currentOfficialMarkdown;
                        } else {
                            generatedOfficialContainer.innerHTML = renderOfficialContent(currentOfficialMarkdown);
                        }
                        saveCurrentOfficial();
                        officialModifyPrompt.value = '';
                    }
                } catch (err) {
                    console.error('Official Modify Error:', err);
                }
            });
        }

        if (letterForm) {
            let letterExamples = '';
            fetch('/letter_examples.txt')
                .then(response => response.text())
                .then(text => { letterExamples = text; });

            letterForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const user = auth.currentUser;
                if (!user) return;
                const topic = letterTopic.value.trim();
                if (!topic) return;
                const prompt = `다음 가정통신문 예시를 참고하여 가정통신문을 마크다운 형식으로 작성해줘.\n예시:\n${letterExamples}\n\n주제: ${topic}\n추가 설명 없이 내용만 출력해.`;
                try {
                    const response = await fetch('/.netlify/functions/generatePlan', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt, model: GEMINI_MODEL })
                    });
                    const result = await response.json();
                    if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                        currentLetterMarkdown = extractMarkdownFromText(result.candidates[0].content.parts[0].text);
                        generatedLetterContainer.innerHTML = parseMarkdown(currentLetterMarkdown);
                        letterOutputSection.classList.remove('hidden');
                        letterModifySection.classList.remove('hidden');
                        letterTopic.value = '';
                        const conciseTitle = await generateConciseTitleFromInput(topic, topic);
                        const docRef = await addDoc(collection(db, "users", user.uid, "letters"), {
                            title: conciseTitle,
                            createdAt: serverTimestamp(),
                            rawContent: currentLetterMarkdown
                        });
                        currentLetterId = docRef.id;
                        loadAndDisplayItems('letters', letterSavedList, viewLetter);
                    }
                } catch (err) {
                    console.error('Letter Generation Error:', err);
                }
            });

            editLetterBtn.addEventListener('click', () => {
                if (!currentLetterMarkdown) return;
                if (!isEditingLetter) {
                    isEditingLetter = true;
                    editLetterBtn.textContent = '완료';
                    editLetterBtn.classList.add('bg-green-500', 'text-white');
                    const textarea = document.createElement('textarea');
                    textarea.id = 'letter-editor';
                    textarea.className = 'w-full h-48 p-2 border rounded-md font-mono text-sm';
                    textarea.value = currentLetterMarkdown;
                    generatedLetterContainer.replaceWith(textarea);
                } else {
                    const textarea = document.getElementById('letter-editor');
                    currentLetterMarkdown = textarea.value;
                    const newDiv = document.createElement('div');
                    newDiv.id = 'generated-letter-container';
                    newDiv.className = 'plan-section-content';
                    newDiv.innerHTML = parseMarkdown(currentLetterMarkdown);
                    textarea.replaceWith(newDiv);
                    generatedLetterContainer = newDiv;
                    isEditingLetter = false;
                    editLetterBtn.textContent = '편집';
                    editLetterBtn.classList.remove('bg-green-500', 'text-white');
                    saveCurrentLetter();
                }
            });

            copyLetterBtn.addEventListener('click', () => {
                if (!currentLetterMarkdown) return;
                const htmlToCopy = currentLetterMarkdown.includes('|') ?
                    markdownTableToHtmlClipboard(currentLetterMarkdown) :
                    markdownToHtml(currentLetterMarkdown);
                copyToClipboard(htmlToCopy, true);
            });

            letterModifyForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!currentLetterMarkdown) return;
                const userPrompt = letterModifyPrompt.value.trim();
                if (!userPrompt) return;
                const prompt = `다음 가정통신문을 사용자의 요청에 맞게 수정해줘.\n내용:\n${currentLetterMarkdown}\n\n요청: ${userPrompt}\n\n수정된 가정통신문을 마크다운 형식으로 출력해줘.`;
                try {
                    const response = await fetch('/.netlify/functions/generatePlan', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt, model: GEMINI_MODEL })
                    });
                    const result = await response.json();
                    if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                        currentLetterMarkdown = extractMarkdownFromText(result.candidates[0].content.parts[0].text);
                        if (isEditingLetter) {
                            const textarea = document.getElementById('letter-editor');
                            textarea.value = currentLetterMarkdown;
                        } else {
                            generatedLetterContainer.innerHTML = parseMarkdown(currentLetterMarkdown);
                        }
                        saveCurrentLetter();
                        letterModifyPrompt.value = '';
                    }
                } catch (err) {
                    console.error('Letter Modify Error:', err);
                }
            });
        }

        // --- FIRESTORE & DATA HANDLING ---
        async function openPlan(planId) {
            const user = auth.currentUser;
            if (!user || !planId) return;
            const docRef = doc(db, "users", user.uid, "plans", planId);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const planToView = docSnap.data();
                switchView('plan');
                displayContent(planToView.rawContent, planToView.title, planToView.summaryContent || null);
                currentPlanId = planId;
                outputPanel.scrollIntoView({ behavior: 'smooth' });
            }
        }

        const loadAndDisplayPlans = async () => {
            const user = auth.currentUser;
            if (!user) return;
            
            const plansCollectionRef = collection(db, "users", user.uid, "plans");
            const q = query(plansCollectionRef);
            
            try {
                const querySnapshot = await getDocs(q);
                const plans = [];
                querySnapshot.forEach((doc) => {
                    plans.push({ id: doc.id, ...doc.data() });
                });

                plans.sort((a, b) => (b.createdAt?.toMillis?.() || b.createdAt?.seconds || 0) - (a.createdAt?.toMillis?.() || a.createdAt?.seconds || 0));
                const populateList = (container, planList) => {
                    if (!container) return;
                    container.innerHTML = '';
                    if (!planList || planList.length === 0) {
                        container.innerHTML = `<p class="text-gray-500 text-center py-4">아직 생성된 계획서가 없습니다.</p>`;
                        return;
                    }
                    planList.forEach((plan) => {
                        const planElement = document.createElement('div');
                        planElement.className = 'p-4 border rounded-md hover:bg-gray-50 transition-colors flex justify-between items-center cursor-pointer';

                        const infoWrapper = document.createElement('div');
                        const titleEl = document.createElement('p');
                        titleEl.className = 'font-semibold';
                        titleEl.textContent = plan.title || '제목 없음';
                        const dateEl = document.createElement('p');
                        dateEl.className = 'text-sm text-gray-500';
                        dateEl.textContent = `생성일: ${formatDateTime(plan.createdAt, false)}`;
                        infoWrapper.appendChild(titleEl);
                        infoWrapper.appendChild(dateEl);

                        const actionsWrapper = document.createElement('div');
                        actionsWrapper.className = 'flex items-center gap-2';

                        const renameBtn = document.createElement('button');
                        renameBtn.className = 'rename-plan-btn text-sm font-medium text-green-600 hover:underline';
                        renameBtn.textContent = '수정';
                        renameBtn.addEventListener('click', async (e) => {
                            e.stopPropagation();
                            const user = auth.currentUser;
                            if (!user) return;
                            const targetPlan = plans.find(p => p.id === plan.id);
                            const newName = prompt('새 이름을 입력하세요', targetPlan?.title || '');
                            if (newName && newName.trim()) {
                                await updateDoc(doc(db, "users", user.uid, "plans", plan.id), { title: newName.trim() });
                                loadAndDisplayPlans();
                            }
                        });

                        const copyBtn = document.createElement('button');
                        copyBtn.className = 'copy-plan-btn text-sm font-medium text-purple-600 hover:underline';
                        copyBtn.textContent = '복사';
                        copyBtn.addEventListener('click', async (e) => {
                            e.stopPropagation();
                            const user = auth.currentUser;
                            if (!user) return;
                            const planData = plans.find(p => p.id === plan.id);
                            if (!planData) return;
                            const baseTitle = (planData.title || '계획서').replace(/\(복사본\d+\)$/,'');
                            let maxCopy = 0;
                            plans.forEach(p => {
                                const match = (p.title || '').match(new RegExp(`^${baseTitle}\\(복사본(\\d+)\\)$`));
                                if (match) maxCopy = Math.max(maxCopy, parseInt(match[1]));
                            });
                            const newTitle = `${baseTitle}(복사본${maxCopy + 1})`;
                            const { id: _id, createdAt: _createdAt, ...rest } = planData;
                            await addDoc(collection(db, "users", user.uid, "plans"), {
                                ...rest,
                                title: newTitle,
                                createdAt: serverTimestamp(),
                            });
                            loadAndDisplayPlans();
                        });

                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'delete-plan-btn text-sm font-medium text-red-600 hover:underline';
                        deleteBtn.textContent = '삭제';
                        deleteBtn.addEventListener('click', async (e) => {
                            e.stopPropagation();
                            const user = auth.currentUser;
                            if (!user) return;
                            try {
                                deleteBtn.disabled = true;
                                await deleteDoc(doc(db, "users", user.uid, "plans", plan.id));
                                loadAndDisplayPlans();
                            } catch (error) {
                                console.error("Error deleting plan:", error);
                            }
                        });

                        actionsWrapper.appendChild(renameBtn);
                        actionsWrapper.appendChild(copyBtn);
                        actionsWrapper.appendChild(deleteBtn);

                        planElement.appendChild(infoWrapper);
                        planElement.appendChild(actionsWrapper);
                        planElement.addEventListener('click', () => openPlan(plan.id));

                        container.appendChild(planElement);
                    });
                };

                const filterPlansByTerm = (term) => {
                    const normalized = (term || '').trim().toLowerCase();
                    if (!normalized) return plans;
                    return plans.filter(plan => (plan.title || '').toLowerCase().includes(normalized));
                };

                const recentTerm = recentPlanSearchInput?.value || '';
                const planTerm = planSearchInput?.value || '';
                const filteredPlans = filterPlansByTerm(planTerm);
                const recentPlans = filterPlansByTerm(recentTerm);
                const recentDisplayPlans = recentTerm.trim() ? recentPlans : plans.slice(0, 5);

                populateList(recentPlansList, recentDisplayPlans);
                if (planSavedList) {
                    populateList(planSavedList, filteredPlans);
                }
            } catch (error) {
                console.error("Error loading plans:", error);
                recentPlansList.innerHTML = `<p class="text-red-500 text-center py-4">계획서를 불러오는 중 오류가 발생했습니다.</p>`;
                if (planSavedList) planSavedList.innerHTML = `<p class="text-red-500 text-center py-4">계획서를 불러오는 중 오류가 발생했습니다.</p>`;
            }
        };

        const loadAndDisplayItems = async (type, container, viewHandler) => {
            const user = auth.currentUser;
            if (!user || !container) return;
            const colRef = collection(db, "users", user.uid, type);
            const q = query(colRef);
            try {
                const snap = await getDocs(q);
                const items = [];
                snap.forEach((doc) => items.push({ id: doc.id, ...doc.data() }));
                items.sort((a, b) => (b.createdAt?.toMillis?.() || b.createdAt?.seconds || 0) - (a.createdAt?.toMillis?.() || a.createdAt?.seconds || 0));

                if (type === 'tables') setHomeListData('tables', items);
                if (type === 'officials') setHomeListData('officials', items);
                if (type === 'letters') setHomeListData('letters', items);

                container.innerHTML = '';
                if (items.length === 0) {
                    container.innerHTML = `<p class="text-gray-500 text-center py-4">저장된 항목이 없습니다.</p>`;
                    return;
                }

                const searchInput = type === 'tables' ? tableSearchInput : type === 'officials' ? officialSearchInput : type === 'letters' ? letterSearchInput : null;
                const searchTerm = (searchInput?.value || '').trim().toLowerCase();
                const displayItems = searchTerm
                    ? items
                        .filter(item => (item.title || '').toLowerCase().includes(searchTerm))
                        .sort((a, b) => (a.createdAt?.toMillis?.() || a.createdAt?.seconds || 0) - (b.createdAt?.toMillis?.() || b.createdAt?.seconds || 0))
                    : items;

                if (displayItems.length === 0) {
                    container.innerHTML = `<p class="text-gray-500 text-center py-4">검색 결과가 없습니다.</p>`;
                    return;
                }

                displayItems.forEach(item => {
                    const el = document.createElement('div');
                    el.className = 'p-4 border rounded-md hover:bg-gray-50 transition-colors flex justify-between items-center cursor-pointer';

                    const info = document.createElement('div');
                    const titleEl = document.createElement('p');
                    titleEl.className = 'font-semibold';
                    titleEl.textContent = item.title || '제목 없음';
                    const dateEl = document.createElement('p');
                    dateEl.className = 'text-sm text-gray-500';
                    dateEl.textContent = `생성일: ${item.createdAt ? formatDateTime(item.createdAt, false) : '날짜 없음'}`;
                    info.appendChild(titleEl);
                    info.appendChild(dateEl);

                    const actions = document.createElement('div');
                    actions.className = 'flex items-center gap-2';

                    const renameBtn = document.createElement('button');
                    renameBtn.className = 'text-sm font-medium text-green-600 hover:underline';
                    renameBtn.textContent = '수정';
                    renameBtn.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        const id = item.id;
                        const user = auth.currentUser;
                        if (!user) return;
                        const target = items.find(i => i.id === id);
                        const newName = prompt('새 이름을 입력하세요', target?.title || '');
                        if (newName && newName.trim()) {
                            await updateDoc(doc(db, "users", user.uid, type, id), { title: newName.trim() });
                            loadAndDisplayItems(type, container, viewHandler);
                        }
                    });

                    const copyBtn = document.createElement('button');
                    copyBtn.className = 'text-sm font-medium text-purple-600 hover:underline';
                    copyBtn.textContent = '복사';
                    copyBtn.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        const id = item.id;
                        const user = auth.currentUser;
                        if (!user) return;
                        const target = items.find(i => i.id === id);
                        if (!target) return;
                        const baseTitle = (target.title || '').replace(/\(복사본\d+\)$/,'');
                        let maxCopy = 0;
                        items.forEach(i => {
                            const match = (i.title || '').match(new RegExp(`^${baseTitle}\\(복사본(\\d+)\\)$`));
                            if (match) maxCopy = Math.max(maxCopy, parseInt(match[1]));
                        });
                        const newTitle = `${baseTitle || '항목'}(복사본${maxCopy + 1})`;
                        const { id: _id, createdAt: _createdAt, ...rest } = target;
                        await addDoc(collection(db, "users", user.uid, type), {
                            ...rest,
                            title: newTitle,
                            createdAt: serverTimestamp(),
                        });
                        loadAndDisplayItems(type, container, viewHandler);
                    });

                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'text-sm font-medium text-red-600 hover:underline';
                    deleteBtn.textContent = '삭제';
                    deleteBtn.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        const id = item.id;
                        const user = auth.currentUser;
                        if (!user) return;
                        await deleteDoc(doc(db, "users", user.uid, type, id));
                        loadAndDisplayItems(type, container, viewHandler);
                    });

                    actions.appendChild(renameBtn);
                    actions.appendChild(copyBtn);
                    actions.appendChild(deleteBtn);

                    el.appendChild(info);
                    el.appendChild(actions);
                    el.addEventListener('click', () => viewHandler(item.id));

                    container.appendChild(el);
                });
            } catch (err) {
                console.error(`Error loading ${type}:`, err);
                container.innerHTML = `<p class="text-red-500 text-center py-4">목록을 불러오지 못했습니다.</p>`;
            }
        };

        async function viewTable(id) {
            const user = auth.currentUser;
            if (!user) return;
            const docRef = doc(db, "users", user.uid, "tables", id);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                switchView('table');
                currentTableId = id;
                currentTableMarkdown = data.rawContent;
                generatedTableContainer.innerHTML = renderMarkdownTable(currentTableMarkdown);
                tableOutputSection.classList.remove('hidden');
                tableModifySection.classList.remove('hidden');
            }
        }

        async function viewOfficial(id) {
            const user = auth.currentUser;
            if (!user) return;
            const docRef = doc(db, "users", user.uid, "officials", id);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                switchView('official');
                currentOfficialId = id;
                currentOfficialTitle = data.title;
                currentOfficialMarkdown = formatOfficialMarkdown(data.rawContent || '');
                officialTitle.textContent = currentOfficialTitle;
                generatedOfficialContainer.innerHTML = renderOfficialContent(currentOfficialMarkdown);
                officialOutputSection.classList.remove('hidden');
                officialModifySection.classList.remove('hidden');
            }
        }

        async function viewLetter(id) {
            const user = auth.currentUser;
            if (!user) return;
            const docRef = doc(db, "users", user.uid, "letters", id);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                switchView('letter');
                currentLetterId = id;
                currentLetterMarkdown = data.rawContent;
                generatedLetterContainer.innerHTML = parseMarkdown(currentLetterMarkdown);
                letterOutputSection.classList.remove('hidden');
                letterModifySection.classList.remove('hidden');
            }
        }

        // --- GENERATOR LOGIC ---
        
        schoolLevelButtons.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                schoolLevelButtons.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
            }
        });

        outlineButtons.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                outlineButtons.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                if (e.target.dataset.value === '세부목차') {
                    currentOutline = [...planOutlineDefinitions["세부목차"]];
                } else {
                    currentOutline = [...planOutlineDefinitions["기본목차"]];
                }
                updateOutlineDescription();
            }
        });

        categoryButtons.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                categoryButtons.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                planCategoryInput.value = e.target.dataset.value;
                updateCategoryDescription();
            }
        });

        addKeywordBtn.addEventListener('click', () => {
            const container = document.createElement('div');
            container.className = 'flex items-center gap-2';
            container.innerHTML = `
                <input type="text" name="keywords" class="keyword-input block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 sm:text-sm" placeholder="추가 키워드">
                <button type="button" class="remove-keyword-btn text-red-500 hover:text-red-700">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 12H6"></path></svg>
                </button>
            `;
            keywordsContainer.appendChild(container);
        });

        keywordsContainer.addEventListener('click', (e) => {
            if (e.target.closest('.remove-keyword-btn')) {
                e.target.closest('.flex').remove();
            }
        });

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            if (!user) return;
            
            formError.classList.add('hidden');

            const planType = customPlanTypeInput.value.trim();
            if (!planType) {
                formError.textContent = '계획서 주제를 입력해주세요.';
                formError.classList.remove('hidden');
                return;
            }
            
            const keywords = [...document.querySelectorAll('.keyword-input')]
                                .map(input => input.value.trim())
                                .filter(Boolean);
            const currentYear = new Date().getFullYear();
            const activeSchool = schoolLevelButtons.querySelector('.active');
            const schoolLevel = activeSchool ? activeSchool.dataset.value : '';

            initialMessage.classList.add('hidden');
            resultSection.classList.add('hidden');
            errorMessageDiv.classList.add('hidden');
            loadingIndicator.style.display = 'flex';
            generateBtn.disabled = true;
            generateBtn.innerHTML = `<div class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div><span class="ml-2">생성 중...</span>`;
            showToast('생성 중입니다..');

            try {
                let prompt = '';
                const outline = currentOutline;
                const category = planCategoryInput.value;
                const focusInstruction = categoryFocus[category] || '';
                prompt = `당신은 대한민국의 유능한 교사입니다. 다음 조건에 맞춰 '${schoolLevel} ${planType}' 초안을 작성해 주세요.\n\n`;
                if (focusInstruction) {
                    prompt += `- 분류: ${category}. ${focusInstruction}\n\n`;
                }
                if (exampleFiles.length) {
                    prompt += `다음 예시 자료의 문법과 내용을 참고하여 작성해 주세요.\\n`;
                    exampleFiles.forEach((file, idx) => {
                        prompt += `예시 ${idx + 1} (${file.name}):\\n${file.text}\\n\\n`;
                    });
                }
                prompt += `**출력 형식:**\n`;
                prompt += `- 전체 계획서의 제목은 'TITLE: [${currentYear+1}학년도 ${planType}]'과 같이 간결한 형식으로 첫 줄에 명시해 주세요.\n`;
                prompt += `- 내용은 반드시 다음 ${outline.length}개의 섹션으로 나누어 작성하고, 각 섹션 제목은 '## 1. ${outline[0].title}'과 같이 '##' 마크다운 헤더를 사용해야 합니다.\n`;
                prompt += `- 섹션 순서: ${outline.map((s, i) => `${i+1}. ${s.title}`).join(', ')}\n\n`;
                prompt += `**섹션별 작성 조건:**\n`;
                outline.forEach((sec, idx) => {
                    switch (sec.type) {
                        case 'bullet':
                            if (sec.title.includes('추진 배경')) {
                                prompt += `${idx + 1}.  **${sec.title}**: 불릿 리스트(-) 형식으로 작성하되, 최소 4개 이상의 항목을 포함하고, 각 항목은 주제나 항목명을 쓰지 말고 바로 내용을 시작하여 문장이 아닌 명사형 표현으로 '~요구', '~필요', '~증대', '~심화', '~대두' 등으로 끝나게 작성하세요.\\n`;
                            } else if (sec.title.includes('추진 목적')) {
                                prompt += `${idx + 1}.  **${sec.title}**: 불릿 리스트(-) 형식으로 작성하되, 최소 4개 이상의 항목을 포함하고, 각 항목은 주제나 항목명을 쓰지 말고 바로 내용을 시작하여 '~실현', '~지원', '~구현', '~확대', '~강화' 등과 같은 명사형 표현으로 끝나게 작성하세요.\\n`;
                            } else if (sec.title.includes('기대효과') || sec.title.includes('기대 효과')) {
                                prompt += `${idx + 1}.  **${sec.title}**: 불릿 리스트(-) 형식으로 작성하되, 아래 문장을 참고하여 교육적 기대 효과를 구체적으로 작성하고, 각 항목은 '~확대', '~강화', '~도모', '~증대' 등과 같은 명사형 표현으로 끝나게 하세요. 참고 문장: 창의력 사고력을 함양한다.; 배움 중심의 학습 문화를 확산한다.; 학교 내 소통과 협력 문화를 조성한다.; 학생 맞춤형 교육 기회를 마련한다.; 교사와 학생 간 상호작용을 활성화한다.; 교사의 전문성을 강화하여 교육력을 제고한다.; 교사와 학생의 업무 피로도를 감소시킨다.; 학교 폭력 및 갈등 요인을 근절한다.; 학부모와 학생의 만족도를 제고한다.\\n`;
                            } else if (sec.title.includes('방향')) {
                                prompt += `${idx + 1}.  **${sec.title}**: 불릿 리스트(-) 형식으로 작성하되, 최소 4개 이상의 항목을 포함하고, 각 항목은 주제나 항목명을 쓰지 말고 바로 내용을 시작하여 '~정립', '~마련', '~추진', '~강화' 등과 같은 명사형 표현으로 끝나게 작성하세요.\\n`;
                            } else if (sec.title.includes('방침')) {
                                prompt += `${idx + 1}.  **${sec.title}**: 불릿 리스트(-) 형식으로 작성하되, 최소 4개 이상의 항목을 포함하고, 각 항목은 주제나 항목명을 쓰지 말고 바로 내용을 시작하여 '~운영', '~구성', '~실시', '~지원' 등과 같은 명사형 표현으로 끝나게 작성하세요.\\n`;
                            } else if (sec.title.includes('근거')) {
                                prompt += `${idx + 1}.  **${sec.title}**: 불릿 리스트(-) 형식으로 작성하되, 각 항목은 관련 법령·계획·조례 등의 제목과 문서 번호, 시행일 등을 괄호 안에 명시한 참고 문헌 형태로 작성하세요. 예시: - (변경)스마트기기 휴대 학습 「디벗 확대 계획」(중등교육과-13191, 2023. 3. 27.)\\n`;
                            } else {
                                prompt += `${idx + 1}.  **${sec.title}**: 불릿 리스트(-) 형식으로 작성하되, 최소 4개 이상의 항목을 포함하고, 각 항목은 '~한다.'로 끝나는 명료한 문장으로 작성하며 두 가지 이상 세부 내용을 포함하세요.\\n`;
                            }
                            break;
                        case 'tablePlan':
                            if (sec.title.includes('세부 추진 계획')) {
                                prompt += `${idx + 1}.  **${sec.title}**: 이 항목의 내용은 작성하지 말고 섹션 제목만 출력하세요.\\n`;
                            } else {
                                prompt += `${idx + 1}.  **${sec.title}**: 추진 과제를 번호 매긴 뒤 각 과제 아래에 '□ 추진업무', '○ 추진 방법', '○ 기관', '○ 기간(일정)', '○ 장소', '○ 수량/예산' 항목을 불릿으로 작성하고, 이어서 '추진 과제', '추진업무', '추진 방법', '기관', '기간', '장소', '수량/예산' 열을 포함한 Markdown 테이블을 추가하세요.\\n`;
                            }
                            break;
                        case 'tableBudget':
                            prompt += `${idx + 1}.  **${sec.title}**: 예산 편성 방향을 짧게 서술하고, 이어서 '순', '사업명', '항목', '산출내역(원)', '예산액(천원)', '비고'를 포함한 Markdown 테이블을 제공하세요. '산출내역(원)'은 '200,000원 × 1대 × 1회'와 같이 곱셈 식으로 작성하세요.\\n`;
                            break;
                        case 'tableSchedule':
                            prompt += `${idx + 1}.  **${sec.title}**: 관련 내용을 간단히 설명하고, '월', '장소', '일시', '대상', '프로그램' 항목을 포함한 Markdown 테이블을 추가하세요. '프로그램' 항목은 각 프로그램의 명칭과 간단한 설명을 포함한 불릿 리스트(-) 형식으로 작성하고 최소 4개 이상의 항목을 포함하세요.\\n`;
                            break;
                        default:
                            prompt += `${idx + 1}.  **${sec.title}**: 계획의 핵심 내용을 구체적으로 서술하세요.\\n`;
                    }
                });
                prompt += `- **핵심 키워드**: '${keywords.join(', ')}'를 계획서 전반에 자연스럽게 반영해주세요.\\n`;
                prompt += `- 모든 불릿 리스트는 최소 4개 이상의 항목을 포함해야 합니다.\\n`;
                prompt += `- '추진 배경', '추진 목적', '기대효과', '추진 방향', '추진 방침' 항목은 문장이 아닌 명사형 표현으로 작성하고, 그 밖의 항목은 공손한 표현을 사용하지 말고 모두 '~한다.'로 끝나는 서술형으로 작성하세요.\\n`;
                prompt += `- **중요**: 생성하는 모든 텍스트에서 마크다운 굵은 글씨(**)를 사용하지 마세요. 모든 내용은 일반 텍스트로만 작성해주세요.`;

                const apiUrl = `/.netlify/functions/generatePlan`;
                
                const response = await fetch(apiUrl, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ prompt: prompt, model: GEMINI_MODEL })
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error?.message || `API 요청 실패: ${response.status}`);
                }
                const result = await response.json();
                
                if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                    const rawText = result.candidates[0].content.parts[0].text;
                    displayContent(rawText, planType);
                    
                    const docRef = await addDoc(collection(db, "users", user.uid, "plans"), {
                        title: planTitle.textContent,
                        planType: planType,
                        createdAt: serverTimestamp(),
                        rawContent: rawText
                    });
                    currentPlanId = docRef.id;
                    loadAndDisplayPlans(); // Refresh recent plans list
                    outputPanel.scrollIntoView({ behavior: 'smooth' });
                } else if (result.candidates?.[0]?.finishReason) {
                     throw new Error(`생성이 중단되었습니다. 이유: ${result.candidates[0].finishReason}. 다른 키워드를 사용해 보세요.`);
                }
                else {
                    throw new Error('AI로부터 유효한 응답을 받지 못했습니다.');
                }
            } catch (error) {
                console.error("Generation/Saving Error:", error);
                errorMessageDiv.classList.remove('hidden');
                errorDetails.textContent = `오류가 발생했습니다: ${error.message}. Google Cloud 프로젝트에서 'Generative Language API'가 활성화되었는지 확인해주세요.`;
            } finally {
                loadingIndicator.style.display = 'none';
                generateBtn.disabled = false;
                generateBtn.innerHTML = `<span>AI 운영계획서 생성</span>`;
            }
        });

        function displayContent(rawText, defaultPlanType, summaryMarkdown = null) {
            let content = rawText;

            const titleMatch = content.match(/^TITLE:\s*(.*)/m);
            const mainTitle = titleMatch && titleMatch[1] ? titleMatch[1].trim() : defaultPlanType;
            if (titleMatch) {
                content = content.substring(titleMatch[0].length).trim();
            }
            planTitle.textContent = mainTitle;

            currentPlanSummaryMarkdown = summaryMarkdown || null;
            if (summaryPopupWindow && !summaryPopupWindow.closed) {
                summaryPopupWindow.close();
            }
            summaryPopupWindow = null;
            isSummaryGenerating = false;

            planContainer.innerHTML = '';

            const sections = content.split(/^##\s/m).filter(s => s.trim() !== '');
            const sectionTitles = [];

            sections.forEach(sectionText => {
                const lines = sectionText.trim().split('\n');
                const sectionTitle = lines.shift().trim();
                sectionTitles.push(sectionTitle);
                let sectionContentMarkdown = lines.join('\n').trim();
                sectionContentMarkdown = sectionContentMarkdown
                    .replace(/합니다\./gm, '한다.')
                    .replace(/합니다$/gm, '한다')
                    .replace(/함\./gm, '한다.')
                    .replace(/함$/gm, '한다');

                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'plan-section';

                const titleEl = document.createElement('h3');
                titleEl.textContent = sectionTitle;

                const contentDiv = document.createElement('div');
                contentDiv.className = 'plan-section-content';

                if (sectionTitle.includes('세부 추진 계획')) {
                    if (sectionContentMarkdown) {
                        sectionDiv.dataset.markdownContent = sectionContentMarkdown;
                        renderSectionContent(contentDiv, sectionContentMarkdown, { isDetail: true });

                        const controlsDiv = document.createElement('div');
                        controlsDiv.className = 'absolute top-4 right-4 flex gap-2';

                        const regenBtn = document.createElement('button');
                        regenBtn.className = 'regenerate-detail-btn';
                        regenBtn.textContent = '재생성';

                        const expandBtn = document.createElement('button');
                        expandBtn.className = 'expand-btn';
                        expandBtn.textContent = '내용 늘리기';

                        const detailBtn = document.createElement('button');
                        detailBtn.className = 'detail-btn';
                        detailBtn.textContent = '자세하게';

                        const editBtn = document.createElement('button');
                        editBtn.className = 'edit-btn';
                        editBtn.textContent = '편집';

                        const copyBtn = document.createElement('button');
                        copyBtn.className = 'copy-section-btn';
                        copyBtn.textContent = '복사';

                        controlsDiv.appendChild(regenBtn);
                        controlsDiv.appendChild(expandBtn);
                        controlsDiv.appendChild(detailBtn);
                        controlsDiv.appendChild(editBtn);
                        controlsDiv.appendChild(copyBtn);

                        sectionDiv.appendChild(controlsDiv);
                    } else {
                        sectionDiv.dataset.markdownContent = '';
                        const generateBtn = document.createElement('button');
                        generateBtn.className = 'generate-detail-btn';
                        generateBtn.textContent = '생성';
                        contentDiv.appendChild(generateBtn);
                    }
                } else {
                    sectionDiv.dataset.markdownContent = sectionContentMarkdown;
                    renderSectionContent(contentDiv, sectionContentMarkdown);

                    const controlsDiv = document.createElement('div');
                    controlsDiv.className = 'absolute top-4 right-4 flex gap-2';

                    if (sectionTitle.includes('추진 목적') || sectionTitle.includes('기대효과')) {
                        const regenBtn = document.createElement('button');
                        regenBtn.className = 'regenerate-section-btn';
                        regenBtn.textContent = '재생성';
                        controlsDiv.appendChild(regenBtn);
                    }

                    const expandBtn = document.createElement('button');
                    expandBtn.className = 'expand-btn';
                    expandBtn.textContent = '내용 늘리기';

                    const detailBtn = document.createElement('button');
                    detailBtn.className = 'detail-btn';
                    detailBtn.textContent = '자세하게';

                    const editBtn = document.createElement('button');
                    editBtn.className = 'edit-btn';
                    editBtn.textContent = '편집';

                    const copyBtn = document.createElement('button');
                    copyBtn.className = 'copy-section-btn';
                    copyBtn.textContent = '복사';

                    controlsDiv.appendChild(expandBtn);
                    controlsDiv.appendChild(detailBtn);
                    controlsDiv.appendChild(editBtn);
                    controlsDiv.appendChild(copyBtn);

                    sectionDiv.appendChild(controlsDiv);
                }

                sectionDiv.appendChild(titleEl);
                sectionDiv.appendChild(contentDiv);
                planContainer.appendChild(sectionDiv);
            });

            if (planModifyTarget) {
                planModifyTarget.innerHTML = '<option value="전체">전체</option>';
                sectionTitles.forEach(title => {
                    const opt = document.createElement('option');
                    opt.value = title;
                    opt.textContent = title;
                    planModifyTarget.appendChild(opt);
                });
                const detailOption = Array.from(planModifyTarget.options).find(opt => opt.value.includes('세부 추진 계획'));
                if (detailOption) {
                    planModifyTarget.value = detailOption.value;
                }
            }

            loadingIndicator.style.display = 'none';
            resultSection.classList.remove('hidden');
            if (planModifySection) planModifySection.classList.remove('hidden');
        }

        function ensureBulletNewlines(text) {
            return text.replace(/([^\n])○/g, '$1\n○');
        }

        function extractBulletItems(markdown) {
            const lines = (markdown || '').split('\n');
            const items = [];
            let current = null;
            lines.forEach(rawLine => {
                const line = rawLine.trim();
                if (!line) return;
                if (/^[-*]\s+/.test(line)) {
                    if (current) items.push(current);
                    current = line.replace(/^[-*]\s+/, '').trim();
                } else if (/^[○●◦]\s*/.test(line)) {
                    if (current) items.push(current);
                    current = line.replace(/^[○●◦]\s*/, '').trim();
                } else if (!line.startsWith('|')) {
                    if (current) {
                        current += ' ' + line;
                    } else {
                        current = line;
                    }
                }
            });
            if (current) items.push(current);
            return items;
        }

        function normalizeBulletList(markdown, { desiredCount = null, referenceItems = [], referenceSuffix = '' } = {}) {
            let items = extractBulletItems(markdown);
            if (!items.length && markdown && markdown.trim()) {
                items = markdown.split('\n').map(line => line.trim()).filter(Boolean);
            }
            const cleanReference = referenceItems.filter(item => item && item.trim()).map(item => item.trim());
            if (desiredCount !== null) {
                items = items.slice(0, desiredCount);
                while (items.length < desiredCount) {
                    const ref = cleanReference[items.length] || cleanReference[cleanReference.length - 1] || '';
                    if (ref) {
                        items.push(referenceSuffix ? `${ref}${referenceSuffix}` : ref);
                    } else if (items.length) {
                        items.push(items[items.length - 1]);
                    } else {
                        items.push('추가 항목');
                    }
                }
            }
            if (!items.length && cleanReference.length) {
                items = cleanReference.map(ref => referenceSuffix ? `${ref}${referenceSuffix}` : ref);
            }
            return items
                .map(item => item.replace(/^[-*]\s+/, '').replace(/^[○●◦]\s*/, '').trim())
                .filter(Boolean)
                .map(item => `- ${item}`)
                .join('\n');
        }

        function escapeHtml(text = '') {
            return text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function formatReferenceDate(value = '') {
            const trimmed = (value || '').trim();
            if (!trimmed) return '';
            const dateMatch = trimmed.match(/(\d{4})\D*(\d{1,2})\D*(\d{1,2})/);
            if (dateMatch) {
                const year = dateMatch[1];
                const monthNum = parseInt(dateMatch[2], 10);
                const dayNum = parseInt(dateMatch[3], 10);
                if (!Number.isNaN(monthNum) && !Number.isNaN(dayNum)) {
                    return `${year}.${monthNum}.${dayNum}.`;
                }
            }
            return trimmed;
        }

        function formatOfficialMarkdown(markdown = '') {
            const lines = (markdown || '').split('\n');
            const formatted = [];
            let numbering = 1;
            let insideAttachments = false;
            lines.forEach((line) => {
                const indentMatch = line.match(/^\s*/);
                const indent = indentMatch ? indentMatch[0] : '';
                let trimmed = line.trim();
                if (!trimmed) {
                    formatted.push('');
                    return;
                }

                const handleEndLine = () => {
                    if (insideAttachments && formatted.length) {
                        const lastIdx = formatted.length - 1;
                        const lastLine = formatted[lastIdx];
                        if (/^\s*붙임\s{2}/.test(lastLine) && !/끝\.$/.test(lastLine)) {
                            formatted[lastIdx] = `${lastLine}  끝.`.trimEnd();
                            insideAttachments = false;
                            return;
                        }
                    }
                    formatted.push(`${indent}끝.`.trimEnd());
                    insideAttachments = false;
                };

                if (/^붙임/.test(trimmed)) {
                    let rest = trimmed.replace(/^붙임\s*[:\-]?\s*/, '');
                    const hasEnding = /끝\.$/.test(rest);
                    if (hasEnding) {
                        rest = rest.replace(/끝\.$/, '').trimEnd();
                    }
                    const baseLine = rest ? `${indent}붙임  ${rest}` : `${indent}붙임  `;
                    if (hasEnding) {
                        formatted.push(`${baseLine}  끝.`.trimEnd());
                        insideAttachments = false;
                    } else {
                        formatted.push(baseLine.trimEnd());
                        insideAttachments = true;
                    }
                    return;
                }

                if (/^끝\.?$/.test(trimmed)) {
                    handleEndLine();
                    return;
                }

                if (!insideAttachments && /^[○●◦◯•]/.test(trimmed)) {
                    const content = trimmed.replace(/^[○●◦◯•]\s*/, '').trim();
                    formatted.push(`${indent}${numbering}. ${content}`.trimEnd());
                    numbering += 1;
                    return;
                }

                if (!insideAttachments && /^[-*]\s+/.test(trimmed)) {
                    const content = trimmed.replace(/^[-*]\s+/, '').trim();
                    formatted.push(`${indent}${numbering}. ${content}`.trimEnd());
                    numbering += 1;
                    return;
                }

                if (!insideAttachments) {
                    const numberMatch = trimmed.match(/^(\d+)\.\s*/);
                    if (numberMatch) {
                        numbering = parseInt(numberMatch[1], 10) + 1;
                        let content = trimmed.slice(numberMatch[0].length).trimStart();
                        if (numberMatch[1] === '1' && /^관련\s*:/.test(content)) {
                            content = content.replace(/\(([^)]*?)\)/, (match, inner) => {
                                const formattedDate = formatReferenceDate(inner);
                                return formattedDate ? `(${formattedDate})` : match;
                            });
                        }
                        formatted.push(`${indent}${numberMatch[1]}. ${content}`.trimEnd());
                        return;
                    }
                }

                formatted.push(`${indent}${trimmed}`.trimEnd());
            });

            while (formatted.length > 1 && formatted[formatted.length - 1] === '' && formatted[formatted.length - 2] === '') {
                formatted.pop();
            }

            return formatted.join('\n').replace(/[\s\u00a0]+$/, '');
        }

        function renderOfficialContent(markdown = '') {
            const plainText = ensureBulletNewlines(markdown.replace(/\*\*(.*?)\*\*/g, '$1'));
            const lines = plainText.split('\n');
            const htmlLines = lines.map(line => {
                if (!line) return '';
                const leadingSpacesMatch = line.match(/^\s+/);
                let content = line;
                let prefix = '';
                if (leadingSpacesMatch) {
                    const leadingSpaces = leadingSpacesMatch[0];
                    prefix = leadingSpaces
                        .replace(/ /g, '&nbsp;')
                        .replace(/\t/g, '&nbsp;&nbsp;&nbsp;&nbsp;');
                    content = line.slice(leadingSpaces.length);
                }
                let htmlContent = escapeHtml(content);
                if (/^붙임\s{2}/.test(content)) {
                    htmlContent = htmlContent.replace(/^붙임\s{2}/, '붙임&nbsp;&nbsp;');
                }
                return prefix + htmlContent;
            });
            return `<div class="official-plain-text">${htmlLines.join('<br>')}</div>`;
        }

        function parseMarkdown(markdown) {
            const plainMarkdown = ensureBulletNewlines(markdown.replace(/\*\*(.*?)\*\*/g, '$1'));
            return marked.parse(plainMarkdown);
        }

        function markdownToHtml(markdown) {
            const plainMarkdown = ensureBulletNewlines(markdown.replace(/\*\*(.*?)\*\*/g, '$1'));
            return marked.parse(plainMarkdown);
        }

        function renderMarkdownTable(markdown) {
            return marked.parse(ensureBulletNewlines(markdown));
        }

        function renderSectionContent(container, markdown, options = {}) {
            if (!container) return;
            const { isDetail = false } = options;
            container.classList.add('plan-section-content');
            if (isDetail) {
                container.classList.add('raw-markdown');
                container.textContent = markdown || '';
            } else {
                container.classList.remove('raw-markdown');
                container.innerHTML = parseMarkdown(markdown || '');
                addTableCopyButtons(container);
            }
        }

        function markdownTableToHtmlClipboard(markdown) {
            const text = ensureBulletNewlines(markdown);
            const rows = text
                .trim()
                .split('\n')
                .map(row => row.split('|').slice(1, -1).map(cell => cell.trim()));
             if (rows.length < 2) return text;

            const header = rows[0];
            const body = rows.slice(2);

            let tableHtml = '<table style="border-collapse: collapse; width: 100%; border: 1px solid black;">';
            tableHtml += '<thead><tr>';
            header.forEach(h => tableHtml += `<th style="border: 1px solid black; padding: 8px; background-color: #f2f2f2; text-align: center;">${h}</th>`);
            tableHtml += '</tr></thead><tbody>';
            body.forEach(row => {
                tableHtml += '<tr>';
                for (let i = 0; i < header.length; i++) {
                    tableHtml += `<td style="border: 1px solid black; padding: 8px;">${markdownToHtml(row[i] || '')}</td>`;
                }
                tableHtml += '</tr>';
            });
            tableHtml += '</tbody></table>';
            return tableHtml;
        }

        function htmlTableToHtmlClipboard(table) {
            const clone = table.cloneNode(true);
            clone.style.borderCollapse = 'collapse';
            clone.style.width = '100%';
            clone.style.border = '1px solid black';
            clone.querySelectorAll('th').forEach(th => {
                th.style.border = '1px solid black';
                th.style.padding = '8px';
                th.style.backgroundColor = '#f2f2f2';
                th.style.textAlign = 'center';
            });
            clone.querySelectorAll('td').forEach(td => {
                td.style.border = '1px solid black';
                td.style.padding = '8px';
            });
            return clone.outerHTML;
        }

        function removeBudgetInfo(markdown) {
            const rows = markdown.split('\n');
            if (rows[0] && rows[0].includes('|')) {
                const headers = rows[0].split('|').map(h => h.trim());
                const budgetIdx = headers.findIndex(h => h.includes('예산'));
                if (budgetIdx > -1) {
                    return rows.map(row => {
                        const cells = row.split('|');
                        const startOffset = cells[0].trim() === '' ? 1 : 0;
                        const idx = budgetIdx + startOffset;
                        if (cells[idx] !== undefined) cells.splice(idx, 1);
                        return cells.join('|');
                    }).filter(line => line.replace(/\|/g, '').trim() !== '').join('\n');
                }
            }
            return rows.filter(line => !line.includes('예산')).join('\n');
        }

        function extractMarkdownFromText(text) {
            return text.replace(/```(?:html|markdown|md)?/g, '').trim();
        }

        function copyToClipboard(text, isHtml = false, customMessage = null) {
            const listener = (e) => {
                e.preventDefault();
                if (isHtml) {
                    e.clipboardData.setData('text/html', text);
                    const plain = text
                        .replace(/&nbsp;/gi, ' ')
                        .replace(/<br\s*\/?\s*>/gi, '\n')
                        .replace(/<\/(p|div|tr)>/gi, '\n')
                        .replace(/<\/li>/gi, '\n')
                        .replace(/<li[^>]*>/gi, '')
                        .replace(/<\/(thead|tbody)>/gi, '')
                        .replace(/<[^>]*>?/gm, '')
                        .replace(/\n{3,}/g, '\n\n')
                        .replace(/[ \t]+\n/g, '\n')
                        .trimEnd();
                    e.clipboardData.setData('text/plain', plain);
                } else {
                    e.clipboardData.setData('text/plain', text);
                }
            };
            document.addEventListener('copy', listener);
            document.execCommand('copy');
            document.removeEventListener('copy', listener);
            if (customMessage) {
                showToast(customMessage);
            } else {
                showToast(isHtml ? '표(HTML)가 클립보드에 복사되었습니다.' : '내용이 클립보드에 복사되었습니다.');
            }
        }

        async function generateConciseTitleFromInput(text, fallback = '') {
            const source = (text || '').trim();
            if (!source) return fallback || '';
            const prompt = `다음 내용을 20자 이내의 간결한 제목으로 요약해줘. 불필요한 따옴표 없이 제목만 출력해. 내용: ${source}`;
            try {
                const response = await fetch('/.netlify/functions/generatePlan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt, model: GEMINI_MODEL })
                });
                const result = await response.json();
                const rawText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (rawText) {
                    const markdown = extractMarkdownFromText(rawText);
                    const candidate = markdown
                        .split('\n')
                        .map(line => line.trim())
                        .find(line => line.length);
                    if (candidate) {
                        return candidate.replace(/^[-#*\d\.\s]+/, '').trim();
                    }
                }
            } catch (err) {
                console.error('Concise Title Generation Error:', err);
            }
            if (fallback && fallback.trim()) return fallback.trim();
            return source.slice(0, 20);
        }

        function addTableCopyButtons(container) {
            container.querySelectorAll('table').forEach(table => {
                if (table.previousElementSibling && table.previousElementSibling.classList && table.previousElementSibling.classList.contains('copy-table-btn')) return;
                const btn = document.createElement('button');
                btn.className = 'copy-table-btn';
                btn.textContent = '표 복사';
                table.parentNode.insertBefore(btn, table);
            });
        }

        function showToast(message) {
            toast.textContent = message;
            toast.classList.remove('opacity-0');
            setTimeout(() => {
                toast.classList.add('opacity-0');
            }, 2000);
        }

        async function saveCurrentSummary(markdown) {
            currentPlanSummaryMarkdown = markdown;
            const user = auth.currentUser;
            if (!user || !currentPlanId) return;
            try {
                await updateDoc(doc(db, "users", user.uid, "plans", currentPlanId), {
                    summaryContent: markdown,
                    summaryUpdatedAt: serverTimestamp()
                });
            } catch (err) {
                console.error('Summary Save Error:', err);
            }
        }

        function showSummaryPopup(summaryMarkdown) {
            if (!summaryMarkdown) return;
            const html = parseMarkdown(summaryMarkdown);
            if (!summaryPopupWindow || summaryPopupWindow.closed) {
                summaryPopupWindow = window.open('', '_blank', 'width=800,height=600,scrollbars=yes');
            }
            if (!summaryPopupWindow) return;

            const popupDoc = summaryPopupWindow.document;
            const baseStyles = "body{font-family:'Noto Sans KR',sans-serif;margin:0;padding:0;background:#f8fafc;color:#0f172a;} .summary-container{position:relative;max-width:960px;margin:0 auto;padding:48px 32px 32px;} .summary-actions{position:absolute;top:16px;right:16px;display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;} .summary-actions button{background:#1d4ed8;color:#ffffff;border:none;border-radius:24px;padding:10px 20px;font-size:14px;font-weight:600;cursor:pointer;box-shadow:0 4px 12px rgba(29,78,216,0.25);transition:background 0.2s ease,transform 0.2s ease;} .summary-actions button:hover{background:#1e40af;transform:translateY(-1px);} .summary-actions button:active{transform:translateY(0);} .summary-content{background:#ffffff;border-radius:12px;box-shadow:0 10px 30px rgba(15,23,42,0.08);padding:32px;line-height:1.7;} .manual-edit-area{width:100%;min-height:180px;margin-bottom:16px;padding:16px;border:1px solid #cbd5f5;border-radius:12px;font-size:15px;font-family:'Noto Sans KR',sans-serif;box-shadow:inset 0 1px 3px rgba(15,23,42,0.08);} .manual-edit-area:focus{outline:2px solid #2563eb;outline-offset:2px;} .hidden{display:none;} @media (max-width:600px){.summary-container{padding:40px 16px 24px;} .summary-content{padding:24px;} .summary-actions{top:12px;right:12px;} .summary-actions button{padding:8px 16px;font-size:13px;} .manual-edit-area{font-size:14px;}}";

            popupDoc.open();
            popupDoc.write('<!DOCTYPE html><html lang="ko"><head><meta charset="UTF-8"><title>요약본</title></head><body></body></html>');
            popupDoc.close();

            const styleTag = popupDoc.createElement('style');
            styleTag.textContent = baseStyles;
            popupDoc.head.appendChild(styleTag);

            const container = popupDoc.createElement('div');
            container.className = 'summary-container';
            container.innerHTML = `
                <div class="summary-actions">
                    <button id="toggle-edit-btn">수동 편집</button>
                    <button id="regenerate-summary-btn">재생성</button>
                    <button id="copy-summary-btn">전문 복사</button>
                </div>
                <textarea id="manual-edit-area" class="manual-edit-area hidden" placeholder="요약본을 직접 수정하세요."></textarea>
                <div id="summary-content" class="summary-content">${html}</div>
            `;
            popupDoc.body.appendChild(container);

            let currentMarkdown = summaryMarkdown;
            const summaryContent = popupDoc.getElementById('summary-content');
            const editArea = popupDoc.getElementById('manual-edit-area');
            const toggleEditBtn = popupDoc.getElementById('toggle-edit-btn');
            const copyBtn = popupDoc.getElementById('copy-summary-btn');
            const regenerateBtn = popupDoc.getElementById('regenerate-summary-btn');
            let isEditing = false;

            const renderMarkdown = (markdown) => parseMarkdown(markdown);
            const applyManualEdit = () => {
                if (!editArea) return;
                currentMarkdown = editArea.value;
                if (summaryContent) {
                    summaryContent.innerHTML = renderMarkdown(currentMarkdown);
                }
            };

            if (editArea) {
                editArea.addEventListener('input', () => {
                    currentMarkdown = editArea.value;
                    if (summaryContent) {
                        summaryContent.innerHTML = renderMarkdown(currentMarkdown);
                    }
                });
            }

            if (toggleEditBtn && editArea) {
                toggleEditBtn.addEventListener('click', () => {
                    if (!isEditing) {
                        isEditing = true;
                        toggleEditBtn.textContent = '편집 완료';
                        editArea.value = currentMarkdown;
                        editArea.classList.remove('hidden');
                        editArea.focus();
                    } else {
                        applyManualEdit();
                        isEditing = false;
                        toggleEditBtn.textContent = '수동 편집';
                        editArea.classList.add('hidden');
                    }
                });
            }

            const copyMarkdown = async () => {
                try {
                    if (summaryPopupWindow.navigator?.clipboard && summaryPopupWindow.isSecureContext) {
                        await summaryPopupWindow.navigator.clipboard.writeText(currentMarkdown);
                        return true;
                    }
                } catch (err) {
                    console.error('Clipboard copy failed:', err);
                }

                const textarea = popupDoc.createElement('textarea');
                textarea.value = currentMarkdown;
                textarea.style.position = 'fixed';
                textarea.style.left = '-9999px';
                popupDoc.body.appendChild(textarea);
                textarea.focus();
                textarea.select();
                let success = false;
                try {
                    if (typeof summaryPopupWindow.document.execCommand === 'function') {
                        success = summaryPopupWindow.document.execCommand('copy');
                    }
                } catch (err) {
                    success = false;
                }
                popupDoc.body.removeChild(textarea);
                return success;
            };

            if (copyBtn) {
                copyBtn.addEventListener('click', async () => {
                    try {
                        if (isEditing && editArea) {
                            applyManualEdit();
                            isEditing = false;
                            if (toggleEditBtn) {
                                toggleEditBtn.textContent = '수동 편집';
                            }
                            editArea.classList.add('hidden');
                        }
                        const copied = await copyMarkdown();
                        if (copied) {
                            copyBtn.textContent = '복사 완료';
                            summaryPopupWindow.setTimeout(() => {
                                copyBtn.textContent = '전문 복사';
                            }, 1500);
                        } else {
                            summaryPopupWindow.alert('복사에 실패했습니다. 다시 시도해주세요.');
                        }
                    } catch (err) {
                        console.error('Copy failed:', err);
                        summaryPopupWindow.alert('복사에 실패했습니다. 다시 시도해주세요.');
                    }
                });
            }

            if (regenerateBtn) {
                const openerWindow = summaryPopupWindow.opener && !summaryPopupWindow.opener.closed ? summaryPopupWindow.opener : null;
                const regenerateHandler = openerWindow && openerWindow.generatePlanSummaryFromPopup ? openerWindow.generatePlanSummaryFromPopup : null;
                if (regenerateHandler) {
                    const originalText = regenerateBtn.textContent;
                    regenerateBtn.addEventListener('click', async () => {
                        regenerateBtn.disabled = true;
                        regenerateBtn.textContent = '재생성 중...';
                        try {
                            const newMarkdown = await regenerateHandler();
                            if (typeof newMarkdown === 'string' && newMarkdown.trim()) {
                                currentMarkdown = newMarkdown;
                                if (summaryContent) {
                                    summaryContent.innerHTML = renderMarkdown(currentMarkdown);
                                }
                                if (editArea && !editArea.classList.contains('hidden')) {
                                    editArea.value = currentMarkdown;
                                }
                            } else {
                                summaryPopupWindow.alert('요약본 재생성에 실패했습니다. 다시 시도해주세요.');
                            }
                        } catch (err) {
                            console.error('Regenerate failed:', err);
                            summaryPopupWindow.alert('요약본 재생성 중 오류가 발생했습니다.');
                        } finally {
                            regenerateBtn.disabled = false;
                            regenerateBtn.textContent = originalText;
                        }
                    });
                } else {
                    regenerateBtn.style.display = 'none';
                }
            }

            summaryPopupWindow.focus();
        }

        async function summarizeDetailSections(detailSections) {
            if (!detailSections.length) return new Map();
            let prompt = `다음은 학교 업무 계획서의 '세부 추진 계획' 섹션 원문이다.\n`;
            prompt += `- 각 섹션 제목은 그대로 사용해.\n`;
            prompt += `- 각 섹션은 아래 형식을 지켜 작성해.\n`;
            prompt += `  ## 제목\n  - 핵심 내용\n  - 핵심 내용\n`;
            prompt += `- 불릿은 '-'로 시작하고 간결한 한 문장으로만 작성해.\n`;
            prompt += `- '항목:' 같은 접두어는 절대 사용하지 마.\n`;
            prompt += `- 각 섹션별 불릿 수는 최대 3개로 제한해.\n`;
            prompt += `- 각 불릿은 30자 이내로 요약해 핵심만 전달해.\n`;
            prompt += `- 다른 설명이나 추가 문구 없이 섹션별 결과만 출력해.\n`;
            detailSections.forEach(({ title, content }) => {
                prompt += `\n[섹션 시작]\n제목: ${title}\n내용:\n${content}\n[섹션 종료]\n`;
            });
            try {
                const response = await fetch('/.netlify/functions/generatePlan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt, model: GEMINI_MODEL })
                });
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                const summaryMap = new Map();
                if (text) {
                    const markdown = extractMarkdownFromText(text);
                    const blocks = markdown.match(/## [^\n]+(?:\n[^#][^\n]*)*/g) || [];
                    blocks.forEach(block => {
                        const lines = block.trim().split('\n');
                        const titleLine = lines.shift() || '';
                        const title = titleLine.replace(/^##\s*/, '').trim();
                        const content = lines.join('\n').trim();
                        if (title) {
                            const rebuilt = [`## ${title}`, content].filter(Boolean).join('\n');
                            summaryMap.set(title, rebuilt.trim());
                        }
                    });
                    if (summaryMap.size) return summaryMap;
                }
            } catch (err) {
                console.error('Detail Summary Generation Error:', err);
            }
            return new Map();
        }

        async function generatePlanSummary(options = {}) {
            const { openPopup = true, showToastMessage = true } = options;
            if (isSummaryGenerating) return null;
            const sections = planContainer ? planContainer.querySelectorAll('.plan-section') : [];
            if (!sections || !sections.length) return null;
            isSummaryGenerating = true;
            if (showToastMessage) {
                showToast('요약본 생성 중입니다..');
            }
            try {
                const sectionData = Array.from(sections).map(sec => {
                    const title = sec.querySelector('h3').textContent;
                    const content = sec.dataset.markdownContent || sec.querySelector('.plan-section-content').innerText.trim();
                    return {
                        title,
                        content,
                        isDetail: title.includes('세부 추진 계획')
                    };
                });
                const detailSections = sectionData.filter(sec => sec.isDetail);
                const detailSummaryMap = await summarizeDetailSections(detailSections);
                const summaryParts = sectionData.map(({ title, content, isDetail }) => {
                    if (isDetail) {
                        const summarized = detailSummaryMap.get(title);
                        if (summarized) {
                            return summarized.replace(/-\s*항목:\s*/g, '- ').trim();
                        }
                    }
                    return `## ${title}\n${content}`.trim();
                });
                const summaryMarkdown = summaryParts.filter(Boolean).join('\n\n').trim();
                await saveCurrentSummary(summaryMarkdown);
                if (openPopup) {
                    showSummaryPopup(summaryMarkdown);
                }
                return summaryMarkdown;
            } catch (err) {
                console.error('Summary Error:', err);
                return null;
            } finally {
                isSummaryGenerating = false;
            }
        }

async function saveCurrentPlan() {
            const user = auth.currentUser;
            if (!user || !currentPlanId) return;
            let rawContent = `TITLE: ${planTitle.textContent}\n\n`;
            planContainer.querySelectorAll('.plan-section').forEach(section => {
                const title = section.querySelector('h3').textContent;
                const markdown = section.dataset.markdownContent;
                rawContent += `## ${title}\n${markdown}\n\n`;
            });
            try {
                await updateDoc(doc(db, "users", user.uid, "plans", currentPlanId), {
                    title: planTitle.textContent,
                    rawContent
                });
            } catch (err) {
                console.error('Plan Save Error:', err);
            }
        }

        if (planModifyForm) {
            planModifyForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!currentPlanId) return;
                const userPrompt = planModifyPrompt.value.trim();
                if (!userPrompt) return;
                showToast('수정 중입니다..');
                const target = planModifyTarget.value;
                let prompt;
                if (target === '전체') {
                    let rawContent = `TITLE: ${planTitle.textContent}\n\n`;
                    planContainer.querySelectorAll('.plan-section').forEach(section => {
                        const title = section.querySelector('h3').textContent;
                        const markdown = section.dataset.markdownContent;
                        rawContent += `## ${title}\n${markdown}\n\n`;
                    });
                    prompt = `다음 운영계획서를 사용자의 요청에 맞게 수정해줘.\n${rawContent}\n\n요청: ${userPrompt}\n\n' TITLE:'으로 시작하는 동일한 형식의 마크다운으로만 결과를 출력해줘.`;
                } else {
                    const section = Array.from(planContainer.querySelectorAll('.plan-section')).find(sec => sec.querySelector('h3').textContent.includes(target));
                    if (!section) return;
                    const secTitle = section.querySelector('h3').textContent;
                    const secMarkdown = section.dataset.markdownContent;
                    prompt = `다음 운영계획서의 '${secTitle}' 부분을 사용자의 요청에 따라 수정해줘.\n## ${secTitle}\n${secMarkdown}\n\n요청: ${userPrompt}\n\n수정된 '${secTitle}' 부분만 '## ${secTitle}' 형식의 마크다운으로 출력해줘.`;
                }
                try {
                    const response = await fetch('/.netlify/functions/generatePlan', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt, model: GEMINI_MODEL })
                    });
                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                        if (text) {
                            const markdown = extractMarkdownFromText(text);
                            if (target === '전체') {
                                displayContent(markdown, planTitle.textContent);
                                await saveCurrentSummary(null);
                            } else {
                                const section = Array.from(planContainer.querySelectorAll('.plan-section')).find(sec => sec.querySelector('h3').textContent.includes(target));
                                if (section) {
                                    const lines = markdown.split('\n');
                                    if (lines[0].startsWith('##')) lines.shift();
                                let newContent = lines.join('\n').trim();
                                newContent = newContent
                                    .replace(/합니다\./gm, '한다.')
                                    .replace(/합니다$/gm, '한다')
                                    .replace(/함\./gm, '한다.')
                                    .replace(/함$/gm, '한다');
                                section.dataset.markdownContent = newContent;
                                const contentDiv = section.querySelector('.plan-section-content');
                                const isDetailSection = section.querySelector('h3').textContent.includes('세부 추진 계획');
                                renderSectionContent(contentDiv, newContent, { isDetail: isDetailSection });
                            }
                        }
                        saveCurrentPlan();
                        planModifyPrompt.value = '';
                    }
                } catch (err) {
                    console.error('Plan Modify Error:', err);
                }
            });
        }

        async function saveCurrentTable() {
            const user = auth.currentUser;
            if (!user || !currentTableId) return;
            try {
                await updateDoc(doc(db, "users", user.uid, "tables", currentTableId), {
                    rawContent: currentTableMarkdown
                });
            } catch (err) {
                console.error('Table Save Error:', err);
            }
        }

        async function saveCurrentOfficial() {
            const user = auth.currentUser;
            if (!user || !currentOfficialId) return;
            try {
                await updateDoc(doc(db, "users", user.uid, "officials", currentOfficialId), {
                    title: currentOfficialTitle,
                    rawContent: currentOfficialMarkdown
                });
            } catch (err) {
                console.error('Official Save Error:', err);
            }
        }

        async function saveCurrentLetter() {
            const user = auth.currentUser;
            if (!user || !currentLetterId) return;
            try {
                await updateDoc(doc(db, "users", user.uid, "letters", currentLetterId), {
                    rawContent: currentLetterMarkdown
                });
            } catch (err) {
                console.error('Letter Save Error:', err);
            }
        }

        planContainer.addEventListener('click', async function(e) {
            const button = e.target.closest('button');
            if (!button) return;

            const sectionDiv = button.closest('.plan-section');
            const contentDiv = sectionDiv.querySelector('.plan-section-content');

            if (button.classList.contains('generate-detail-btn') || button.classList.contains('regenerate-detail-btn')) {
                const sections = planContainer.querySelectorAll('.plan-section');
                let otherSections = '';
                sections.forEach(sec => {
                    const title = sec.querySelector('h3').textContent;
                    if (!title.includes('세부 추진 계획')) {
                        const content = sec.dataset.markdownContent || '';
                        otherSections += `## ${title}\n${content}\n\n`;
                    }
                });
                let prompt = `다음 주제와 다른 항목 내용을 참고하여 세부 추진 계획을 작성해줘.\n주제: ${planTitle.textContent}\n\n`;
                if (otherSections) {
                    prompt += `다른 항목 내용:\n${otherSections}`;
                }
                if (detailPlanExamples) {
                    prompt += `세부 추진 계획 예시:\n${detailPlanExamples}\n\n`;
                }
                if (planExamples) {
                    prompt += `부호 및 구조 예시:\n${planExamples}\n\n`;
                }
                if (exampleFiles.length) {
                    prompt += `예시 자료:\n`;
                    exampleFiles.forEach((file, idx) => {
                        prompt += `예시 ${idx + 1} (${file.name}):\n${file.text}\n\n`;
                    });
                }
                prompt += `'세부 추진 계획'을 Markdown 표 형식으로 출력해줘. 표에는 '목표', '추진방향', '추진 일정', '예산 관련', '예산 운용 계획', '기대효과' 항목은 포함하지 마.`;
                try {
                    showToast('세부 추진 계획 생성 중입니다..');
                    const response = await fetch('/.netlify/functions/generatePlan', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt, model: GEMINI_MODEL })
                    });
                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (text) {
                        const markdown = extractMarkdownFromText(text);
                        const lines = markdown.split('\n');
                        if (lines[0].startsWith('##')) lines.shift();
                        let newContent = lines.join('\n').trim();
                        newContent = newContent.replace(/합니다\./gm, '한다.').replace(/합니다$/gm, '한다').replace(/함\./gm, '한다.').replace(/함$/gm, '한다');
                        newContent = removeBudgetInfo(newContent);
                        sectionDiv.dataset.markdownContent = newContent;
                        renderSectionContent(contentDiv, newContent, { isDetail: true });

                        const oldControls = sectionDiv.querySelector('.absolute.top-4.right-4');
                        if (oldControls) oldControls.remove();

                        const controlsDiv = document.createElement('div');
                        controlsDiv.className = 'absolute top-4 right-4 flex gap-2';

                        const regenBtn = document.createElement('button');
                        regenBtn.className = 'regenerate-detail-btn';
                        regenBtn.textContent = '재생성';

                        const expandBtn = document.createElement('button');
                        expandBtn.className = 'expand-btn';
                        expandBtn.textContent = '내용 늘리기';

                        const detailBtn = document.createElement('button');
                        detailBtn.className = 'detail-btn';
                        detailBtn.textContent = '자세하게';

                        const editBtn = document.createElement('button');
                        editBtn.className = 'edit-btn';
                        editBtn.textContent = '편집';

                        const copyBtn = document.createElement('button');
                        copyBtn.className = 'copy-section-btn';
                        copyBtn.textContent = '복사';

                        controlsDiv.appendChild(regenBtn);
                        controlsDiv.appendChild(expandBtn);
                        controlsDiv.appendChild(detailBtn);
                        controlsDiv.appendChild(editBtn);
                        controlsDiv.appendChild(copyBtn);
                        sectionDiv.insertBefore(controlsDiv, sectionDiv.firstChild);
                        await saveCurrentPlan();
                    }
                } catch (err) {
                    console.error('Detail Plan Generate Error:', err);
                }
            } else if (button.classList.contains('regenerate-section-btn')) {
                const secTitle = sectionDiv.querySelector('h3').textContent;
                const previousMarkdown = sectionDiv.dataset.markdownContent || '';
                const sections = planContainer.querySelectorAll('.plan-section');
                let otherSections = '';
                sections.forEach(sec => {
                    const title = sec.querySelector('h3').textContent;
                    if (title !== secTitle) {
                        const content = sec.dataset.markdownContent || '';
                        otherSections += `## ${title}\n${content}\n\n`;
                    }
                });
                let prompt = `다음 계획서의 다른 항목을 참고하여 ${secTitle}을 작성해줘.\n주제: ${planTitle.textContent}\n\n`;
                if (otherSections) {
                    prompt += `다른 항목 내용:\n${otherSections}`;
                }
                let referencePurposeBullets = [];
                let desiredEffectBulletCount = null;
                if (secTitle.includes('기대효과')) {
                    const purposeSection = Array.from(sections).find(sec => sec.querySelector('h3').textContent.includes('추진 목적'));
                    if (purposeSection) {
                        const purposeContent = purposeSection.dataset.markdownContent || '';
                        referencePurposeBullets = extractBulletItems(purposeContent);
                        prompt += `추진 목적:\n${purposeContent}\n\n`;
                        if (referencePurposeBullets.length) {
                            desiredEffectBulletCount = referencePurposeBullets.length;
                            prompt += `출력은 반드시 '-'로 시작하는 마크다운 불릿 포인트 ${referencePurposeBullets.length}개로 작성하고, 각 항목은 위 추진 목적 각각에 대응되는 기대 효과를 명사형 표현으로 정리해줘.`;
                        } else {
                            prompt += `출력은 반드시 '-'로 시작하는 마크다운 불릿 포인트 형식으로 작성하고, 각 항목은 명사형 표현으로 끝나게 해줘.`;
                        }
                    } else {
                        prompt += `출력은 반드시 '-'로 시작하는 마크다운 불릿 포인트 형식으로 작성하고, 각 항목은 명사형 표현으로 끝나게 해줘.`;
                    }
                } else if (secTitle.includes('추진 목적')) {
                    prompt += `출력은 반드시 '-'로 시작하는 마크다운 불릿 포인트 형식을 유지하고, 각 항목은 명사형 표현으로 작성해줘.`;
                }
                try {
                    showToast('재생성 중입니다..');
                    const response = await fetch('/.netlify/functions/generatePlan', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt, model: GEMINI_MODEL })
                    });
                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (text) {
                        const markdown = extractMarkdownFromText(text);
                        const lines = markdown.split('\n');
                        if (lines[0].startsWith('##')) lines.shift();
                        let newContent = lines.join('\n').trim();
                        if (secTitle.includes('기대효과')) {
                            const referenceItems = referencePurposeBullets.length ? referencePurposeBullets : extractBulletItems(previousMarkdown);
                            const referenceSuffix = referencePurposeBullets.length ? ' 관련 기대 효과' : '';
                            newContent = normalizeBulletList(newContent, {
                                desiredCount: desiredEffectBulletCount,
                                referenceItems,
                                referenceSuffix
                            });
                        } else if (secTitle.includes('추진 목적')) {
                            const existingBullets = extractBulletItems(previousMarkdown);
                            newContent = normalizeBulletList(newContent, {
                                desiredCount: existingBullets.length || null,
                                referenceItems: existingBullets
                            });
                        }
                        sectionDiv.dataset.markdownContent = newContent;
                                const isDetailSection = section.querySelector('h3').textContent.includes('세부 추진 계획');
                                renderSectionContent(contentDiv, newContent, { isDetail: isDetailSection });
                        addTableCopyButtons(contentDiv);
                        await saveCurrentPlan();
                    }
                } catch (err) {
                    console.error('Section Regenerate Error:', err);
                }
            } else if (button.classList.contains('copy-section-btn')) {
                const tempDiv = contentDiv.cloneNode(true);
                tempDiv.querySelectorAll('table').forEach(t => t.remove());
                copyToClipboard(tempDiv.innerText.trim(), false);
            } else if (button.classList.contains('copy-table-btn')) {
                let table = button.nextElementSibling;
                if (!table || table.tagName !== 'TABLE') table = button.previousElementSibling;
                if (table && table.tagName === 'TABLE') {
                    const htmlToCopy = htmlTableToHtmlClipboard(table);
                    if (!htmlToCopy || !htmlToCopy.trim() || !/<table[\s>]/i.test(htmlToCopy)) return;
                    copyToClipboard(htmlToCopy, true, '표가 클립보드에 복사되었습니다.');
                }
            } else if (button.classList.contains('edit-btn')) {
                if (button.textContent === '편집') { // Start editing
                    button.textContent = '완료';
                    button.classList.add('bg-green-500', 'text-white');
                    const currentMarkdown = sectionDiv.dataset.markdownContent;
                    const textarea = document.createElement('textarea');
                    textarea.className = 'w-full h-48 p-2 border rounded-md font-mono text-sm';
                    textarea.value = currentMarkdown;
                    contentDiv.replaceWith(textarea);
                } else { // Finish editing
                    button.textContent = '편집';
                    button.classList.remove('bg-green-500', 'text-white');
                    const textarea = sectionDiv.querySelector('textarea');
                    const newMarkdown = textarea.value;
                    sectionDiv.dataset.markdownContent = newMarkdown;
                    const newContentDiv = document.createElement('div');
                    const isDetailSection = sectionDiv.querySelector('h3').textContent.includes('세부 추진 계획');
                    renderSectionContent(newContentDiv, newMarkdown, { isDetail: isDetailSection });
                    textarea.replaceWith(newContentDiv);
                    saveCurrentPlan();
                }
            } else if (button.classList.contains('expand-btn') || button.classList.contains('detail-btn')) {
                if (!contentDiv) return;
                const isExpand = button.classList.contains('expand-btn');
                const secTitle = sectionDiv.querySelector('h3').textContent;
                const secMarkdown = sectionDiv.dataset.markdownContent;
                const sections = planContainer.querySelectorAll('.plan-section');
                let prompt;
                if (button.classList.contains('detail-btn') && secTitle.includes('세부 추진 계획')) {
                    let otherSections = '';
                    sections.forEach(sec => {
                        const title = sec.querySelector('h3').textContent;
                        if (title !== secTitle) {
                            const content = sec.dataset.markdownContent || '';
                            otherSections += `## ${title}\n${content}\n\n`;
                        }
                    });
                    prompt = `다음 주제와 다른 항목 내용을 참고하여 세부 추진 계획을 작성해줘.\n주제: ${planTitle.textContent}\n\n`;
                    if (otherSections) {
                        prompt += `다른 항목 내용:\n${otherSections}`;
                    }
                    if (detailPlanExamples) {
                        prompt += `세부 추진 계획 예시:\n${detailPlanExamples}\n\n`;
                    }
                    if (planExamples) {
                        prompt += `부호 및 구조 예시:\n${planExamples}\n\n`;
                    }
                    if (exampleFiles.length) {
                        prompt += `예시 자료:\n`;
                        exampleFiles.forEach((file, idx) => {
                            prompt += `예시 ${idx + 1} (${file.name}):\n${file.text}\n\n`;
                        });
                    }
                    prompt += `'세부 추진 계획'을 Markdown 표 형식으로 출력해줘. 표에는 '목표', '추진방향', '추진 일정', '예산 관련', '예산 운용 계획', '기대효과' 항목은 포함하지 마.`;
                } else if (isExpand) {
                    if (secTitle.includes('추진 배경') || secTitle.includes('방향') || secTitle.includes('방침')) {
                        prompt = `다음 계획서 항목의 내용을 확장해줘. 기존의 불릿 리스트는 그대로 유지하고 항목의 개수를 늘리지 말아줘. 대신 각 불릿의 표현을 더욱 구체적으로 작성해줘. 각 항목은 주제나 항목명을 쓰지 말고 바로 내용을 시작하며 문장이 아닌 명사형 표현으로 끝나게 해줘.\n## ${secTitle}\n${secMarkdown}\n\n'## ${secTitle}' 형식의 마크다운으로 출력해줘.`;
                    } else if (secTitle.includes('추진 목적') || secTitle.includes('기대효과')) {
                        const bulletCount = (secMarkdown.match(/^- /gm) || []).length;
                        const targetCount = Math.ceil(bulletCount * 1.5);
                        prompt = `다음 계획서 항목의 내용을 확장해줘. 기존의 불릿 항목들을 유지하면서 새로운 불릿을 추가해 전체 항목 수가 약 ${targetCount}개가 되도록 해줘. 각 항목은 문장이 아닌 명사형 표현으로 끝나게 해줘. 모든 항목은 '- '로 시작하는 마크다운 불릿 포인트 형식으로 출력해줘.\n## ${secTitle}\n${secMarkdown}\n\n'## ${secTitle}' 형식의 마크다운으로 출력해줘.`;
                    } else {
                        prompt = `다음 계획서 항목의 내용을 확장해줘. 기존의 불릿 리스트나 표 형식은 그대로 유지하되, 항목의 개수를 늘려줘. 자세한 설명을 추가하는 대신 새로운 불릿이나 표 행을 추가해줘.\n## ${secTitle}\n${secMarkdown}\n\n'## ${secTitle}' 형식의 마크다운으로 출력해줘.`;
                    }
                } else {
                    if (secTitle.includes('추진 목적') || secTitle.includes('기대효과')) {
                        prompt = `다음 계획서 항목의 내용을 구체적으로 작성해줘. 기존의 불릿 리스트는 그대로 유지하고, 항목의 개수는 늘리지 말며 각 항목의 설명을 더욱 자세하게 해줘. 모든 항목은 '- '로 시작하는 마크다운 불릿 포인트 형식으로 작성하고 문장이 아닌 명사형 표현으로 끝나게 해줘.\n## ${secTitle}\n${secMarkdown}\n\n'## ${secTitle}' 형식의 마크다운으로 출력해줘.`;
                    } else {
                        prompt = `다음 계획서 항목의 내용을 구체적으로 작성해줘. 기존의 불릿 리스트나 표 형식은 그대로 유지하고, 항목의 개수는 늘리지 말며 각 항목의 설명을 더욱 자세하게 해줘.\n## ${secTitle}\n${secMarkdown}\n\n'## ${secTitle}' 형식의 마크다운으로 출력해줘.`;
                    }
                }
                try {
                    showToast(isExpand ? '내용 늘리는 중입니다..' : '자세하게 작성 중입니다..');
                    const response = await fetch('/.netlify/functions/generatePlan', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt, model: GEMINI_MODEL })
                    });
                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (text) {
                        const markdown = extractMarkdownFromText(text);
                        const lines = markdown.split('\n');
                        if (lines[0].startsWith('##')) lines.shift();
                        let newContent = lines.join('\n').trim();
                        if (!secTitle.includes('추진 배경') && !secTitle.includes('추진 목적') && !secTitle.includes('기대효과') && !secTitle.includes('방향') && !secTitle.includes('방침')) {
                            newContent = newContent.replace(/합니다\./gm, '한다.').replace(/합니다$/gm, '한다').replace(/함\./gm, '한다.').replace(/함$/gm, '한다');
                        }
                        newContent = removeBudgetInfo(newContent);
                        if (secTitle.includes('추진 목적') || secTitle.includes('기대효과')) {
                            const baseReference = extractBulletItems(secMarkdown);
                            const options = { referenceItems: baseReference };
                            if (!isExpand && baseReference.length) {
                                options.desiredCount = baseReference.length;
                            }
                            if (secTitle.includes('기대효과')) {
                                const purposeSection = Array.from(sections).find(sec => sec.querySelector('h3').textContent.includes('추진 목적'));
                                const purposeBullets = extractBulletItems(purposeSection ? purposeSection.dataset.markdownContent || '' : '');
                                if (purposeBullets.length) {
                                    options.referenceItems = baseReference.length ? baseReference : purposeBullets;
                                    if (!isExpand && !options.desiredCount) {
                                        options.desiredCount = purposeBullets.length;
                                    }
                                    options.referenceSuffix = ' 관련 기대 효과';
                                }
                            }
                            newContent = normalizeBulletList(newContent, options);
                        }
                        sectionDiv.dataset.markdownContent = newContent;
                        const isDetailSection = secTitle.includes('세부 추진 계획');
                        renderSectionContent(contentDiv, newContent, { isDetail: isDetailSection });
                        await saveCurrentPlan();
                    }
                } catch (err) {
                    console.error('Section Update Error:', err);
                }
            }
        });

        if (mergePlanBtn) {
            mergePlanBtn.addEventListener('click', async () => {
                if (currentPlanSummaryMarkdown && !isSummaryGenerating) {
                    showSummaryPopup(currentPlanSummaryMarkdown);
                    return;
                }
                const markdown = await generatePlanSummary({ openPopup: true, showToastMessage: true });
                if (!markdown && !isSummaryGenerating) {
                    showToast('요약본 생성에 실패했습니다.');
                }
            });
        }

        window.generatePlanSummaryFromPopup = async () => {
            const markdown = await generatePlanSummary({ openPopup: false, showToastMessage: true });
            return markdown;
        };

        editTitleBtn.addEventListener('click', () => {
            const isEditing = editTitleBtn.textContent === '완료';
            if (isEditing) {
                planTitle.textContent = planTitleInput.value;
                planTitle.classList.remove('hidden');
                planTitleInput.classList.add('hidden');
                editTitleBtn.textContent = '편집';
                editTitleBtn.classList.remove('bg-green-500', 'text-white');
                saveCurrentPlan();
            } else {
                planTitleInput.value = planTitle.textContent;
                planTitle.classList.add('hidden');
                planTitleInput.classList.remove('hidden');
                planTitleInput.focus();
                editTitleBtn.textContent = '완료';
                editTitleBtn.classList.add('bg-green-500', 'text-white');
            }
        });

        // --- INITIALIZATION ---
    </script>
</body>
</html>
