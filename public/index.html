<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>에이두 티쳐 - AI 학교 운영계획서</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        html { scroll-behavior: smooth; }
        body { font-family: 'Noto Sans KR', sans-serif; }
        .plan-section {
            position: relative;
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            background-color: #f8fafc;
        }
        .plan-section h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e2e8f0;
        }
        .plan-section-content p { margin-bottom: 1rem; line-height: 1.6; }
        .plan-section-content ul { list-style-type: disc; margin-left: 1.5rem; margin-bottom: 1rem; }
        .plan-section-content li { margin-bottom: 0.5rem; }
        .plan-section-content table { width: 100%; border-collapse: collapse; margin-bottom: 1rem; }
        .plan-section-content th,
        .plan-section-content td { border: 1px solid #cbd5e1; padding: 0.75rem; text-align: left; }
        .plan-section-content th { background-color: #f1f5f9; font-weight: 600; }
        .edit-btn, .copy-section-btn {
            background-color: #e2e8f0;
            color: #475569;
            border: none;
            padding: 0.25rem 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .edit-btn:hover, .copy-section-btn:hover { background-color: #cbd5e1; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #7A9D54; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .nav-link { padding: 0.5rem 1rem; border-radius: 0.375rem; transition: background-color 0.2s, color 0.2s; }
        .nav-link.active { background-color: #7A9D54; color: white; }
        .nav-link:not(.active):hover { background-color: #f3f4f6; }
        .school-level-btn, .plan-type-btn {
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        .school-level-btn.active, .plan-type-btn.active {
            background-color: #84cc16; /* lime-500 */
            color: white;
            border-color: #65a30d; /* lime-600 */
            font-weight: 600;
        }
        .school-level-btn:not(.active), .plan-type-btn:not(.active) {
            background-color: #f1f5f9; /* slate-100 */
            color: #475569; /* slate-600 */
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <div id="app">
        <!-- Auth View (Login/Signup) -->
        <div id="auth-view" class="min-h-screen flex items-center justify-center bg-gray-100">
            <div class="w-full max-w-md bg-white rounded-lg shadow-md p-8">
                <h2 class="text-2xl font-bold text-center text-[#7A9D54] mb-6">에이두 티쳐 시작하기</h2>
                <form id="auth-form" onsubmit="return false;">
                    <div class="mb-4">
                        <label for="email" class="block text-gray-700 text-sm font-bold mb-2">이메일</label>
                        <input type="email" id="email" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                    </div>
                    <div class="mb-6">
                        <label for="password" class="block text-gray-700 text-sm font-bold mb-2">비밀번호</label>
                        <input type="password" id="password" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline" required>
                    </div>
                    <p id="auth-error" class="text-red-500 text-xs italic mb-4 hidden"></p>
                    <div class="flex items-center justify-between">
                        <button type="button" id="login-btn" class="bg-[#7A9D54] hover:bg-[#6a8a4a] text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">로그인</button>
                        <button type="button" id="signup-btn" class="inline-block align-baseline font-bold text-sm text-green-600 hover:text-green-800">계정이 없으신가요? 회원가입</button>
                    </div>
                    <div class="my-4 flex items-center">
                        <div class="flex-grow border-t border-gray-300"></div>
                        <span class="flex-shrink mx-4 text-gray-400 text-sm">또는</span>
                        <div class="flex-grow border-t border-gray-300"></div>
                    </div>
                    <button type="button" id="google-login-btn" class="w-full bg-white border border-gray-300 text-gray-700 font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline flex items-center justify-center gap-2 hover:bg-gray-50 transition-colors">
                        <svg class="w-5 h-5" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path><path fill="none" d="M0 0h48v48H0z"></path></svg>
                        Google 계정으로 로그인
                    </button>
                </form>
            </div>
        </div>

        <!-- Main App View -->
        <div id="main-app-view" class="hidden flex-col min-h-screen">
            <header class="bg-white shadow-md w-full sticky top-0 z-50">
                <div class="container mx-auto px-6 py-3 flex justify-between items-center">
                    <h1 class="text-2xl font-bold text-[#7A9D54]"><a href="#home" id="home-link">📝 에이두 티쳐</a></h1>
                    <nav class="flex items-center gap-4">
                        <span id="user-email" class="text-sm text-gray-600"></span>
                        <a href="#home" id="nav-home" class="nav-link">홈</a>
                        <a href="#plan" id="nav-plan" class="nav-link">계획서</a>
                        <a href="#table" id="nav-table" class="nav-link">[한글] 표 만들기</a>
                        <a href="#official" id="nav-official" class="nav-link">공문서</a>
                        <a href="#letter" id="nav-letter" class="nav-link">가정통신문</a>
                        <a href="#lesson" id="nav-lesson" class="nav-link">교수학습 지도안</a>
                        <button id="logout-btn" class="text-sm bg-red-500 hover:bg-red-600 text-white font-semibold py-1 px-3 rounded-md transition-colors">로그아웃</button>
                    </nav>
                </div>
            </header>
            <main class="flex-grow container mx-auto p-6">
                <!-- Home View -->
                <div id="home-view">
                    <h2 class="text-3xl font-bold mb-6">홈</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-lg">
                            <h3 class="text-xl font-bold mb-2">안녕하세요, <span id="home-user-email"></span> 선생님!</h3>
                            <p class="text-gray-600 mb-4">에이두 티쳐와 함께 학교의 업무를 간편히 관리해보세요.</p>
                            <div class="flex flex-wrap gap-4">
                                <button id="go-to-generator-btn" class="bg-[#7A9D54] text-white font-bold py-3 px-6 rounded-lg hover:bg-[#6a8a4a] transition-colors">새 운영계획서 생성하기 →</button>
                                <button id="go-to-table-btn" class="bg-[#7A9D54] text-white font-bold py-3 px-6 rounded-lg hover:bg-[#6a8a4a] transition-colors">[한글] 표 만들기 →</button>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-lg">
                            <h3 class="text-xl font-bold mb-4">생성 통계</h3>
                            <div id="stats-chart-container" class="h-48 flex items-center justify-center">
                                <canvas id="statsChart"></canvas>
                            </div>
                        </div>
                        <div class="md:col-span-2 lg:col-span-3 bg-white p-6 rounded-lg shadow-lg">
                            <h3 class="text-xl font-bold mb-4">최근 생성한 계획서</h3>
                            <div id="recent-plans-list" class="space-y-3"></div>
                        </div>
                    </div>
                </div>
                <!-- Plan View -->
                <div id="plan-view" class="hidden">
                    <div class="flex flex-col lg:flex-row gap-6">
                        <aside class="w-full lg:w-1/3 bg-white p-6 rounded-lg shadow-lg h-fit lg:sticky top-24">
                            <h3 class="text-lg font-semibold mb-4">입력 테이블</h3>
                            <form id="plan-form" onsubmit="return false;">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">학교급</label>
                                    <div id="school-level-buttons" class="grid grid-cols-3 gap-2">
                                        <button type="button" data-value="유치원" class="school-level-btn py-2 px-3 rounded-md text-sm">유치원</button>
                                        <button type="button" data-value="초등학교" class="school-level-btn py-2 px-3 rounded-md text-sm active">초등학교</button>
                                        <button type="button" data-value="중학교" class="school-level-btn py-2 px-3 rounded-md text-sm">중학교</button>
                                        <button type="button" data-value="고등학교" class="school-level-btn py-2 px-3 rounded-md text-sm">고등학교</button>
                                        <button type="button" data-value="없음" class="school-level-btn py-2 px-3 rounded-md text-sm">없음</button>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">계획서 주제</label>
                                    <div id="plan-type-buttons" class="grid grid-cols-2 gap-2"></div>
                                    <input type="text" id="custom-plan-type" placeholder="계획서 주제를 직접 입력하세요" class="block w-full mt-2 px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 sm:text-sm">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">핵심 키워드</label>
                                    <div id="keywords-container" class="space-y-2 mt-1">
                                        <div class="flex items-center gap-2">
                                            <input type="text" name="keywords" class="keyword-input block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 sm:text-sm" placeholder="예: AI 융합">
                                        </div>
                                    </div>
                                    <button type="button" id="add-keyword-btn" class="mt-2 text-sm text-blue-600 hover:underline flex items-center">
                                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                                        키워드 추가
                                    </button>
                                </div>

                                <p id="form-error" class="text-red-500 text-xs italic mt-2 hidden"></p>
                                <button type="submit" id="generate-btn" class="w-full bg-[#7A9D54] text-white font-bold py-3 px-4 rounded-lg hover:bg-[#6a8a4a] flex items-center justify-center">AI 운영계획서 생성</button>
                            </form>
                            <div class="bg-white p-6 rounded-lg shadow hidden" id="plan-modify-section">
                                <h3 class="text-lg font-semibold mb-4">수정 테이블</h3>
                                <form id="plan-modify-form" class="space-y-4">
                                    <div>
                                        <label for="plan-modify-target" class="block text-sm font-medium text-gray-700">수정 영역</label>
                                        <select id="plan-modify-target" class="mt-1 block w-full border border-gray-300 rounded-md p-2">
                                            <option value="전체">전체</option>
                                            <option value="목적">목적</option>
                                            <option value="운영 방침">운영 방침</option>
                                            <option value="세부 운영 계획">세부 운영 계획</option>
                                            <option value="예산">예산</option>
                                            <option value="기대효과">기대효과</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="plan-modify-prompt" class="block text-sm font-medium text-gray-700">수정 내용</label>
                                        <input type="text" id="plan-modify-prompt" class="mt-1 block w-full border border-gray-300 rounded-md p-2" placeholder="수정할 내용을 입력하세요">
                                    </div>
                                    <button type="submit" id="modify-plan-btn" class="w-full bg-[#7A9D54] text-white font-bold py-2 px-4 rounded-lg hover:bg-[#6a8a4a]">AI 수정 적용</button>
                                </form>
                            </div>
                            <div class="mt-8">
                                <h3 class="text-lg font-bold mb-4 border-b pb-2">목록 테이블</h3>
                                <div id="plan-saved-list" class="space-y-3 max-h-60 overflow-y-auto">
                                    <!-- Recent plans will be dynamically inserted here -->
                                </div>
                            </div>
                        </aside>
                        <section id="output-panel" class="w-full lg:w-2/3">
                            <h3 class="text-lg font-semibold mb-4">출력 테이블</h3>
                            <div id="initial-message" class="bg-white p-8 rounded-lg shadow-lg"><h2 class="text-2xl font-bold text-gray-800">AI 운영계획서 초안이 이곳에 표시됩니다.</h2></div>
                            <div id="loading-indicator" class="hidden flex-col items-center justify-center text-center py-16">
                                <div class="loader"></div>
                                <p class="mt-4 text-lg font-semibold text-gray-700">AI가 열심히 계획서를 작성하고 있습니다...</p>
                                <p class="text-slate-500">잠시만 기다려 주세요...</p>
                            </div>
                            
                            <div id="result-section" class="hidden">
                                <div class="flex justify-between items-center mb-6 bg-white p-6 rounded-lg shadow-lg">
                                    <div class="flex items-center gap-4">
                                        <h2 id="plan-title" class="text-2xl font-bold text-slate-800"></h2>
                                        <input type="text" id="plan-title-input" class="hidden text-2xl font-bold text-slate-800 border-b-2 border-blue-500 focus:outline-none">
                                    </div>
                                    <div class="flex gap-2">
                                        <button id="merge-plan-btn" class="copy-section-btn">한장으로 합치기</button>
                                        <button id="edit-title-btn" class="edit-btn">편집</button>
                                    </div>
                                </div>
                                <div id="generated-plan-container" class="space-y-6">
                                    <!-- Generated sections will be injected here -->
                                </div>
                            </div>

                            <div id="error-message" class="hidden text-center bg-white p-8 rounded-lg shadow-lg"><h2 class="text-2xl font-bold text-red-600">오류가 발생했습니다</h2><p id="error-details" class="mt-4 text-gray-600"></p></div>
                        </section>
                    </div>
                </div>
                <!-- Table Generator View -->
                <div id="table-view" class="hidden">
                    <div class="container mx-auto p-6">
                        <h2 class="text-3xl font-bold mb-6">[한글] 표 만들기</h2>
                        <div class="flex flex-col lg:flex-row gap-6">
                            <!-- Input & Modify Section -->
                            <aside class="w-full lg:w-1/3 space-y-6">
                                <div class="bg-white p-6 rounded-lg shadow">
                                    <h3 class="text-lg font-semibold mb-4">입력 테이블</h3>
                                    <form id="table-form" class="space-y-4">
                                        <div>
                                            <label for="table-topic" class="block text-sm font-medium text-gray-700">표 주제</label>
                                            <textarea id="table-topic" rows="4" class="mt-1 block w-full border border-gray-300 rounded-md p-2" placeholder="표의 주제를 입력하세요"></textarea>
                                        </div>
                                        <button type="submit" id="generate-table-btn" class="w-full bg-[#7A9D54] text-white font-bold py-2 px-4 rounded-lg hover:bg-[#6a8a4a]">AI 표 생성</button>
                                    </form>
                                </div>

                                <!-- AI Modify Table -->
                                <div class="bg-white p-6 rounded-lg shadow hidden" id="table-modify-section">
                                    <h3 class="text-lg font-semibold mb-4">AI 수정 테이블</h3>
                                    <form id="table-modify-form" class="space-y-4">
                                        <div>
                                            <label for="table-modify-prompt" class="block text-sm font-medium text-gray-700">수정 내용</label>
                                            <input type="text" id="table-modify-prompt" class="mt-1 block w-full border border-gray-300 rounded-md p-2" placeholder="수정할 내용을 입력하세요">
                                        </div>
                                        <button type="submit" id="modify-table-btn" class="w-full bg-[#7A9D54] text-white font-bold py-2 px-4 rounded-lg hover:bg-[#6a8a4a]">AI 수정 적용</button>
                                    </form>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold mt-6 mb-2">저장된 목록</h3>
                                    <div id="table-saved-list" class="space-y-3"></div>
                                </div>
                            </aside>

                            <!-- Output Section -->
                            <section class="w-full lg:w-2/3">
                                <div class="plan-section hidden" id="table-output-section">
                                    <div class="absolute top-4 right-4 flex gap-2">
                                        <button id="copy-table-btn" class="copy-section-btn">복사</button>
                                        <button id="edit-table-btn" class="edit-btn">편집</button>
                                    </div>
                                    <div id="generated-table-container" class="plan-section-content overflow-x-auto"></div>
                                </div>
                            </section>
                        </div>
                    </div>
                </div>
                <!-- Official Docs View -->
                <div id="official-view" class="hidden">
                    <div class="container mx-auto p-6">
                        <h2 class="text-3xl font-bold mb-6">공문서</h2>
                        <div class="flex flex-col lg:flex-row gap-6">
                            <!-- Input & Modify Section -->
                            <aside class="w-full lg:w-1/3 space-y-6">
                                <div class="bg-white p-6 rounded-lg shadow">
                                    <h3 class="text-lg font-semibold mb-4">입력 테이블</h3>
                                    <form id="official-form" class="space-y-4">
                                        <div>
                                            <label for="official-topic" class="block text-sm font-medium text-gray-700">주제</label>
                                            <textarea id="official-topic" rows="3" class="mt-1 block w-full border border-gray-300 rounded-md p-2" placeholder="공문서 주제를 입력하세요" required></textarea>
                                        </div>
                                        <div>
                                            <label for="official-reference" class="block text-sm font-medium text-gray-700">근거 (선택)</label>
                                            <input type="text" id="official-reference" class="mt-1 block w-full border border-gray-300 rounded-md p-2" placeholder="관련 기관 문서 번호 날짜를 입력하세요">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">첨부 파일 (선택)</label>
                                            <div id="attachments-container" class="space-y-2"></div>
                                            <button type="button" id="add-attachment-btn" class="mt-2 text-sm text-blue-600 hover:underline">+ 추가</button>
                                        </div>
                                        <button type="submit" id="generate-official-btn" class="w-full bg-[#7A9D54] text-white font-bold py-2 px-4 rounded-lg hover:bg-[#6a8a4a]">AI 공문서 생성</button>
                                    </form>
                                </div>

                                <!-- AI Modify Table -->
                                <div class="bg-white p-6 rounded-lg shadow hidden" id="official-modify-section">
                                    <h3 class="text-lg font-semibold mb-4">AI 수정 테이블</h3>
                                    <form id="official-modify-form" class="space-y-4">
                                        <div>
                                            <label for="official-modify-prompt" class="block text-sm font-medium text-gray-700">수정 내용</label>
                                            <input type="text" id="official-modify-prompt" class="mt-1 block w-full border border-gray-300 rounded-md p-2" placeholder="수정할 내용을 입력하세요">
                                        </div>
                                        <button type="submit" id="modify-official-btn" class="w-full bg-[#7A9D54] text-white font-bold py-2 px-4 rounded-lg hover:bg-[#6a8a4a]">AI 수정 적용</button>
                                    </form>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold mt-6 mb-2">저장된 목록</h3>
                                    <div id="official-saved-list" class="space-y-3"></div>
                                </div>
                            </aside>

                            <!-- Output Section -->
                            <section class="w-full lg:w-2/3">
                                <div class="plan-section hidden relative" id="official-output-section">
                                    <div class="absolute top-4 right-4 flex gap-2">
                                        <button id="copy-official-btn" class="copy-section-btn">복사</button>
                                        <button id="edit-official-btn" class="edit-btn">편집</button>
                                    </div>
                                    <div class="mb-4 flex items-center gap-2">
                                        <h3 id="official-title" class="text-xl font-bold"></h3>
                                        <input type="text" id="official-title-input" class="hidden text-xl font-bold border-b border-gray-400 focus:outline-none">
                                        <button type="button" id="edit-official-title-btn" class="edit-btn">편집</button>
                                        <button type="button" id="copy-official-title-btn" class="copy-section-btn">복사</button>
                                    </div>
                                    <div id="generated-official-container" class="plan-section-content"></div>
                                </div>
                            </section>
                        </div>
                    </div>
                </div>
                <!-- Letter View -->
                <div id="letter-view" class="hidden">
                    <div class="container mx-auto p-6">
                        <h2 class="text-3xl font-bold mb-6">가정통신문</h2>
                        <div class="flex flex-col lg:flex-row gap-6">
                            <!-- Input & Modify Section -->
                            <aside class="w-full lg:w-1/3 space-y-6">
                                <div class="bg-white p-6 rounded-lg shadow">
                                    <h3 class="text-lg font-semibold mb-4">입력 테이블</h3>
                                    <form id="letter-form" class="space-y-4">
                                        <div>
                                            <label for="letter-topic" class="block text-sm font-medium text-gray-700">주제</label>
                                            <textarea id="letter-topic" rows="4" class="mt-1 block w-full border border-gray-300 rounded-md p-2" placeholder="가정통신문 주제를 입력하세요"></textarea>
                                        </div>
                                        <button type="submit" id="generate-letter-btn" class="w-full bg-[#7A9D54] text-white font-bold py-2 px-4 rounded-lg hover:bg-[#6a8a4a]">AI 가정통신문 생성</button>
                                    </form>
                                </div>

                                <!-- AI Modify Table -->
                                <div class="bg-white p-6 rounded-lg shadow hidden" id="letter-modify-section">
                                    <h3 class="text-lg font-semibold mb-4">AI 수정 테이블</h3>
                                    <form id="letter-modify-form" class="space-y-4">
                                        <div>
                                            <label for="letter-modify-prompt" class="block text-sm font-medium text-gray-700">수정 내용</label>
                                            <input type="text" id="letter-modify-prompt" class="mt-1 block w-full border border-gray-300 rounded-md p-2" placeholder="수정할 내용을 입력하세요">
                                        </div>
                                        <button type="submit" id="modify-letter-btn" class="w-full bg-[#7A9D54] text-white font-bold py-2 px-4 rounded-lg hover:bg-[#6a8a4a]">AI 수정 적용</button>
                                    </form>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold mt-6 mb-2">저장된 목록</h3>
                                    <div id="letter-saved-list" class="space-y-3"></div>
                                </div>
                            </aside>

                            <!-- Output Section -->
                            <section class="w-full lg:w-2/3">
                                <div class="plan-section hidden" id="letter-output-section">
                                    <div class="absolute top-4 right-4 flex gap-2">
                                        <button id="copy-letter-btn" class="copy-section-btn">복사</button>
                                        <button id="edit-letter-btn" class="edit-btn">편집</button>
                                    </div>
                                    <div id="generated-letter-container" class="plan-section-content"></div>
                                </div>
                            </section>
                        </div>
                    </div>
                </div>
                <!-- Lesson Plan View -->
                <div id="lesson-view" class="hidden">
                    <h2 class="text-3xl font-bold mb-6">교수학습 지도안</h2>
                    <p class="text-gray-600">준비 중입니다.</p>
                </div>
            </main>
        </div>
        <!-- Toast Message -->
        <div id="toast" class="fixed bottom-10 right-10 bg-gray-900 text-white py-2 px-5 rounded-lg shadow-lg opacity-0 transition-opacity duration-300">
            복사되었습니다!
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, getDocs, doc, getDoc, deleteDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDCeJPDQUNi-KmJ9DhkTRIu-9t2PGZCpt0",
            authDomain: "mansungcoin-c6e06.firebaseapp.com",
            databaseURL: "https://mansungcoin-c6e06-default-rtdb.firebaseio.com",
            projectId: "mansungcoin-c6e06",
            storageBucket: "mansungcoin-c6e06.firebasestorage.app",
            messagingSenderId: "704809284946",
            appId: "1:704809284946:web:54e4788586e6c68de1768b"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global DOM Elements
        const authView = document.getElementById('auth-view');
        const mainAppView = document.getElementById('main-app-view');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const loginBtn = document.getElementById('login-btn');
        const signupBtn = document.getElementById('signup-btn');
        const googleLoginBtn = document.getElementById('google-login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const authError = document.getElementById('auth-error');
        const userEmailSpan = document.getElementById('user-email');
        const homeUserEmailSpan = document.getElementById('home-user-email');
        const navHome = document.getElementById('nav-home');
        const navPlan = document.getElementById('nav-plan');
        const navTable = document.getElementById('nav-table');
        const navOfficial = document.getElementById('nav-official');
        const navLetter = document.getElementById('nav-letter');
        const navLesson = document.getElementById('nav-lesson');
        const homeLink = document.getElementById('home-link');
        const homeView = document.getElementById('home-view');
        const planView = document.getElementById('plan-view');
        const tableView = document.getElementById('table-view');
        const officialView = document.getElementById('official-view');
        const letterView = document.getElementById('letter-view');
        const lessonView = document.getElementById('lesson-view');
        const goToGeneratorBtn = document.getElementById('go-to-generator-btn');
        const goToTableBtn = document.getElementById('go-to-table-btn');
        const recentPlansList = document.getElementById('recent-plans-list');
        const form = document.getElementById('plan-form');
        const generateBtn = document.getElementById('generate-btn');
        const initialMessage = document.getElementById('initial-message');
        const loadingIndicator = document.getElementById('loading-indicator');
        const resultSection = document.getElementById('result-section');
        const planContainer = document.getElementById('generated-plan-container');
        const planTitle = document.getElementById('plan-title');
        const planTitleInput = document.getElementById('plan-title-input');
        const mergePlanBtn = document.getElementById('merge-plan-btn');
        const editTitleBtn = document.getElementById('edit-title-btn');
        const errorMessageDiv = document.getElementById('error-message');
        const errorDetails = document.getElementById('error-details');
        const toast = document.getElementById('toast');
        const outputPanel = document.getElementById('output-panel');
        const schoolLevelButtons = document.getElementById('school-level-buttons');
        const planTypeButtons = document.getElementById('plan-type-buttons');
        const customPlanTypeInput = document.getElementById('custom-plan-type');
        const keywordsContainer = document.getElementById('keywords-container');
        const addKeywordBtn = document.getElementById('add-keyword-btn');
        const formError = document.getElementById('form-error');
        const planModifySection = document.getElementById('plan-modify-section');
        const planModifyForm = document.getElementById('plan-modify-form');
        const planModifyTarget = document.getElementById('plan-modify-target');
        const planModifyPrompt = document.getElementById('plan-modify-prompt');
        const planSavedList = document.getElementById('plan-saved-list');
        let currentPlanId = null;

        const tableForm = document.getElementById('table-form');
        const tableTopic = document.getElementById('table-topic');
        const tableOutputSection = document.getElementById('table-output-section');
        let generatedTableContainer = document.getElementById('generated-table-container');
        const editTableBtn = document.getElementById('edit-table-btn');
        const copyTableBtn = document.getElementById('copy-table-btn');
        const tableModifySection = document.getElementById('table-modify-section');
        const tableModifyForm = document.getElementById('table-modify-form');
        const tableModifyPrompt = document.getElementById('table-modify-prompt');
        const tableSavedList = document.getElementById('table-saved-list');
        let currentTableMarkdown = '';
        let isEditingTable = false;
        let currentTableId = null;

        const letterForm = document.getElementById('letter-form');
        const letterTopic = document.getElementById('letter-topic');
        const letterOutputSection = document.getElementById('letter-output-section');
        let generatedLetterContainer = document.getElementById('generated-letter-container');
        const editLetterBtn = document.getElementById('edit-letter-btn');
        const copyLetterBtn = document.getElementById('copy-letter-btn');
        const letterModifySection = document.getElementById('letter-modify-section');
        const letterModifyForm = document.getElementById('letter-modify-form');
        const letterModifyPrompt = document.getElementById('letter-modify-prompt');
        const letterSavedList = document.getElementById('letter-saved-list');
        let currentLetterMarkdown = '';
        let isEditingLetter = false;
        let currentLetterId = null;

        const officialForm = document.getElementById('official-form');
        const officialTopic = document.getElementById('official-topic');
        const officialReference = document.getElementById('official-reference');
        const attachmentsContainer = document.getElementById('attachments-container');
        const addAttachmentBtn = document.getElementById('add-attachment-btn');
        const officialOutputSection = document.getElementById('official-output-section');
        let generatedOfficialContainer = document.getElementById('generated-official-container');
        const editOfficialBtn = document.getElementById('edit-official-btn');
        const copyOfficialBtn = document.getElementById('copy-official-btn');
        const officialModifySection = document.getElementById('official-modify-section');
        const officialModifyForm = document.getElementById('official-modify-form');
        const officialModifyPrompt = document.getElementById('official-modify-prompt');
        const officialTitle = document.getElementById('official-title');
        const officialTitleInput = document.getElementById('official-title-input');
        const editOfficialTitleBtn = document.getElementById('edit-official-title-btn');
        const copyOfficialTitleBtn = document.getElementById('copy-official-title-btn');
        const officialSavedList = document.getElementById('official-saved-list');
        let currentOfficialTitle = '';
        let currentOfficialMarkdown = '';
        let isEditingOfficial = false;
        let currentOfficialId = null;

        const views = { home: homeView, plan: planView, table: tableView, official: officialView, letter: letterView, lesson: lessonView };
        const navLinks = { home: navHome, plan: navPlan, table: navTable, official: navOfficial, letter: navLetter, lesson: navLesson };

        let statsChartInstance = null;

        // --- AUTHENTICATION ---
        onAuthStateChanged(auth, user => {
            if (user) {
                authView.classList.add('hidden');
                mainAppView.classList.remove('hidden');
                mainAppView.classList.add('flex');
                const userEmail = user.displayName || user.email;
                userEmailSpan.textContent = userEmail;
                homeUserEmailSpan.textContent = userEmail;
                switchView('home');
            } else {
                authView.classList.remove('hidden');
                mainAppView.classList.add('hidden');
                mainAppView.classList.remove('flex');
            }
        });

        const handleAuthError = (error) => {
            console.error("Authentication Error:", error);
            let errorMessage = "오류가 발생했습니다. 다시 시도해주세요.";
            switch (error.code) {
                case 'auth/invalid-email': errorMessage = '유효하지 않은 이메일 주소입니다.'; break;
                case 'auth/user-not-found':
                case 'auth/invalid-credential': errorMessage = '가입되지 않은 이메일이거나 비밀번호가 틀렸습니다.'; break;
                case 'auth/wrong-password': errorMessage = '비밀번호가 틀렸습니다.'; break;
                case 'auth/email-already-in-use': errorMessage = '이미 사용 중인 이메일입니다.'; break;
                case 'auth/weak-password': errorMessage = '비밀번호는 6자 이상이어야 합니다.'; break;
                case 'auth/popup-closed-by-user': errorMessage = '로그인 팝업이 닫혔습니다.'; break;
                case 'auth/unauthorized-domain': errorMessage = "로그인이 허용되지 않은 도메인입니다. Firebase 콘솔 > Authentication > 설정 > 승인된 도메인에 'googleusercontent.com'을 추가해주세요."; break;
                case 'auth/identity-toolkit-api-has-not-been-used-in-project': errorMessage = "Firebase 프로젝트의 인증 API가 활성화되지 않았습니다. Google Cloud 콘솔에서 'Identity Toolkit API'를 활성화해주세요."; break;
                default: errorMessage = `로그인에 실패했습니다. (${error.code})`; break;
            }
            authError.textContent = errorMessage;
            authError.classList.remove('hidden');
        };
        
        signupBtn.addEventListener('click', async () => {
             authError.classList.add('hidden');
             try { await createUserWithEmailAndPassword(auth, emailInput.value, passwordInput.value); } catch (error) { handleAuthError(error); }
        });

        loginBtn.addEventListener('click', async () => {
            authError.classList.add('hidden');
            try { await signInWithEmailAndPassword(auth, emailInput.value, passwordInput.value); } catch (error) { handleAuthError(error); }
        });

        googleLoginBtn.addEventListener('click', async () => {
            authError.classList.add('hidden');
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                handleAuthError(error);
            }
        });

        logoutBtn.addEventListener('click', () => signOut(auth));

        // --- APP NAVIGATION ---
        const switchView = (view) => {
            const targetView = view || 'home';
            Object.entries(views).forEach(([key, section]) => {
                section.classList.toggle('hidden', key !== targetView);
                navLinks[key].classList.toggle('active', key === targetView);
            });
            window.location.hash = targetView;
            if (targetView === 'plan' && planModifySection) {
                planModifySection.classList.add('hidden');
            }
            if (targetView === 'home' || targetView === 'plan') {
                loadAndDisplayPlans();
            }
            if (targetView === 'table') {
                loadAndDisplayItems('tables', tableSavedList, viewTable);
            }
            if (targetView === 'official') {
                loadAndDisplayItems('officials', officialSavedList, viewOfficial);
            }
            if (targetView === 'letter') {
                loadAndDisplayItems('letters', letterSavedList, viewLetter);
            }
        };

        navHome.addEventListener('click', (e) => { e.preventDefault(); switchView('home'); });
        homeLink.addEventListener('click', (e) => { e.preventDefault(); switchView('home'); });
        navPlan.addEventListener('click', (e) => { e.preventDefault(); switchView('plan'); });
        navTable.addEventListener('click', (e) => { e.preventDefault(); switchView('table'); });
        navOfficial.addEventListener('click', (e) => { e.preventDefault(); switchView('official'); });
        navLetter.addEventListener('click', (e) => { e.preventDefault(); switchView('letter'); });
        navLesson.addEventListener('click', (e) => { e.preventDefault(); switchView('lesson'); });
        goToGeneratorBtn.addEventListener('click', () => switchView('plan'));
        goToTableBtn.addEventListener('click', () => switchView('table'));

        // --- TABLE GENERATOR LOGIC ---
        if (tableForm) {
            tableForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const user = auth.currentUser;
                if (!user) return;
                let topic = tableTopic.value.trim();
                const rowMatch = topic.match(/\[행\]\s*(\d+)/);
                const colMatch = topic.match(/\[열\]\s*(\d+)/);
                const rows = rowMatch ? rowMatch[1] : null;
                const cols = colMatch ? colMatch[1] : null;
                topic = topic.replace(/\[행\]\s*\d+/, '').replace(/\[열\]\s*\d+/, '').trim();
                if (!topic) return;

                let prompt = `다음 조건에 맞는 표를 마크다운 형식으로 작성해줘.\n주제: ${topic}`;
                if (rows) prompt += `\n행 수: ${rows}`;
                if (cols) prompt += `\n열 수: ${cols}`;
                prompt += `\n추가 설명 없이 표만 출력해.`;
                try {
                    const response = await fetch('/.netlify/functions/generatePlan', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt })
                    });
                    const result = await response.json();
                    if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                        currentTableMarkdown = extractMarkdownFromText(result.candidates[0].content.parts[0].text);
                        generatedTableContainer.innerHTML = renderMarkdownTable(currentTableMarkdown);
                        tableOutputSection.classList.remove('hidden');
                        tableModifySection.classList.remove('hidden');
                        const docRef = await addDoc(collection(db, "users", user.uid, "tables"), {
                            title: topic,
                            createdAt: serverTimestamp(),
                            rawContent: currentTableMarkdown
                        });
                        currentTableId = docRef.id;
                        loadAndDisplayItems('tables', tableSavedList, viewTable);
                    }
                } catch (err) {
                    console.error('Table Generation Error:', err);
                }
            });

            editTableBtn.addEventListener('click', () => {
                if (!currentTableMarkdown) return;
                if (!isEditingTable) {
                    isEditingTable = true;
                    editTableBtn.textContent = '완료';
                    editTableBtn.classList.add('bg-green-500', 'text-white');
                    const textarea = document.createElement('textarea');
                    textarea.id = 'table-editor';
                    textarea.className = 'w-full h-48 p-2 border rounded-md font-mono text-sm';
                    textarea.value = currentTableMarkdown;
                    generatedTableContainer.replaceWith(textarea);
                } else {
                    const textarea = document.getElementById('table-editor');
                    currentTableMarkdown = textarea.value;
                    const newDiv = document.createElement('div');
                    newDiv.id = 'generated-table-container';
                    newDiv.className = 'plan-section-content overflow-x-auto';
                    newDiv.innerHTML = renderMarkdownTable(currentTableMarkdown);
                    textarea.replaceWith(newDiv);
                    generatedTableContainer = newDiv;
                    isEditingTable = false;
                    editTableBtn.textContent = '편집';
                    editTableBtn.classList.remove('bg-green-500', 'text-white');
                    saveCurrentTable();
                }
            });

            copyTableBtn.addEventListener('click', () => {
                if (!currentTableMarkdown) return;
                const htmlToCopy = markdownTableToHtmlClipboard(currentTableMarkdown);
                copyToClipboard(htmlToCopy, true);
            });

            tableModifyForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!currentTableMarkdown) return;
                const userPrompt = tableModifyPrompt.value.trim();
                if (!userPrompt) return;
                const prompt = `다음 마크다운 표를 사용자의 요청에 맞게 수정해줘.\n표:\n${currentTableMarkdown}\n\n요청: ${userPrompt}\n\n수정된 표를 마크다운 표로만 출력해줘.`;
                try {
                    const response = await fetch('/.netlify/functions/generatePlan', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt })
                    });
                    const result = await response.json();
                    if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                        currentTableMarkdown = extractMarkdownFromText(result.candidates[0].content.parts[0].text);
                        if (isEditingTable) {
                            const textarea = document.getElementById('table-editor');
                            textarea.value = currentTableMarkdown;
                        } else {
                            generatedTableContainer.innerHTML = renderMarkdownTable(currentTableMarkdown);
                        }
                        saveCurrentTable();
                    }
                } catch (err) {
                    console.error('Table Modify Error:', err);
                }
            });
        }

        // --- OFFICIAL DOCUMENT LOGIC ---
        if (addAttachmentBtn) {
            const addAttachmentInput = () => {
                const wrapper = document.createElement('div');
                wrapper.className = 'flex items-center gap-2';
                const input = document.createElement('input');
                input.type = 'file';
                input.className = 'block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer';
                const span = document.createElement('span');
                span.className = 'text-sm text-gray-600 flex-1';
                input.addEventListener('change', () => {
                    span.textContent = input.files[0]?.name || '';
                });
                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.className = 'text-red-500 font-bold';
                removeBtn.textContent = 'X';
                removeBtn.addEventListener('click', () => wrapper.remove());
                wrapper.appendChild(input);
                wrapper.appendChild(span);
                wrapper.appendChild(removeBtn);
                attachmentsContainer.appendChild(wrapper);
            };
            addAttachmentBtn.addEventListener('click', addAttachmentInput);
        }

        if (officialForm) {
            const officialDocExamples = `제목: 2023학년도 과학의 날 주간 행사 결과 제출
1. 관련: OO초등학교-5678(2023. 10. 15.)
2023학년도 과학의 날 주간 행사 결과를 붙임과 같이 제출합니다.

붙임  2023학년도 과학의 날 주간 행사 결과 1부.  끝.
---
제목: ○○시 학교운영위원장협의회 장학생 추천 제출
1. 관련 : 교육지원과-31899(2018.10.1.)
2. ○○시 학교운영위원장협의회 장학생 추천 의뢰에 따라 붙임과 같이 제출합니다. 

붙임  ○○시 학교운영위원장협의회 장학생 학교장 추천서(○○초) 1부.  끝.
---
제목: ○○○○학년도 돌봄교실 방과후프로그램강사 채용 공고
1. 관련: 00초등학교-2141(2019. 3. 11.) 
2. ○○○○학년도 돌봄교실 프로그램강사 채용을 위하여 붙임과 같이 공고하고자 합니다. 
붙임  ○○○○ 돌봄교실 방과후프로그램강사 채용 공고 1부.  끝.
---
제목: 20xx. 전문적 학습공동체 외부 강사 초청 연수 실시
1. 관련: OO초등학교-2101(2019. 3. 11.) 
2. 교원 전문성 신장을 위한 2019. 전문적 학습공동체 외부 강사 초청 연수를 다음과 같이 실시하고자 합니다.
  가. 일시: 2019. 5. 29.(수) 13:30~15:30(3차시)
  나. 장소: 본교 라온숲(우천시 본교 전담실)
  다. 대상: 본교 전문적 학습공동체 회원 11명
  라. 주제: 숲체험 활동 체험 및 숲 밧줄놀이 지도의 실제
  마. 강사: 권금주(숲해설가, 숲밧줄놀이 지도자)
  바. 비용
    1) 강사비 : 50,000원(기타강사에 준함)
    2) 원고료 : 105,000원(한글 7.5매로 제한).  끝.
---
제목: 20xx학년도 전문적 학습공동체 연수를 위한 협조 요청
1. 관련: 00초등학교-2141(2019. 3. 11.) 
2. 교원 전문성 신장을 위한 2019. 전문적 학습공동체 연수 의뢰를 아래와 같이 보내드리오니 귀 기관의 협조를 요청합니다.  
  가. 일 시: 2019. 3. 27.(수) 14:40 ~ 16:40 (2시간)
  나. 장 소: 00초등학교 전담실
  다. 주 제: 생태감수성 함양을 위한 00교육활동의 실제
  라. 강 사: 00초등학교 000 교사
  마. 대 상: 00초 전문적 학습공동체 『0000』 회원 00명
  바. 기 타: 강사비 및 원고비 규정에 따라 지급 예정.  끝.
---
제목: 20○○학년도 00교육 성과보고 및 종합학습발표회 안내
1. 귀교(기관)의 무궁한 발전을 기원합니다.
2. 20○○ 00교육성과보고 및 종합학습발표회 꿈과 끼를 펼치는“00 한마당 축제”를 아래와 같이 개최하오니 바쁘시더라도 참석하시어 자리를 빛내주시면 감사하겠습니다.
  가. 일 시: 20○○.11.23(금) 14:00~16:30
  나. 장 소: 00초등학교 강당
  다. 내 용: 00교육 성과보고, 작품전시회 및 학습발표회

붙임  모시는 글(프로그램) 1부.  끝.
---
제목: 2019. 전문적 학습공동체 외부 강사 초청 연수 실시
1. 관련: 00초등학교-2101(2019. 3. 11.) 
2. 환경교육 관련 교원 전문성 신장을 위한 2019. 전문적 학습공동체 외부 강사 초청 연수를 다음과 같이 실시하고자 합니다.
  가. 일시: 2019. 0. 00.(수) 14:00~16:00(3차시)
  나. 장소: 본교 전담실
  다. 대상: 본교 전문적 학습공동체 『000』회원 00명
  라. 주제:‘초록식물을 늘리고, 재활용품으로 살리고’
           (스칸디아모스 토피어리 및 양말목 공예 관련 지도방안의 실제)
  마. 비용
    1) 강사비 : 90,000원(기타강사에 준함, 60분씩 2개 강좌)
    2) 원고비 : 28,000원(2매).  끝.
---
제목: 2023학년도 AI 활용 교육 연수 보고
1. 관련: OO초등학교-1234(2023. 6. 19.)
2. 2023학년도 AI 활용 교육 연수에 대하여 붙임과 같이 보고합니다.
  가. 일자: 2023. 10. 15. (일) 14:00~16:00
  나. 장소: 본교 대강당
  다. 대상: 교직원
  라. 연수 주제: AI 활용 교육 방법 및 사례 공유

붙임  1. 2023학년도 AI 활용 교육 연수 자료 1부.
      2. 2023학년도 AI 활용 교육 연수 교직원 연수 등록부 1부.  끝.
---
제목: 2024학년도 개별화교육계획 수정 회의 보고
1. 관련: OO초등학교-1234(2023. 6. 19.)
2. 2023학년도 개별화교육계획 수정 회의에 대하여 다음과 같이 보고합니다.
  가. 일자: 2023. 10. 25. (수) 14:00~15:00
  나. 장소: 본교 회의실
  다. 참석자: 교사 및 학부모
  라. 회의 주제: 개별화교육계획 수정 및 보완

붙임  1. 2023학년도 개별화교육계획 수정 회의 자료 1부.
      2. 2023학년도 개별화교육계획 수정 회의 참석자 명단 1부.  끝.
---
제목: 어린이놀이시설 중대사고 발생 보고(○○초)
1. 관련: 어린이놀이시설 안전관리법 제22조
2. 2018.XX.XX. 우리학교에서 발생한 어린이놀이시설 중대사고 건에 대하여 다음과 같이 보고합니다.
  
  가. 사고일시: 2018.XX.XX. 00:00경
  나. 놀이시설번호: XXXXX

붙임  1. 어린이놀이시설 사고보고서(OO초) 1부.
      2. 사고현장 및 조치 사진 1부.  끝.
---
제목: 2023학년도 개별화교육지원팀 회의 계획
1. 관련: OO초등학교-1234(2023. 6. 19.)
2. 2023학년도 개별화교육지원팀 회의를 다음과 같이 실시하고자 합니다.
  가. 일자: 2023. 7. 15. (토) 10:00~12:00
  나. 장소: 본교 회의실
  다. 참석자: 개별화교육지원팀 구성원
  라. 회의 주제: 개별화교육계획 수립 및 실행 전략

붙임  1. 2023학년도 개별화교육지원팀 회의록 1부.
      2. 2023학년도 개별화교육지원팀 회의 명단 1부.  끝.
---
제목: 2023학년도 교내 체육대회 계획
1. 관련: OO초등학교-1234(2023.6.19.)
2. 2023학년도 교내 체육대회 계획을 붙임과 같이 수립하여 운영하고자 합니다.

붙임  2023학년도 교내 체육대회 계획 1부.  끝.
---
제목: 2024학년도 교원 보결수업 지원 계획
1. 관련: ○○과-21○○(20○○.○○.○.), 00초-10○○(20○○.○.○.)
2. 교원의 보결수업 기피 완화 및 책무성을 강화하고 학생의 학습권 보호 및 교육과정 운영의 적정성을 확보하고자 다음과 같이 교원 보결수업 지원 계획 수립하여 운영하고자 합니다.
  가. 적용시기: 2024.3.1.부터
  나. 주요 내용
    1) 보결수업비가 남용되지 않도록‘교체수업’을 원칙으로 함
    2) 교체수업 불가시 보결수업 배정
    3) 시간당 보결수업비: 7,000원
    4) 월 최대 보결수업비: 30,000원

 붙임  2018학년도 교원 보결 수업 지원 계획 1부.  끝. 
---
제목: 20xx학년도 학부모 상담주간 운영 계획
1. 관련: OO초등학교-1234(2023. 6. 19.)
2. 학교교육계획에 의거 학부모 상담을 통한 생활지도 및 진로지도 자료 확보를 통한 바른 품성 함양과 건전한 면학 분위기 조성을 위해 20xx년도 상반기 학부모 상담주간을 아래와 같이 계획하여 실시하고자 합니다.
3. 상담기간 : 20xx. 4. 1 (월) ~ 4. 5 (금)
4. 대상 : 전교생 대상
5. 내용 : 학습환경, 생활 등 보호자 면담-생활지도, 학교폭력 예방 및 진로지도 자료 확보
6. 추진 유의 사항
  기. 희망 가정에 한하여 대면 상담, 다과(음식) 준비 금지 당부
  나. 상담 희망 날짜, 시간, 상담요청 내용 미리 파악 

붙임  20xx학년도 학부모 상담주간 운영 계획 1부. 끝
---
제목: 20○○학년도 종합 학습발표회 계획(안)
  20○○학년도 학교교육과정 운영 계획에 의거 붙임과 같이 종합 학습발표회를  실시하고자합니다.
1. 일시: 20○○. 11.23(금) 14:00 ~
2. 장소: 00관 및 운동장 주변
3. 운영프로그램 : 학예발표회, 작품전시회
4. 주제: 꿈과 끼를 펼치는 00 한마당 축제
5. 세부추진사항 : 붙임 참조

붙임   20○○ 종합학습발표회 운영 계획(안) 1부. 끝. 
---
제목: 20○○학년도 입학식 계획
  20○○ 학교 교육과정 운영 계획에 의거 아래와 같이 입학식을 운영하고자 합니다.
1. 일시: 20○○. 3. 2(금) 10:00 ~
2. 장소: 00관
3. 대상: 신입생 000명, 재학생 6학년 2학급
4. 입학식순 : 첨부
           
붙임: 1. 입학식순 1부
      2. 입학허가서 1부
      3. 재학생 환영사 1부
      4. 신입생 답사 1부. 끝.
---
제목: 귀국학생 재취학에 따른 조기진급, 졸업, 진학 평가위원회 개최
1. 관련: 초․ 중등교육법시행령 제 29조 (유예자 등의 학적관리) 2항
2. 의무교육을 유예 ․ 면제 ․ 정원외 관리 중인 학생이 재취학 하고자 하여 조기진급․졸업․진학 평가위원회의를 다음과 같이 개최하고자 합니다.
  가. 목 적 : 해외 거주로 인하여 귀국 후 교과, 언어, 학생 생활에 있어 학생의                          수준을 파악하여 학교생활에 잘 적응할 수 있도록 한다. 
  나. 내 용 
    1) 조기진급․졸업․진학 평가위원회를 구성하며, 위원은 본교에 재직 중인 교원 중 5인 이내로 구성하며, 위원장은 교장으로 한다.
    2) 평가교과는 2-3학년은 국어, 수학 교과를 4-6학년은 국어, 수학, 사회, 과학 내용             중 조기진급․졸업․진학 평가위원회의 출제 문항을 평가한다.  
    3) 교과별 이수인정 점수는 60점 이상으로 한다. 
    4) 학교장이 학생을 면담한 후 교과목별 이수인정 평가결과에 따라 학년을 결정한다. 
    5) 귀국학생이 타학교 재학 중에 유예, 면제, 정원외 관리되었을 때는 타학교에서             서류를 송부받아 생활기록부에 첨부토록 한다.
  다. 절 차
    귀국학생 접수 → 교과목별 이수인정 평가 → 조기진급․졸업․진학 평가위원회의 → 학교장 결재 → 학년반 지정 → 타학교 재학이 있는 경우 서류 송부요청
 
붙임  1. 3학년 교과목별 이수인정 평가지 1부.
      2. 4학년 교과목별 이수인정 평가지 1부. 끝.
---
제목: ○○시 학교운영위원장협의회 장학생 선발을 위한 장학생 선정위원회 개최
1. 관련 : 교육지원과-31889(2000.10.1.)
2. ○○시 학교운영위원장협의회의 장학생 추천 의뢰에 따라 장학생 선정위원회를 개최하고자 합니다.
  가. 일시 및 장소 : 2018.10.2.(화) 12:30~00:00, 교무실
  나. 참석 대상 : 시상관리위원(10명)
  다. 협의 내용 : 장학생 추천자 선정 1명
  라. 추천 대상자 선정 기준
    1) 학교발전에 이바지한 학생
    2) 학교생활이 타의 모범이 되는 학생
    3) 기타 가정 및 개인 형편상 도움이 필요한 학생
    4) 장학금 기수여자 제외.  끝.
---
제목: 20○○학년도 학부모회 총회 개최
  20○○학년도 학부모회 총회를 다음과 같이 개최하고자 합니다.
1. 일시 : 20○○. 3. 19(화). 오후 6시(시간 엄수 바랍니다.) 
2. 대상 : 학부모
3. 장소 : 본교 강당
4. 행사내용
  가. 20○○학년도 학교교육과정 설명회
  나. 녹색어머니회 발대식
  다. 위촉장수여(명예사서도우미, ‘엄마 책 읽어 주세요’ 강사)
5. 학부모 연수
  가. 학교폭력 예방 연수
  나. 교원능력 개발 평가 관련 연수 
6. 총회 안건 
  가. 20○○학년도 학부모회임원 선출(회장, 감사2)
  나. 교육 상담(담임과의 대화 시간 운영)

붙임  1. 학부모회 총회 안내장 1부.
      2. 학부모총회 회순 1부.
      3. 학부모 총회 현수막(안) 1부. 끝.
---
제목: 20○○학년도 졸업생 시상규정 개정을 위한 교무기획위원회 개최
  20○○학년도 졸업생 시상규정 개정 관련 협의를 위한 교무기획위원회를 아래와 같이 개최하고자 합니다.
1. 일시: 20○○. 3. 18(월), 15:00
2. 장소: 교무실
3. 참석대상: 교무기획위원회 위원장(교감 000), 교무부장, 6학년 각 반 담임교사, 시상관리 업무담당자 등 11명
4. 안건: 20○○학년도 졸업생 시상 규정 개정
※ 참석대상자는 20○○학년도 졸업생 시상규정(붙임문서) 숙독 후 참석

붙임   20○○학년도 졸업생 시상규정_00초 1부.  끝.`;
            officialForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const user = auth.currentUser;
                if (!user) return;
                const topic = officialTopic.value.trim();
                if (!topic) return;
                const referenceText = officialReference.value.trim();
                let agency = '', docNumber = '', date = '';
                if (referenceText) {
                    try {
                        const parsePrompt = `다음 문장에서 관련 기관, 문서 번호, 날짜를 JSON으로 추출해줘. 포맷: {"agency":"", "docNumber":"", "date":""} 문장: ${referenceText}`;
                        const parseRes = await fetch('/.netlify/functions/generatePlan', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ prompt: parsePrompt })
                        });
                        const parseResult = await parseRes.json();
                        const text = parseResult.candidates?.[0]?.content?.parts?.[0]?.text;
                        if (text) {
                            const jsonMatch = text.match(/\{[\s\S]*\}/);
                            if (jsonMatch) {
                                const obj = JSON.parse(jsonMatch[0]);
                                agency = obj.agency || '';
                                docNumber = obj.docNumber || '';
                                date = obj.date || '';
                            }
                        }
                    } catch (err) {
                        console.error('Evidence Parse Error:', err);
                    }
                }
                const attachments = Array.from(attachmentsContainer.querySelectorAll('input[type="file"]'))
                    .map(input => input.files[0]?.name)
                    .filter(Boolean);

                let prompt = `다음 공문서 예시를 참고하여 공문서 기안을 작성해줘.\n예시:\n${officialDocExamples}\n\n주제: ${topic}`;
                if (agency || docNumber || date) prompt += `\n근거: ${agency}-${docNumber}(${date})`;
                if (attachments.length) prompt += `\n첨부파일: ${attachments.join(', ')}`;
                prompt += `\n형식:\n제목 ${topic}\n1. 관련: [근거]\n2. ${topic}을 반영한 내용`;
                if (attachments.length > 1) {
                    const attachmentList = attachments
                        .map((a, idx) => `${idx + 1}. ${a} 1부.`)
                        .join('\n      ');
                    prompt += `\n\n붙임  ${attachmentList} 끝.`;
                } else if (attachments.length === 1) {
                    prompt += `\n\n붙임 ${attachments[0]} 1부. 끝.`;
                } else {
                    prompt += `\n\n끝.`;
                }
                prompt += `\n근거 정보가 없으면 '1. 관련:' 항목은 생략하고, 첨부파일이 없으면 붙임 부분은 생략해.`;
                if (attachments.length > 1) {
                    prompt += ` 첨부파일이 여러 개인 경우 번호를 붙여 구분해.`;
                }
                prompt += ` 제목은 첫 줄에만 작성해. 추가 설명 없이 마크다운으로 작성해.`;

                try {
                    const response = await fetch('/.netlify/functions/generatePlan', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt })
                    });
                    const result = await response.json();
                    if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                        const fullText = extractMarkdownFromText(result.candidates[0].content.parts[0].text);
                        const lines = fullText.split('\n');
                        currentOfficialTitle = lines.shift().trim();
                        currentOfficialMarkdown = lines.join('\n').trim();
                        officialTitle.textContent = currentOfficialTitle;
                        generatedOfficialContainer.innerHTML = parseMarkdown(currentOfficialMarkdown);
                        officialOutputSection.classList.remove('hidden');
                        officialModifySection.classList.remove('hidden');
                        officialTopic.value = '';
                        officialReference.value = '';
                        attachmentsContainer.innerHTML = '';
                        const docRef = await addDoc(collection(db, "users", user.uid, "officials"), {
                            title: currentOfficialTitle,
                            createdAt: serverTimestamp(),
                            rawContent: currentOfficialMarkdown
                        });
                        currentOfficialId = docRef.id;
                        loadAndDisplayItems('officials', officialSavedList, viewOfficial);
                    }
                } catch (err) {
                    console.error('Official Generation Error:', err);
                }
            });

            editOfficialBtn.addEventListener('click', () => {
                if (!currentOfficialMarkdown) return;
                if (!isEditingOfficial) {
                    isEditingOfficial = true;
                    editOfficialBtn.textContent = '완료';
                    editOfficialBtn.classList.add('bg-green-500', 'text-white');
                    const textarea = document.createElement('textarea');
                    textarea.id = 'official-editor';
                    textarea.className = 'w-full h-48 p-2 border rounded-md font-mono text-sm';
                    textarea.value = currentOfficialMarkdown;
                    generatedOfficialContainer.replaceWith(textarea);
                } else {
                    const textarea = document.getElementById('official-editor');
                    currentOfficialMarkdown = textarea.value;
                    const newDiv = document.createElement('div');
                    newDiv.id = 'generated-official-container';
                    newDiv.className = 'plan-section-content';
                    newDiv.innerHTML = parseMarkdown(currentOfficialMarkdown);
                    textarea.replaceWith(newDiv);
                    generatedOfficialContainer = newDiv;
                    isEditingOfficial = false;
                    editOfficialBtn.textContent = '편집';
                    editOfficialBtn.classList.remove('bg-green-500', 'text-white');
                    saveCurrentOfficial();
                }
            });

            copyOfficialBtn.addEventListener('click', () => {
                if (!currentOfficialMarkdown && !currentOfficialTitle) return;
                const htmlToCopy = markdownToHtml(`${currentOfficialTitle}\n${currentOfficialMarkdown}`);
                copyToClipboard(htmlToCopy, true);
            });

            editOfficialTitleBtn.addEventListener('click', () => {
                const isEditing = editOfficialTitleBtn.textContent === '완료';
                if (isEditing) {
                    officialTitle.textContent = officialTitleInput.value;
                    officialTitle.classList.remove('hidden');
                    officialTitleInput.classList.add('hidden');
                    editOfficialTitleBtn.textContent = '편집';
                    editOfficialTitleBtn.classList.remove('bg-green-500', 'text-white');
                    currentOfficialTitle = officialTitle.textContent;
                    saveCurrentOfficial();
                } else {
                    officialTitleInput.value = officialTitle.textContent;
                    officialTitle.classList.add('hidden');
                    officialTitleInput.classList.remove('hidden');
                    officialTitleInput.focus();
                    editOfficialTitleBtn.textContent = '완료';
                    editOfficialTitleBtn.classList.add('bg-green-500', 'text-white');
                }
            });

            copyOfficialTitleBtn.addEventListener('click', () => {
                if (!officialTitle.textContent) return;
                copyToClipboard(officialTitle.textContent);
            });

            officialModifyForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!currentOfficialMarkdown && !currentOfficialTitle) return;
                const userPrompt = officialModifyPrompt.value.trim();
                if (!userPrompt) return;
                const currentContent = `${currentOfficialTitle}\n${currentOfficialMarkdown}`;
                const prompt = `다음 공문서 기안을 사용자의 요청에 맞게 수정해줘.\n공문서:\n${currentContent}\n\n요청: ${userPrompt}\n\n수정된 공문서를 동일한 형식(첫 줄은 제목)으로 마크다운으로 출력해줘.`;
                try {
                    const response = await fetch('/.netlify/functions/generatePlan', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt })
                    });
                    const result = await response.json();
                    if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                        const fullText = extractMarkdownFromText(result.candidates[0].content.parts[0].text);
                        const lines = fullText.split('\n');
                        currentOfficialTitle = lines.shift().trim();
                        currentOfficialMarkdown = lines.join('\n').trim();
                        officialTitle.textContent = currentOfficialTitle;
                        if (isEditingOfficial) {
                            const textarea = document.getElementById('official-editor');
                            textarea.value = currentOfficialMarkdown;
                        } else {
                            generatedOfficialContainer.innerHTML = parseMarkdown(currentOfficialMarkdown);
                        }
                        saveCurrentOfficial();
                        officialModifyPrompt.value = '';
                    }
                } catch (err) {
                    console.error('Official Modify Error:', err);
                }
            });
        }

        if (letterForm) {
            let letterExamples = '';
            fetch('/letter_examples.txt')
                .then(response => response.text())
                .then(text => { letterExamples = text; });

            letterForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const user = auth.currentUser;
                if (!user) return;
                const topic = letterTopic.value.trim();
                if (!topic) return;
                const prompt = `다음 가정통신문 예시를 참고하여 가정통신문을 마크다운 형식으로 작성해줘.\n예시:\n${letterExamples}\n\n주제: ${topic}\n추가 설명 없이 내용만 출력해.`;
                try {
                    const response = await fetch('/.netlify/functions/generatePlan', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt })
                    });
                    const result = await response.json();
                    if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                        currentLetterMarkdown = extractMarkdownFromText(result.candidates[0].content.parts[0].text);
                        generatedLetterContainer.innerHTML = parseMarkdown(currentLetterMarkdown);
                        letterOutputSection.classList.remove('hidden');
                        letterModifySection.classList.remove('hidden');
                        letterTopic.value = '';
                        const docRef = await addDoc(collection(db, "users", user.uid, "letters"), {
                            title: topic,
                            createdAt: serverTimestamp(),
                            rawContent: currentLetterMarkdown
                        });
                        currentLetterId = docRef.id;
                        loadAndDisplayItems('letters', letterSavedList, viewLetter);
                    }
                } catch (err) {
                    console.error('Letter Generation Error:', err);
                }
            });

            editLetterBtn.addEventListener('click', () => {
                if (!currentLetterMarkdown) return;
                if (!isEditingLetter) {
                    isEditingLetter = true;
                    editLetterBtn.textContent = '완료';
                    editLetterBtn.classList.add('bg-green-500', 'text-white');
                    const textarea = document.createElement('textarea');
                    textarea.id = 'letter-editor';
                    textarea.className = 'w-full h-48 p-2 border rounded-md font-mono text-sm';
                    textarea.value = currentLetterMarkdown;
                    generatedLetterContainer.replaceWith(textarea);
                } else {
                    const textarea = document.getElementById('letter-editor');
                    currentLetterMarkdown = textarea.value;
                    const newDiv = document.createElement('div');
                    newDiv.id = 'generated-letter-container';
                    newDiv.className = 'plan-section-content';
                    newDiv.innerHTML = parseMarkdown(currentLetterMarkdown);
                    textarea.replaceWith(newDiv);
                    generatedLetterContainer = newDiv;
                    isEditingLetter = false;
                    editLetterBtn.textContent = '편집';
                    editLetterBtn.classList.remove('bg-green-500', 'text-white');
                    saveCurrentLetter();
                }
            });

            copyLetterBtn.addEventListener('click', () => {
                if (!currentLetterMarkdown) return;
                const htmlToCopy = currentLetterMarkdown.includes('|') ?
                    markdownTableToHtmlClipboard(currentLetterMarkdown) :
                    markdownToHtml(currentLetterMarkdown);
                copyToClipboard(htmlToCopy, true);
            });

            letterModifyForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!currentLetterMarkdown) return;
                const userPrompt = letterModifyPrompt.value.trim();
                if (!userPrompt) return;
                const prompt = `다음 가정통신문을 사용자의 요청에 맞게 수정해줘.\n내용:\n${currentLetterMarkdown}\n\n요청: ${userPrompt}\n\n수정된 가정통신문을 마크다운 형식으로 출력해줘.`;
                try {
                    const response = await fetch('/.netlify/functions/generatePlan', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt })
                    });
                    const result = await response.json();
                    if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                        currentLetterMarkdown = extractMarkdownFromText(result.candidates[0].content.parts[0].text);
                        if (isEditingLetter) {
                            const textarea = document.getElementById('letter-editor');
                            textarea.value = currentLetterMarkdown;
                        } else {
                            generatedLetterContainer.innerHTML = parseMarkdown(currentLetterMarkdown);
                        }
                        saveCurrentLetter();
                        letterModifyPrompt.value = '';
                    }
                } catch (err) {
                    console.error('Letter Modify Error:', err);
                }
            });
        }

        // --- CHART LOGIC ---
        const updateStatsChart = (plans) => {
            const statsCanvas = document.getElementById('statsChart');
            const chartContainer = document.getElementById('stats-chart-container');
            const ctx = statsCanvas.getContext('2d');

            if (statsChartInstance) {
                statsChartInstance.destroy();
                statsChartInstance = null;
            }
            
            const existingMessage = chartContainer.querySelector('.no-data-message');
            if (existingMessage) existingMessage.remove();
            statsCanvas.style.display = 'block';

            if (!plans || plans.length === 0) {
                statsCanvas.style.display = 'none';
                const noDataMessage = document.createElement('div');
                noDataMessage.className = 'no-data-message text-center text-gray-500 flex items-center justify-center h-full';
                noDataMessage.textContent = '생성된 계획서 없음';
                chartContainer.appendChild(noDataMessage);
                return;
            }

            const standardTypes = ['학교폭력 예방 교육 계획', '진로 체험 활동 계획', '디지털 리터러시 교육 계획', '기초학력 향상 지원 계획', '다문화 교육 활동 계획', '교육과정 운영계획'];
            const stats = { '기타': 0 };
            standardTypes.forEach(t => stats[t] = 0);

            plans.forEach(plan => {
                if (standardTypes.includes(plan.planType)) {
                    stats[plan.planType]++;
                } else {
                    stats['기타']++;
                }
            });

            const chartData = Object.values(stats).filter(count => count > 0);
            const chartLabels = Object.keys(stats).filter(type => stats[type] > 0);
            
            const shortLabels = chartLabels.map(label => {
                if(label === '기타') return '기타';
                if(label.includes(' ')) return label.split(' ')[0];
                return label;
            });

            statsChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: shortLabels,
                    datasets: [{
                        label: '계획서 종류',
                        data: chartData,
                        backgroundColor: ['#7A9D54', '#A8C292', '#E0A75E', '#F1DDBF', '#D4A5A5', '#8B9A46', '#C6A9A3'],
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom', labels: { padding: 15, font: { family: "'Noto Sans KR', sans-serif" } } } }
                }
            });
        };

        // --- FIRESTORE & DATA HANDLING ---
        const loadAndDisplayPlans = async () => {
            const user = auth.currentUser;
            if (!user) return;
            
            const plansCollectionRef = collection(db, "users", user.uid, "plans");
            const q = query(plansCollectionRef);
            
            try {
                const querySnapshot = await getDocs(q);
                const plans = [];
                querySnapshot.forEach((doc) => {
                    plans.push({ id: doc.id, ...doc.data() });
                });

                plans.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));
                updateStatsChart(plans);

                const populateList = (container, planList) => {
                    container.innerHTML = '';
                    if (planList.length === 0) {
                        container.innerHTML = `<p class="text-gray-500 text-center py-4">아직 생성된 계획서가 없습니다.</p>`;
                        return;
                    }
                    planList.forEach((plan) => {
                        const planElement = document.createElement('div');
                        planElement.className = 'p-4 border rounded-md hover:bg-gray-50 transition-colors flex justify-between items-center';
                        planElement.innerHTML = `
                            <div>
                                <p class="font-semibold">${plan.title}</p>
                                <p class="text-sm text-gray-500">생성일: ${plan.createdAt ? new Date(plan.createdAt.toDate()).toLocaleDateString() : '날짜 없음'}</p>
                            </div>
                            <div class="flex items-center gap-2">
                                <button class="rename-plan-btn text-sm font-medium text-green-600 hover:underline" data-id="${plan.id}">수정</button>
                                <button class="copy-plan-btn text-sm font-medium text-purple-600 hover:underline" data-id="${plan.id}">복사</button>
                                <button class="view-plan-btn text-sm font-medium text-blue-600 hover:underline" data-id="${plan.id}">보기</button>
                                <button class="delete-plan-btn text-sm font-medium text-red-600 hover:underline" data-id="${plan.id}">삭제</button>
                            </div>
                        `;
                        container.appendChild(planElement);
                    });
                };
                
                populateList(recentPlansList, plans.slice(0, 5));
                if (planSavedList) {
                    populateList(planSavedList, plans);
                }

                document.querySelectorAll('.view-plan-btn').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const user = auth.currentUser;
                        if (!user) return;
                        const planId = e.target.dataset.id;
                        const docRef = doc(db, "users", user.uid, "plans", planId);
                        const docSnap = await getDoc(docRef);
                        if (docSnap.exists()) {
                            const planToView = docSnap.data();
                            switchView('plan');
                            displayContent(planToView.rawContent, planToView.title);
                            currentPlanId = planId;
                            outputPanel.scrollIntoView({ behavior: 'smooth' });
                        }
                    });
                });
                
                document.querySelectorAll('.delete-plan-btn').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const user = auth.currentUser;
                        if (!user) return;
                        try {
                            const buttonEl = e.currentTarget;
                            buttonEl.disabled = true;
                            await deleteDoc(doc(db, "users", user.uid, "plans", buttonEl.dataset.id));
                            loadAndDisplayPlans();
                        } catch (error) {
                            console.error("Error deleting plan:", error);
                        }
                    });
                });

                document.querySelectorAll('.rename-plan-btn').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const user = auth.currentUser;
                        if (!user) return;
                        const planId = e.target.dataset.id;
                        const targetPlan = plans.find(p => p.id === planId);
                        const newName = prompt('새 이름을 입력하세요', targetPlan?.title || '');
                        if (newName && newName.trim()) {
                            await updateDoc(doc(db, "users", user.uid, "plans", planId), { title: newName.trim() });
                            loadAndDisplayPlans();
                        }
                    });
                });

                document.querySelectorAll('.copy-plan-btn').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const user = auth.currentUser;
                        if (!user) return;
                        const planId = e.target.dataset.id;
                        const plan = plans.find(p => p.id === planId);
                        if (!plan) return;
                        const baseTitle = plan.title.replace(/\(복사본\d+\)$/,'');
                        let maxCopy = 0;
                        plans.forEach(p => {
                            const match = p.title.match(new RegExp(`^${baseTitle}\\(복사본(\\d+)\\)$`));
                            if (match) maxCopy = Math.max(maxCopy, parseInt(match[1]));
                        });
                        const newTitle = `${baseTitle}(복사본${maxCopy + 1})`;
                        const { id: _id, createdAt: _createdAt, ...rest } = plan;
                        await addDoc(collection(db, "users", user.uid, "plans"), {
                            ...rest,
                            title: newTitle,
                            createdAt: serverTimestamp(),
                        });
                        loadAndDisplayPlans();
                    });
                });
            } catch (error) {
                console.error("Error loading plans:", error);
                recentPlansList.innerHTML = `<p class="text-red-500 text-center py-4">계획서를 불러오는 중 오류가 발생했습니다.</p>`;
                if (planSavedList) planSavedList.innerHTML = `<p class="text-red-500 text-center py-4">계획서를 불러오는 중 오류가 발생했습니다.</p>`;
                updateStatsChart([]);
            }
        };

        const loadAndDisplayItems = async (type, container, viewHandler) => {
            const user = auth.currentUser;
            if (!user || !container) return;
            const colRef = collection(db, "users", user.uid, type);
            const q = query(colRef);
            try {
                const snap = await getDocs(q);
                const items = [];
                snap.forEach((doc) => items.push({ id: doc.id, ...doc.data() }));
                items.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));
                container.innerHTML = '';
                if (items.length === 0) {
                    container.innerHTML = `<p class="text-gray-500 text-center py-4">저장된 항목이 없습니다.</p>`;
                    return;
                }
                items.forEach(item => {
                    const el = document.createElement('div');
                    el.className = 'p-4 border rounded-md hover:bg-gray-50 transition-colors flex justify-between items-center';
                    el.innerHTML = `
                        <div>
                            <p class="font-semibold">${item.title}</p>
                            <p class="text-sm text-gray-500">생성일: ${item.createdAt ? new Date(item.createdAt.toDate()).toLocaleDateString() : '날짜 없음'}</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <button class="rename-item-btn text-sm font-medium text-green-600 hover:underline" data-id="${item.id}">수정</button>
                            <button class="copy-item-btn text-sm font-medium text-purple-600 hover:underline" data-id="${item.id}">복사</button>
                            <button class="view-item-btn text-sm font-medium text-blue-600 hover:underline" data-id="${item.id}">보기</button>
                            <button class="delete-item-btn text-sm font-medium text-red-600 hover:underline" data-id="${item.id}">삭제</button>
                        </div>`;
                    container.appendChild(el);
                });
                container.querySelectorAll('.view-item-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => viewHandler(e.target.dataset.id));
                });
                container.querySelectorAll('.delete-item-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const id = e.target.dataset.id;
                        const user = auth.currentUser;
                        if (!user) return;
                        await deleteDoc(doc(db, "users", user.uid, type, id));
                        loadAndDisplayItems(type, container, viewHandler);
                    });
                });
                container.querySelectorAll('.rename-item-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const id = e.target.dataset.id;
                        const user = auth.currentUser;
                        if (!user) return;
                        const target = items.find(i => i.id === id);
                        const newName = prompt('새 이름을 입력하세요', target?.title || '');
                        if (newName && newName.trim()) {
                            await updateDoc(doc(db, "users", user.uid, type, id), { title: newName.trim() });
                            loadAndDisplayItems(type, container, viewHandler);
                        }
                    });
                });
                container.querySelectorAll('.copy-item-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const id = e.target.dataset.id;
                        const user = auth.currentUser;
                        if (!user) return;
                        const target = items.find(i => i.id === id);
                        if (!target) return;
                        const baseTitle = target.title.replace(/\(복사본\d+\)$/,'');
                        let maxCopy = 0;
                        items.forEach(i => {
                            const match = i.title.match(new RegExp(`^${baseTitle}\\(복사본(\\d+)\\)$`));
                            if (match) maxCopy = Math.max(maxCopy, parseInt(match[1]));
                        });
                        const newTitle = `${baseTitle}(복사본${maxCopy + 1})`;
                        const { id: _id, createdAt: _createdAt, ...rest } = target;
                        await addDoc(collection(db, "users", user.uid, type), {
                            ...rest,
                            title: newTitle,
                            createdAt: serverTimestamp(),
                        });
                        loadAndDisplayItems(type, container, viewHandler);
                    });
                });
            } catch (err) {
                console.error(`Error loading ${type}:`, err);
                container.innerHTML = `<p class="text-red-500 text-center py-4">목록을 불러오지 못했습니다.</p>`;
            }
        };

        const viewTable = async (id) => {
            const user = auth.currentUser;
            if (!user) return;
            const docRef = doc(db, "users", user.uid, "tables", id);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                switchView('table');
                currentTableId = id;
                currentTableMarkdown = data.rawContent;
                generatedTableContainer.innerHTML = renderMarkdownTable(currentTableMarkdown);
                tableOutputSection.classList.remove('hidden');
                tableModifySection.classList.remove('hidden');
            }
        };

        const viewOfficial = async (id) => {
            const user = auth.currentUser;
            if (!user) return;
            const docRef = doc(db, "users", user.uid, "officials", id);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                switchView('official');
                currentOfficialId = id;
                currentOfficialTitle = data.title;
                currentOfficialMarkdown = data.rawContent;
                officialTitle.textContent = currentOfficialTitle;
                generatedOfficialContainer.innerHTML = parseMarkdown(currentOfficialMarkdown);
                officialOutputSection.classList.remove('hidden');
                officialModifySection.classList.remove('hidden');
            }
        };

        const viewLetter = async (id) => {
            const user = auth.currentUser;
            if (!user) return;
            const docRef = doc(db, "users", user.uid, "letters", id);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                switchView('letter');
                currentLetterId = id;
                currentLetterMarkdown = data.rawContent;
                generatedLetterContainer.innerHTML = parseMarkdown(currentLetterMarkdown);
                letterOutputSection.classList.remove('hidden');
                letterModifySection.classList.remove('hidden');
            }
        };

        // --- GENERATOR LOGIC ---
        
        const populateSelects = () => {
            const planTypes = ['교육과정 운영계획', '학교폭력 예방 교육 계획', '진로 체험 활동 계획', '디지털 리터러시 교육 계획', '기초학력 향상 지원 계획', '다문화 교육 활동 계획'];
            planTypeButtons.innerHTML = planTypes.map(type => `<button type="button" data-value="${type}" class="plan-type-btn py-2 px-3 rounded-md text-sm">${type}</button>`).join('');
            const firstBtn = planTypeButtons.querySelector('button');
            if (firstBtn) firstBtn.classList.add('active');
        };

        schoolLevelButtons.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                schoolLevelButtons.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
            }
        });

        planTypeButtons.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                planTypeButtons.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                // Clear custom topic input when a preset topic is chosen
                customPlanTypeInput.value = '';
            }
        });

        // When user types a custom topic, deselect all preset topic buttons
        customPlanTypeInput.addEventListener('input', () => {
            if (customPlanTypeInput.value.trim()) {
                planTypeButtons.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
            }
        });

        addKeywordBtn.addEventListener('click', () => {
            const container = document.createElement('div');
            container.className = 'flex items-center gap-2';
            container.innerHTML = `
                <input type="text" name="keywords" class="keyword-input block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 sm:text-sm" placeholder="추가 키워드">
                <button type="button" class="remove-keyword-btn text-red-500 hover:text-red-700">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 12H6"></path></svg>
                </button>
            `;
            keywordsContainer.appendChild(container);
        });

        keywordsContainer.addEventListener('click', (e) => {
            if (e.target.closest('.remove-keyword-btn')) {
                e.target.closest('.flex').remove();
            }
        });

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            if (!user) return;
            
            formError.classList.add('hidden');

            const selectedPlanBtn = planTypeButtons.querySelector('.active');
            const selectedPlanType = selectedPlanBtn ? selectedPlanBtn.dataset.value : '';
            const customPlan = customPlanTypeInput.value.trim();
            let planType = '';
            if (selectedPlanType && customPlan) {
                planType = `${selectedPlanType} ${customPlan}`;
            } else if (selectedPlanType) {
                planType = selectedPlanType;
            } else if (customPlan) {
                planType = customPlan;
            } else {
                formError.textContent = '계획서 주제를 선택하거나 입력해주세요.';
                formError.classList.remove('hidden');
                return;
            }
            
            const schoolLevel = schoolLevelButtons.querySelector('.active').dataset.value;
            const keywords = [...document.querySelectorAll('.keyword-input')]
                                .map(input => input.value.trim())
                                .filter(Boolean);
            const currentYear = new Date().getFullYear();

            initialMessage.classList.add('hidden');
            resultSection.classList.add('hidden');
            errorMessageDiv.classList.add('hidden');
            loadingIndicator.style.display = 'flex';
            generateBtn.disabled = true;
            generateBtn.innerHTML = `<div class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div><span class="ml-2">생성 중...</span>`;

            try {
                let prompt = `당신은 대한민국의 유능한 교사입니다. 다음 조건에 맞춰 '${schoolLevel} ${planType}' 초안을 작성해 주세요.

**출력 형식:**
- 전체 계획서의 제목은 'TITLE: [${currentYear+1}학년도 ${planType}]'과 같이 간결한 형식으로 첫 줄에 명시해 주세요.
- 내용은 반드시 다음 5개의 섹션으로 나누어 작성하고, 각 섹션 제목은 '## 1. 목적'과 같이 '##' 마크다운 헤더를 사용해야 합니다.
- 섹션 순서: 1. 목적, 2. 운영방침, 3. 세부 운영 계획, 4. 예산, 5. 기대효과

**섹션별 작성 조건:**
1.  **목적**: 계획의 핵심 목표를 명확하고 간결하게箇条書き(bullet points) 형식으로 제시하세요.
2.  **운영방침**: 계획을 실행하기 위한 기본 원칙과 방향을 箇条書き 형식으로 제시하세요.
3.  **세부 운영 계획**: 관련 내용을 간단한 문단으로 설명한 뒤, '구분', '추진 내용', '세부 추진 계획', '시기', '대상' 등의 항목을 포함한 Markdown 테이블을 추가하세요.
4.  **예산**: 예산 편성 방향을 짧게 서술하고, 이어서 '항목', '산출 근거', '예산액(원)', '비고'를 포함한 Markdown 테이블을 제공하세요. '산출 근거'는 '10000원*일*명'과 같이 금액*일*명 형태의 곱셈 식으로 작성하세요. 실제적인 예산을 편성해야 합니다.
5.  **기대효과**: 계획 실행을 통해 예상되는 긍정적인 결과를 箇条書き 형식으로 구체적으로 서술하세요.
- **핵심 키워드**: '${keywords.join(', ')}'를 계획서 전반에 자연스럽게 반영해주세요.
- **중요**: 생성하는 모든 텍스트에서 마크다운 굵은 글씨(**)를 사용하지 마세요. 모든 내용은 일반 텍스트로만 작성해주세요.
`;

                const apiUrl = `/.netlify/functions/generatePlan`;
                
                const response = await fetch(apiUrl, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ prompt: prompt }) 
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error?.message || `API 요청 실패: ${response.status}`);
                }
                const result = await response.json();
                
                if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                    const rawText = result.candidates[0].content.parts[0].text;
                    displayContent(rawText, planType);
                    
                    const docRef = await addDoc(collection(db, "users", user.uid, "plans"), {
                        title: planTitle.textContent,
                        planType: planType,
                        createdAt: serverTimestamp(),
                        rawContent: rawText
                    });
                    currentPlanId = docRef.id;
                    loadAndDisplayPlans(); // Refresh recent plans list
                    outputPanel.scrollIntoView({ behavior: 'smooth' });
                } else if (result.candidates?.[0]?.finishReason) {
                     throw new Error(`생성이 중단되었습니다. 이유: ${result.candidates[0].finishReason}. 다른 키워드를 사용해 보세요.`);
                }
                else {
                    throw new Error('AI로부터 유효한 응답을 받지 못했습니다.');
                }
            } catch (error) {
                console.error("Generation/Saving Error:", error);
                errorMessageDiv.classList.remove('hidden');
                errorDetails.textContent = `오류가 발생했습니다: ${error.message}. Google Cloud 프로젝트에서 'Generative Language API'가 활성화되었는지 확인해주세요.`;
            } finally {
                loadingIndicator.style.display = 'none';
                generateBtn.disabled = false;
                generateBtn.innerHTML = `<span>AI 운영계획서 생성</span>`;
            }
        });

        function displayContent(rawText, defaultPlanType) {
            let content = rawText;

            const titleMatch = content.match(/^TITLE:\s*(.*)/m);
            const mainTitle = titleMatch && titleMatch[1] ? titleMatch[1].trim() : defaultPlanType;
            if (titleMatch) {
                content = content.substring(titleMatch[0].length).trim();
            }
            planTitle.textContent = mainTitle;
            
            planContainer.innerHTML = '';

            const sections = content.split(/^##\s/m).filter(s => s.trim() !== '');

            sections.forEach(sectionText => {
                const lines = sectionText.trim().split('\n');
                const sectionTitle = lines.shift().trim();
                const sectionContentMarkdown = lines.join('\n').trim();

                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'plan-section';
                sectionDiv.dataset.markdownContent = sectionContentMarkdown;
                
                const titleEl = document.createElement('h3');
                titleEl.textContent = sectionTitle;
                
                const contentDiv = document.createElement('div');
                contentDiv.className = 'plan-section-content';
                contentDiv.innerHTML = parseMarkdown(sectionContentMarkdown);
                
                const controlsDiv = document.createElement('div');
                controlsDiv.className = 'absolute top-4 right-4 flex gap-2';

                const editBtn = document.createElement('button');
                editBtn.className = 'edit-btn';
                editBtn.textContent = '편집';

                const copyBtn = document.createElement('button');
                copyBtn.className = 'copy-section-btn';
                copyBtn.textContent = '복사';
                
                controlsDiv.appendChild(editBtn);
                controlsDiv.appendChild(copyBtn);

                sectionDiv.appendChild(controlsDiv);
                sectionDiv.appendChild(titleEl);
                sectionDiv.appendChild(contentDiv);
                planContainer.appendChild(sectionDiv);
            });

            loadingIndicator.style.display = 'none';
            resultSection.classList.remove('hidden');
            if (planModifySection) planModifySection.classList.remove('hidden');
        }

        function parseMarkdown(markdown) {
            const plainMarkdown = markdown.replace(/\*\*(.*?)\*\*/g, '$1');
            if (plainMarkdown.includes('|')) {
                const lines = plainMarkdown.split('\n');
                let html = '';
                let tableBuffer = [];
                let textBuffer = [];

                const flushText = () => {
                    if (textBuffer.length) {
                        html += markdownToHtml(textBuffer.join('\n'));
                        textBuffer = [];
                    }
                };

                const flushTable = () => {
                    if (tableBuffer.length) {
                        html += renderMarkdownTable(tableBuffer.join('\n'));
                        tableBuffer = [];
                    }
                };

                lines.forEach(line => {
                    if (line.includes('|')) {
                        flushText();
                        tableBuffer.push(line);
                    } else {
                        flushTable();
                        textBuffer.push(line);
                    }
                });
                flushText();
                flushTable();
                return html;
            }
            return markdownToHtml(plainMarkdown);
        }

        function markdownToHtml(markdown) {
            let finalHtml = '';
            let inList = false;
            let listType = null; // 'ul' or 'ol'
            const lines = markdown.split('\n');

            lines.forEach(line => {
                const trimmedLine = line.trim();

                if (/^\d+\.\s+/.test(trimmedLine)) {
                    if (!inList || listType !== 'ol') {
                        if (inList) finalHtml += listType === 'ul' ? '</ul>' : '</ol>';
                        finalHtml += '<ol>';
                        inList = true;
                        listType = 'ol';
                    }
                    finalHtml += `<li>${trimmedLine.replace(/^\d+\.\s+/, '')}</li>`;
                } else if (/^[\*-]\s+/.test(trimmedLine)) {
                    if (!inList || listType !== 'ul') {
                        if (inList) finalHtml += listType === 'ul' ? '</ul>' : '</ol>';
                        finalHtml += '<ul>';
                        inList = true;
                        listType = 'ul';
                    }
                    finalHtml += `<li>${trimmedLine.replace(/^[\*-]\s+/, '')}</li>`;
                } else {
                    if (inList) {
                        finalHtml += listType === 'ul' ? '</ul>' : '</ol>';
                        inList = false;
                        listType = null;
                    }
                    if (trimmedLine) {
                        finalHtml += `<p>${trimmedLine}</p>`;
                    }
                }
            });

            if (inList) {
                finalHtml += listType === 'ul' ? '</ul>' : '</ol>';
            }
            return finalHtml;
        }

        function renderMarkdownTable(markdown) {
            const rows = markdown
                .trim()
                .split('\n')
                .filter(row => row.includes('|'))
                .map(row => row.split('|').slice(1, -1).map(cell => cell.trim()));
            if (rows.length < 2) return markdownToHtml(markdown);

            const header = rows[0];
            const body = rows.slice(2);
            
            let tableHtml = '<table><thead><tr>';
            header.forEach(h => tableHtml += `<th>${h}</th>`);
            tableHtml += '</tr></thead><tbody>';
            body.forEach(row => {
                tableHtml += '<tr>';
                for (let i = 0; i < header.length; i++) {
                    tableHtml += `<td>${row[i] || ''}</td>`;
                }
                tableHtml += '</tr>';
            });
            tableHtml += '</tbody></table>';
            return tableHtml;
        }

        function markdownTableToHtmlClipboard(markdown) {
            const rows = markdown
                .trim()
                .split('\n')
                .map(row => row.split('|').slice(1, -1).map(cell => cell.trim()));
             if (rows.length < 2) return markdown;

            const header = rows[0];
            const body = rows.slice(2);

            let tableHtml = '<table style="border-collapse: collapse; width: 100%; border: 1px solid black;">';
            tableHtml += '<thead><tr>';
            header.forEach(h => tableHtml += `<th style="border: 1px solid black; padding: 8px; background-color: #f2f2f2; text-align: center;">${h}</th>`);
            tableHtml += '</tr></thead><tbody>';
            body.forEach(row => {
                tableHtml += '<tr>';
                for (let i = 0; i < header.length; i++) {
                    tableHtml += `<td style="border: 1px solid black; padding: 8px;">${row[i] || ''}</td>`;
                }
                tableHtml += '</tr>';
            });
            tableHtml += '</tbody></table>';
            return tableHtml;
        }

        function extractMarkdownFromText(text) {
            return text.replace(/```(?:html|markdown|md)?/g, '').trim();
        }

        function copyToClipboard(text, isHtml = false) {
            const listener = (e) => {
                e.preventDefault();
                if (isHtml) {
                    e.clipboardData.setData('text/html', text);
                    e.clipboardData.setData('text/plain', text.replace(/<[^>]*>?/gm, ''));
                } else {
                    e.clipboardData.setData('text/plain', text);
                }
            };
            document.addEventListener('copy', listener);
            document.execCommand('copy');
            document.removeEventListener('copy', listener);
            showToast(isHtml ? '표(HTML)가 클립보드에 복사되었습니다.' : '내용이 클립보드에 복사되었습니다.');
        }

        function showToast(message) {
            toast.textContent = message;
            toast.classList.remove('opacity-0');
            setTimeout(() => {
                toast.classList.add('opacity-0');
            }, 2000);
        }

async function saveCurrentPlan() {
            const user = auth.currentUser;
            if (!user || !currentPlanId) return;
            let rawContent = `TITLE: ${planTitle.textContent}\n\n`;
            planContainer.querySelectorAll('.plan-section').forEach(section => {
                const title = section.querySelector('h3').textContent;
                const markdown = section.dataset.markdownContent;
                rawContent += `## ${title}\n${markdown}\n\n`;
            });
            try {
                await updateDoc(doc(db, "users", user.uid, "plans", currentPlanId), {
                    title: planTitle.textContent,
                    rawContent
                });
            } catch (err) {
                console.error('Plan Save Error:', err);
            }
        }

        if (planModifyForm) {
            planModifyForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!currentPlanId) return;
                const userPrompt = planModifyPrompt.value.trim();
                if (!userPrompt) return;
                const target = planModifyTarget.value;
                let prompt;
                if (target === '전체') {
                    let rawContent = `TITLE: ${planTitle.textContent}\n\n`;
                    planContainer.querySelectorAll('.plan-section').forEach(section => {
                        const title = section.querySelector('h3').textContent;
                        const markdown = section.dataset.markdownContent;
                        rawContent += `## ${title}\n${markdown}\n\n`;
                    });
                    prompt = `다음 운영계획서를 사용자의 요청에 맞게 수정해줘.\n${rawContent}\n\n요청: ${userPrompt}\n\n' TITLE:'으로 시작하는 동일한 형식의 마크다운으로만 결과를 출력해줘.`;
                } else {
                    const section = Array.from(planContainer.querySelectorAll('.plan-section')).find(sec => sec.querySelector('h3').textContent.includes(target));
                    if (!section) return;
                    const secTitle = section.querySelector('h3').textContent;
                    const secMarkdown = section.dataset.markdownContent;
                    prompt = `다음 운영계획서의 '${secTitle}' 부분을 사용자의 요청에 따라 수정해줘.\n## ${secTitle}\n${secMarkdown}\n\n요청: ${userPrompt}\n\n수정된 '${secTitle}' 부분만 '## ${secTitle}' 형식의 마크다운으로 출력해줘.`;
                }
                try {
                    const response = await fetch('/.netlify/functions/generatePlan', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt })
                    });
                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (text) {
                        const markdown = extractMarkdownFromText(text);
                        if (target === '전체') {
                            displayContent(markdown, planTitle.textContent);
                        } else {
                            const section = Array.from(planContainer.querySelectorAll('.plan-section')).find(sec => sec.querySelector('h3').textContent.includes(target));
                            if (section) {
                                const lines = markdown.split('\n');
                                if (lines[0].startsWith('##')) lines.shift();
                                const newContent = lines.join('\n').trim();
                                section.dataset.markdownContent = newContent;
                                const contentDiv = section.querySelector('.plan-section-content');
                                contentDiv.innerHTML = parseMarkdown(newContent);
                            }
                        }
                        saveCurrentPlan();
                        planModifyPrompt.value = '';
                    }
                } catch (err) {
                    console.error('Plan Modify Error:', err);
                }
            });
        }

        async function saveCurrentTable() {
            const user = auth.currentUser;
            if (!user || !currentTableId) return;
            try {
                await updateDoc(doc(db, "users", user.uid, "tables", currentTableId), {
                    rawContent: currentTableMarkdown
                });
            } catch (err) {
                console.error('Table Save Error:', err);
            }
        }

        async function saveCurrentOfficial() {
            const user = auth.currentUser;
            if (!user || !currentOfficialId) return;
            try {
                await updateDoc(doc(db, "users", user.uid, "officials", currentOfficialId), {
                    title: currentOfficialTitle,
                    rawContent: currentOfficialMarkdown
                });
            } catch (err) {
                console.error('Official Save Error:', err);
            }
        }

        async function saveCurrentLetter() {
            const user = auth.currentUser;
            if (!user || !currentLetterId) return;
            try {
                await updateDoc(doc(db, "users", user.uid, "letters", currentLetterId), {
                    rawContent: currentLetterMarkdown
                });
            } catch (err) {
                console.error('Letter Save Error:', err);
            }
        }

        planContainer.addEventListener('click', function(e) {
            const button = e.target.closest('button');
            if (!button) return;

            const sectionDiv = button.closest('.plan-section');
            const contentDiv = sectionDiv.querySelector('.plan-section-content');

            if (button.classList.contains('copy-section-btn')) {
                const markdownContent = sectionDiv.dataset.markdownContent;
                if (markdownContent.includes('|')) {
                    const htmlToCopy = markdownTableToHtmlClipboard(markdownContent);
                    copyToClipboard(htmlToCopy, true);
                } else {
                    copyToClipboard(contentDiv.innerText, false);
                }
            } else if (button.classList.contains('edit-btn')) {
                if (button.textContent === '편집') { // Start editing
                    button.textContent = '완료';
                    button.classList.add('bg-green-500', 'text-white');
                    const currentMarkdown = sectionDiv.dataset.markdownContent;
                    const textarea = document.createElement('textarea');
                    textarea.className = 'w-full h-48 p-2 border rounded-md font-mono text-sm';
                    textarea.value = currentMarkdown;
                    contentDiv.replaceWith(textarea);
                } else { // Finish editing
                    button.textContent = '편집';
                    button.classList.remove('bg-green-500', 'text-white');
                    const textarea = sectionDiv.querySelector('textarea');
                    const newMarkdown = textarea.value;
                    sectionDiv.dataset.markdownContent = newMarkdown;
                    const newContentDiv = document.createElement('div');
                    newContentDiv.className = 'plan-section-content';
                    newContentDiv.innerHTML = parseMarkdown(newMarkdown);
                    textarea.replaceWith(newContentDiv);
                    saveCurrentPlan();
                }
            }
        });

        if (mergePlanBtn) {
            mergePlanBtn.addEventListener('click', () => {
                const order = ['목적', '운영 방침', '세부 운영 계획', '예산', '기대효과'];
                let html = `<h1>${planTitle.textContent}</h1>`;
                order.forEach(name => {
                    const section = Array.from(planContainer.querySelectorAll('.plan-section'))
                        .find(sec => sec.querySelector('h3').textContent.includes(name));
                    if (section) {
                        html += `<h2>${name}</h2>` + section.querySelector('.plan-section-content').innerHTML;
                    }
                });
                const popup = window.open('', '_blank', 'width=800,height=600,scrollbars=yes');
                if (popup) {
                    popup.document.write(`<!DOCTYPE html><html lang="ko"><head><meta charset="UTF-8"><title>${planTitle.textContent}</title></head><body><button id="copyHtmlBtn">HTML 복사</button><div id="content">${html}</div><script>document.getElementById('copyHtmlBtn').addEventListener('click',function(){const t=document.createElement('textarea');t.value=document.getElementById('content').innerHTML;document.body.appendChild(t);t.select();document.execCommand('copy');document.body.removeChild(t);alert('HTML이 복사되었습니다.');});<\/script></body></html>`);
                    popup.document.close();
                }
            });
        }

        editTitleBtn.addEventListener('click', () => {
            const isEditing = editTitleBtn.textContent === '완료';
            if (isEditing) {
                planTitle.textContent = planTitleInput.value;
                planTitle.classList.remove('hidden');
                planTitleInput.classList.add('hidden');
                editTitleBtn.textContent = '편집';
                editTitleBtn.classList.remove('bg-green-500', 'text-white');
                saveCurrentPlan();
            } else {
                planTitleInput.value = planTitle.textContent;
                planTitle.classList.add('hidden');
                planTitleInput.classList.remove('hidden');
                planTitleInput.focus();
                editTitleBtn.textContent = '완료';
                editTitleBtn.classList.add('bg-green-500', 'text-white');
            }
        });

        // --- INITIALIZATION ---
        populateSelects();
    </script>
</body>
</html>
