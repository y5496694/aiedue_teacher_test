<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì—ì´ë‘ í”Œëœ - AI í•™êµ ìš´ì˜ê³„íšì„œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        html { scroll-behavior: smooth; }
        body { font-family: 'Noto Sans KR', sans-serif; }
        .plan-section {
            position: relative;
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            background-color: #f8fafc;
        }
        .plan-section h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e2e8f0;
        }
        .plan-section-content p { margin-bottom: 1rem; line-height: 1.6; }
        .plan-section-content ul {
            list-style: none;
            margin-left: 1.5rem;
            margin-bottom: 1rem;
            padding-left: 0;
        }
        .plan-section-content ul li {
            margin-bottom: 0.5rem;
            position: relative;
            padding-left: 1em;
        }
        .plan-section-content ul li::before {
            content: "â—‹";
            position: absolute;
            left: -1em;
        }
        .plan-section-content ol {
            list-style: decimal;
            margin-left: 1.5rem;
            margin-bottom: 1rem;
            padding-left: 1.25rem;
        }
        .plan-section-content ol li {
            margin-bottom: 0.5rem;
            position: relative;
        }
        .plan-section-content ol li::before { content: none; }
        .plan-section-content ol > li > ul > li::before { content: "â–¡"; }
        .plan-section-content ol > li > ul > li > ul > li::before { content: "â—‹"; }
        .plan-section-content ol > li > ul > li > ul > li > ul > li::before { content: "-"; }
        .plan-section-content table { width: 100%; border-collapse: collapse; margin-bottom: 1rem; }
        .plan-section-content th,
        .plan-section-content td { border: 1px solid #cbd5e1; padding: 0.75rem; text-align: left; }
        .plan-section-content td { white-space: pre-line; }
        .plan-section-content th { background-color: #f1f5f9; font-weight: 600; }
        .plan-section-content.raw-markdown {
            white-space: pre-wrap;
            font-family: 'Noto Sans KR', sans-serif;
        }
        #generated-official-container .official-plain-text {
            white-space: normal;
            line-height: 1.7;
        }
        .edit-btn, .copy-section-btn, .copy-table-btn, .expand-btn, .detail-btn, .generate-detail-btn, .regenerate-detail-btn, .regenerate-section-btn {
            background-color: #e2e8f0;
            color: #475569;
            border: none;
            padding: 0.25rem 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .edit-btn:hover, .copy-section-btn:hover, .copy-table-btn:hover, .expand-btn:hover, .detail-btn:hover, .generate-detail-btn:hover, .regenerate-detail-btn:hover, .regenerate-section-btn:hover { background-color: #cbd5e1; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #7A9D54; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .nav-link { padding: 0.5rem 1rem; border-radius: 0.375rem; transition: background-color 0.2s, color 0.2s; }
        .nav-link.active { background-color: #7A9D54; color: white; }
        .nav-link:not(.active):hover { background-color: #f3f4f6; }
        .school-level-btn, .plan-type-btn, .outline-btn, .category-btn {
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        .school-level-btn.active, .plan-type-btn.active, .outline-btn.active, .category-btn.active {
            background-color: #84cc16; /* lime-500 */
            color: white;
            border-color: #65a30d; /* lime-600 */
            font-weight: 600;
        }
        .school-level-btn:not(.active), .plan-type-btn:not(.active), .outline-btn:not(.active), .category-btn:not(.active) {
            background-color: #f1f5f9; /* slate-100 */
            color: #475569; /* slate-600 */
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <div id="app">
        <!-- Auth View (Login/Signup) -->
        <div id="auth-view" class="min-h-screen flex items-center justify-center bg-gray-100">
            <div class="w-full max-w-md bg-white rounded-lg shadow-md p-8">
                <h2 class="text-2xl font-bold text-center text-[#7A9D54] mb-6">ì—ì´ë‘ í”Œëœ ì‹œì‘í•˜ê¸°</h2>
                <form id="auth-form" onsubmit="return false;">
                    <div class="mb-4">
                        <label for="email" class="block text-gray-700 text-sm font-bold mb-2">ì´ë©”ì¼</label>
                        <input type="email" id="email" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                    </div>
                    <div class="mb-6">
                        <label for="password" class="block text-gray-700 text-sm font-bold mb-2">ë¹„ë°€ë²ˆí˜¸</label>
                        <input type="password" id="password" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline" required>
                    </div>
                    <p id="auth-error" class="text-red-500 text-xs italic mb-4 hidden"></p>
                    <div class="flex items-center justify-between">
                        <button type="button" id="login-btn" class="bg-[#7A9D54] hover:bg-[#6a8a4a] text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">ë¡œê·¸ì¸</button>
                        <button type="button" id="signup-btn" class="inline-block align-baseline font-bold text-sm text-green-600 hover:text-green-800">ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”? íšŒì›ê°€ì…</button>
                    </div>
                    <div class="my-4 flex items-center">
                        <div class="flex-grow border-t border-gray-300"></div>
                        <span class="flex-shrink mx-4 text-gray-400 text-sm">ë˜ëŠ”</span>
                        <div class="flex-grow border-t border-gray-300"></div>
                    </div>
                    <button type="button" id="google-login-btn" class="w-full bg-white border border-gray-300 text-gray-700 font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline flex items-center justify-center gap-2 hover:bg-gray-50 transition-colors">
                        <svg class="w-5 h-5" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path><path fill="none" d="M0 0h48v48H0z"></path></svg>
                        Google ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸
                    </button>
                </form>
            </div>
        </div>

        <!-- Main App View -->
        <div id="main-app-view" class="hidden flex-col min-h-screen">
            <header class="bg-white shadow-md w-full sticky top-0 z-50">
                <div class="container mx-auto px-6 py-3 flex justify-between items-center">
                    <h1 class="text-2xl font-bold text-[#7A9D54]"><a href="#home" id="home-link">ğŸ“ ì—ì´ë‘ í”Œëœ</a></h1>
                    <nav class="flex items-center gap-4">
                        <span id="user-email" class="text-sm text-gray-600"></span>
                        <a href="#home" id="nav-home" class="nav-link">í™ˆ</a>
                        <a href="#plan" id="nav-plan" class="nav-link">ê³„íšì„œ</a>
                        <a href="#table" id="nav-table" class="nav-link">í‘œ ë§Œë“¤ê¸°(HWP)</a>
                        <a href="#official" id="nav-official" class="nav-link">ê¸°ì•ˆë¬¸</a>
                        <a href="#letter" id="nav-letter" class="nav-link">ê°€ì •í†µì‹ ë¬¸</a>
                        <a href="#community" id="nav-community" class="nav-link">ì»¤ë®¤ë‹ˆí‹°</a>
                        <button id="my-info-btn" class="text-sm bg-blue-500 hover:bg-blue-600 text-white font-semibold py-1 px-3 rounded-md transition-colors">ë‚´ ì •ë³´</button>
                        <button id="logout-btn" class="text-sm bg-red-500 hover:bg-red-600 text-white font-semibold py-1 px-3 rounded-md transition-colors">ë¡œê·¸ì•„ì›ƒ</button>
                    </nav>
                </div>
            </header>
            <main class="flex-grow container mx-auto p-6">
                <!-- Home View -->
                <div id="home-view">
                    <h2 class="text-3xl font-bold mb-6">í™ˆ</h2>
                    <div class="space-y-6">
                        <div class="bg-white p-6 rounded-lg shadow-lg">
                            <h3 class="text-xl font-bold mb-2">ì•ˆë…•í•˜ì„¸ìš”, <span id="home-user-email"></span> ì„ ìƒë‹˜!</h3>
                            <p class="text-gray-600 mb-4">ì—ì´ë‘ í”Œëœê³¼ í•¨ê»˜ í•™êµì˜ ì—…ë¬´ë¥¼ ê°„í¸íˆ ê´€ë¦¬í•´ë³´ì„¸ìš”.</p>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-lg">
                            <h3 class="text-xl font-bold mb-4">ìµœê·¼ ìƒì„±í•œ ê³„íšì„œ</h3>
                            <input type="search" id="recent-plan-search" placeholder="ì œëª© ê²€ìƒ‰" class="w-full mb-3 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                            <div id="recent-plans-list" class="space-y-3"></div>
                        </div>
                    </div>
                    <div class="mt-10">
                        <h3 class="text-2xl font-bold mb-4">ìµœê·¼ ìë£Œ ëª¨ì•„ë³´ê¸°</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6">
                            <div class="bg-white p-6 rounded-lg shadow-lg">
                                <h4 class="text-lg font-semibold mb-3">í‘œ</h4>
                                <input type="search" id="home-tables-search" placeholder="ì œëª© ê²€ìƒ‰" class="w-full mb-3 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                                <div id="home-tables-list" class="space-y-2 text-sm text-gray-700"></div>
                            </div>
                            <div class="bg-white p-6 rounded-lg shadow-lg">
                                <h4 class="text-lg font-semibold mb-3">ê¸°ì•ˆë¬¸</h4>
                                <input type="search" id="home-officials-search" placeholder="ì œëª© ê²€ìƒ‰" class="w-full mb-3 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                                <div id="home-officials-list" class="space-y-2 text-sm text-gray-700"></div>
                            </div>
                            <div class="bg-white p-6 rounded-lg shadow-lg">
                                <h4 class="text-lg font-semibold mb-3">ê°€ì •í†µì‹ ë¬¸</h4>
                                <input type="search" id="home-letters-search" placeholder="ì œëª© ê²€ìƒ‰" class="w-full mb-3 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                                <div id="home-letters-list" class="space-y-2 text-sm text-gray-700"></div>
                            </div>
                            <div class="bg-white p-6 rounded-lg shadow-lg">
                                <h4 class="text-lg font-semibold mb-3">ì»¤ë®¤ë‹ˆí‹°</h4>
                                <input type="search" id="home-community-search" placeholder="ì œëª© ê²€ìƒ‰" class="w-full mb-3 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                                <div id="home-community-list" class="space-y-2 text-sm text-gray-700"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Plan View -->
                <div id="plan-view" class="hidden">
                    <div class="flex flex-col lg:flex-row gap-6">
                        <aside class="w-full lg:w-1/3 bg-white p-6 rounded-lg shadow-lg h-fit lg:sticky top-24">
                            <h3 class="text-lg font-semibold mb-4">ë©”ë‰´ì–¼, ì§€ì¹¨ ì…ë ¥ í…Œì´ë¸”</h3>
                            <form id="plan-form" onsubmit="return false;">
                                <div class="mb-4">
                                    <button type="button" id="example-upload-btn" class="w-full bg-blue-100 text-blue-700 font-medium py-1 px-2 rounded-md">ì˜ˆì‹œ íŒŒì¼ ì—…ë¡œë“œ</button>
                                    <input type="file" id="example-file-input" accept=".pdf" multiple class="hidden" />
                                    <div id="example-file-list" class="mt-2 space-y-1 text-sm text-gray-700"></div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">í•™êµê¸‰</label>
                                    <div id="school-level-buttons" class="grid grid-cols-4 gap-1">
                                        <button type="button" data-value="ì´ˆë“±í•™êµ" class="school-level-btn py-1 px-2 rounded text-xs active">ì´ˆë“±í•™êµ</button>
                                        <button type="button" data-value="ì¤‘í•™êµ" class="school-level-btn py-1 px-2 rounded text-xs">ì¤‘í•™êµ</button>
                                        <button type="button" data-value="ê³ ë“±í•™êµ" class="school-level-btn py-1 px-2 rounded text-xs">ê³ ë“±í•™êµ</button>
                                        <button type="button" data-value="ì—†ìŒ" class="school-level-btn py-1 px-2 rounded text-xs">ì—†ìŒ</button>
                                    </div>
                                </div>
                                <div class="mt-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">ëª©ì°¨</label>
                                    <div id="outline-buttons" class="flex flex-wrap gap-2">
                                        <button type="button" data-value="ê¸°ë³¸ëª©ì°¨" class="outline-btn py-1 px-2 rounded text-xs active">ê¸°ë³¸ëª©ì°¨</button>
                                        <button type="button" data-value="ì„¸ë¶€ëª©ì°¨" class="outline-btn py-1 px-2 rounded text-xs">ì„¸ë¶€ëª©ì°¨</button>
                                    </div>
                                    <div id="outline-description" class="mt-2 text-xs text-gray-600"></div>
                                </div>
                                <div class="mt-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">ë¶„ë¥˜</label>
                                    <input type="hidden" id="plan-category" value="ì •ì±…">
                                    <div id="category-buttons" class="flex flex-wrap gap-2">
                                        <button type="button" data-value="ì •ì±…" class="category-btn py-1 px-2 rounded text-xs active">ì •ì±…</button>
                                        <button type="button" data-value="êµìœ¡" class="category-btn py-1 px-2 rounded text-xs">êµìœ¡</button>
                                        <button type="button" data-value="ì§€ì›" class="category-btn py-1 px-2 rounded text-xs">ì§€ì›</button>
                                        <button type="button" data-value="ê¸°íš" class="category-btn py-1 px-2 rounded text-xs">ê¸°íš</button>
                                        <button type="button" data-value="ê¸°íƒ€" class="category-btn py-1 px-2 rounded text-xs">ê¸°íƒ€</button>
                                    </div>
                                    <div id="category-description" class="mt-2 text-xs text-gray-600 whitespace-pre-line"></div>
                                </div>
                                <div class="mt-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">ê³„íšì„œ ì£¼ì œ</label>
                                    <input type="text" id="custom-plan-type" placeholder="0000 ìš´ì˜ê³„íš" class="block w-full mt-2 px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 sm:text-sm">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">í•µì‹¬ í‚¤ì›Œë“œ</label>
                                    <div id="keywords-container" class="space-y-2 mt-1">
                                        <div class="flex items-center gap-2">
                                            <input type="text" name="keywords" class="keyword-input block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 sm:text-sm" placeholder="ì˜ˆ: AI ìœµí•©">
                                        </div>
                                    </div>
                                    <button type="button" id="add-keyword-btn" class="mt-2 text-sm text-blue-600 hover:underline flex items-center">
                                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                                        í‚¤ì›Œë“œ ì¶”ê°€
                                    </button>
                                </div>

                                <p id="form-error" class="text-red-500 text-xs italic mt-2 hidden"></p>
                                <button type="submit" id="generate-btn" class="w-full bg-[#7A9D54] text-white font-bold py-3 px-4 rounded-lg hover:bg-[#6a8a4a] flex items-center justify-center">AI ìš´ì˜ê³„íšì„œ ìƒì„±</button>
                            </form>
                            <div class="bg-white p-6 rounded-lg shadow hidden" id="plan-modify-section">
                                <h3 class="text-lg font-semibold mb-2">ì„¸ë¶€ ì¶”ì§„ ê³„íš ìˆ˜ì • í…Œì´ë¸”</h3>
                                <p class="text-sm text-gray-600 mb-4">ìˆ˜ì •í•˜ê³ ì í•˜ëŠ” ëª©ì°¨ë¥¼ ë³€ê²½ ëª©ì°¨ì—ì„œ ì •í•˜ê³ , ìˆ˜ì • ë‚´ìš©ì„ ì‘ì„± í›„ ì—”í„°ë¥¼ ëˆŒëŸ¬ë³´ì„¸ìš”.</p>
                                <form id="plan-modify-form" class="space-y-4">
                                    <div>
                                        <label for="plan-modify-target" class="block text-sm font-medium text-gray-700">ìˆ˜ì • ëª©ì°¨</label>
                                        <select id="plan-modify-target" class="mt-1 block w-full border border-gray-300 rounded-md p-2">
                                            <option value="ì „ì²´">ì „ì²´</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="plan-modify-prompt" class="block text-sm font-medium text-gray-700">ìˆ˜ì • ë‚´ìš©</label>
                                        <input type="text" id="plan-modify-prompt" class="mt-1 block w-full border border-gray-300 rounded-md p-2" placeholder="ìˆ˜ì •í•  ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”">
                                    </div>
                                    <button type="submit" id="modify-plan-btn" class="w-full bg-[#FCA5A5] text-white font-bold py-2 px-4 rounded-lg hover:bg-[#F87171]">AI ìˆ˜ì • ì ìš©</button>
                                </form>
                            </div>
                            <div class="mt-8">
                                <h3 class="text-lg font-bold mb-2">ì´ì „ ê³„íšì„œ ì‘ì„± ëª©ë¡</h3>
                                <input type="search" id="plan-search" placeholder="ì œëª© ê²€ìƒ‰" class="w-full mb-3 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                                <div id="plan-saved-list" class="space-y-3 max-h-60 overflow-y-auto">
                                    <!-- Recent plans will be dynamically inserted here -->
                                </div>
                            </div>
                        </aside>
                        <section id="output-panel" class="w-full lg:w-2/3">
                            <h3 class="text-lg font-semibold mb-4">ì¶œë ¥ í…Œì´ë¸”</h3>
                            <div id="initial-message" class="bg-white p-8 rounded-lg shadow-lg"><h2 class="text-2xl font-bold text-gray-800">AI ìš´ì˜ê³„íšì„œ ì´ˆì•ˆì´ ì´ê³³ì— í‘œì‹œë©ë‹ˆë‹¤.</h2></div>
                            <div id="loading-indicator" class="hidden flex-col items-center justify-center text-center py-16">
                                <div class="loader"></div>
                                <p class="mt-4 text-lg font-semibold text-gray-700">AIê°€ ì—´ì‹¬íˆ ê³„íšì„œë¥¼ ì‘ì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
                                <p class="text-slate-500">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”...</p>
                            </div>
                            
                            <div id="result-section" class="hidden">
                                <div class="flex justify-between items-center mb-6 bg-white p-6 rounded-lg shadow-lg">
                                    <div class="flex items-center gap-4">
                                        <h2 id="plan-title" class="text-2xl font-bold text-slate-800"></h2>
                                        <input type="text" id="plan-title-input" class="hidden text-2xl font-bold text-slate-800 border-b-2 border-blue-500 focus:outline-none">
                                    </div>
                                    <div class="flex gap-2">
                                        <button id="merge-plan-btn" class="copy-section-btn" title="AIê°€ A4 í•œ ì¥ ë¶„ëŸ‰ìœ¼ë¡œ ìš”ì•½í•©ë‹ˆë‹¤">ìš”ì•½ë³¸(AI)</button>
                                        <button id="edit-title-btn" class="edit-btn">í¸ì§‘</button>
                                    </div>
                                </div>
                                <div id="generated-plan-container" class="space-y-6">
                                    <!-- Generated sections will be injected here -->
                                </div>
                            </div>

                            <div id="error-message" class="hidden text-center bg-white p-8 rounded-lg shadow-lg"><h2 class="text-2xl font-bold text-red-600">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</h2><p id="error-details" class="mt-4 text-gray-600"></p></div>
                        </section>
                    </div>
                </div>
                <!-- Table Generator View -->
                <div id="table-view" class="hidden">
                    <div class="container mx-auto p-6">
                        <h2 class="text-3xl font-bold mb-6">í‘œ ë§Œë“¤ê¸°(HWP)</h2>
                        <div class="flex flex-col lg:flex-row gap-6">
                            <!-- Input & Modify Section -->
                            <aside class="w-full lg:w-1/3 space-y-6">
                                <div class="bg-white p-6 rounded-lg shadow">
                                    <h3 class="text-lg font-semibold mb-4">ì…ë ¥ í…Œì´ë¸”</h3>
                                    <form id="table-form" class="space-y-4">
                                        <div>
                                            <label for="table-topic" class="block text-sm font-medium text-gray-700">í‘œ ì£¼ì œ</label>
                                            <textarea id="table-topic" rows="4" class="mt-1 block w-full border border-gray-300 rounded-md p-2" placeholder="í‘œì˜ ì£¼ì œë¥¼ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                                        </div>
                                        <button type="submit" id="generate-table-btn" class="w-full bg-[#7A9D54] text-white font-bold py-2 px-4 rounded-lg hover:bg-[#6a8a4a]">AI í‘œ ìƒì„±</button>
                                    </form>
                                </div>

                                <!-- AI Modify Table -->
                                <div class="bg-white p-6 rounded-lg shadow hidden" id="table-modify-section">
                                    <h3 class="text-lg font-semibold mb-4">AI ìˆ˜ì • í…Œì´ë¸”</h3>
                                    <form id="table-modify-form" class="space-y-4">
                                        <div>
                                            <label for="table-modify-prompt" class="block text-sm font-medium text-gray-700">ìˆ˜ì • ë‚´ìš©</label>
                                            <input type="text" id="table-modify-prompt" class="mt-1 block w-full border border-gray-300 rounded-md p-2" placeholder="ìˆ˜ì •í•  ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”">
                                        </div>
                                        <button type="submit" id="modify-table-btn" class="w-full bg-[#FCA5A5] text-white font-bold py-2 px-4 rounded-lg hover:bg-[#F87171]">AI ìˆ˜ì • ì ìš©</button>
                                    </form>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold mt-6 mb-2">ì €ì¥ëœ ëª©ë¡</h3>
                                    <input type="search" id="table-search" placeholder="ì œëª© ê²€ìƒ‰" class="w-full mb-3 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                                    <div id="table-saved-list" class="space-y-3"></div>
                                </div>
                            </aside>

                            <!-- Output Section -->
                            <section class="w-full lg:w-2/3">
                                <div class="plan-section hidden" id="table-output-section">
                                    <div class="absolute top-4 right-4 flex gap-2">
                                        <button id="copy-table-btn" class="copy-section-btn">ë³µì‚¬</button>
                                        <button id="edit-table-btn" class="edit-btn">í¸ì§‘</button>
                                    </div>
                                    <div id="generated-table-container" class="plan-section-content overflow-x-auto"></div>
                                </div>
                            </section>
                        </div>
                    </div>
                </div>
                <!-- Official Docs View -->
                <div id="official-view" class="hidden">
                    <div class="container mx-auto p-6">
                        <h2 class="text-3xl font-bold mb-6">ê¸°ì•ˆë¬¸</h2>
                        <div class="flex flex-col lg:flex-row gap-6">
                            <!-- Input & Modify Section -->
                            <aside class="w-full lg:w-1/3 space-y-6">
                                <div class="bg-white p-6 rounded-lg shadow">
                                    <h3 class="text-lg font-semibold mb-4">ì…ë ¥ í…Œì´ë¸”</h3>
                                    <form id="official-form" class="space-y-4">
                                        <div>
                                            <label for="official-topic" class="block text-sm font-medium text-gray-700">ì£¼ì œ</label>
                                            <textarea id="official-topic" rows="3" class="mt-1 block w-full border border-gray-300 rounded-md p-2" placeholder="ê¸°ì•ˆë¬¸ ì£¼ì œë¥¼ ì…ë ¥í•˜ì„¸ìš”" required></textarea>
                                        </div>
                                        <div>
                                            <label for="official-reference" class="block text-sm font-medium text-gray-700">ê·¼ê±° (ì„ íƒ)</label>
                                            <input type="text" id="official-reference" class="mt-1 block w-full border border-gray-300 rounded-md p-2" placeholder="ê´€ë ¨ ê¸°ê´€ ë¬¸ì„œ ë²ˆí˜¸ ë‚ ì§œë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">ì²¨ë¶€ íŒŒì¼ (ì„ íƒ)</label>
                                            <div id="attachments-container" class="space-y-2"></div>
                                            <button type="button" id="add-attachment-btn" class="mt-2 text-sm text-blue-600 hover:underline">+ ì¶”ê°€</button>
                                        </div>
                                        <button type="submit" id="generate-official-btn" class="w-full bg-[#7A9D54] text-white font-bold py-2 px-4 rounded-lg hover:bg-[#6a8a4a]">AI ê¸°ì•ˆë¬¸ ìƒì„±</button>
                                    </form>
                                </div>

                                <!-- AI Modify Table -->
                                <div class="bg-white p-6 rounded-lg shadow hidden" id="official-modify-section">
                                    <h3 class="text-lg font-semibold mb-4">AI ìˆ˜ì • í…Œì´ë¸”</h3>
                                    <form id="official-modify-form" class="space-y-4">
                                        <div>
                                            <label for="official-modify-prompt" class="block text-sm font-medium text-gray-700">ìˆ˜ì • ë‚´ìš©</label>
                                            <input type="text" id="official-modify-prompt" class="mt-1 block w-full border border-gray-300 rounded-md p-2" placeholder="ìˆ˜ì •í•  ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”">
                                        </div>
                                        <button type="submit" id="modify-official-btn" class="w-full bg-[#FCA5A5] text-white font-bold py-2 px-4 rounded-lg hover:bg-[#F87171]">AI ìˆ˜ì • ì ìš©</button>
                                    </form>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold mt-6 mb-2">ì €ì¥ëœ ëª©ë¡</h3>
                                    <input type="search" id="official-search" placeholder="ì œëª© ê²€ìƒ‰" class="w-full mb-3 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                                    <div id="official-saved-list" class="space-y-3"></div>
                                </div>
                            </aside>

                            <!-- Output Section -->
                            <section class="w-full lg:w-2/3">
                                <div class="plan-section hidden relative" id="official-output-section">
                                    <div class="absolute top-4 right-4 flex gap-2">
                                        <button id="copy-official-btn" class="copy-section-btn">ë³µì‚¬</button>
                                        <button id="edit-official-btn" class="edit-btn">í¸ì§‘</button>
                                    </div>
                                    <div class="mb-4 flex items-center gap-2">
                                        <h3 id="official-title" class="text-xl font-bold"></h3>
                                        <input type="text" id="official-title-input" class="hidden text-xl font-bold border-b border-gray-400 focus:outline-none">
                                        <button type="button" id="edit-official-title-btn" class="edit-btn">í¸ì§‘</button>
                                        <button type="button" id="copy-official-title-btn" class="copy-section-btn">ë³µì‚¬</button>
                                    </div>
                                    <div id="generated-official-container" class="plan-section-content"></div>
                                </div>
                            </section>
                        </div>
                    </div>
                </div>
                <!-- Letter View -->
                <div id="letter-view" class="hidden">
                    <div class="container mx-auto p-6">
                        <h2 class="text-3xl font-bold mb-6">ê°€ì •í†µì‹ ë¬¸</h2>
                        <div class="flex flex-col lg:flex-row gap-6">
                            <!-- Input & Modify Section -->
                            <aside class="w-full lg:w-1/3 space-y-6">
                                <div class="bg-white p-6 rounded-lg shadow">
                                    <h3 class="text-lg font-semibold mb-4">ì…ë ¥ í…Œì´ë¸”</h3>
                                    <form id="letter-form" class="space-y-4">
                                        <div>
                                            <label for="letter-topic" class="block text-sm font-medium text-gray-700">ì£¼ì œ</label>
                                            <textarea id="letter-topic" rows="4" class="mt-1 block w-full border border-gray-300 rounded-md p-2" placeholder="ê°€ì •í†µì‹ ë¬¸ ì£¼ì œë¥¼ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                                        </div>
                                        <button type="submit" id="generate-letter-btn" class="w-full bg-[#7A9D54] text-white font-bold py-2 px-4 rounded-lg hover:bg-[#6a8a4a]">AI ê°€ì •í†µì‹ ë¬¸ ìƒì„±</button>
                                    </form>
                                </div>

                                <!-- AI Modify Table -->
                                <div class="bg-white p-6 rounded-lg shadow hidden" id="letter-modify-section">
                                    <h3 class="text-lg font-semibold mb-4">AI ìˆ˜ì • í…Œì´ë¸”</h3>
                                    <form id="letter-modify-form" class="space-y-4">
                                        <div>
                                            <label for="letter-modify-prompt" class="block text-sm font-medium text-gray-700">ìˆ˜ì • ë‚´ìš©</label>
                                            <input type="text" id="letter-modify-prompt" class="mt-1 block w-full border border-gray-300 rounded-md p-2" placeholder="ìˆ˜ì •í•  ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”">
                                        </div>
                                        <button type="submit" id="modify-letter-btn" class="w-full bg-[#FCA5A5] text-white font-bold py-2 px-4 rounded-lg hover:bg-[#F87171]">AI ìˆ˜ì • ì ìš©</button>
                                    </form>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold mt-6 mb-2">ì €ì¥ëœ ëª©ë¡</h3>
                                    <input type="search" id="letter-search" placeholder="ì œëª© ê²€ìƒ‰" class="w-full mb-3 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                                    <div id="letter-saved-list" class="space-y-3"></div>
                                </div>
                            </aside>

                            <!-- Output Section -->
                            <section class="w-full lg:w-2/3">
                                <div class="plan-section hidden" id="letter-output-section">
                                    <div class="absolute top-4 right-4 flex gap-2">
                                        <button id="copy-letter-btn" class="copy-section-btn">ë³µì‚¬</button>
                                        <button id="edit-letter-btn" class="edit-btn">í¸ì§‘</button>
                                    </div>
                                    <div id="generated-letter-container" class="plan-section-content"></div>
                                </div>
                            </section>
                        </div>
                    </div>
                </div>
                <!-- Community View -->
                <div id="community-view" class="hidden">
                    <div class="container mx-auto p-6">
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
                            <h2 class="text-3xl font-bold">ì»¤ë®¤ë‹ˆí‹°</h2>
                            <button id="open-create-post-btn" class="self-start md:self-auto bg-[#7A9D54] hover:bg-[#6a8a4a] text-white font-semibold px-4 py-2 rounded-md transition-colors">ê¸€ ì‘ì„±</button>
                        </div>
                        <input type="search" id="community-search" placeholder="ì œëª© ê²€ìƒ‰" class="w-full mb-4 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                        <div id="community-post-list" class="space-y-4"></div>
                    </div>
                </div>
            </main>
        </div>
        <!-- Toast Message -->
        <div id="toast" class="fixed bottom-10 right-10 bg-gray-900 text-white py-2 px-5 rounded-lg shadow-lg opacity-0 transition-opacity duration-300">
            ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!
        </div>
        <!-- Profile Modal -->
        <div id="profile-modal" class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 px-4">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
                <h3 class="text-xl font-semibold mb-2">ë‚´ ì •ë³´</h3>
                <p class="text-sm text-gray-500 mb-4">ë¡œê·¸ì¸ ê³„ì •: <span id="profile-email" class="font-medium text-gray-700"></span></p>
                <label for="profile-name-input" class="block text-sm font-medium text-gray-700 mb-1">ì´ë¦„</label>
                <input id="profile-name-input" type="text" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
                <div class="mt-6 flex justify-end gap-2">
                    <button id="close-profile-modal" class="px-4 py-2 rounded-md border border-gray-300 text-gray-600 hover:bg-gray-100">ì·¨ì†Œ</button>
                    <button id="save-profile-btn" class="px-4 py-2 rounded-md bg-[#7A9D54] text-white hover:bg-[#6a8a4a]">ì €ì¥</button>
                </div>
            </div>
        </div>
        <!-- Community Post Modal -->
        <div id="community-post-modal" class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 px-4">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 id="community-modal-title" class="text-xl font-semibold">ìƒˆ ê¸€ ì‘ì„±</h3>
                    <button id="close-community-modal" class="text-gray-500 hover:text-gray-700">âœ•</button>
                </div>
                <form id="community-post-form" class="space-y-4">
                    <div>
                        <label for="community-post-title" class="block text-sm font-medium text-gray-700 mb-1">ì œëª©</label>
                        <input id="community-post-title" type="text" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500" required>
                    </div>
                    <div>
                        <label for="community-post-content" class="block text-sm font-medium text-gray-700 mb-1">ë‚´ìš©</label>
                        <textarea id="community-post-content" rows="6" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500" required></textarea>
                    </div>
                    <div class="flex justify-end gap-2">
                        <button type="button" id="cancel-community-post" class="px-4 py-2 rounded-md border border-gray-300 text-gray-600 hover:bg-gray-100">ì·¨ì†Œ</button>
                        <button type="submit" id="community-post-submit" class="px-4 py-2 rounded-md bg-[#7A9D54] text-white hover:bg-[#6a8a4a]">ë“±ë¡</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, getDocs, doc, getDoc, deleteDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDCeJPDQUNi-KmJ9DhkTRIu-9t2PGZCpt0",
            authDomain: "mansungcoin-c6e06.firebaseapp.com",
            databaseURL: "https://mansungcoin-c6e06-default-rtdb.firebaseio.com",
            projectId: "mansungcoin-c6e06",
            storageBucket: "mansungcoin-c6e06.firebasestorage.app",
            messagingSenderId: "704809284946",
            appId: "1:704809284946:web:54e4788586e6c68de1768b"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global DOM Elements
        const authView = document.getElementById('auth-view');
        const mainAppView = document.getElementById('main-app-view');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const loginBtn = document.getElementById('login-btn');
        const signupBtn = document.getElementById('signup-btn');
        const googleLoginBtn = document.getElementById('google-login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const authError = document.getElementById('auth-error');
        const userEmailSpan = document.getElementById('user-email');
        const homeUserEmailSpan = document.getElementById('home-user-email');
        const navHome = document.getElementById('nav-home');
        const navPlan = document.getElementById('nav-plan');
        const navTable = document.getElementById('nav-table');
        const navOfficial = document.getElementById('nav-official');
        const navLetter = document.getElementById('nav-letter');
        const navCommunity = document.getElementById('nav-community');
        const myInfoBtn = document.getElementById('my-info-btn');
        const profileModal = document.getElementById('profile-modal');
        const profileNameInput = document.getElementById('profile-name-input');
        const profileEmail = document.getElementById('profile-email');
        const closeProfileModalBtn = document.getElementById('close-profile-modal');
        const saveProfileBtn = document.getElementById('save-profile-btn');
        const homeLink = document.getElementById('home-link');
        const homeView = document.getElementById('home-view');
        const planView = document.getElementById('plan-view');
        const tableView = document.getElementById('table-view');
        const officialView = document.getElementById('official-view');
        const letterView = document.getElementById('letter-view');
        const communityView = document.getElementById('community-view');
        const communityPostList = document.getElementById('community-post-list');
        const communitySearchInput = document.getElementById('community-search');
        const openCreatePostBtn = document.getElementById('open-create-post-btn');
        const communityPostModal = document.getElementById('community-post-modal');
        const communityPostForm = document.getElementById('community-post-form');
        const communityPostTitleInput = document.getElementById('community-post-title');
        const communityPostContentInput = document.getElementById('community-post-content');
        const communityModalTitle = document.getElementById('community-modal-title');
        const communityPostSubmitBtn = document.getElementById('community-post-submit');
        const closeCommunityModalBtn = document.getElementById('close-community-modal');
        const cancelCommunityPostBtn = document.getElementById('cancel-community-post');
        const homeTablesList = document.getElementById('home-tables-list');
        const homeTablesSearchInput = document.getElementById('home-tables-search');
        const homeOfficialsList = document.getElementById('home-officials-list');
        const homeOfficialsSearchInput = document.getElementById('home-officials-search');
        const homeLettersList = document.getElementById('home-letters-list');
        const homeLettersSearchInput = document.getElementById('home-letters-search');
        const homeCommunityList = document.getElementById('home-community-list');
        const homeCommunitySearchInput = document.getElementById('home-community-search');
        const planSearchInput = document.getElementById('plan-search');
        const tableSearchInput = document.getElementById('table-search');
        const officialSearchInput = document.getElementById('official-search');
        const letterSearchInput = document.getElementById('letter-search');
        const recentPlansList = document.getElementById('recent-plans-list');
        const recentPlanSearchInput = document.getElementById('recent-plan-search');
        const form = document.getElementById('plan-form');
        const GEMINI_MODEL = 'gemini-2.0-flash-lite-001';

        const generateBtn = document.getElementById('generate-btn');
        const initialMessage = document.getElementById('initial-message');
        const loadingIndicator = document.getElementById('loading-indicator');
        const resultSection = document.getElementById('result-section');
        const planContainer = document.getElementById('generated-plan-container');
        const planTitle = document.getElementById('plan-title');
        const planTitleInput = document.getElementById('plan-title-input');
        const mergePlanBtn = document.getElementById('merge-plan-btn');
        const editTitleBtn = document.getElementById('edit-title-btn');
        const errorMessageDiv = document.getElementById('error-message');
        const errorDetails = document.getElementById('error-details');
        const toast = document.getElementById('toast');
        const outputPanel = document.getElementById('output-panel');
        const schoolLevelButtons = document.getElementById('school-level-buttons');
        const outlineButtons = document.getElementById('outline-buttons');
        const categoryButtons = document.getElementById('category-buttons');
        const planCategoryInput = document.getElementById('plan-category');
        const outlineDescription = document.getElementById('outline-description');
        const categoryDescription = document.getElementById('category-description');
        const customPlanTypeInput = document.getElementById('custom-plan-type');
        const keywordsContainer = document.getElementById('keywords-container');
        const addKeywordBtn = document.getElementById('add-keyword-btn');
        const formError = document.getElementById('form-error');
        const planModifySection = document.getElementById('plan-modify-section');
        const planModifyForm = document.getElementById('plan-modify-form');
        const planModifyTarget = document.getElementById('plan-modify-target');
        const planModifyPrompt = document.getElementById('plan-modify-prompt');
        const planSavedList = document.getElementById('plan-saved-list');
        let currentPlanId = null;

        const exampleUploadBtn = document.getElementById('example-upload-btn');
        const exampleFileInput = document.getElementById('example-file-input');
        const exampleFileList = document.getElementById('example-file-list');
        let exampleFiles = [];
        let currentPlanSummaryMarkdown = null;
        let summaryPopupWindow = null;
        let isSummaryGenerating = false;

        exampleUploadBtn.addEventListener('click', () => exampleFileInput.click());

        async function extractPdfText(arrayBuffer) {
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            let text = '';
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const content = await page.getTextContent();
                text += content.items.map(item => item.str).join(' ') + '\n';
            }
            return text;
        }

        function extractOutline(text) {
            return text.split(/\r?\n/)
                       .map(l => l.trim())
                       .filter(l => /^\d+[\.\)]\s+/.test(l))
                       .map(l => l.replace(/^\d+[\.\)]\s+/, ''));
        }
        function renderExampleFileList() {
            exampleFileList.innerHTML = '';
            exampleFiles.forEach(file => {
                const item = document.createElement('div');
                item.className = 'flex items-center';
                item.dataset.name = file.name;
                item.innerHTML = `<span class="flex-1 truncate">${file.name}</span><button type="button" class="remove-example ml-2 text-red-500 text-xs">ì œê±°</button>`;
                exampleFileList.appendChild(item);
            });
        }

        exampleFileList.addEventListener('click', (e) => {
            if (e.target.classList.contains('remove-example')) {
                const name = e.target.parentElement.dataset.name;
                exampleFiles = exampleFiles.filter(f => f.name !== name);
                renderExampleFileList();
            }
        });

        exampleFileInput.addEventListener('change', async (e) => {
            const files = Array.from(e.target.files);
            if (!files.length) return;
            try {
                for (const file of files) {
                    const arrayBuffer = await file.arrayBuffer();
                    const ext = file.name.split('.').pop().toLowerCase();
                    if (ext !== 'pdf') {
                        showToast('PDF íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                        continue;
                    }
                    const text = await extractPdfText(arrayBuffer);
                    const outline = extractOutline(text);
                    exampleFiles.push({ name: file.name, text, outline });
                }
                renderExampleFileList();
                e.target.value = '';
                showToast('ì˜ˆì‹œ íŒŒì¼ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.');
            } catch (err) {
                console.error('Example file error:', err);
                showToast('íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        });

        // Load plan examples to guide dynamic 'ì„¸ë¶€ ì¶”ì§„ ê³„íš' generation
        // First, load detailed plan examples as the primary reference
        let detailPlanExamples = '';
        fetch('/detail_plan_examples.txt')
            .then(response => response.text())
            .then(text => { detailPlanExamples = text; });

        // Load additional general plan examples
        let planExamples = '';
        fetch('/plan_examples.txt')
            .then(response => response.text())
            .then(text => { planExamples = text; });

        const planOutlineDefinitions = {
            "ê¸°ë³¸ëª©ì°¨": [
                { title: "ê·¼ê±°", type: "bullet" },
                { title: "ëª©ì ", type: "bullet" },
                { title: "ë°©ì¹¨", type: "bullet" },
                { title: "ì„¸ë¶€ ì¶”ì§„ ê³„íš", type: "tablePlan" },
                { title: "ê¸°ëŒ€íš¨ê³¼", type: "bullet" }
            ],
            "ì„¸ë¶€ëª©ì°¨": [
                { title: "ì¶”ì§„ ë°°ê²½", type: "bullet" },
                { title: "ì¶”ì§„ ê·¼ê±°", type: "bullet" },
                { title: "ì¶”ì§„ ëª©ì ", type: "bullet" },
                { title: "ì¶”ì§„ ë°©í–¥", type: "bullet" },
                { title: "ì„¸ë¶€ ì¶”ì§„ ê³„íš", type: "tablePlan" },
                { title: "ì¶”ì§„ ì¼ì •", type: "tableSchedule" },
                { title: "ì˜ˆì‚° ìš´ìš© ê³„íš", type: "tableBudget" },
                { title: "ê¸°ëŒ€íš¨ê³¼", type: "bullet" }
            ]
        };

        let currentOutline = [...planOutlineDefinitions["ê¸°ë³¸ëª©ì°¨"]];

        const categoryExamples = {
            "ì •ì±…": "ê¸°ì¡´ ê³„íšì— ì¡´ì¬í•˜ë˜ ê²ƒì— ìƒˆë¡œìš´ ë‚´ìš©ì´ë‚˜ ë©”ë‰´ì–¼, ì •ì±…ì´ ì¶”ê°€ë˜ëŠ” ì •ì±… ë°©í–¥/ì˜ˆì‚°/ì¸ì‚¬ ê³„íš ì£¼ì œë¼ëŠ” ê²ƒì— ì£¼ì•ˆì ì„ ë‘ì–´ ì‘ì„±í•˜ì„¸ìš”.",
            "êµìœ¡": "êµìœ¡ê³¼ì • ë‚´ìš©ê³¼ í•™ìƒ ì§€ë„ì— ì£¼ì•ˆì ì„ ë‘ì–´ ì‘ì„±í•˜ì„¸ìš”.",
            "ì§€ì›": "ì•ˆì „, ê±´ê°•, ë¯¸ë˜êµìœ¡ ì§€ì› ë°©ì•ˆ, ìœ„ê¸° ëŒ€ì‘, ë³´ê±´ì— ì£¼ì•ˆì ì„ ë‘ì–´ ì‘ì„±í•˜ì„¸ìš”.",
            "ê¸°íš": "ê¸°ì¡´ ê³„íšì´ ì—†ê³  ìƒˆë¡œìš´ ì •ì±…ì„ ê¸°íší•´ì•¼ í•œë‹¤ëŠ” ì£¼ì œì— ì£¼ì•ˆì ì„ ë‘ì–´ ì‘ì„±í•˜ì„¸ìš”.",
            "ê¸°íƒ€": "ì •ì±…, êµìœ¡, ì§€ì›, ê¸°íšì— í•´ë‹¹í•˜ì§€ ì•ŠëŠ” ê¸°íƒ€ ì£¼ì œë¼ëŠ” ê²ƒì— ì£¼ì•ˆì ì„ ë‘ì–´ ì‘ì„±í•˜ì„¸ìš”."
        };

        const categoryFocus = {
            "ì •ì±…": "ê¸°ì¡´ ê³„íšì— ì¡´ì¬í•˜ë˜ ê²ƒì— ìƒˆë¡œìš´ ë‚´ìš©ì´ë‚˜ ë©”ë‰´ì–¼, ì •ì±…ì´ ì¶”ê°€ë˜ëŠ” ì •ì±… ë°©í–¥/ì˜ˆì‚°/ì¸ì‚¬ ê³„íš ì£¼ì œë¼ëŠ” ê²ƒì— ì£¼ì•ˆì ì„ ë‘ì–´ ì‘ì„±í•˜ì„¸ìš”.",
            "êµìœ¡": "êµìœ¡ê³¼ì • ë‚´ìš©ê³¼ í•™ìƒ ì§€ë„ì— ì£¼ì•ˆì ì„ ë‘ì–´ ì‘ì„±í•˜ì„¸ìš”.",
            "ì§€ì›": "ì•ˆì „, ê±´ê°•, ë¯¸ë˜êµìœ¡ ì§€ì› ë°©ì•ˆ, ìœ„ê¸° ëŒ€ì‘, ë³´ê±´ì— ì£¼ì•ˆì ì„ ë‘ì–´ ì‘ì„±í•˜ì„¸ìš”.",
            "ê¸°íš": "ê¸°ì¡´ ê³„íšì´ ì—†ê³  ìƒˆë¡œìš´ ì •ì±…ì„ ê¸°íší•´ì•¼ í•œë‹¤ëŠ” ì£¼ì œì— ì£¼ì•ˆì ì„ ë‘ì–´ ì‘ì„±í•˜ì„¸ìš”.",
            "ê¸°íƒ€": "ì •ì±…, êµìœ¡, ì§€ì›, ê¸°íšì— í•´ë‹¹í•˜ì§€ ì•ŠëŠ” ê¸°íƒ€ ì£¼ì œë¼ëŠ” ê²ƒì— ì£¼ì•ˆì ì„ ë‘ì–´ ì‘ì„±í•˜ì„¸ìš”."
        };

        function updateOutlineDescription() {
            const sections = currentOutline.map(s => s.title).join(', ');
            outlineDescription.textContent = `ëª©ì°¨ êµ¬ì„±: ${sections}`;
        }

        function updateCategoryDescription() {
            const category = categoryButtons.querySelector('.active').dataset.value;
            categoryDescription.textContent = categoryExamples[category] || '';
        }

        updateOutlineDescription();
        updateCategoryDescription();

        const tableForm = document.getElementById('table-form');
        const tableTopic = document.getElementById('table-topic');
        const tableOutputSection = document.getElementById('table-output-section');
        let generatedTableContainer = document.getElementById('generated-table-container');
        const editTableBtn = document.getElementById('edit-table-btn');
        const copyTableBtn = document.getElementById('copy-table-btn');
        const tableModifySection = document.getElementById('table-modify-section');
        const tableModifyForm = document.getElementById('table-modify-form');
        const tableModifyPrompt = document.getElementById('table-modify-prompt');
        const tableSavedList = document.getElementById('table-saved-list');
        let currentTableMarkdown = '';
        let isEditingTable = false;
        let currentTableId = null;

        const letterForm = document.getElementById('letter-form');
        const letterTopic = document.getElementById('letter-topic');
        const letterOutputSection = document.getElementById('letter-output-section');
        let generatedLetterContainer = document.getElementById('generated-letter-container');
        const editLetterBtn = document.getElementById('edit-letter-btn');
        const copyLetterBtn = document.getElementById('copy-letter-btn');
        const letterModifySection = document.getElementById('letter-modify-section');
        const letterModifyForm = document.getElementById('letter-modify-form');
        const letterModifyPrompt = document.getElementById('letter-modify-prompt');
        const letterSavedList = document.getElementById('letter-saved-list');
        let currentLetterMarkdown = '';
        let isEditingLetter = false;
        let currentLetterId = null;

        const officialForm = document.getElementById('official-form');
        const officialTopic = document.getElementById('official-topic');
        const officialReference = document.getElementById('official-reference');
        const attachmentsContainer = document.getElementById('attachments-container');
        const addAttachmentBtn = document.getElementById('add-attachment-btn');
        const officialOutputSection = document.getElementById('official-output-section');
        let generatedOfficialContainer = document.getElementById('generated-official-container');
        const editOfficialBtn = document.getElementById('edit-official-btn');
        const copyOfficialBtn = document.getElementById('copy-official-btn');
        const officialModifySection = document.getElementById('official-modify-section');
        const officialModifyForm = document.getElementById('official-modify-form');
        const officialModifyPrompt = document.getElementById('official-modify-prompt');
        const officialTitle = document.getElementById('official-title');
        const officialTitleInput = document.getElementById('official-title-input');
        const editOfficialTitleBtn = document.getElementById('edit-official-title-btn');
        const copyOfficialTitleBtn = document.getElementById('copy-official-title-btn');
        const officialSavedList = document.getElementById('official-saved-list');
        let currentOfficialTitle = '';
        let currentOfficialMarkdown = '';
        let isEditingOfficial = false;
        let currentOfficialId = null;

        const convertTimestampToDate = (timestamp) => {
            if (!timestamp) return null;
            if (typeof timestamp.toDate === 'function') return timestamp.toDate();
            if (timestamp.seconds) return new Date(timestamp.seconds * 1000);
            return new Date(timestamp);
        };

        const formatDateTime = (timestamp, includeTime = true) => {
            const date = convertTimestampToDate(timestamp);
            if (!date || Number.isNaN(date.getTime())) return 'ë‚ ì§œ ì—†ìŒ';
            if (!includeTime) return date.toLocaleDateString('ko-KR');
            return date.toLocaleString('ko-KR', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
        };

        const homeListData = {
            tables: [],
            officials: [],
            letters: [],
            community: []
        };

        const homeListConfigs = {
            tables: { container: homeTablesList, searchInput: homeTablesSearchInput, emptyText: 'ìƒì„±ëœ í‘œê°€ ì—†ìŠµë‹ˆë‹¤.', view: (id) => viewTable(id) },
            officials: { container: homeOfficialsList, searchInput: homeOfficialsSearchInput, emptyText: 'ìƒì„±ëœ ê¸°ì•ˆë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.', view: (id) => viewOfficial(id) },
            letters: { container: homeLettersList, searchInput: homeLettersSearchInput, emptyText: 'ìƒì„±ëœ ê°€ì •í†µì‹ ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.', view: (id) => viewLetter(id) },
            community: { container: homeCommunityList, searchInput: homeCommunitySearchInput, emptyText: 'ì‘ì„±ëœ ì»¤ë®¤ë‹ˆí‹° ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.', view: (id) => openCommunityPost(id) }
        };

        const renderHomeList = (type) => {
            const config = homeListConfigs[type];
            if (!config || !config.container) return;
            const { container, searchInput, emptyText, view } = config;
            const items = homeListData[type] || [];
            container.innerHTML = '';
            if (!items.length) {
                container.innerHTML = `<p class="text-sm text-gray-400">${emptyText}</p>`;
                return;
            }
            const searchTerm = (searchInput?.value || '').trim().toLowerCase();
            const filteredItems = searchTerm
                ? items.filter(item => (item.title || '').toLowerCase().includes(searchTerm))
                : items;
            if (!filteredItems.length) {
                container.innerHTML = '<p class="text-sm text-gray-400">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            const displayItems = searchTerm ? filteredItems : filteredItems.slice(0, 4);
            displayItems.forEach(item => {
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'w-full text-left py-2 border-b border-gray-100 last:border-b-0 focus:outline-none focus:ring-2 focus:ring-[#7A9D54]';
                const title = document.createElement('p');
                title.className = 'text-sm font-medium text-gray-800 truncate';
                title.textContent = item.title || 'ì œëª© ì—†ìŒ';
                const date = document.createElement('p');
                date.className = 'text-xs text-gray-500 mt-1';
                date.textContent = formatDateTime(item.createdAt, false);
                button.appendChild(title);
                button.appendChild(date);
                button.addEventListener('click', () => {
                    if (typeof view === 'function' && item.id) {
                        view(item.id);
                    }
                });
                container.appendChild(button);
            });
        };

        const setHomeListData = (type, items = []) => {
            if (!(type in homeListData)) return;
            homeListData[type] = items;
            renderHomeList(type);
        };

        const openModal = (modal) => { if (modal) modal.classList.remove('hidden'); };
        const closeModal = (modal) => { if (modal) modal.classList.add('hidden'); };

        let communityPostsCache = [];
        let activePostMenu = null;
        let isEditingCommunityPost = false;
        let editingCommunityPostId = null;

        const closeActivePostMenu = () => {
            if (activePostMenu) {
                activePostMenu.classList.add('hidden');
                activePostMenu = null;
            }
        };

        if (homeTablesSearchInput) {
            homeTablesSearchInput.addEventListener('input', () => renderHomeList('tables'));
        }
        if (homeOfficialsSearchInput) {
            homeOfficialsSearchInput.addEventListener('input', () => renderHomeList('officials'));
        }
        if (homeLettersSearchInput) {
            homeLettersSearchInput.addEventListener('input', () => renderHomeList('letters'));
        }
        if (homeCommunitySearchInput) {
            homeCommunitySearchInput.addEventListener('input', () => renderHomeList('community'));
        }

        const attachModalDismiss = (modal) => {
            if (!modal) return;
            modal.addEventListener('click', (event) => {
                if (event.target === modal) {
                    if (modal === communityPostModal) {
                        closeCommunityModal();
                    } else {
                        closeModal(modal);
                    }
                }
            });
        };

        const views = { home: homeView, plan: planView, table: tableView, official: officialView, letter: letterView, community: communityView };
        const navLinks = { home: navHome, plan: navPlan, table: navTable, official: navOfficial, letter: navLetter, community: navCommunity };

        // --- AUTHENTICATION ---
        onAuthStateChanged(auth, user => {
            if (user) {
                authView.classList.add('hidden');
                mainAppView.classList.remove('hidden');
                mainAppView.classList.add('flex');
                const userEmail = user.displayName || user.email;
                userEmailSpan.textContent = userEmail;
                homeUserEmailSpan.textContent = userEmail;
                switchView('home');
                refreshHomeSummaries();
            } else {
                authView.classList.remove('hidden');
                mainAppView.classList.add('hidden');
                mainAppView.classList.remove('flex');
            }
        });

        const handleAuthError = (error) => {
            console.error("Authentication Error:", error);
            let errorMessage = "ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
            switch (error.code) {
                case 'auth/invalid-email': errorMessage = 'ìœ íš¨í•˜ì§€ ì•Šì€ ì´ë©”ì¼ ì£¼ì†Œì…ë‹ˆë‹¤.'; break;
                case 'auth/user-not-found':
                case 'auth/invalid-credential': errorMessage = 'ê°€ì…ë˜ì§€ ì•Šì€ ì´ë©”ì¼ì´ê±°ë‚˜ ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.'; break;
                case 'auth/wrong-password': errorMessage = 'ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.'; break;
                case 'auth/email-already-in-use': errorMessage = 'ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì´ë©”ì¼ì…ë‹ˆë‹¤.'; break;
                case 'auth/weak-password': errorMessage = 'ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.'; break;
                case 'auth/popup-closed-by-user': errorMessage = 'ë¡œê·¸ì¸ íŒì—…ì´ ë‹«í˜”ìŠµë‹ˆë‹¤.'; break;
                case 'auth/unauthorized-domain': errorMessage = "ë¡œê·¸ì¸ì´ í—ˆìš©ë˜ì§€ ì•Šì€ ë„ë©”ì¸ì…ë‹ˆë‹¤. Firebase ì½˜ì†” > Authentication > ì„¤ì • > ìŠ¹ì¸ëœ ë„ë©”ì¸ì— 'googleusercontent.com'ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”."; break;
                case 'auth/identity-toolkit-api-has-not-been-used-in-project': errorMessage = "Firebase í”„ë¡œì íŠ¸ì˜ ì¸ì¦ APIê°€ í™œì„±í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. Google Cloud ì½˜ì†”ì—ì„œ 'Identity Toolkit API'ë¥¼ í™œì„±í™”í•´ì£¼ì„¸ìš”."; break;
                default: errorMessage = `ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (${error.code})`; break;
            }
            authError.textContent = errorMessage;
            authError.classList.remove('hidden');
        };
        
        signupBtn.addEventListener('click', async () => {
             authError.classList.add('hidden');
             try { await createUserWithEmailAndPassword(auth, emailInput.value, passwordInput.value); } catch (error) { handleAuthError(error); }
        });

        loginBtn.addEventListener('click', async () => {
            authError.classList.add('hidden');
            try { await signInWithEmailAndPassword(auth, emailInput.value, passwordInput.value); } catch (error) { handleAuthError(error); }
        });

        googleLoginBtn.addEventListener('click', async () => {
            authError.classList.add('hidden');
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                handleAuthError(error);
            }
        });

        logoutBtn.addEventListener('click', () => signOut(auth));

        // --- APP NAVIGATION ---
        const switchView = (view) => {
            const targetView = view || 'home';
            Object.entries(views).forEach(([key, section]) => {
                section.classList.toggle('hidden', key !== targetView);
                if (navLinks[key]) {
                    navLinks[key].classList.toggle('active', key === targetView);
                }
            });
            window.location.hash = targetView;
            if (targetView === 'plan' && planModifySection) {
                planModifySection.classList.add('hidden');
            }
            if (targetView === 'home') {
                loadAndDisplayPlans();
                refreshHomeSummaries();
            }
            if (targetView === 'plan') {
                loadAndDisplayPlans();
            }
            if (targetView === 'table') {
                loadAndDisplayItems('tables', tableSavedList, viewTable);
            }
            if (targetView === 'official') {
                loadAndDisplayItems('officials', officialSavedList, viewOfficial);
            }
            if (targetView === 'letter') {
                loadAndDisplayItems('letters', letterSavedList, viewLetter);
            }
            if (targetView === 'community') {
                loadCommunityPosts();
            }
        };

        navHome.addEventListener('click', (e) => { e.preventDefault(); switchView('home'); });
        homeLink.addEventListener('click', (e) => { e.preventDefault(); switchView('home'); });
        navPlan.addEventListener('click', (e) => { e.preventDefault(); switchView('plan'); });
        navTable.addEventListener('click', (e) => { e.preventDefault(); switchView('table'); });
        navOfficial.addEventListener('click', (e) => { e.preventDefault(); switchView('official'); });
        navLetter.addEventListener('click', (e) => { e.preventDefault(); switchView('letter'); });
        if (navCommunity) {
            navCommunity.addEventListener('click', (e) => { e.preventDefault(); switchView('community'); });
        }

        if (planSearchInput) {
            planSearchInput.addEventListener('input', () => loadAndDisplayPlans());
        }
        if (recentPlanSearchInput) {
            recentPlanSearchInput.addEventListener('input', () => loadAndDisplayPlans());
        }
        if (tableSearchInput) {
            tableSearchInput.addEventListener('input', () => loadAndDisplayItems('tables', tableSavedList, viewTable));
        }
        if (officialSearchInput) {
            officialSearchInput.addEventListener('input', () => loadAndDisplayItems('officials', officialSavedList, viewOfficial));
        }
        if (letterSearchInput) {
            letterSearchInput.addEventListener('input', () => loadAndDisplayItems('letters', letterSavedList, viewLetter));
        }
        if (communitySearchInput) {
            communitySearchInput.addEventListener('input', () => loadCommunityPosts());
        }

        attachModalDismiss(profileModal);
        attachModalDismiss(communityPostModal);
        document.addEventListener('click', closeActivePostMenu);

        if (myInfoBtn) {
            myInfoBtn.addEventListener('click', () => {
                const user = auth.currentUser;
                if (!user) return;
                profileNameInput.value = user.displayName || '';
                profileEmail.textContent = user.email || '';
                openModal(profileModal);
            });
        }
        if (closeProfileModalBtn) {
            closeProfileModalBtn.addEventListener('click', () => closeModal(profileModal));
        }
        if (saveProfileBtn) {
            saveProfileBtn.addEventListener('click', async () => {
                const user = auth.currentUser;
                if (!user) return;
                const newName = profileNameInput.value.trim();
                try {
                    await updateProfile(user, { displayName: newName || null });
                    const updatedName = newName || user.email;
                    userEmailSpan.textContent = updatedName;
                    homeUserEmailSpan.textContent = updatedName;
                    closeModal(profileModal);
                    showToast('ì´ë¦„ì„ ì €ì¥í–ˆìŠµë‹ˆë‹¤.');
                } catch (error) {
                    console.error('Profile update error:', error);
                }
            });
        }

        const resetCommunityModalState = () => {
            isEditingCommunityPost = false;
            editingCommunityPostId = null;
            if (communityModalTitle) communityModalTitle.textContent = 'ìƒˆ ê¸€ ì‘ì„±';
            if (communityPostSubmitBtn) communityPostSubmitBtn.textContent = 'ë“±ë¡';
        };

        const closeCommunityModal = () => {
            if (communityPostForm) communityPostForm.reset();
            resetCommunityModalState();
            closeModal(communityPostModal);
        };
        if (openCreatePostBtn) {
            openCreatePostBtn.addEventListener('click', () => {
                resetCommunityModalState();
                if (communityPostForm) communityPostForm.reset();
                openModal(communityPostModal);
            });
        }
        if (closeCommunityModalBtn) {
            closeCommunityModalBtn.addEventListener('click', (event) => {
                event.preventDefault();
                closeCommunityModal();
            });
        }
        if (cancelCommunityPostBtn) {
            cancelCommunityPostBtn.addEventListener('click', (event) => {
                event.preventDefault();
                closeCommunityModal();
            });
        }
        if (communityPostForm) {
            communityPostForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                const user = auth.currentUser;
                if (!user) return;
                const title = communityPostTitleInput.value.trim();
                const content = communityPostContentInput.value.trim();
                if (!title || !content) return;
                try {
                    if (isEditingCommunityPost && editingCommunityPostId) {
                        await updateDoc(doc(db, 'communityPosts', editingCommunityPostId), {
                            title,
                            content,
                            updatedAt: serverTimestamp()
                        });
                        showToast('ê¸€ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    } else {
                        await addDoc(collection(db, 'communityPosts'), {
                            title,
                            content,
                            authorId: user.uid,
                            authorName: user.displayName || user.email,
                            createdAt: serverTimestamp()
                        });
                        showToast('ê¸€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    }
                    closeCommunityModal();
                    loadCommunityPosts();
                } catch (error) {
                    console.error('Error saving community post:', error);
                }
            });
        }

        const loadAndRenderComments = async (postId, container) => {
            if (!container) return;
            const user = auth.currentUser;
            try {
                const commentsRef = collection(db, 'communityPosts', postId, 'comments');
                const snap = await getDocs(commentsRef);
                const comments = [];
                snap.forEach(docSnap => comments.push({ id: docSnap.id, ...docSnap.data() }));
                comments.sort((a, b) => (a.createdAt?.toMillis?.() || a.createdAt?.seconds || 0) - (b.createdAt?.toMillis?.() || b.createdAt?.seconds || 0));
                container.innerHTML = '';
                if (comments.length === 0) {
                    container.innerHTML = '<p class="text-sm text-gray-500">ì²« ëŒ“ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš”.</p>';
                    return;
                }
                comments.forEach(comment => {
                    const commentCard = document.createElement('div');
                    commentCard.className = 'bg-gray-50 border border-gray-200 rounded-md px-3 py-2';

                    const metaRow = document.createElement('div');
                    metaRow.className = 'flex flex-wrap items-center justify-between gap-2 text-xs text-gray-500';
                    const metaLeft = document.createElement('div');
                    metaLeft.className = 'flex items-center gap-2';
                    const authorSpan = document.createElement('span');
                    authorSpan.textContent = comment.authorName || 'ìµëª…';
                    const timeSpan = document.createElement('span');
                    timeSpan.textContent = formatDateTime(comment.createdAt, true);
                    metaLeft.appendChild(authorSpan);
                    metaLeft.appendChild(document.createTextNode('Â·'));
                    metaLeft.appendChild(timeSpan);
                    metaRow.appendChild(metaLeft);

                    if (user && comment.authorId === user.uid) {
                        const actionWrap = document.createElement('div');
                        actionWrap.className = 'flex items-center gap-2';
                        const editBtn = document.createElement('button');
                        editBtn.type = 'button';
                        editBtn.className = 'text-blue-600 hover:underline';
                        editBtn.textContent = 'ìˆ˜ì •';
                        const deleteBtn = document.createElement('button');
                        deleteBtn.type = 'button';
                        deleteBtn.className = 'text-red-500 hover:underline';
                        deleteBtn.textContent = 'ì‚­ì œ';
                        actionWrap.appendChild(editBtn);
                        actionWrap.appendChild(deleteBtn);
                        metaRow.appendChild(actionWrap);

                        editBtn.addEventListener('click', async () => {
                            const updated = prompt('ëŒ“ê¸€ì„ ìˆ˜ì •í•˜ì„¸ìš”', comment.content || '');
                            if (!updated || !updated.trim()) return;
                            try {
                                await updateDoc(doc(db, 'communityPosts', postId, 'comments', comment.id), {
                                    content: updated.trim(),
                                    updatedAt: serverTimestamp()
                                });
                                showToast('ëŒ“ê¸€ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                                await loadAndRenderComments(postId, container);
                            } catch (error) {
                                console.error('Error updating comment:', error);
                            }
                        });

                        deleteBtn.addEventListener('click', async () => {
                            if (!confirm('ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
                            try {
                                await deleteDoc(doc(db, 'communityPosts', postId, 'comments', comment.id));
                                showToast('ëŒ“ê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                                await loadAndRenderComments(postId, container);
                            } catch (error) {
                                console.error('Error deleting comment:', error);
                            }
                        });
                    }

                    const contentEl = document.createElement('p');
                    contentEl.className = 'mt-2 text-sm text-gray-700 whitespace-pre-wrap';
                    contentEl.textContent = comment.content || '';

                    commentCard.appendChild(metaRow);
                    commentCard.appendChild(contentEl);
                    container.appendChild(commentCard);
                });
            } catch (error) {
                console.error('Error loading comments:', error);
                container.innerHTML = '<p class="text-sm text-red-500">ëŒ“ê¸€ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>';
            }
        };

        const renderCommunityPosts = async (posts) => {
            if (!communityPostList) return;
            closeActivePostMenu();
            communityPostList.innerHTML = '';
            if (!posts || posts.length === 0) {
                communityPostList.innerHTML = '<p class="text-gray-500 text-center py-4">ë“±ë¡ëœ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            for (const post of posts) {
                const card = document.createElement('div');
                card.className = 'bg-white p-6 rounded-lg shadow-md';
                card.id = `community-post-${post.id}`;

                const header = document.createElement('div');
                header.className = 'flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3';
                const leftBox = document.createElement('div');
                const titleEl = document.createElement('h3');
                titleEl.className = 'text-xl font-semibold text-gray-800';
                titleEl.textContent = post.title || 'ì œëª© ì—†ìŒ';
                const authorInfo = document.createElement('p');
                authorInfo.className = 'text-sm text-gray-500';
                authorInfo.textContent = `ì‘ì„±ì ${post.authorName || 'ìµëª…'}`;
                leftBox.appendChild(titleEl);
                leftBox.appendChild(authorInfo);

                const rightBox = document.createElement('div');
                rightBox.className = 'flex items-start gap-2 relative';
                const dateEl = document.createElement('span');
                dateEl.className = 'text-sm text-gray-500 whitespace-nowrap';
                dateEl.textContent = formatDateTime(post.createdAt, true);
                rightBox.appendChild(dateEl);

                const user = auth.currentUser;
                if (user && post.authorId === user.uid) {
                    const menuWrapper = document.createElement('div');
                    menuWrapper.className = 'relative';
                    const menuBtn = document.createElement('button');
                    menuBtn.type = 'button';
                    menuBtn.className = 'text-gray-500 hover:text-gray-700 px-2';
                    menuBtn.innerHTML = '&#8942;';
                    const menu = document.createElement('div');
                    menu.className = 'hidden absolute right-0 mt-2 w-32 bg-white border border-gray-200 rounded-md shadow-lg z-20 text-sm text-left';
                    menu.addEventListener('click', (e) => e.stopPropagation());
                    const editContentBtn = document.createElement('button');
                    editContentBtn.type = 'button';
                    editContentBtn.className = 'block w-full px-4 py-2 hover:bg-gray-100 text-left';
                    editContentBtn.textContent = 'ê¸€ ìˆ˜ì •';
                    const editTitleBtn = document.createElement('button');
                    editTitleBtn.type = 'button';
                    editTitleBtn.className = 'block w-full px-4 py-2 hover:bg-gray-100 text-left';
                    editTitleBtn.textContent = 'ì œëª© ìˆ˜ì •';
                    const deleteBtn = document.createElement('button');
                    deleteBtn.type = 'button';
                    deleteBtn.className = 'block w-full px-4 py-2 hover:bg-gray-100 text-left text-red-600';
                    deleteBtn.textContent = 'ì‚­ì œ';
                    menu.appendChild(editContentBtn);
                    menu.appendChild(editTitleBtn);
                    menu.appendChild(deleteBtn);
                    menuWrapper.appendChild(menuBtn);
                    menuWrapper.appendChild(menu);
                    rightBox.appendChild(menuWrapper);

                    menuBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        if (activePostMenu && activePostMenu !== menu) {
                            activePostMenu.classList.add('hidden');
                        }
                        const willOpen = menu.classList.contains('hidden');
                        menu.classList.toggle('hidden');
                        activePostMenu = willOpen ? menu : null;
                    });

                    editTitleBtn.addEventListener('click', async () => {
                        closeActivePostMenu();
                        const newTitle = prompt('ìƒˆ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”', post.title || '');
                        if (!newTitle || !newTitle.trim()) return;
                        try {
                            await updateDoc(doc(db, 'communityPosts', post.id), {
                                title: newTitle.trim(),
                                updatedAt: serverTimestamp()
                            });
                            showToast('ì œëª©ì„ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤.');
                            loadCommunityPosts();
                        } catch (error) {
                            console.error('Error updating post title:', error);
                        }
                    });

                    editContentBtn.addEventListener('click', () => {
                        closeActivePostMenu();
                        isEditingCommunityPost = true;
                        editingCommunityPostId = post.id;
                        if (communityModalTitle) communityModalTitle.textContent = 'ê¸€ ìˆ˜ì •';
                        if (communityPostSubmitBtn) communityPostSubmitBtn.textContent = 'ìˆ˜ì • ì™„ë£Œ';
                        communityPostTitleInput.value = post.title || '';
                        communityPostContentInput.value = post.content || '';
                        openModal(communityPostModal);
                    });

                    deleteBtn.addEventListener('click', async () => {
                        closeActivePostMenu();
                        if (!confirm('ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
                        try {
                            const commentsSnap = await getDocs(collection(db, 'communityPosts', post.id, 'comments'));
                            await Promise.all(commentsSnap.docs.map(commentDoc => deleteDoc(commentDoc.ref)));
                            await deleteDoc(doc(db, 'communityPosts', post.id));
                            showToast('ê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                            loadCommunityPosts();
                        } catch (error) {
                            console.error('Error deleting post:', error);
                        }
                    });
                }

                header.appendChild(leftBox);
                header.appendChild(rightBox);
                card.appendChild(header);

                const contentEl = document.createElement('p');
                contentEl.className = 'mt-4 whitespace-pre-wrap text-gray-700';
                contentEl.textContent = post.content || '';
                card.appendChild(contentEl);

                const commentsSection = document.createElement('div');
                commentsSection.className = 'mt-6 border-t pt-4';
                const commentsTitle = document.createElement('h4');
                commentsTitle.className = 'font-semibold text-gray-800 mb-3';
                commentsTitle.textContent = 'ëŒ“ê¸€';
                const commentsContainer = document.createElement('div');
                commentsContainer.className = 'space-y-3';
                commentsSection.appendChild(commentsTitle);
                commentsSection.appendChild(commentsContainer);

                await loadAndRenderComments(post.id, commentsContainer);

                const commentForm = document.createElement('form');
                commentForm.className = 'mt-4 space-y-2';
                const commentTextarea = document.createElement('textarea');
                commentTextarea.rows = 3;
                commentTextarea.className = 'w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500';
                commentTextarea.placeholder = 'ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”';
                const commentSubmit = document.createElement('button');
                commentSubmit.type = 'submit';
                commentSubmit.className = 'px-4 py-2 bg-[#7A9D54] text-white rounded-md hover:bg-[#6a8a4a]';
                commentSubmit.textContent = 'ë“±ë¡';
                commentForm.appendChild(commentTextarea);
                commentForm.appendChild(commentSubmit);
                commentForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const user = auth.currentUser;
                    if (!user) return;
                    const content = commentTextarea.value.trim();
                    if (!content) return;
                    try {
                        await addDoc(collection(db, 'communityPosts', post.id, 'comments'), {
                            content,
                            authorId: user.uid,
                            authorName: user.displayName || user.email,
                            createdAt: serverTimestamp()
                        });
                        commentTextarea.value = '';
                        await loadAndRenderComments(post.id, commentsContainer);
                        showToast('ëŒ“ê¸€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    } catch (error) {
                        console.error('Error adding comment:', error);
                    }
                });

                commentsSection.appendChild(commentForm);
                card.appendChild(commentsSection);
                communityPostList.appendChild(card);
            }
        };

        const highlightCommunityPost = (postId) => {
            const target = document.getElementById(`community-post-${postId}`);
            if (!target) return false;
            target.scrollIntoView({ behavior: 'smooth', block: 'start' });
            target.classList.add('border-2', 'border-green-500');
            setTimeout(() => {
                target.classList.remove('border-2', 'border-green-500');
            }, 2000);
            return true;
        };

        function openCommunityPost(postId) {
            if (!postId) return;
            switchView('community');
            setTimeout(() => {
                if (!highlightCommunityPost(postId)) {
                    loadCommunityPosts().then(() => highlightCommunityPost(postId));
                }
            }, 200);
        }

        const loadCommunityPosts = async (options = {}) => {
            const { skipRender = false } = options;
            try {
                const postsRef = collection(db, 'communityPosts');
                const snap = await getDocs(postsRef);
                const posts = [];
                snap.forEach(docSnap => posts.push({ id: docSnap.id, ...docSnap.data() }));
                posts.sort((a, b) => (b.createdAt?.toMillis?.() || b.createdAt?.seconds || 0) - (a.createdAt?.toMillis?.() || a.createdAt?.seconds || 0));
                communityPostsCache = posts;
                setHomeListData('community', posts);
                if (skipRender) return;
                const searchTerm = (communitySearchInput?.value || '').trim().toLowerCase();
                let displayPosts = posts;
                if (searchTerm) {
                    displayPosts = posts
                        .filter(post => (post.title || '').toLowerCase().includes(searchTerm))
                        .sort((a, b) => (a.createdAt?.toMillis?.() || a.createdAt?.seconds || 0) - (b.createdAt?.toMillis?.() || b.createdAt?.seconds || 0));
                }
                await renderCommunityPosts(displayPosts);
            } catch (error) {
                console.error('Error loading community posts:', error);
                if (!skipRender && communityPostList) {
                    communityPostList.innerHTML = '<p class="text-red-500 text-center py-4">ì»¤ë®¤ë‹ˆí‹° ê¸€ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>';
                }
            }
        };

        const fetchUserCollectionItems = async (type) => {
            const user = auth.currentUser;
            if (!user) return [];
            const colRef = collection(db, 'users', user.uid, type);
            const snap = await getDocs(query(colRef));
            const items = [];
            snap.forEach(docSnap => items.push({ id: docSnap.id, ...docSnap.data() }));
            items.sort((a, b) => (b.createdAt?.toMillis?.() || b.createdAt?.seconds || 0) - (a.createdAt?.toMillis?.() || a.createdAt?.seconds || 0));
            return items;
        };

        const refreshHomeSummaries = async () => {
            const user = auth.currentUser;
            if (!user) return;
            try {
                const [tables, officials, letters] = await Promise.all([
                    fetchUserCollectionItems('tables'),
                    fetchUserCollectionItems('officials'),
                    fetchUserCollectionItems('letters')
                ]);
                setHomeListData('tables', tables);
                setHomeListData('officials', officials);
                setHomeListData('letters', letters);
            } catch (error) {
                console.error('Home summary load error:', error);
            }
            await loadCommunityPosts({ skipRender: true });
        };

        // --- TABLE GENERATOR LOGIC ---
        if (tableForm) {
            tableForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const user = auth.currentUser;
                if (!user) return;
                let topic = tableTopic.value.trim();
                const rowMatch = topic.match(/\[í–‰\]\s*(\d+)/);
                const colMatch = topic.match(/\[ì—´\]\s*(\d+)/);
                const rows = rowMatch ? rowMatch[1] : null;
                const cols = colMatch ? colMatch[1] : null;
                topic = topic.replace(/\[í–‰\]\s*\d+/, '').replace(/\[ì—´\]\s*\d+/, '').trim();
                if (!topic) return;

                showToast('ìƒì„± ì¤‘ì…ë‹ˆë‹¤..');

                let prompt = `ë‹¤ìŒ ì¡°ê±´ì— ë§ëŠ” í‘œë¥¼ ë§ˆí¬ë‹¤ìš´ í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•´ì¤˜.\nì£¼ì œ: ${topic}`;
                if (rows) prompt += `\ní–‰ ìˆ˜: ${rows}`;
                if (cols) prompt += `\nì—´ ìˆ˜: ${cols}`;
                prompt += `\nì¶”ê°€ ì„¤ëª… ì—†ì´ í‘œë§Œ ì¶œë ¥í•´.`;
                try {
                    const response = await fetch('/.netlify/functions/generatePlan', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt, model: GEMINI_MODEL })
                    });
                    const result = await response.json();
                    if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                        currentTableMarkdown = extractMarkdownFromText(result.candidates[0].content.parts[0].text);
                        generatedTableContainer.innerHTML = renderMarkdownTable(currentTableMarkdown);
                        tableOutputSection.classList.remove('hidden');
                        tableModifySection.classList.remove('hidden');
                        const conciseTitle = await generateConciseTitleFromInput(topic, topic);
                        const docRef = await addDoc(collection(db, "users", user.uid, "tables"), {
                            title: conciseTitle,
                            createdAt: serverTimestamp(),
                            rawContent: currentTableMarkdown
                        });
                        currentTableId = docRef.id;
                        loadAndDisplayItems('tables', tableSavedList, viewTable);
                    }
                } catch (err) {
                    console.error('Table Generation Error:', err);
                }
            });

            editTableBtn.addEventListener('click', () => {
                if (!currentTableMarkdown) return;
                if (!isEditingTable) {
                    isEditingTable = true;
                    editTableBtn.textContent = 'ì™„ë£Œ';
                    editTableBtn.classList.add('bg-green-500', 'text-white');
                    const textarea = document.createElement('textarea');
                    textarea.id = 'table-editor';
                    textarea.className = 'w-full h-48 p-2 border rounded-md font-mono text-sm';
                    textarea.value = currentTableMarkdown;
                    generatedTableContainer.replaceWith(textarea);
                } else {
                    const textarea = document.getElementById('table-editor');
                    currentTableMarkdown = textarea.value;
                    const newDiv = document.createElement('div');
                    newDiv.id = 'generated-table-container';
                    newDiv.className = 'plan-section-content overflow-x-auto';
                    newDiv.innerHTML = renderMarkdownTable(currentTableMarkdown);
                    textarea.replaceWith(newDiv);
                    generatedTableContainer = newDiv;
                    isEditingTable = false;
                    editTableBtn.textContent = 'í¸ì§‘';
                    editTableBtn.classList.remove('bg-green-500', 'text-white');
                    saveCurrentTable();
                }
            });

            copyTableBtn.addEventListener('click', () => {
                if (!currentTableMarkdown) return;
                const tableElement = generatedTableContainer?.querySelector?.('table');
                let htmlToCopy = tableElement ? htmlTableToHtmlClipboard(tableElement) : null;
                if (!htmlToCopy || !htmlToCopy.trim() || !/<table[\s>]/i.test(htmlToCopy)) {
                    htmlToCopy = markdownTableToHtmlClipboard(currentTableMarkdown);
                }
                if (!htmlToCopy || !htmlToCopy.trim() || !/<table[\s>]/i.test(htmlToCopy)) return;
                copyToClipboard(htmlToCopy, true, 'í‘œê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
            });

            tableModifyForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!currentTableMarkdown) return;
                const userPrompt = tableModifyPrompt.value.trim();
                if (!userPrompt) return;
                showToast('ìˆ˜ì • ì¤‘ì…ë‹ˆë‹¤..');
                const prompt = `ë‹¤ìŒ ë§ˆí¬ë‹¤ìš´ í‘œë¥¼ ì‚¬ìš©ìì˜ ìš”ì²­ì— ë§ê²Œ ìˆ˜ì •í•´ì¤˜.\ní‘œ:\n${currentTableMarkdown}\n\nìš”ì²­: ${userPrompt}\n\nìˆ˜ì •ëœ í‘œë¥¼ ë§ˆí¬ë‹¤ìš´ í‘œë¡œë§Œ ì¶œë ¥í•´ì¤˜.`;
                try {
                    const response = await fetch('/.netlify/functions/generatePlan', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt, model: GEMINI_MODEL })
                    });
                    const result = await response.json();
                    if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                        currentTableMarkdown = extractMarkdownFromText(result.candidates[0].content.parts[0].text);
                        if (isEditingTable) {
                            const textarea = document.getElementById('table-editor');
                            textarea.value = currentTableMarkdown;
                        } else {
                            generatedTableContainer.innerHTML = renderMarkdownTable(currentTableMarkdown);
                        }
                        saveCurrentTable();
                    }
                } catch (err) {
                    console.error('Table Modify Error:', err);
                }
            });
        }

        // --- OFFICIAL DOCUMENT LOGIC ---
        if (addAttachmentBtn) {
            const addAttachmentInput = () => {
                const wrapper = document.createElement('div');
                wrapper.className = 'flex items-center gap-2';
                const input = document.createElement('input');
                input.type = 'file';
                input.className = 'block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer';
                const span = document.createElement('span');
                span.className = 'text-sm text-gray-600 flex-1';
                input.addEventListener('change', () => {
                    span.textContent = input.files[0]?.name || '';
                });
                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.className = 'text-red-500 font-bold';
                removeBtn.textContent = 'X';
                removeBtn.addEventListener('click', () => wrapper.remove());
                wrapper.appendChild(input);
                wrapper.appendChild(span);
                wrapper.appendChild(removeBtn);
                attachmentsContainer.appendChild(wrapper);
            };
            addAttachmentBtn.addEventListener('click', addAttachmentInput);
        }

        if (officialForm) {
            const officialDocExamples = `ì œëª©: 2023í•™ë…„ë„ ê³¼í•™ì˜ ë‚  ì£¼ê°„ í–‰ì‚¬ ê²°ê³¼ ì œì¶œ
1. ê´€ë ¨: OOì´ˆë“±í•™êµ-5678(2023. 10. 15.)
2023í•™ë…„ë„ ê³¼í•™ì˜ ë‚  ì£¼ê°„ í–‰ì‚¬ ê²°ê³¼ë¥¼ ë¶™ì„ê³¼ ê°™ì´ ì œì¶œí•©ë‹ˆë‹¤.

ë¶™ì„  2023í•™ë…„ë„ ê³¼í•™ì˜ ë‚  ì£¼ê°„ í–‰ì‚¬ ê²°ê³¼ 1ë¶€.  ë.
---
ì œëª©: â—‹â—‹ì‹œ í•™êµìš´ì˜ìœ„ì›ì¥í˜‘ì˜íšŒ ì¥í•™ìƒ ì¶”ì²œ ì œì¶œ
1. ê´€ë ¨ : êµìœ¡ì§€ì›ê³¼-31899(2018.10.1.)
2. â—‹â—‹ì‹œ í•™êµìš´ì˜ìœ„ì›ì¥í˜‘ì˜íšŒ ì¥í•™ìƒ ì¶”ì²œ ì˜ë¢°ì— ë”°ë¼ ë¶™ì„ê³¼ ê°™ì´ ì œì¶œí•©ë‹ˆë‹¤. 

ë¶™ì„  â—‹â—‹ì‹œ í•™êµìš´ì˜ìœ„ì›ì¥í˜‘ì˜íšŒ ì¥í•™ìƒ í•™êµì¥ ì¶”ì²œì„œ(â—‹â—‹ì´ˆ) 1ë¶€.  ë.
---
ì œëª©: â—‹â—‹â—‹â—‹í•™ë…„ë„ ëŒë´„êµì‹¤ ë°©ê³¼í›„í”„ë¡œê·¸ë¨ê°•ì‚¬ ì±„ìš© ê³µê³ 
1. ê´€ë ¨: 00ì´ˆë“±í•™êµ-2141(2019. 3. 11.) 
2. â—‹â—‹â—‹â—‹í•™ë…„ë„ ëŒë´„êµì‹¤ í”„ë¡œê·¸ë¨ê°•ì‚¬ ì±„ìš©ì„ ìœ„í•˜ì—¬ ë¶™ì„ê³¼ ê°™ì´ ê³µê³ í•˜ê³ ì í•©ë‹ˆë‹¤. 
ë¶™ì„  â—‹â—‹â—‹â—‹ ëŒë´„êµì‹¤ ë°©ê³¼í›„í”„ë¡œê·¸ë¨ê°•ì‚¬ ì±„ìš© ê³µê³  1ë¶€.  ë.
---
ì œëª©: 20xx. ì „ë¬¸ì  í•™ìŠµê³µë™ì²´ ì™¸ë¶€ ê°•ì‚¬ ì´ˆì²­ ì—°ìˆ˜ ì‹¤ì‹œ
1. ê´€ë ¨: OOì´ˆë“±í•™êµ-2101(2019. 3. 11.) 
2. êµì› ì „ë¬¸ì„± ì‹ ì¥ì„ ìœ„í•œ 2019. ì „ë¬¸ì  í•™ìŠµê³µë™ì²´ ì™¸ë¶€ ê°•ì‚¬ ì´ˆì²­ ì—°ìˆ˜ë¥¼ ë‹¤ìŒê³¼ ê°™ì´ ì‹¤ì‹œí•˜ê³ ì í•©ë‹ˆë‹¤.
  ê°€. ì¼ì‹œ: 2019. 5. 29.(ìˆ˜) 13:30~15:30(3ì°¨ì‹œ)
  ë‚˜. ì¥ì†Œ: ë³¸êµ ë¼ì˜¨ìˆ²(ìš°ì²œì‹œ ë³¸êµ ì „ë‹´ì‹¤)
  ë‹¤. ëŒ€ìƒ: ë³¸êµ ì „ë¬¸ì  í•™ìŠµê³µë™ì²´ íšŒì› 11ëª…
  ë¼. ì£¼ì œ: ìˆ²ì²´í—˜ í™œë™ ì²´í—˜ ë° ìˆ² ë°§ì¤„ë†€ì´ ì§€ë„ì˜ ì‹¤ì œ
  ë§ˆ. ê°•ì‚¬: ê¶Œê¸ˆì£¼(ìˆ²í•´ì„¤ê°€, ìˆ²ë°§ì¤„ë†€ì´ ì§€ë„ì)
  ë°”. ë¹„ìš©
    1) ê°•ì‚¬ë¹„ : 50,000ì›(ê¸°íƒ€ê°•ì‚¬ì— ì¤€í•¨)
    2) ì›ê³ ë£Œ : 105,000ì›(í•œê¸€ 7.5ë§¤ë¡œ ì œí•œ).  ë.
---
ì œëª©: 20xxí•™ë…„ë„ ì „ë¬¸ì  í•™ìŠµê³µë™ì²´ ì—°ìˆ˜ë¥¼ ìœ„í•œ í˜‘ì¡° ìš”ì²­
1. ê´€ë ¨: 00ì´ˆë“±í•™êµ-2141(2019. 3. 11.) 
2. êµì› ì „ë¬¸ì„± ì‹ ì¥ì„ ìœ„í•œ 2019. ì „ë¬¸ì  í•™ìŠµê³µë™ì²´ ì—°ìˆ˜ ì˜ë¢°ë¥¼ ì•„ë˜ì™€ ê°™ì´ ë³´ë‚´ë“œë¦¬ì˜¤ë‹ˆ ê·€ ê¸°ê´€ì˜ í˜‘ì¡°ë¥¼ ìš”ì²­í•©ë‹ˆë‹¤.  
  ê°€. ì¼ ì‹œ: 2019. 3. 27.(ìˆ˜) 14:40 ~ 16:40 (2ì‹œê°„)
  ë‚˜. ì¥ ì†Œ: 00ì´ˆë“±í•™êµ ì „ë‹´ì‹¤
  ë‹¤. ì£¼ ì œ: ìƒíƒœê°ìˆ˜ì„± í•¨ì–‘ì„ ìœ„í•œ 00êµìœ¡í™œë™ì˜ ì‹¤ì œ
  ë¼. ê°• ì‚¬: 00ì´ˆë“±í•™êµ 000 êµì‚¬
  ë§ˆ. ëŒ€ ìƒ: 00ì´ˆ ì „ë¬¸ì  í•™ìŠµê³µë™ì²´ ã€0000ã€ íšŒì› 00ëª…
  ë°”. ê¸° íƒ€: ê°•ì‚¬ë¹„ ë° ì›ê³ ë¹„ ê·œì •ì— ë”°ë¼ ì§€ê¸‰ ì˜ˆì •.  ë.
---
ì œëª©: 20â—‹â—‹í•™ë…„ë„ 00êµìœ¡ ì„±ê³¼ë³´ê³  ë° ì¢…í•©í•™ìŠµë°œí‘œíšŒ ì•ˆë‚´
1. ê·€êµ(ê¸°ê´€)ì˜ ë¬´ê¶í•œ ë°œì „ì„ ê¸°ì›í•©ë‹ˆë‹¤.
2. 20â—‹â—‹ 00êµìœ¡ì„±ê³¼ë³´ê³  ë° ì¢…í•©í•™ìŠµë°œí‘œíšŒ ê¿ˆê³¼ ë¼ë¥¼ í¼ì¹˜ëŠ”â€œ00 í•œë§ˆë‹¹ ì¶•ì œâ€ë¥¼ ì•„ë˜ì™€ ê°™ì´ ê°œìµœí•˜ì˜¤ë‹ˆ ë°”ì˜ì‹œë”ë¼ë„ ì°¸ì„í•˜ì‹œì–´ ìë¦¬ë¥¼ ë¹›ë‚´ì£¼ì‹œë©´ ê°ì‚¬í•˜ê² ìŠµë‹ˆë‹¤.
  ê°€. ì¼ ì‹œ: 20â—‹â—‹.11.23(ê¸ˆ) 14:00~16:30
  ë‚˜. ì¥ ì†Œ: 00ì´ˆë“±í•™êµ ê°•ë‹¹
  ë‹¤. ë‚´ ìš©: 00êµìœ¡ ì„±ê³¼ë³´ê³ , ì‘í’ˆì „ì‹œíšŒ ë° í•™ìŠµë°œí‘œíšŒ

ë¶™ì„  ëª¨ì‹œëŠ” ê¸€(í”„ë¡œê·¸ë¨) 1ë¶€.  ë.
---
ì œëª©: 2019. ì „ë¬¸ì  í•™ìŠµê³µë™ì²´ ì™¸ë¶€ ê°•ì‚¬ ì´ˆì²­ ì—°ìˆ˜ ì‹¤ì‹œ
1. ê´€ë ¨: 00ì´ˆë“±í•™êµ-2101(2019. 3. 11.) 
2. í™˜ê²½êµìœ¡ ê´€ë ¨ êµì› ì „ë¬¸ì„± ì‹ ì¥ì„ ìœ„í•œ 2019. ì „ë¬¸ì  í•™ìŠµê³µë™ì²´ ì™¸ë¶€ ê°•ì‚¬ ì´ˆì²­ ì—°ìˆ˜ë¥¼ ë‹¤ìŒê³¼ ê°™ì´ ì‹¤ì‹œí•˜ê³ ì í•©ë‹ˆë‹¤.
  ê°€. ì¼ì‹œ: 2019. 0. 00.(ìˆ˜) 14:00~16:00(3ì°¨ì‹œ)
  ë‚˜. ì¥ì†Œ: ë³¸êµ ì „ë‹´ì‹¤
  ë‹¤. ëŒ€ìƒ: ë³¸êµ ì „ë¬¸ì  í•™ìŠµê³µë™ì²´ ã€000ã€íšŒì› 00ëª…
  ë¼. ì£¼ì œ:â€˜ì´ˆë¡ì‹ë¬¼ì„ ëŠ˜ë¦¬ê³ , ì¬í™œìš©í’ˆìœ¼ë¡œ ì‚´ë¦¬ê³ â€™
           (ìŠ¤ì¹¸ë””ì•„ëª¨ìŠ¤ í† í”¼ì–´ë¦¬ ë° ì–‘ë§ëª© ê³µì˜ˆ ê´€ë ¨ ì§€ë„ë°©ì•ˆì˜ ì‹¤ì œ)
  ë§ˆ. ë¹„ìš©
    1) ê°•ì‚¬ë¹„ : 90,000ì›(ê¸°íƒ€ê°•ì‚¬ì— ì¤€í•¨, 60ë¶„ì”© 2ê°œ ê°•ì¢Œ)
    2) ì›ê³ ë¹„ : 28,000ì›(2ë§¤).  ë.
---
ì œëª©: 2023í•™ë…„ë„ AI í™œìš© êµìœ¡ ì—°ìˆ˜ ë³´ê³ 
1. ê´€ë ¨: OOì´ˆë“±í•™êµ-1234(2023. 6. 19.)
2. 2023í•™ë…„ë„ AI í™œìš© êµìœ¡ ì—°ìˆ˜ì— ëŒ€í•˜ì—¬ ë¶™ì„ê³¼ ê°™ì´ ë³´ê³ í•©ë‹ˆë‹¤.
  ê°€. ì¼ì: 2023. 10. 15. (ì¼) 14:00~16:00
  ë‚˜. ì¥ì†Œ: ë³¸êµ ëŒ€ê°•ë‹¹
  ë‹¤. ëŒ€ìƒ: êµì§ì›
  ë¼. ì—°ìˆ˜ ì£¼ì œ: AI í™œìš© êµìœ¡ ë°©ë²• ë° ì‚¬ë¡€ ê³µìœ 

ë¶™ì„  1. 2023í•™ë…„ë„ AI í™œìš© êµìœ¡ ì—°ìˆ˜ ìë£Œ 1ë¶€.
      2. 2023í•™ë…„ë„ AI í™œìš© êµìœ¡ ì—°ìˆ˜ êµì§ì› ì—°ìˆ˜ ë“±ë¡ë¶€ 1ë¶€.  ë.
---
ì œëª©: 2024í•™ë…„ë„ ê°œë³„í™”êµìœ¡ê³„íš ìˆ˜ì • íšŒì˜ ë³´ê³ 
1. ê´€ë ¨: OOì´ˆë“±í•™êµ-1234(2023. 6. 19.)
2. 2023í•™ë…„ë„ ê°œë³„í™”êµìœ¡ê³„íš ìˆ˜ì • íšŒì˜ì— ëŒ€í•˜ì—¬ ë‹¤ìŒê³¼ ê°™ì´ ë³´ê³ í•©ë‹ˆë‹¤.
  ê°€. ì¼ì: 2023. 10. 25. (ìˆ˜) 14:00~15:00
  ë‚˜. ì¥ì†Œ: ë³¸êµ íšŒì˜ì‹¤
  ë‹¤. ì°¸ì„ì: êµì‚¬ ë° í•™ë¶€ëª¨
  ë¼. íšŒì˜ ì£¼ì œ: ê°œë³„í™”êµìœ¡ê³„íš ìˆ˜ì • ë° ë³´ì™„

ë¶™ì„  1. 2023í•™ë…„ë„ ê°œë³„í™”êµìœ¡ê³„íš ìˆ˜ì • íšŒì˜ ìë£Œ 1ë¶€.
      2. 2023í•™ë…„ë„ ê°œë³„í™”êµìœ¡ê³„íš ìˆ˜ì • íšŒì˜ ì°¸ì„ì ëª…ë‹¨ 1ë¶€.  ë.
---
ì œëª©: ì–´ë¦°ì´ë†€ì´ì‹œì„¤ ì¤‘ëŒ€ì‚¬ê³  ë°œìƒ ë³´ê³ (â—‹â—‹ì´ˆ)
1. ê´€ë ¨: ì–´ë¦°ì´ë†€ì´ì‹œì„¤ ì•ˆì „ê´€ë¦¬ë²• ì œ22ì¡°
2. 2018.XX.XX. ìš°ë¦¬í•™êµì—ì„œ ë°œìƒí•œ ì–´ë¦°ì´ë†€ì´ì‹œì„¤ ì¤‘ëŒ€ì‚¬ê³  ê±´ì— ëŒ€í•˜ì—¬ ë‹¤ìŒê³¼ ê°™ì´ ë³´ê³ í•©ë‹ˆë‹¤.
  
  ê°€. ì‚¬ê³ ì¼ì‹œ: 2018.XX.XX. 00:00ê²½
  ë‚˜. ë†€ì´ì‹œì„¤ë²ˆí˜¸: XXXXX

ë¶™ì„  1. ì–´ë¦°ì´ë†€ì´ì‹œì„¤ ì‚¬ê³ ë³´ê³ ì„œ(OOì´ˆ) 1ë¶€.
      2. ì‚¬ê³ í˜„ì¥ ë° ì¡°ì¹˜ ì‚¬ì§„ 1ë¶€.  ë.
---
ì œëª©: 2023í•™ë…„ë„ ê°œë³„í™”êµìœ¡ì§€ì›íŒ€ íšŒì˜ ê³„íš
1. ê´€ë ¨: OOì´ˆë“±í•™êµ-1234(2023. 6. 19.)
2. 2023í•™ë…„ë„ ê°œë³„í™”êµìœ¡ì§€ì›íŒ€ íšŒì˜ë¥¼ ë‹¤ìŒê³¼ ê°™ì´ ì‹¤ì‹œí•˜ê³ ì í•©ë‹ˆë‹¤.
  ê°€. ì¼ì: 2023. 7. 15. (í† ) 10:00~12:00
  ë‚˜. ì¥ì†Œ: ë³¸êµ íšŒì˜ì‹¤
  ë‹¤. ì°¸ì„ì: ê°œë³„í™”êµìœ¡ì§€ì›íŒ€ êµ¬ì„±ì›
  ë¼. íšŒì˜ ì£¼ì œ: ê°œë³„í™”êµìœ¡ê³„íš ìˆ˜ë¦½ ë° ì‹¤í–‰ ì „ëµ

ë¶™ì„  1. 2023í•™ë…„ë„ ê°œë³„í™”êµìœ¡ì§€ì›íŒ€ íšŒì˜ë¡ 1ë¶€.
      2. 2023í•™ë…„ë„ ê°œë³„í™”êµìœ¡ì§€ì›íŒ€ íšŒì˜ ëª…ë‹¨ 1ë¶€.  ë.
---
ì œëª©: 2023í•™ë…„ë„ êµë‚´ ì²´ìœ¡ëŒ€íšŒ ê³„íš
1. ê´€ë ¨: OOì´ˆë“±í•™êµ-1234(2023.6.19.)
2. 2023í•™ë…„ë„ êµë‚´ ì²´ìœ¡ëŒ€íšŒ ê³„íšì„ ë¶™ì„ê³¼ ê°™ì´ ìˆ˜ë¦½í•˜ì—¬ ìš´ì˜í•˜ê³ ì í•©ë‹ˆë‹¤.

ë¶™ì„  2023í•™ë…„ë„ êµë‚´ ì²´ìœ¡ëŒ€íšŒ ê³„íš 1ë¶€.  ë.
---
ì œëª©: 2024í•™ë…„ë„ êµì› ë³´ê²°ìˆ˜ì—… ì§€ì› ê³„íš
1. ê´€ë ¨: â—‹â—‹ê³¼-21â—‹â—‹(20â—‹â—‹.â—‹â—‹.â—‹.), 00ì´ˆ-10â—‹â—‹(20â—‹â—‹.â—‹.â—‹.)
2. êµì›ì˜ ë³´ê²°ìˆ˜ì—… ê¸°í”¼ ì™„í™” ë° ì±…ë¬´ì„±ì„ ê°•í™”í•˜ê³  í•™ìƒì˜ í•™ìŠµê¶Œ ë³´í˜¸ ë° êµìœ¡ê³¼ì • ìš´ì˜ì˜ ì ì •ì„±ì„ í™•ë³´í•˜ê³ ì ë‹¤ìŒê³¼ ê°™ì´ êµì› ë³´ê²°ìˆ˜ì—… ì§€ì› ê³„íš ìˆ˜ë¦½í•˜ì—¬ ìš´ì˜í•˜ê³ ì í•©ë‹ˆë‹¤.
  ê°€. ì ìš©ì‹œê¸°: 2024.3.1.ë¶€í„°
  ë‚˜. ì£¼ìš” ë‚´ìš©
    1) ë³´ê²°ìˆ˜ì—…ë¹„ê°€ ë‚¨ìš©ë˜ì§€ ì•Šë„ë¡â€˜êµì²´ìˆ˜ì—…â€™ì„ ì›ì¹™ìœ¼ë¡œ í•¨
    2) êµì²´ìˆ˜ì—… ë¶ˆê°€ì‹œ ë³´ê²°ìˆ˜ì—… ë°°ì •
    3) ì‹œê°„ë‹¹ ë³´ê²°ìˆ˜ì—…ë¹„: 7,000ì›
    4) ì›” ìµœëŒ€ ë³´ê²°ìˆ˜ì—…ë¹„: 30,000ì›

 ë¶™ì„  2018í•™ë…„ë„ êµì› ë³´ê²° ìˆ˜ì—… ì§€ì› ê³„íš 1ë¶€.  ë. 
---
ì œëª©: 20xxí•™ë…„ë„ í•™ë¶€ëª¨ ìƒë‹´ì£¼ê°„ ìš´ì˜ ê³„íš
1. ê´€ë ¨: OOì´ˆë“±í•™êµ-1234(2023. 6. 19.)
2. í•™êµêµìœ¡ê³„íšì— ì˜ê±° í•™ë¶€ëª¨ ìƒë‹´ì„ í†µí•œ ìƒí™œì§€ë„ ë° ì§„ë¡œì§€ë„ ìë£Œ í™•ë³´ë¥¼ í†µí•œ ë°”ë¥¸ í’ˆì„± í•¨ì–‘ê³¼ ê±´ì „í•œ ë©´í•™ ë¶„ìœ„ê¸° ì¡°ì„±ì„ ìœ„í•´ 20xxë…„ë„ ìƒë°˜ê¸° í•™ë¶€ëª¨ ìƒë‹´ì£¼ê°„ì„ ì•„ë˜ì™€ ê°™ì´ ê³„íší•˜ì—¬ ì‹¤ì‹œí•˜ê³ ì í•©ë‹ˆë‹¤.
3. ìƒë‹´ê¸°ê°„ : 20xx. 4. 1 (ì›”) ~ 4. 5 (ê¸ˆ)
4. ëŒ€ìƒ : ì „êµìƒ ëŒ€ìƒ
5. ë‚´ìš© : í•™ìŠµí™˜ê²½, ìƒí™œ ë“± ë³´í˜¸ì ë©´ë‹´-ìƒí™œì§€ë„, í•™êµí­ë ¥ ì˜ˆë°© ë° ì§„ë¡œì§€ë„ ìë£Œ í™•ë³´
6. ì¶”ì§„ ìœ ì˜ ì‚¬í•­
  ê¸°. í¬ë§ ê°€ì •ì— í•œí•˜ì—¬ ëŒ€ë©´ ìƒë‹´, ë‹¤ê³¼(ìŒì‹) ì¤€ë¹„ ê¸ˆì§€ ë‹¹ë¶€
  ë‚˜. ìƒë‹´ í¬ë§ ë‚ ì§œ, ì‹œê°„, ìƒë‹´ìš”ì²­ ë‚´ìš© ë¯¸ë¦¬ íŒŒì•… 

ë¶™ì„  20xxí•™ë…„ë„ í•™ë¶€ëª¨ ìƒë‹´ì£¼ê°„ ìš´ì˜ ê³„íš 1ë¶€. ë
---
ì œëª©: 20â—‹â—‹í•™ë…„ë„ ì¢…í•© í•™ìŠµë°œí‘œíšŒ ê³„íš(ì•ˆ)
  20â—‹â—‹í•™ë…„ë„ í•™êµêµìœ¡ê³¼ì • ìš´ì˜ ê³„íšì— ì˜ê±° ë¶™ì„ê³¼ ê°™ì´ ì¢…í•© í•™ìŠµë°œí‘œíšŒë¥¼  ì‹¤ì‹œí•˜ê³ ìí•©ë‹ˆë‹¤.
1. ì¼ì‹œ: 20â—‹â—‹. 11.23(ê¸ˆ) 14:00 ~
2. ì¥ì†Œ: 00ê´€ ë° ìš´ë™ì¥ ì£¼ë³€
3. ìš´ì˜í”„ë¡œê·¸ë¨ : í•™ì˜ˆë°œí‘œíšŒ, ì‘í’ˆì „ì‹œíšŒ
4. ì£¼ì œ: ê¿ˆê³¼ ë¼ë¥¼ í¼ì¹˜ëŠ” 00 í•œë§ˆë‹¹ ì¶•ì œ
5. ì„¸ë¶€ì¶”ì§„ì‚¬í•­ : ë¶™ì„ ì°¸ì¡°

ë¶™ì„   20â—‹â—‹ ì¢…í•©í•™ìŠµë°œí‘œíšŒ ìš´ì˜ ê³„íš(ì•ˆ) 1ë¶€. ë. 
---
ì œëª©: 20â—‹â—‹í•™ë…„ë„ ì…í•™ì‹ ê³„íš
  20â—‹â—‹ í•™êµ êµìœ¡ê³¼ì • ìš´ì˜ ê³„íšì— ì˜ê±° ì•„ë˜ì™€ ê°™ì´ ì…í•™ì‹ì„ ìš´ì˜í•˜ê³ ì í•©ë‹ˆë‹¤.
1. ì¼ì‹œ: 20â—‹â—‹. 3. 2(ê¸ˆ) 10:00 ~
2. ì¥ì†Œ: 00ê´€
3. ëŒ€ìƒ: ì‹ ì…ìƒ 000ëª…, ì¬í•™ìƒ 6í•™ë…„ 2í•™ê¸‰
4. ì…í•™ì‹ìˆœ : ì²¨ë¶€
           
ë¶™ì„: 1. ì…í•™ì‹ìˆœ 1ë¶€
      2. ì…í•™í—ˆê°€ì„œ 1ë¶€
      3. ì¬í•™ìƒ í™˜ì˜ì‚¬ 1ë¶€
      4. ì‹ ì…ìƒ ë‹µì‚¬ 1ë¶€. ë.
---
ì œëª©: ê·€êµ­í•™ìƒ ì¬ì·¨í•™ì— ë”°ë¥¸ ì¡°ê¸°ì§„ê¸‰, ì¡¸ì—…, ì§„í•™ í‰ê°€ìœ„ì›íšŒ ê°œìµœ
1. ê´€ë ¨: ì´ˆâ€¤ ì¤‘ë“±êµìœ¡ë²•ì‹œí–‰ë ¹ ì œ 29ì¡° (ìœ ì˜ˆì ë“±ì˜ í•™ì ê´€ë¦¬) 2í•­
2. ì˜ë¬´êµìœ¡ì„ ìœ ì˜ˆ â€¤ ë©´ì œ â€¤ ì •ì›ì™¸ ê´€ë¦¬ ì¤‘ì¸ í•™ìƒì´ ì¬ì·¨í•™ í•˜ê³ ì í•˜ì—¬ ì¡°ê¸°ì§„ê¸‰â€¤ì¡¸ì—…â€¤ì§„í•™ í‰ê°€ìœ„ì›íšŒì˜ë¥¼ ë‹¤ìŒê³¼ ê°™ì´ ê°œìµœí•˜ê³ ì í•©ë‹ˆë‹¤.
  ê°€. ëª© ì  : í•´ì™¸ ê±°ì£¼ë¡œ ì¸í•˜ì—¬ ê·€êµ­ í›„ êµê³¼, ì–¸ì–´, í•™ìƒ ìƒí™œì— ìˆì–´ í•™ìƒì˜                          ìˆ˜ì¤€ì„ íŒŒì•…í•˜ì—¬ í•™êµìƒí™œì— ì˜ ì ì‘í•  ìˆ˜ ìˆë„ë¡ í•œë‹¤. 
  ë‚˜. ë‚´ ìš© 
    1) ì¡°ê¸°ì§„ê¸‰â€¤ì¡¸ì—…â€¤ì§„í•™ í‰ê°€ìœ„ì›íšŒë¥¼ êµ¬ì„±í•˜ë©°, ìœ„ì›ì€ ë³¸êµì— ì¬ì§ ì¤‘ì¸ êµì› ì¤‘ 5ì¸ ì´ë‚´ë¡œ êµ¬ì„±í•˜ë©°, ìœ„ì›ì¥ì€ êµì¥ìœ¼ë¡œ í•œë‹¤.
    2) í‰ê°€êµê³¼ëŠ” 2-3í•™ë…„ì€ êµ­ì–´, ìˆ˜í•™ êµê³¼ë¥¼ 4-6í•™ë…„ì€ êµ­ì–´, ìˆ˜í•™, ì‚¬íšŒ, ê³¼í•™ ë‚´ìš©             ì¤‘ ì¡°ê¸°ì§„ê¸‰â€¤ì¡¸ì—…â€¤ì§„í•™ í‰ê°€ìœ„ì›íšŒì˜ ì¶œì œ ë¬¸í•­ì„ í‰ê°€í•œë‹¤.  
    3) êµê³¼ë³„ ì´ìˆ˜ì¸ì • ì ìˆ˜ëŠ” 60ì  ì´ìƒìœ¼ë¡œ í•œë‹¤. 
    4) í•™êµì¥ì´ í•™ìƒì„ ë©´ë‹´í•œ í›„ êµê³¼ëª©ë³„ ì´ìˆ˜ì¸ì • í‰ê°€ê²°ê³¼ì— ë”°ë¼ í•™ë…„ì„ ê²°ì •í•œë‹¤. 
    5) ê·€êµ­í•™ìƒì´ íƒ€í•™êµ ì¬í•™ ì¤‘ì— ìœ ì˜ˆ, ë©´ì œ, ì •ì›ì™¸ ê´€ë¦¬ë˜ì—ˆì„ ë•ŒëŠ” íƒ€í•™êµì—ì„œ             ì„œë¥˜ë¥¼ ì†¡ë¶€ë°›ì•„ ìƒí™œê¸°ë¡ë¶€ì— ì²¨ë¶€í† ë¡ í•œë‹¤.
  ë‹¤. ì ˆ ì°¨
    ê·€êµ­í•™ìƒ ì ‘ìˆ˜ â†’ êµê³¼ëª©ë³„ ì´ìˆ˜ì¸ì • í‰ê°€ â†’ ì¡°ê¸°ì§„ê¸‰â€¤ì¡¸ì—…â€¤ì§„í•™ í‰ê°€ìœ„ì›íšŒì˜ â†’ í•™êµì¥ ê²°ì¬ â†’ í•™ë…„ë°˜ ì§€ì • â†’ íƒ€í•™êµ ì¬í•™ì´ ìˆëŠ” ê²½ìš° ì„œë¥˜ ì†¡ë¶€ìš”ì²­
 
ë¶™ì„  1. 3í•™ë…„ êµê³¼ëª©ë³„ ì´ìˆ˜ì¸ì • í‰ê°€ì§€ 1ë¶€.
      2. 4í•™ë…„ êµê³¼ëª©ë³„ ì´ìˆ˜ì¸ì • í‰ê°€ì§€ 1ë¶€. ë.
---
ì œëª©: â—‹â—‹ì‹œ í•™êµìš´ì˜ìœ„ì›ì¥í˜‘ì˜íšŒ ì¥í•™ìƒ ì„ ë°œì„ ìœ„í•œ ì¥í•™ìƒ ì„ ì •ìœ„ì›íšŒ ê°œìµœ
1. ê´€ë ¨ : êµìœ¡ì§€ì›ê³¼-31889(2000.10.1.)
2. â—‹â—‹ì‹œ í•™êµìš´ì˜ìœ„ì›ì¥í˜‘ì˜íšŒì˜ ì¥í•™ìƒ ì¶”ì²œ ì˜ë¢°ì— ë”°ë¼ ì¥í•™ìƒ ì„ ì •ìœ„ì›íšŒë¥¼ ê°œìµœí•˜ê³ ì í•©ë‹ˆë‹¤.
  ê°€. ì¼ì‹œ ë° ì¥ì†Œ : 2018.10.2.(í™”) 12:30~00:00, êµë¬´ì‹¤
  ë‚˜. ì°¸ì„ ëŒ€ìƒ : ì‹œìƒê´€ë¦¬ìœ„ì›(10ëª…)
  ë‹¤. í˜‘ì˜ ë‚´ìš© : ì¥í•™ìƒ ì¶”ì²œì ì„ ì • 1ëª…
  ë¼. ì¶”ì²œ ëŒ€ìƒì ì„ ì • ê¸°ì¤€
    1) í•™êµë°œì „ì— ì´ë°”ì§€í•œ í•™ìƒ
    2) í•™êµìƒí™œì´ íƒ€ì˜ ëª¨ë²”ì´ ë˜ëŠ” í•™ìƒ
    3) ê¸°íƒ€ ê°€ì • ë° ê°œì¸ í˜•í¸ìƒ ë„ì›€ì´ í•„ìš”í•œ í•™ìƒ
    4) ì¥í•™ê¸ˆ ê¸°ìˆ˜ì—¬ì ì œì™¸.  ë.
---
ì œëª©: 20â—‹â—‹í•™ë…„ë„ í•™ë¶€ëª¨íšŒ ì´íšŒ ê°œìµœ
  20â—‹â—‹í•™ë…„ë„ í•™ë¶€ëª¨íšŒ ì´íšŒë¥¼ ë‹¤ìŒê³¼ ê°™ì´ ê°œìµœí•˜ê³ ì í•©ë‹ˆë‹¤.
1. ì¼ì‹œ : 20â—‹â—‹. 3. 19(í™”). ì˜¤í›„ 6ì‹œ(ì‹œê°„ ì—„ìˆ˜ ë°”ëë‹ˆë‹¤.) 
2. ëŒ€ìƒ : í•™ë¶€ëª¨
3. ì¥ì†Œ : ë³¸êµ ê°•ë‹¹
4. í–‰ì‚¬ë‚´ìš©
  ê°€. 20â—‹â—‹í•™ë…„ë„ í•™êµêµìœ¡ê³¼ì • ì„¤ëª…íšŒ
  ë‚˜. ë…¹ìƒ‰ì–´ë¨¸ë‹ˆíšŒ ë°œëŒ€ì‹
  ë‹¤. ìœ„ì´‰ì¥ìˆ˜ì—¬(ëª…ì˜ˆì‚¬ì„œë„ìš°ë¯¸, â€˜ì—„ë§ˆ ì±… ì½ì–´ ì£¼ì„¸ìš”â€™ ê°•ì‚¬)
5. í•™ë¶€ëª¨ ì—°ìˆ˜
  ê°€. í•™êµí­ë ¥ ì˜ˆë°© ì—°ìˆ˜
  ë‚˜. êµì›ëŠ¥ë ¥ ê°œë°œ í‰ê°€ ê´€ë ¨ ì—°ìˆ˜ 
6. ì´íšŒ ì•ˆê±´ 
  ê°€. 20â—‹â—‹í•™ë…„ë„ í•™ë¶€ëª¨íšŒì„ì› ì„ ì¶œ(íšŒì¥, ê°ì‚¬2)
  ë‚˜. êµìœ¡ ìƒë‹´(ë‹´ì„ê³¼ì˜ ëŒ€í™” ì‹œê°„ ìš´ì˜)

ë¶™ì„  1. í•™ë¶€ëª¨íšŒ ì´íšŒ ì•ˆë‚´ì¥ 1ë¶€.
      2. í•™ë¶€ëª¨ì´íšŒ íšŒìˆœ 1ë¶€.
      3. í•™ë¶€ëª¨ ì´íšŒ í˜„ìˆ˜ë§‰(ì•ˆ) 1ë¶€. ë.
---
ì œëª©: 20â—‹â—‹í•™ë…„ë„ ì¡¸ì—…ìƒ ì‹œìƒê·œì • ê°œì •ì„ ìœ„í•œ êµë¬´ê¸°íšìœ„ì›íšŒ ê°œìµœ
  20â—‹â—‹í•™ë…„ë„ ì¡¸ì—…ìƒ ì‹œìƒê·œì • ê°œì • ê´€ë ¨ í˜‘ì˜ë¥¼ ìœ„í•œ êµë¬´ê¸°íšìœ„ì›íšŒë¥¼ ì•„ë˜ì™€ ê°™ì´ ê°œìµœí•˜ê³ ì í•©ë‹ˆë‹¤.
1. ì¼ì‹œ: 20â—‹â—‹. 3. 18(ì›”), 15:00
2. ì¥ì†Œ: êµë¬´ì‹¤
3. ì°¸ì„ëŒ€ìƒ: êµë¬´ê¸°íšìœ„ì›íšŒ ìœ„ì›ì¥(êµê° 000), êµë¬´ë¶€ì¥, 6í•™ë…„ ê° ë°˜ ë‹´ì„êµì‚¬, ì‹œìƒê´€ë¦¬ ì—…ë¬´ë‹´ë‹¹ì ë“± 11ëª…
4. ì•ˆê±´: 20â—‹â—‹í•™ë…„ë„ ì¡¸ì—…ìƒ ì‹œìƒ ê·œì • ê°œì •
â€» ì°¸ì„ëŒ€ìƒìëŠ” 20â—‹â—‹í•™ë…„ë„ ì¡¸ì—…ìƒ ì‹œìƒê·œì •(ë¶™ì„ë¬¸ì„œ) ìˆ™ë… í›„ ì°¸ì„

ë¶™ì„   20â—‹â—‹í•™ë…„ë„ ì¡¸ì—…ìƒ ì‹œìƒê·œì •_00ì´ˆ 1ë¶€.  ë.`;
            officialForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const user = auth.currentUser;
                if (!user) return;
                const topic = officialTopic.value.trim();
                if (!topic) return;
                const referenceText = officialReference.value.trim();
                let agency = '', docNumber = '', date = '';
                if (referenceText) {
                    try {
                        const parsePrompt = `ë‹¤ìŒ ë¬¸ì¥ì—ì„œ ê´€ë ¨ ê¸°ê´€, ë¬¸ì„œ ë²ˆí˜¸, ë‚ ì§œë¥¼ JSONìœ¼ë¡œ ì¶”ì¶œí•´ì¤˜. í¬ë§·: {"agency":"", "docNumber":"", "date":""} ë¬¸ì¥: ${referenceText}`;
                        const parseRes = await fetch('/.netlify/functions/generatePlan', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ prompt: parsePrompt, model: GEMINI_MODEL })
                        });
                        const parseResult = await parseRes.json();
                        const text = parseResult.candidates?.[0]?.content?.parts?.[0]?.text;
                        if (text) {
                            const jsonMatch = text.match(/\{[\s\S]*\}/);
                            if (jsonMatch) {
                                const obj = JSON.parse(jsonMatch[0]);
                                agency = obj.agency || '';
                                docNumber = obj.docNumber || '';
                                date = obj.date || '';
                            }
                        }
                    } catch (err) {
                        console.error('Evidence Parse Error:', err);
                    }
                }
                const attachments = Array.from(attachmentsContainer.querySelectorAll('input[type="file"]'))
                    .map(input => input.files[0]?.name)
                    .filter(Boolean);

                let prompt = `ë‹¤ìŒ ê¸°ì•ˆë¬¸ ì˜ˆì‹œë¥¼ ì°¸ê³ í•˜ì—¬ ê¸°ì•ˆë¬¸ì„ ì‘ì„±í•´ì¤˜.\nì˜ˆì‹œ:\n${officialDocExamples}\n\nì£¼ì œ: ${topic}`;
                if (agency || docNumber || date) prompt += `\nê·¼ê±°: ${agency}-${docNumber}(${date})`;
                if (attachments.length) prompt += `\nì²¨ë¶€íŒŒì¼: ${attachments.join(', ')}`;
                prompt += `\ní˜•ì‹:\nì œëª© ${topic}\n1. ê´€ë ¨: [ê·¼ê±°]\n   - ê´„í˜¸ ì•ˆ ë‚ ì§œëŠ” 'YYYY.M.D.' í˜•ì‹ìœ¼ë¡œ ëì— ë§ˆì¹¨í‘œë¥¼ í¬í•¨í•´ ì‘ì„±í•´\n2. ${topic}ì„ ë°˜ì˜í•œ ë‚´ìš©`;
                if (attachments.length > 1) {
                    const attachmentList = attachments
                        .map((a, idx) => `${idx + 1}. ${a} 1ë¶€.`)
                        .join('\n      ');
                    prompt += `\n\në¶™ì„  ${attachmentList}  ë.`;
                } else if (attachments.length === 1) {
                    prompt += `\n\në¶™ì„  ${attachments[0]} 1ë¶€.  ë.`;
                } else {
                    prompt += `\n\në.`;
                }
                prompt += `\nê·¼ê±° ì •ë³´ê°€ ì—†ìœ¼ë©´ '1. ê´€ë ¨:' í•­ëª©ì€ ìƒëµí•˜ê³ , ì²¨ë¶€íŒŒì¼ì´ ì—†ìœ¼ë©´ ë¶™ì„ ë¶€ë¶„ì€ ìƒëµí•´.`;
                if (attachments.length > 1) {
                    prompt += ` ì²¨ë¶€íŒŒì¼ì´ ì—¬ëŸ¬ ê°œì¸ ê²½ìš° ë²ˆí˜¸ë¥¼ ë¶™ì—¬ êµ¬ë¶„í•´.`;
                }
                prompt += ` ì œëª©ì€ ì²« ì¤„ì—ë§Œ ì‘ì„±í•´. ì¶”ê°€ ì„¤ëª… ì—†ì´ ë§ˆí¬ë‹¤ìš´ìœ¼ë¡œ ì‘ì„±í•´.`;
                prompt += ` í•­ëª©ì€ í•­ìƒ '1.', '2.'ì™€ ê°™ì´ ìˆ«ì ëª©ë¡ í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•˜ê³ , ë¶ˆë¦¿ ê¸°í˜¸ëŠ” ì‚¬ìš©í•˜ì§€ ë§ˆ.`;
                prompt += ` 'ë¶™ì„' ë‹¤ìŒì—ëŠ” ë‘ ì¹¸ì„ ë„ìš°ê³ , ê°™ì€ ì¤„ì—ì„œ ë‘ ì¹¸ì„ ë„ìš´ ë’¤ 'ë.'ìœ¼ë¡œ ë§ˆë¬´ë¦¬í•´.`;

                try {
                    const response = await fetch('/.netlify/functions/generatePlan', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt, model: GEMINI_MODEL })
                    });
                    const result = await response.json();
                    if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                        const fullText = extractMarkdownFromText(result.candidates[0].content.parts[0].text);
                        const lines = fullText.split('\n');
                        currentOfficialTitle = lines.shift().trim();
                        currentOfficialMarkdown = formatOfficialMarkdown(lines.join('\n').trim());
                        officialTitle.textContent = currentOfficialTitle;
                        generatedOfficialContainer.innerHTML = renderOfficialContent(currentOfficialMarkdown);
                        officialOutputSection.classList.remove('hidden');
                        officialModifySection.classList.remove('hidden');
                        officialTopic.value = '';
                        officialReference.value = '';
                        attachmentsContainer.innerHTML = '';
                        const docRef = await addDoc(collection(db, "users", user.uid, "officials"), {
                            title: currentOfficialTitle,
                            createdAt: serverTimestamp(),
                            rawContent: currentOfficialMarkdown
                        });
                        currentOfficialId = docRef.id;
                        loadAndDisplayItems('officials', officialSavedList, viewOfficial);
                    }
                } catch (err) {
                    console.error('Official Generation Error:', err);
                }
            });

            editOfficialBtn.addEventListener('click', () => {
                if (!currentOfficialMarkdown) return;
                if (!isEditingOfficial) {
                    isEditingOfficial = true;
                    editOfficialBtn.textContent = 'ì™„ë£Œ';
                    editOfficialBtn.classList.add('bg-green-500', 'text-white');
                    const textarea = document.createElement('textarea');
                    textarea.id = 'official-editor';
                    textarea.className = 'w-full h-48 p-2 border rounded-md font-mono text-sm';
                    textarea.value = currentOfficialMarkdown;
                    generatedOfficialContainer.replaceWith(textarea);
                } else {
                    const textarea = document.getElementById('official-editor');
                    currentOfficialMarkdown = formatOfficialMarkdown(textarea.value);
                    const newDiv = document.createElement('div');
                    newDiv.id = 'generated-official-container';
                    newDiv.className = 'plan-section-content';
                    newDiv.innerHTML = renderOfficialContent(currentOfficialMarkdown);
                    textarea.replaceWith(newDiv);
                    generatedOfficialContainer = newDiv;
                    isEditingOfficial = false;
                    editOfficialBtn.textContent = 'í¸ì§‘';
                    editOfficialBtn.classList.remove('bg-green-500', 'text-white');
                    saveCurrentOfficial();
                }
            });

            copyOfficialBtn.addEventListener('click', () => {
                if (!currentOfficialMarkdown && !currentOfficialTitle) return;
                const htmlToCopy = markdownToHtml(`${currentOfficialTitle}\n${currentOfficialMarkdown}`);
                copyToClipboard(htmlToCopy, true);
            });

            editOfficialTitleBtn.addEventListener('click', () => {
                const isEditing = editOfficialTitleBtn.textContent === 'ì™„ë£Œ';
                if (isEditing) {
                    officialTitle.textContent = officialTitleInput.value;
                    officialTitle.classList.remove('hidden');
                    officialTitleInput.classList.add('hidden');
                    editOfficialTitleBtn.textContent = 'í¸ì§‘';
                    editOfficialTitleBtn.classList.remove('bg-green-500', 'text-white');
                    currentOfficialTitle = officialTitle.textContent;
                    saveCurrentOfficial();
                } else {
                    officialTitleInput.value = officialTitle.textContent;
                    officialTitle.classList.add('hidden');
                    officialTitleInput.classList.remove('hidden');
                    officialTitleInput.focus();
                    editOfficialTitleBtn.textContent = 'ì™„ë£Œ';
                    editOfficialTitleBtn.classList.add('bg-green-500', 'text-white');
                }
            });

            copyOfficialTitleBtn.addEventListener('click', () => {
                if (!officialTitle.textContent) return;
                copyToClipboard(officialTitle.textContent);
            });

            officialModifyForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!currentOfficialMarkdown && !currentOfficialTitle) return;
                const userPrompt = officialModifyPrompt.value.trim();
                if (!userPrompt) return;
                const currentContent = `${currentOfficialTitle}\n${currentOfficialMarkdown}`;
                const prompt = `ë‹¤ìŒ ê¸°ì•ˆë¬¸ì„ ì‚¬ìš©ìì˜ ìš”ì²­ì— ë§ê²Œ ìˆ˜ì •í•´ì¤˜.\nê¸°ì•ˆë¬¸:\n${currentContent}\n\nìš”ì²­: ${userPrompt}\n\nìˆ˜ì •ëœ ê¸°ì•ˆë¬¸ì„ ë™ì¼í•œ í˜•ì‹(ì²« ì¤„ì€ ì œëª©)ìœ¼ë¡œ ë§ˆí¬ë‹¤ìš´ìœ¼ë¡œ ì¶œë ¥í•´ì¤˜.`;
                try {
                    const response = await fetch('/.netlify/functions/generatePlan', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt, model: GEMINI_MODEL })
                    });
                    const result = await response.json();
                    if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                        const fullText = extractMarkdownFromText(result.candidates[0].content.parts[0].text);
                        const lines = fullText.split('\n');
                        currentOfficialTitle = lines.shift().trim();
                        currentOfficialMarkdown = formatOfficialMarkdown(lines.join('\n').trim());
                        officialTitle.textContent = currentOfficialTitle;
                        if (isEditingOfficial) {
                            const textarea = document.getElementById('official-editor');
                            textarea.value = currentOfficialMarkdown;
                        } else {
                            generatedOfficialContainer.innerHTML = renderOfficialContent(currentOfficialMarkdown);
                        }
                        saveCurrentOfficial();
                        officialModifyPrompt.value = '';
                    }
                } catch (err) {
                    console.error('Official Modify Error:', err);
                }
            });
        }

        if (letterForm) {
            let letterExamples = '';
            fetch('/letter_examples.txt')
                .then(response => response.text())
                .then(text => { letterExamples = text; });

            letterForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const user = auth.currentUser;
                if (!user) return;
                const topic = letterTopic.value.trim();
                if (!topic) return;
                const prompt = `ë‹¤ìŒ ê°€ì •í†µì‹ ë¬¸ ì˜ˆì‹œë¥¼ ì°¸ê³ í•˜ì—¬ ê°€ì •í†µì‹ ë¬¸ì„ ë§ˆí¬ë‹¤ìš´ í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•´ì¤˜.\nì˜ˆì‹œ:\n${letterExamples}\n\nì£¼ì œ: ${topic}\nì¶”ê°€ ì„¤ëª… ì—†ì´ ë‚´ìš©ë§Œ ì¶œë ¥í•´.`;
                try {
                    const response = await fetch('/.netlify/functions/generatePlan', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt, model: GEMINI_MODEL })
                    });
                    const result = await response.json();
                    if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                        currentLetterMarkdown = extractMarkdownFromText(result.candidates[0].content.parts[0].text);
                        generatedLetterContainer.innerHTML = parseMarkdown(currentLetterMarkdown);
                        letterOutputSection.classList.remove('hidden');
                        letterModifySection.classList.remove('hidden');
                        letterTopic.value = '';
                        const conciseTitle = await generateConciseTitleFromInput(topic, topic);
                        const docRef = await addDoc(collection(db, "users", user.uid, "letters"), {
                            title: conciseTitle,
                            createdAt: serverTimestamp(),
                            rawContent: currentLetterMarkdown
                        });
                        currentLetterId = docRef.id;
                        loadAndDisplayItems('letters', letterSavedList, viewLetter);
                    }
                } catch (err) {
                    console.error('Letter Generation Error:', err);
                }
            });

            editLetterBtn.addEventListener('click', () => {
                if (!currentLetterMarkdown) return;
                if (!isEditingLetter) {
                    isEditingLetter = true;
                    editLetterBtn.textContent = 'ì™„ë£Œ';
                    editLetterBtn.classList.add('bg-green-500', 'text-white');
                    const textarea = document.createElement('textarea');
                    textarea.id = 'letter-editor';
                    textarea.className = 'w-full h-48 p-2 border rounded-md font-mono text-sm';
                    textarea.value = currentLetterMarkdown;
                    generatedLetterContainer.replaceWith(textarea);
                } else {
                    const textarea = document.getElementById('letter-editor');
                    currentLetterMarkdown = textarea.value;
                    const newDiv = document.createElement('div');
                    newDiv.id = 'generated-letter-container';
                    newDiv.className = 'plan-section-content';
                    newDiv.innerHTML = parseMarkdown(currentLetterMarkdown);
                    textarea.replaceWith(newDiv);
                    generatedLetterContainer = newDiv;
                    isEditingLetter = false;
                    editLetterBtn.textContent = 'í¸ì§‘';
                    editLetterBtn.classList.remove('bg-green-500', 'text-white');
                    saveCurrentLetter();
                }
            });

            copyLetterBtn.addEventListener('click', () => {
                if (!currentLetterMarkdown) return;
                const htmlToCopy = currentLetterMarkdown.includes('|') ?
                    markdownTableToHtmlClipboard(currentLetterMarkdown) :
                    markdownToHtml(currentLetterMarkdown);
                copyToClipboard(htmlToCopy, true);
            });

            letterModifyForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!currentLetterMarkdown) return;
                const userPrompt = letterModifyPrompt.value.trim();
                if (!userPrompt) return;
                const prompt = `ë‹¤ìŒ ê°€ì •í†µì‹ ë¬¸ì„ ì‚¬ìš©ìì˜ ìš”ì²­ì— ë§ê²Œ ìˆ˜ì •í•´ì¤˜.\në‚´ìš©:\n${currentLetterMarkdown}\n\nìš”ì²­: ${userPrompt}\n\nìˆ˜ì •ëœ ê°€ì •í†µì‹ ë¬¸ì„ ë§ˆí¬ë‹¤ìš´ í˜•ì‹ìœ¼ë¡œ ì¶œë ¥í•´ì¤˜.`;
                try {
                    const response = await fetch('/.netlify/functions/generatePlan', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt, model: GEMINI_MODEL })
                    });
                    const result = await response.json();
                    if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                        currentLetterMarkdown = extractMarkdownFromText(result.candidates[0].content.parts[0].text);
                        if (isEditingLetter) {
                            const textarea = document.getElementById('letter-editor');
                            textarea.value = currentLetterMarkdown;
                        } else {
                            generatedLetterContainer.innerHTML = parseMarkdown(currentLetterMarkdown);
                        }
                        saveCurrentLetter();
                        letterModifyPrompt.value = '';
                    }
                } catch (err) {
                    console.error('Letter Modify Error:', err);
                }
            });
        }

        // --- FIRESTORE & DATA HANDLING ---
        async function openPlan(planId) {
            const user = auth.currentUser;
            if (!user || !planId) return;
            const docRef = doc(db, "users", user.uid, "plans", planId);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const planToView = docSnap.data();
                switchView('plan');
                displayContent(planToView.rawContent, planToView.title, planToView.summaryContent || null);
                currentPlanId = planId;
                outputPanel.scrollIntoView({ behavior: 'smooth' });
            }
        }

        const loadAndDisplayPlans = async () => {
            const user = auth.currentUser;
            if (!user) return;
            
            const plansCollectionRef = collection(db, "users", user.uid, "plans");
            const q = query(plansCollectionRef);
            
            try {
                const querySnapshot = await getDocs(q);
                const plans = [];
                querySnapshot.forEach((doc) => {
                    plans.push({ id: doc.id, ...doc.data() });
                });

                plans.sort((a, b) => (b.createdAt?.toMillis?.() || b.createdAt?.seconds || 0) - (a.createdAt?.toMillis?.() || a.createdAt?.seconds || 0));
                const populateList = (container, planList) => {
                    if (!container) return;
                    container.innerHTML = '';
                    if (!planList || planList.length === 0) {
                        container.innerHTML = `<p class="text-gray-500 text-center py-4">ì•„ì§ ìƒì„±ëœ ê³„íšì„œê°€ ì—†ìŠµë‹ˆë‹¤.</p>`;
                        return;
                    }
                    planList.forEach((plan) => {
                        const planElement = document.createElement('div');
                        planElement.className = 'p-4 border rounded-md hover:bg-gray-50 transition-colors flex justify-between items-center cursor-pointer';

                        const infoWrapper = document.createElement('div');
                        const titleEl = document.createElement('p');
                        titleEl.className = 'font-semibold';
                        titleEl.textContent = plan.title || 'ì œëª© ì—†ìŒ';
                        const dateEl = document.createElement('p');
                        dateEl.className = 'text-sm text-gray-500';
                        dateEl.textContent = `ìƒì„±ì¼: ${formatDateTime(plan.createdAt, false)}`;
                        infoWrapper.appendChild(titleEl);
                        infoWrapper.appendChild(dateEl);

                        const actionsWrapper = document.createElement('div');
                        actionsWrapper.className = 'flex items-center gap-2';

                        const renameBtn = document.createElement('button');
                        renameBtn.className = 'rename-plan-btn text-sm font-medium text-green-600 hover:underline';
                        renameBtn.textContent = 'ìˆ˜ì •';
                        renameBtn.addEventListener('click', async (e) => {
                            e.stopPropagation();
                            const user = auth.currentUser;
                            if (!user) return;
                            const targetPlan = plans.find(p => p.id === plan.id);
                            const newName = prompt('ìƒˆ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”', targetPlan?.title || '');
                            if (newName && newName.trim()) {
                                await updateDoc(doc(db, "users", user.uid, "plans", plan.id), { title: newName.trim() });
                                loadAndDisplayPlans();
                            }
                        });

                        const copyBtn = document.createElement('button');
                        copyBtn.className = 'copy-plan-btn text-sm font-medium text-purple-600 hover:underline';
                        copyBtn.textContent = 'ë³µì‚¬';
                        copyBtn.addEventListener('click', async (e) => {
                            e.stopPropagation();
                            const user = auth.currentUser;
                            if (!user) return;
                            const planData = plans.find(p => p.id === plan.id);
                            if (!planData) return;
                            const baseTitle = (planData.title || 'ê³„íšì„œ').replace(/\(ë³µì‚¬ë³¸\d+\)$/,'');
                            let maxCopy = 0;
                            plans.forEach(p => {
                                const match = (p.title || '').match(new RegExp(`^${baseTitle}\\(ë³µì‚¬ë³¸(\\d+)\\)$`));
                                if (match) maxCopy = Math.max(maxCopy, parseInt(match[1]));
                            });
                            const newTitle = `${baseTitle}(ë³µì‚¬ë³¸${maxCopy + 1})`;
                            const { id: _id, createdAt: _createdAt, ...rest } = planData;
                            await addDoc(collection(db, "users", user.uid, "plans"), {
                                ...rest,
                                title: newTitle,
                                createdAt: serverTimestamp(),
                            });
                            loadAndDisplayPlans();
                        });

                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'delete-plan-btn text-sm font-medium text-red-600 hover:underline';
                        deleteBtn.textContent = 'ì‚­ì œ';
                        deleteBtn.addEventListener('click', async (e) => {
                            e.stopPropagation();
                            const user = auth.currentUser;
                            if (!user) return;
                            try {
                                deleteBtn.disabled = true;
                                await deleteDoc(doc(db, "users", user.uid, "plans", plan.id));
                                loadAndDisplayPlans();
                            } catch (error) {
                                console.error("Error deleting plan:", error);
                            }
                        });

                        actionsWrapper.appendChild(renameBtn);
                        actionsWrapper.appendChild(copyBtn);
                        actionsWrapper.appendChild(deleteBtn);

                        planElement.appendChild(infoWrapper);
                        planElement.appendChild(actionsWrapper);
                        planElement.addEventListener('click', () => openPlan(plan.id));

                        container.appendChild(planElement);
                    });
                };

                const filterPlansByTerm = (term) => {
                    const normalized = (term || '').trim().toLowerCase();
                    if (!normalized) return plans;
                    return plans.filter(plan => (plan.title || '').toLowerCase().includes(normalized));
                };

                const recentTerm = recentPlanSearchInput?.value || '';
                const planTerm = planSearchInput?.value || '';
                const filteredPlans = filterPlansByTerm(planTerm);
                const recentPlans = filterPlansByTerm(recentTerm);
                const recentDisplayPlans = recentTerm.trim() ? recentPlans : plans.slice(0, 5);

                populateList(recentPlansList, recentDisplayPlans);
                if (planSavedList) {
                    populateList(planSavedList, filteredPlans);
                }
            } catch (error) {
                console.error("Error loading plans:", error);
                recentPlansList.innerHTML = `<p class="text-red-500 text-center py-4">ê³„íšì„œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>`;
                if (planSavedList) planSavedList.innerHTML = `<p class="text-red-500 text-center py-4">ê³„íšì„œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>`;
            }
        };

        const loadAndDisplayItems = async (type, container, viewHandler) => {
            const user = auth.currentUser;
            if (!user || !container) return;
            const colRef = collection(db, "users", user.uid, type);
            const q = query(colRef);
            try {
                const snap = await getDocs(q);
                const items = [];
                snap.forEach((doc) => items.push({ id: doc.id, ...doc.data() }));
                items.sort((a, b) => (b.createdAt?.toMillis?.() || b.createdAt?.seconds || 0) - (a.createdAt?.toMillis?.() || a.createdAt?.seconds || 0));

                if (type === 'tables') setHomeListData('tables', items);
                if (type === 'officials') setHomeListData('officials', items);
                if (type === 'letters') setHomeListData('letters', items);

                container.innerHTML = '';
                if (items.length === 0) {
                    container.innerHTML = `<p class="text-gray-500 text-center py-4">ì €ì¥ëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
                    return;
                }

                const searchInput = type === 'tables' ? tableSearchInput : type === 'officials' ? officialSearchInput : type === 'letters' ? letterSearchInput : null;
                const searchTerm = (searchInput?.value || '').trim().toLowerCase();
                const displayItems = searchTerm
                    ? items
                        .filter(item => (item.title || '').toLowerCase().includes(searchTerm))
                        .sort((a, b) => (a.createdAt?.toMillis?.() || a.createdAt?.seconds || 0) - (b.createdAt?.toMillis?.() || b.createdAt?.seconds || 0))
                    : items;

                if (displayItems.length === 0) {
                    container.innerHTML = `<p class="text-gray-500 text-center py-4">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>`;
                    return;
                }

                displayItems.forEach(item => {
                    const el = document.createElement('div');
                    el.className = 'p-4 border rounded-md hover:bg-gray-50 transition-colors flex justify-between items-center cursor-pointer';

                    const info = document.createElement('div');
                    const titleEl = document.createElement('p');
                    titleEl.className = 'font-semibold';
                    titleEl.textContent = item.title || 'ì œëª© ì—†ìŒ';
                    const dateEl = document.createElement('p');
                    dateEl.className = 'text-sm text-gray-500';
                    dateEl.textContent = `ìƒì„±ì¼: ${item.createdAt ? formatDateTime(item.createdAt, false) : 'ë‚ ì§œ ì—†ìŒ'}`;
                    info.appendChild(titleEl);
                    info.appendChild(dateEl);

                    const actions = document.createElement('div');
                    actions.className = 'flex items-center gap-2';

                    const renameBtn = document.createElement('button');
                    renameBtn.className = 'text-sm font-medium text-green-600 hover:underline';
                    renameBtn.textContent = 'ìˆ˜ì •';
                    renameBtn.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        const id = item.id;
                        const user = auth.currentUser;
                        if (!user) return;
                        const target = items.find(i => i.id === id);
                        const newName = prompt('ìƒˆ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”', target?.title || '');
                        if (newName && newName.trim()) {
                            await updateDoc(doc(db, "users", user.uid, type, id), { title: newName.trim() });
                            loadAndDisplayItems(type, container, viewHandler);
                        }
                    });

                    const copyBtn = document.createElement('button');
                    copyBtn.className = 'text-sm font-medium text-purple-600 hover:underline';
                    copyBtn.textContent = 'ë³µì‚¬';
                    copyBtn.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        const id = item.id;
                        const user = auth.currentUser;
                        if (!user) return;
                        const target = items.find(i => i.id === id);
                        if (!target) return;
                        const baseTitle = (target.title || '').replace(/\(ë³µì‚¬ë³¸\d+\)$/,'');
                        let maxCopy = 0;
                        items.forEach(i => {
                            const match = (i.title || '').match(new RegExp(`^${baseTitle}\\(ë³µì‚¬ë³¸(\\d+)\\)$`));
                            if (match) maxCopy = Math.max(maxCopy, parseInt(match[1]));
                        });
                        const newTitle = `${baseTitle || 'í•­ëª©'}(ë³µì‚¬ë³¸${maxCopy + 1})`;
                        const { id: _id, createdAt: _createdAt, ...rest } = target;
                        await addDoc(collection(db, "users", user.uid, type), {
                            ...rest,
                            title: newTitle,
                            createdAt: serverTimestamp(),
                        });
                        loadAndDisplayItems(type, container, viewHandler);
                    });

                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'text-sm font-medium text-red-600 hover:underline';
                    deleteBtn.textContent = 'ì‚­ì œ';
                    deleteBtn.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        const id = item.id;
                        const user = auth.currentUser;
                        if (!user) return;
                        await deleteDoc(doc(db, "users", user.uid, type, id));
                        loadAndDisplayItems(type, container, viewHandler);
                    });

                    actions.appendChild(renameBtn);
                    actions.appendChild(copyBtn);
                    actions.appendChild(deleteBtn);

                    el.appendChild(info);
                    el.appendChild(actions);
                    el.addEventListener('click', () => viewHandler(item.id));

                    container.appendChild(el);
                });
            } catch (err) {
                console.error(`Error loading ${type}:`, err);
                container.innerHTML = `<p class="text-red-500 text-center py-4">ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>`;
            }
        };

        async function viewTable(id) {
            const user = auth.currentUser;
            if (!user) return;
            const docRef = doc(db, "users", user.uid, "tables", id);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                switchView('table');
                currentTableId = id;
                currentTableMarkdown = data.rawContent;
                generatedTableContainer.innerHTML = renderMarkdownTable(currentTableMarkdown);
                tableOutputSection.classList.remove('hidden');
                tableModifySection.classList.remove('hidden');
            }
        }

        async function viewOfficial(id) {
            const user = auth.currentUser;
            if (!user) return;
            const docRef = doc(db, "users", user.uid, "officials", id);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                switchView('official');
                currentOfficialId = id;
                currentOfficialTitle = data.title;
                currentOfficialMarkdown = formatOfficialMarkdown(data.rawContent || '');
                officialTitle.textContent = currentOfficialTitle;
                generatedOfficialContainer.innerHTML = renderOfficialContent(currentOfficialMarkdown);
                officialOutputSection.classList.remove('hidden');
                officialModifySection.classList.remove('hidden');
            }
        }

        async function viewLetter(id) {
            const user = auth.currentUser;
            if (!user) return;
            const docRef = doc(db, "users", user.uid, "letters", id);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                switchView('letter');
                currentLetterId = id;
                currentLetterMarkdown = data.rawContent;
                generatedLetterContainer.innerHTML = parseMarkdown(currentLetterMarkdown);
                letterOutputSection.classList.remove('hidden');
                letterModifySection.classList.remove('hidden');
            }
        }

        // --- GENERATOR LOGIC ---
        
        schoolLevelButtons.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                schoolLevelButtons.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
            }
        });

        outlineButtons.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                outlineButtons.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                if (e.target.dataset.value === 'ì„¸ë¶€ëª©ì°¨') {
                    currentOutline = [...planOutlineDefinitions["ì„¸ë¶€ëª©ì°¨"]];
                } else {
                    currentOutline = [...planOutlineDefinitions["ê¸°ë³¸ëª©ì°¨"]];
                }
                updateOutlineDescription();
            }
        });

        categoryButtons.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                categoryButtons.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                planCategoryInput.value = e.target.dataset.value;
                updateCategoryDescription();
            }
        });

        addKeywordBtn.addEventListener('click', () => {
            const container = document.createElement('div');
            container.className = 'flex items-center gap-2';
            container.innerHTML = `
                <input type="text" name="keywords" class="keyword-input block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 sm:text-sm" placeholder="ì¶”ê°€ í‚¤ì›Œë“œ">
                <button type="button" class="remove-keyword-btn text-red-500 hover:text-red-700">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 12H6"></path></svg>
                </button>
            `;
            keywordsContainer.appendChild(container);
        });

        keywordsContainer.addEventListener('click', (e) => {
            if (e.target.closest('.remove-keyword-btn')) {
                e.target.closest('.flex').remove();
            }
        });

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            if (!user) return;
            
            formError.classList.add('hidden');

            const planType = customPlanTypeInput.value.trim();
            if (!planType) {
                formError.textContent = 'ê³„íšì„œ ì£¼ì œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
                formError.classList.remove('hidden');
                return;
            }
            
            const keywords = [...document.querySelectorAll('.keyword-input')]
                                .map(input => input.value.trim())
                                .filter(Boolean);
            const currentYear = new Date().getFullYear();
            const activeSchool = schoolLevelButtons.querySelector('.active');
            const schoolLevel = activeSchool ? activeSchool.dataset.value : '';

            initialMessage.classList.add('hidden');
            resultSection.classList.add('hidden');
            errorMessageDiv.classList.add('hidden');
            loadingIndicator.style.display = 'flex';
            generateBtn.disabled = true;
            generateBtn.innerHTML = `<div class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div><span class="ml-2">ìƒì„± ì¤‘...</span>`;
            showToast('ìƒì„± ì¤‘ì…ë‹ˆë‹¤..');

            try {
                let prompt = '';
                const outline = currentOutline;
                const category = planCategoryInput.value;
                const focusInstruction = categoryFocus[category] || '';
                prompt = `ë‹¹ì‹ ì€ ëŒ€í•œë¯¼êµ­ì˜ ìœ ëŠ¥í•œ êµì‚¬ì…ë‹ˆë‹¤. ë‹¤ìŒ ì¡°ê±´ì— ë§ì¶° '${schoolLevel} ${planType}' ì´ˆì•ˆì„ ì‘ì„±í•´ ì£¼ì„¸ìš”.\n\n`;
                if (focusInstruction) {
                    prompt += `- ë¶„ë¥˜: ${category}. ${focusInstruction}\n\n`;
                }
                if (exampleFiles.length) {
                    prompt += `ë‹¤ìŒ ì˜ˆì‹œ ìë£Œì˜ ë¬¸ë²•ê³¼ ë‚´ìš©ì„ ì°¸ê³ í•˜ì—¬ ì‘ì„±í•´ ì£¼ì„¸ìš”.\\n`;
                    exampleFiles.forEach((file, idx) => {
                        prompt += `ì˜ˆì‹œ ${idx + 1} (${file.name}):\\n${file.text}\\n\\n`;
                    });
                }
                prompt += `**ì¶œë ¥ í˜•ì‹:**\n`;
                prompt += `- ì „ì²´ ê³„íšì„œì˜ ì œëª©ì€ 'TITLE: [${currentYear+1}í•™ë…„ë„ ${planType}]'ê³¼ ê°™ì´ ê°„ê²°í•œ í˜•ì‹ìœ¼ë¡œ ì²« ì¤„ì— ëª…ì‹œí•´ ì£¼ì„¸ìš”.\n`;
                prompt += `- ë‚´ìš©ì€ ë°˜ë“œì‹œ ë‹¤ìŒ ${outline.length}ê°œì˜ ì„¹ì…˜ìœ¼ë¡œ ë‚˜ëˆ„ì–´ ì‘ì„±í•˜ê³ , ê° ì„¹ì…˜ ì œëª©ì€ '## 1. ${outline[0].title}'ê³¼ ê°™ì´ '##' ë§ˆí¬ë‹¤ìš´ í—¤ë”ë¥¼ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.\n`;
                prompt += `- ì„¹ì…˜ ìˆœì„œ: ${outline.map((s, i) => `${i+1}. ${s.title}`).join(', ')}\n\n`;
                prompt += `**ì„¹ì…˜ë³„ ì‘ì„± ì¡°ê±´:**\n`;
                outline.forEach((sec, idx) => {
                    switch (sec.type) {
                        case 'bullet':
                            if (sec.title.includes('ì¶”ì§„ ë°°ê²½')) {
                                prompt += `${idx + 1}.  **${sec.title}**: ë¶ˆë¦¿ ë¦¬ìŠ¤íŠ¸(-) í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•˜ë˜, ìµœì†Œ 4ê°œ ì´ìƒì˜ í•­ëª©ì„ í¬í•¨í•˜ê³ , ê° í•­ëª©ì€ ì£¼ì œë‚˜ í•­ëª©ëª…ì„ ì“°ì§€ ë§ê³  ë°”ë¡œ ë‚´ìš©ì„ ì‹œì‘í•˜ì—¬ ë¬¸ì¥ì´ ì•„ë‹Œ ëª…ì‚¬í˜• í‘œí˜„ìœ¼ë¡œ '~ìš”êµ¬', '~í•„ìš”', '~ì¦ëŒ€', '~ì‹¬í™”', '~ëŒ€ë‘' ë“±ìœ¼ë¡œ ëë‚˜ê²Œ ì‘ì„±í•˜ì„¸ìš”.\\n`;
                            } else if (sec.title.includes('ì¶”ì§„ ëª©ì ')) {
                                prompt += `${idx + 1}.  **${sec.title}**: ë¶ˆë¦¿ ë¦¬ìŠ¤íŠ¸(-) í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•˜ë˜, ìµœì†Œ 4ê°œ ì´ìƒì˜ í•­ëª©ì„ í¬í•¨í•˜ê³ , ê° í•­ëª©ì€ ì£¼ì œë‚˜ í•­ëª©ëª…ì„ ì“°ì§€ ë§ê³  ë°”ë¡œ ë‚´ìš©ì„ ì‹œì‘í•˜ì—¬ '~ì‹¤í˜„', '~ì§€ì›', '~êµ¬í˜„', '~í™•ëŒ€', '~ê°•í™”' ë“±ê³¼ ê°™ì€ ëª…ì‚¬í˜• í‘œí˜„ìœ¼ë¡œ ëë‚˜ê²Œ ì‘ì„±í•˜ì„¸ìš”.\\n`;
                            } else if (sec.title.includes('ê¸°ëŒ€íš¨ê³¼') || sec.title.includes('ê¸°ëŒ€ íš¨ê³¼')) {
                                prompt += `${idx + 1}.  **${sec.title}**: ë¶ˆë¦¿ ë¦¬ìŠ¤íŠ¸(-) í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•˜ë˜, ì•„ë˜ ë¬¸ì¥ì„ ì°¸ê³ í•˜ì—¬ êµìœ¡ì  ê¸°ëŒ€ íš¨ê³¼ë¥¼ êµ¬ì²´ì ìœ¼ë¡œ ì‘ì„±í•˜ê³ , ê° í•­ëª©ì€ '~í™•ëŒ€', '~ê°•í™”', '~ë„ëª¨', '~ì¦ëŒ€' ë“±ê³¼ ê°™ì€ ëª…ì‚¬í˜• í‘œí˜„ìœ¼ë¡œ ëë‚˜ê²Œ í•˜ì„¸ìš”. ì°¸ê³  ë¬¸ì¥: ì°½ì˜ë ¥ ì‚¬ê³ ë ¥ì„ í•¨ì–‘í•œë‹¤.; ë°°ì›€ ì¤‘ì‹¬ì˜ í•™ìŠµ ë¬¸í™”ë¥¼ í™•ì‚°í•œë‹¤.; í•™êµ ë‚´ ì†Œí†µê³¼ í˜‘ë ¥ ë¬¸í™”ë¥¼ ì¡°ì„±í•œë‹¤.; í•™ìƒ ë§ì¶¤í˜• êµìœ¡ ê¸°íšŒë¥¼ ë§ˆë ¨í•œë‹¤.; êµì‚¬ì™€ í•™ìƒ ê°„ ìƒí˜¸ì‘ìš©ì„ í™œì„±í™”í•œë‹¤.; êµì‚¬ì˜ ì „ë¬¸ì„±ì„ ê°•í™”í•˜ì—¬ êµìœ¡ë ¥ì„ ì œê³ í•œë‹¤.; êµì‚¬ì™€ í•™ìƒì˜ ì—…ë¬´ í”¼ë¡œë„ë¥¼ ê°ì†Œì‹œí‚¨ë‹¤.; í•™êµ í­ë ¥ ë° ê°ˆë“± ìš”ì¸ì„ ê·¼ì ˆí•œë‹¤.; í•™ë¶€ëª¨ì™€ í•™ìƒì˜ ë§Œì¡±ë„ë¥¼ ì œê³ í•œë‹¤.\\n`;
                            } else if (sec.title.includes('ë°©í–¥')) {
                                prompt += `${idx + 1}.  **${sec.title}**: ë¶ˆë¦¿ ë¦¬ìŠ¤íŠ¸(-) í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•˜ë˜, ìµœì†Œ 4ê°œ ì´ìƒì˜ í•­ëª©ì„ í¬í•¨í•˜ê³ , ê° í•­ëª©ì€ ì£¼ì œë‚˜ í•­ëª©ëª…ì„ ì“°ì§€ ë§ê³  ë°”ë¡œ ë‚´ìš©ì„ ì‹œì‘í•˜ì—¬ '~ì •ë¦½', '~ë§ˆë ¨', '~ì¶”ì§„', '~ê°•í™”' ë“±ê³¼ ê°™ì€ ëª…ì‚¬í˜• í‘œí˜„ìœ¼ë¡œ ëë‚˜ê²Œ ì‘ì„±í•˜ì„¸ìš”.\\n`;
                            } else if (sec.title.includes('ë°©ì¹¨')) {
                                prompt += `${idx + 1}.  **${sec.title}**: ë¶ˆë¦¿ ë¦¬ìŠ¤íŠ¸(-) í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•˜ë˜, ìµœì†Œ 4ê°œ ì´ìƒì˜ í•­ëª©ì„ í¬í•¨í•˜ê³ , ê° í•­ëª©ì€ ì£¼ì œë‚˜ í•­ëª©ëª…ì„ ì“°ì§€ ë§ê³  ë°”ë¡œ ë‚´ìš©ì„ ì‹œì‘í•˜ì—¬ '~ìš´ì˜', '~êµ¬ì„±', '~ì‹¤ì‹œ', '~ì§€ì›' ë“±ê³¼ ê°™ì€ ëª…ì‚¬í˜• í‘œí˜„ìœ¼ë¡œ ëë‚˜ê²Œ ì‘ì„±í•˜ì„¸ìš”.\\n`;
                            } else if (sec.title.includes('ê·¼ê±°')) {
                                prompt += `${idx + 1}.  **${sec.title}**: ë¶ˆë¦¿ ë¦¬ìŠ¤íŠ¸(-) í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•˜ë˜, ê° í•­ëª©ì€ ê´€ë ¨ ë²•ë ¹Â·ê³„íšÂ·ì¡°ë¡€ ë“±ì˜ ì œëª©ê³¼ ë¬¸ì„œ ë²ˆí˜¸, ì‹œí–‰ì¼ ë“±ì„ ê´„í˜¸ ì•ˆì— ëª…ì‹œí•œ ì°¸ê³  ë¬¸í—Œ í˜•íƒœë¡œ ì‘ì„±í•˜ì„¸ìš”. ì˜ˆì‹œ: - (ë³€ê²½)ìŠ¤ë§ˆíŠ¸ê¸°ê¸° íœ´ëŒ€ í•™ìŠµ ã€Œë””ë²— í™•ëŒ€ ê³„íšã€(ì¤‘ë“±êµìœ¡ê³¼-13191, 2023. 3. 27.)\\n`;
                            } else {
                                prompt += `${idx + 1}.  **${sec.title}**: ë¶ˆë¦¿ ë¦¬ìŠ¤íŠ¸(-) í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•˜ë˜, ìµœì†Œ 4ê°œ ì´ìƒì˜ í•­ëª©ì„ í¬í•¨í•˜ê³ , ê° í•­ëª©ì€ '~í•œë‹¤.'ë¡œ ëë‚˜ëŠ” ëª…ë£Œí•œ ë¬¸ì¥ìœ¼ë¡œ ì‘ì„±í•˜ë©° ë‘ ê°€ì§€ ì´ìƒ ì„¸ë¶€ ë‚´ìš©ì„ í¬í•¨í•˜ì„¸ìš”.\\n`;
                            }
                            break;
                        case 'tablePlan':
                            if (sec.title.includes('ì„¸ë¶€ ì¶”ì§„ ê³„íš')) {
                                prompt += `${idx + 1}.  **${sec.title}**: ì´ í•­ëª©ì˜ ë‚´ìš©ì€ ì‘ì„±í•˜ì§€ ë§ê³  ì„¹ì…˜ ì œëª©ë§Œ ì¶œë ¥í•˜ì„¸ìš”.\\n`;
                            } else {
                                prompt += `${idx + 1}.  **${sec.title}**: ì¶”ì§„ ê³¼ì œë¥¼ ë²ˆí˜¸ ë§¤ê¸´ ë’¤ ê° ê³¼ì œ ì•„ë˜ì— 'â–¡ ì¶”ì§„ì—…ë¬´', 'â—‹ ì¶”ì§„ ë°©ë²•', 'â—‹ ê¸°ê´€', 'â—‹ ê¸°ê°„(ì¼ì •)', 'â—‹ ì¥ì†Œ', 'â—‹ ìˆ˜ëŸ‰/ì˜ˆì‚°' í•­ëª©ì„ ë¶ˆë¦¿ìœ¼ë¡œ ì‘ì„±í•˜ê³ , ì´ì–´ì„œ 'ì¶”ì§„ ê³¼ì œ', 'ì¶”ì§„ì—…ë¬´', 'ì¶”ì§„ ë°©ë²•', 'ê¸°ê´€', 'ê¸°ê°„', 'ì¥ì†Œ', 'ìˆ˜ëŸ‰/ì˜ˆì‚°' ì—´ì„ í¬í•¨í•œ Markdown í…Œì´ë¸”ì„ ì¶”ê°€í•˜ì„¸ìš”.\\n`;
                            }
                            break;
                        case 'tableBudget':
                            prompt += `${idx + 1}.  **${sec.title}**: ì˜ˆì‚° í¸ì„± ë°©í–¥ì„ ì§§ê²Œ ì„œìˆ í•˜ê³ , ì´ì–´ì„œ 'ìˆœ', 'ì‚¬ì—…ëª…', 'í•­ëª©', 'ì‚°ì¶œë‚´ì—­(ì›)', 'ì˜ˆì‚°ì•¡(ì²œì›)', 'ë¹„ê³ 'ë¥¼ í¬í•¨í•œ Markdown í…Œì´ë¸”ì„ ì œê³µí•˜ì„¸ìš”. 'ì‚°ì¶œë‚´ì—­(ì›)'ì€ '200,000ì› Ã— 1ëŒ€ Ã— 1íšŒ'ì™€ ê°™ì´ ê³±ì…ˆ ì‹ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”.\\n`;
                            break;
                        case 'tableSchedule':
                            prompt += `${idx + 1}.  **${sec.title}**: ê´€ë ¨ ë‚´ìš©ì„ ê°„ë‹¨íˆ ì„¤ëª…í•˜ê³ , 'ì›”', 'ì¥ì†Œ', 'ì¼ì‹œ', 'ëŒ€ìƒ', 'í”„ë¡œê·¸ë¨' í•­ëª©ì„ í¬í•¨í•œ Markdown í…Œì´ë¸”ì„ ì¶”ê°€í•˜ì„¸ìš”. 'í”„ë¡œê·¸ë¨' í•­ëª©ì€ ê° í”„ë¡œê·¸ë¨ì˜ ëª…ì¹­ê³¼ ê°„ë‹¨í•œ ì„¤ëª…ì„ í¬í•¨í•œ ë¶ˆë¦¿ ë¦¬ìŠ¤íŠ¸(-) í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•˜ê³  ìµœì†Œ 4ê°œ ì´ìƒì˜ í•­ëª©ì„ í¬í•¨í•˜ì„¸ìš”.\\n`;
                            break;
                        default:
                            prompt += `${idx + 1}.  **${sec.title}**: ê³„íšì˜ í•µì‹¬ ë‚´ìš©ì„ êµ¬ì²´ì ìœ¼ë¡œ ì„œìˆ í•˜ì„¸ìš”.\\n`;
                    }
                });
                prompt += `- **í•µì‹¬ í‚¤ì›Œë“œ**: '${keywords.join(', ')}'ë¥¼ ê³„íšì„œ ì „ë°˜ì— ìì—°ìŠ¤ëŸ½ê²Œ ë°˜ì˜í•´ì£¼ì„¸ìš”.\\n`;
                prompt += `- ëª¨ë“  ë¶ˆë¦¿ ë¦¬ìŠ¤íŠ¸ëŠ” ìµœì†Œ 4ê°œ ì´ìƒì˜ í•­ëª©ì„ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤.\\n`;
                prompt += `- 'ì¶”ì§„ ë°°ê²½', 'ì¶”ì§„ ëª©ì ', 'ê¸°ëŒ€íš¨ê³¼', 'ì¶”ì§„ ë°©í–¥', 'ì¶”ì§„ ë°©ì¹¨' í•­ëª©ì€ ë¬¸ì¥ì´ ì•„ë‹Œ ëª…ì‚¬í˜• í‘œí˜„ìœ¼ë¡œ ì‘ì„±í•˜ê³ , ê·¸ ë°–ì˜ í•­ëª©ì€ ê³µì†í•œ í‘œí˜„ì„ ì‚¬ìš©í•˜ì§€ ë§ê³  ëª¨ë‘ '~í•œë‹¤.'ë¡œ ëë‚˜ëŠ” ì„œìˆ í˜•ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”.\\n`;
                prompt += `- **ì¤‘ìš”**: ìƒì„±í•˜ëŠ” ëª¨ë“  í…ìŠ¤íŠ¸ì—ì„œ ë§ˆí¬ë‹¤ìš´ êµµì€ ê¸€ì”¨(**)ë¥¼ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”. ëª¨ë“  ë‚´ìš©ì€ ì¼ë°˜ í…ìŠ¤íŠ¸ë¡œë§Œ ì‘ì„±í•´ì£¼ì„¸ìš”.`;

                const apiUrl = `/.netlify/functions/generatePlan`;
                
                const response = await fetch(apiUrl, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ prompt: prompt, model: GEMINI_MODEL })
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error?.message || `API ìš”ì²­ ì‹¤íŒ¨: ${response.status}`);
                }
                const result = await response.json();
                
                if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                    const rawText = result.candidates[0].content.parts[0].text;
                    displayContent(rawText, planType);
                    
                    const docRef = await addDoc(collection(db, "users", user.uid, "plans"), {
                        title: planTitle.textContent,
                        planType: planType,
                        createdAt: serverTimestamp(),
                        rawContent: rawText
                    });
                    currentPlanId = docRef.id;
                    loadAndDisplayPlans(); // Refresh recent plans list
                    outputPanel.scrollIntoView({ behavior: 'smooth' });
                } else if (result.candidates?.[0]?.finishReason) {
                     throw new Error(`ìƒì„±ì´ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ìœ : ${result.candidates[0].finishReason}. ë‹¤ë¥¸ í‚¤ì›Œë“œë¥¼ ì‚¬ìš©í•´ ë³´ì„¸ìš”.`);
                }
                else {
                    throw new Error('AIë¡œë¶€í„° ìœ íš¨í•œ ì‘ë‹µì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error("Generation/Saving Error:", error);
                errorMessageDiv.classList.remove('hidden');
                errorDetails.textContent = `ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}. Google Cloud í”„ë¡œì íŠ¸ì—ì„œ 'Generative Language API'ê°€ í™œì„±í™”ë˜ì—ˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.`;
            } finally {
                loadingIndicator.style.display = 'none';
                generateBtn.disabled = false;
                generateBtn.innerHTML = `<span>AI ìš´ì˜ê³„íšì„œ ìƒì„±</span>`;
            }
        });

        function displayContent(rawText, defaultPlanType, summaryMarkdown = null) {
            let content = rawText;

            if (initialMessage) {
                initialMessage.classList.add('hidden');
            }

            const titleMatch = content.match(/^TITLE:\s*(.*)/m);
            const mainTitle = titleMatch && titleMatch[1] ? titleMatch[1].trim() : defaultPlanType;
            if (titleMatch) {
                content = content.substring(titleMatch[0].length).trim();
            }
            planTitle.textContent = mainTitle;

            currentPlanSummaryMarkdown = summaryMarkdown || null;
            if (summaryPopupWindow && !summaryPopupWindow.closed) {
                summaryPopupWindow.close();
            }
            summaryPopupWindow = null;
            isSummaryGenerating = false;

            planContainer.innerHTML = '';

            const sections = content.split(/^##\s/m).filter(s => s.trim() !== '');
            const sectionTitles = [];

            sections.forEach(sectionText => {
                const lines = sectionText.trim().split('\n');
                const sectionTitle = lines.shift().trim();
                sectionTitles.push(sectionTitle);
                let sectionContentMarkdown = lines.join('\n').trim();
                sectionContentMarkdown = sectionContentMarkdown
                    .replace(/í•©ë‹ˆë‹¤\./gm, 'í•œë‹¤.')
                    .replace(/í•©ë‹ˆë‹¤$/gm, 'í•œë‹¤')
                    .replace(/í•¨\./gm, 'í•œë‹¤.')
                    .replace(/í•¨$/gm, 'í•œë‹¤');

                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'plan-section';

                const titleEl = document.createElement('h3');
                titleEl.textContent = sectionTitle;

                const contentDiv = document.createElement('div');
                contentDiv.className = 'plan-section-content';

                if (sectionTitle.includes('ì„¸ë¶€ ì¶”ì§„ ê³„íš')) {
                    if (sectionContentMarkdown) {
                        sectionDiv.dataset.markdownContent = sectionContentMarkdown;
                        renderSectionContent(contentDiv, sectionContentMarkdown, { isDetail: true });

                        const controlsDiv = document.createElement('div');
                        controlsDiv.className = 'absolute top-4 right-4 flex gap-2';

                        const regenBtn = document.createElement('button');
                        regenBtn.className = 'regenerate-detail-btn';
                        regenBtn.textContent = 'ì¬ìƒì„±';

                        const expandBtn = document.createElement('button');
                        expandBtn.className = 'expand-btn';
                        expandBtn.textContent = 'ë‚´ìš© ëŠ˜ë¦¬ê¸°';

                        const detailBtn = document.createElement('button');
                        detailBtn.className = 'detail-btn';
                        detailBtn.textContent = 'ìì„¸í•˜ê²Œ';

                        const editBtn = document.createElement('button');
                        editBtn.className = 'edit-btn';
                        editBtn.textContent = 'í¸ì§‘';

                        const copyBtn = document.createElement('button');
                        copyBtn.className = 'copy-section-btn';
                        copyBtn.textContent = 'ë³µì‚¬';

                        controlsDiv.appendChild(regenBtn);
                        controlsDiv.appendChild(expandBtn);
                        controlsDiv.appendChild(detailBtn);
                        controlsDiv.appendChild(editBtn);
                        controlsDiv.appendChild(copyBtn);

                        sectionDiv.appendChild(controlsDiv);
                    } else {
                        sectionDiv.dataset.markdownContent = '';
                        const generateBtn = document.createElement('button');
                        generateBtn.className = 'generate-detail-btn';
                        generateBtn.textContent = 'ìƒì„±';
                        contentDiv.appendChild(generateBtn);
                    }
                } else {
                    sectionDiv.dataset.markdownContent = sectionContentMarkdown;
                    renderSectionContent(contentDiv, sectionContentMarkdown);

                    const controlsDiv = document.createElement('div');
                    controlsDiv.className = 'absolute top-4 right-4 flex gap-2';

                    if (sectionTitle.includes('ì¶”ì§„ ëª©ì ') || sectionTitle.includes('ê¸°ëŒ€íš¨ê³¼')) {
                        const regenBtn = document.createElement('button');
                        regenBtn.className = 'regenerate-section-btn';
                        regenBtn.textContent = 'ì¬ìƒì„±';
                        controlsDiv.appendChild(regenBtn);
                    }

                    const expandBtn = document.createElement('button');
                    expandBtn.className = 'expand-btn';
                    expandBtn.textContent = 'ë‚´ìš© ëŠ˜ë¦¬ê¸°';

                    const detailBtn = document.createElement('button');
                    detailBtn.className = 'detail-btn';
                    detailBtn.textContent = 'ìì„¸í•˜ê²Œ';

                    const editBtn = document.createElement('button');
                    editBtn.className = 'edit-btn';
                    editBtn.textContent = 'í¸ì§‘';

                    const copyBtn = document.createElement('button');
                    copyBtn.className = 'copy-section-btn';
                    copyBtn.textContent = 'ë³µì‚¬';

                    controlsDiv.appendChild(expandBtn);
                    controlsDiv.appendChild(detailBtn);
                    controlsDiv.appendChild(editBtn);
                    controlsDiv.appendChild(copyBtn);

                    sectionDiv.appendChild(controlsDiv);
                }

                sectionDiv.appendChild(titleEl);
                sectionDiv.appendChild(contentDiv);
                planContainer.appendChild(sectionDiv);
            });

            if (planModifyTarget) {
                planModifyTarget.innerHTML = '<option value="ì „ì²´">ì „ì²´</option>';
                sectionTitles.forEach(title => {
                    const opt = document.createElement('option');
                    opt.value = title;
                    opt.textContent = title;
                    planModifyTarget.appendChild(opt);
                });
                const detailOption = Array.from(planModifyTarget.options).find(opt => opt.value.includes('ì„¸ë¶€ ì¶”ì§„ ê³„íš'));
                if (detailOption) {
                    planModifyTarget.value = detailOption.value;
                }
            }

            loadingIndicator.style.display = 'none';
            resultSection.classList.remove('hidden');
            if (planModifySection) planModifySection.classList.remove('hidden');
        }

        function ensureBulletNewlines(text) {
            return text.replace(/([^\n])â—‹/g, '$1\nâ—‹');
        }

        function extractBulletItems(markdown) {
            const lines = (markdown || '').split('\n');
            const items = [];
            let current = null;
            lines.forEach(rawLine => {
                const line = rawLine.trim();
                if (!line) return;
                if (/^[-*]\s+/.test(line)) {
                    if (current) items.push(current);
                    current = line.replace(/^[-*]\s+/, '').trim();
                } else if (/^[â—‹â—â—¦]\s*/.test(line)) {
                    if (current) items.push(current);
                    current = line.replace(/^[â—‹â—â—¦]\s*/, '').trim();
                } else if (!line.startsWith('|')) {
                    if (current) {
                        current += ' ' + line;
                    } else {
                        current = line;
                    }
                }
            });
            if (current) items.push(current);
            return items;
        }

        function normalizeBulletList(markdown, { desiredCount = null, referenceItems = [], referenceSuffix = '' } = {}) {
            let items = extractBulletItems(markdown);
            if (!items.length && markdown && markdown.trim()) {
                items = markdown.split('\n').map(line => line.trim()).filter(Boolean);
            }
            const cleanReference = referenceItems.filter(item => item && item.trim()).map(item => item.trim());
            if (desiredCount !== null) {
                items = items.slice(0, desiredCount);
                while (items.length < desiredCount) {
                    const ref = cleanReference[items.length] || cleanReference[cleanReference.length - 1] || '';
                    if (ref) {
                        items.push(referenceSuffix ? `${ref}${referenceSuffix}` : ref);
                    } else if (items.length) {
                        items.push(items[items.length - 1]);
                    } else {
                        items.push('ì¶”ê°€ í•­ëª©');
                    }
                }
            }
            if (!items.length && cleanReference.length) {
                items = cleanReference.map(ref => referenceSuffix ? `${ref}${referenceSuffix}` : ref);
            }
            return items
                .map(item => item.replace(/^[-*]\s+/, '').replace(/^[â—‹â—â—¦]\s*/, '').trim())
                .filter(Boolean)
                .map(item => `- ${item}`)
                .join('\n');
        }

        function escapeHtml(text = '') {
            return text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function formatReferenceDate(value = '') {
            const trimmed = (value || '').trim();
            if (!trimmed) return '';
            const dateMatch = trimmed.match(/(\d{4})\D*(\d{1,2})\D*(\d{1,2})/);
            if (dateMatch) {
                const year = dateMatch[1];
                const monthNum = parseInt(dateMatch[2], 10);
                const dayNum = parseInt(dateMatch[3], 10);
                if (!Number.isNaN(monthNum) && !Number.isNaN(dayNum)) {
                    return `${year}.${monthNum}.${dayNum}.`;
                }
            }
            return trimmed;
        }

        function formatOfficialMarkdown(markdown = '') {
            const lines = (markdown || '').split('\n');
            const formatted = [];
            let numbering = 1;
            let insideAttachments = false;
            lines.forEach((line) => {
                const indentMatch = line.match(/^\s*/);
                const indent = indentMatch ? indentMatch[0] : '';
                let trimmed = line.trim();
                if (!trimmed) {
                    formatted.push('');
                    return;
                }

                const handleEndLine = () => {
                    if (insideAttachments && formatted.length) {
                        const lastIdx = formatted.length - 1;
                        const lastLine = formatted[lastIdx];
                        if (/^\s*ë¶™ì„\s{2}/.test(lastLine) && !/ë\.$/.test(lastLine)) {
                            formatted[lastIdx] = `${lastLine}  ë.`.trimEnd();
                            insideAttachments = false;
                            return;
                        }
                    }
                    formatted.push(`${indent}ë.`.trimEnd());
                    insideAttachments = false;
                };

                if (/^ë¶™ì„/.test(trimmed)) {
                    let rest = trimmed.replace(/^ë¶™ì„\s*[:\-]?\s*/, '');
                    const hasEnding = /ë\.$/.test(rest);
                    if (hasEnding) {
                        rest = rest.replace(/ë\.$/, '').trimEnd();
                    }
                    const baseLine = rest ? `${indent}ë¶™ì„  ${rest}` : `${indent}ë¶™ì„  `;
                    if (hasEnding) {
                        formatted.push(`${baseLine}  ë.`.trimEnd());
                        insideAttachments = false;
                    } else {
                        formatted.push(baseLine.trimEnd());
                        insideAttachments = true;
                    }
                    return;
                }

                if (/^ë\.?$/.test(trimmed)) {
                    handleEndLine();
                    return;
                }

                if (!insideAttachments && /^[â—‹â—â—¦â—¯â€¢]/.test(trimmed)) {
                    const content = trimmed.replace(/^[â—‹â—â—¦â—¯â€¢]\s*/, '').trim();
                    formatted.push(`${indent}${numbering}. ${content}`.trimEnd());
                    numbering += 1;
                    return;
                }

                if (!insideAttachments && /^[-*]\s+/.test(trimmed)) {
                    const content = trimmed.replace(/^[-*]\s+/, '').trim();
                    formatted.push(`${indent}${numbering}. ${content}`.trimEnd());
                    numbering += 1;
                    return;
                }

                if (!insideAttachments) {
                    const numberMatch = trimmed.match(/^(\d+)\.\s*/);
                    if (numberMatch) {
                        numbering = parseInt(numberMatch[1], 10) + 1;
                        let content = trimmed.slice(numberMatch[0].length).trimStart();
                        if (numberMatch[1] === '1' && /^ê´€ë ¨\s*:/.test(content)) {
                            content = content.replace(/\(([^)]*?)\)/, (match, inner) => {
                                const formattedDate = formatReferenceDate(inner);
                                return formattedDate ? `(${formattedDate})` : match;
                            });
                        }
                        formatted.push(`${indent}${numberMatch[1]}. ${content}`.trimEnd());
                        return;
                    }
                }

                formatted.push(`${indent}${trimmed}`.trimEnd());
            });

            while (formatted.length > 1 && formatted[formatted.length - 1] === '' && formatted[formatted.length - 2] === '') {
                formatted.pop();
            }

            return formatted.join('\n').replace(/[\s\u00a0]+$/, '');
        }

        function renderOfficialContent(markdown = '') {
            const plainText = ensureBulletNewlines(markdown.replace(/\*\*(.*?)\*\*/g, '$1'));
            const lines = plainText.split('\n');
            const htmlLines = lines.map(line => {
                if (!line) return '';
                const leadingSpacesMatch = line.match(/^\s+/);
                let content = line;
                let prefix = '';
                if (leadingSpacesMatch) {
                    const leadingSpaces = leadingSpacesMatch[0];
                    prefix = leadingSpaces
                        .replace(/ /g, '&nbsp;')
                        .replace(/\t/g, '&nbsp;&nbsp;&nbsp;&nbsp;');
                    content = line.slice(leadingSpaces.length);
                }
                let htmlContent = escapeHtml(content);
                if (/^ë¶™ì„\s{2}/.test(content)) {
                    htmlContent = htmlContent.replace(/^ë¶™ì„\s{2}/, 'ë¶™ì„&nbsp;&nbsp;');
                }
                return prefix + htmlContent;
            });
            return `<div class="official-plain-text">${htmlLines.join('<br>')}</div>`;
        }

        function parseMarkdown(markdown) {
            const plainMarkdown = ensureBulletNewlines(markdown.replace(/\*\*(.*?)\*\*/g, '$1'));
            return marked.parse(plainMarkdown);
        }

        function markdownToHtml(markdown) {
            const plainMarkdown = ensureBulletNewlines(markdown.replace(/\*\*(.*?)\*\*/g, '$1'));
            return marked.parse(plainMarkdown);
        }

        function renderMarkdownTable(markdown) {
            return marked.parse(ensureBulletNewlines(markdown));
        }

        function renderSectionContent(container, markdown, options = {}) {
            if (!container) return;
            const { isDetail = false } = options;
            container.classList.add('plan-section-content');
            if (isDetail) {
                container.classList.add('raw-markdown');
                container.textContent = markdown || '';
            } else {
                container.classList.remove('raw-markdown');
                container.innerHTML = parseMarkdown(markdown || '');
                addTableCopyButtons(container);
            }
        }

        function markdownTableToHtmlClipboard(markdown) {
            const text = ensureBulletNewlines(markdown);
            const rows = text
                .trim()
                .split('\n')
                .map(row => row.split('|').slice(1, -1).map(cell => cell.trim()));
             if (rows.length < 2) return text;

            const header = rows[0];
            const body = rows.slice(2);

            let tableHtml = '<table style="border-collapse: collapse; width: 100%; border: 1px solid black;">';
            tableHtml += '<thead><tr>';
            header.forEach(h => tableHtml += `<th style="border: 1px solid black; padding: 8px; background-color: #f2f2f2; text-align: center;">${h}</th>`);
            tableHtml += '</tr></thead><tbody>';
            body.forEach(row => {
                tableHtml += '<tr>';
                for (let i = 0; i < header.length; i++) {
                    tableHtml += `<td style="border: 1px solid black; padding: 8px;">${markdownToHtml(row[i] || '')}</td>`;
                }
                tableHtml += '</tr>';
            });
            tableHtml += '</tbody></table>';
            return tableHtml;
        }

        function htmlTableToHtmlClipboard(table) {
            const clone = table.cloneNode(true);
            clone.style.borderCollapse = 'collapse';
            clone.style.width = '100%';
            clone.style.border = '1px solid black';
            clone.querySelectorAll('th').forEach(th => {
                th.style.border = '1px solid black';
                th.style.padding = '8px';
                th.style.backgroundColor = '#f2f2f2';
                th.style.textAlign = 'center';
            });
            clone.querySelectorAll('td').forEach(td => {
                td.style.border = '1px solid black';
                td.style.padding = '8px';
            });
            return clone.outerHTML;
        }

        function removeBudgetInfo(markdown) {
            const rows = markdown.split('\n');
            if (rows[0] && rows[0].includes('|')) {
                const headers = rows[0].split('|').map(h => h.trim());
                const budgetIdx = headers.findIndex(h => h.includes('ì˜ˆì‚°'));
                if (budgetIdx > -1) {
                    return rows.map(row => {
                        const cells = row.split('|');
                        const startOffset = cells[0].trim() === '' ? 1 : 0;
                        const idx = budgetIdx + startOffset;
                        if (cells[idx] !== undefined) cells.splice(idx, 1);
                        return cells.join('|');
                    }).filter(line => line.replace(/\|/g, '').trim() !== '').join('\n');
                }
            }
            return rows.filter(line => !line.includes('ì˜ˆì‚°')).join('\n');
        }

        function extractMarkdownFromText(text) {
            return text.replace(/```(?:html|markdown|md)?/g, '').trim();
        }

        function copyToClipboard(text, isHtml = false, customMessage = null) {
            const listener = (e) => {
                e.preventDefault();
                if (isHtml) {
                    e.clipboardData.setData('text/html', text);
                    const plain = text
                        .replace(/&nbsp;/gi, ' ')
                        .replace(/<br\s*\/?\s*>/gi, '\n')
                        .replace(/<\/(p|div|tr)>/gi, '\n')
                        .replace(/<\/li>/gi, '\n')
                        .replace(/<li[^>]*>/gi, '')
                        .replace(/<\/(thead|tbody)>/gi, '')
                        .replace(/<[^>]*>?/gm, '')
                        .replace(/\n{3,}/g, '\n\n')
                        .replace(/[ \t]+\n/g, '\n')
                        .trimEnd();
                    e.clipboardData.setData('text/plain', plain);
                } else {
                    e.clipboardData.setData('text/plain', text);
                }
            };
            document.addEventListener('copy', listener);
            document.execCommand('copy');
            document.removeEventListener('copy', listener);
            if (customMessage) {
                showToast(customMessage);
            } else {
                showToast(isHtml ? 'í‘œ(HTML)ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ë‚´ìš©ì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
            }
        }

        async function generateConciseTitleFromInput(text, fallback = '') {
            const source = (text || '').trim();
            if (!source) return fallback || '';
            const prompt = `ë‹¤ìŒ ë‚´ìš©ì„ 20ì ì´ë‚´ì˜ ê°„ê²°í•œ ì œëª©ìœ¼ë¡œ ìš”ì•½í•´ì¤˜. ë¶ˆí•„ìš”í•œ ë”°ì˜´í‘œ ì—†ì´ ì œëª©ë§Œ ì¶œë ¥í•´. ë‚´ìš©: ${source}`;
            try {
                const response = await fetch('/.netlify/functions/generatePlan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt, model: GEMINI_MODEL })
                });
                const result = await response.json();
                const rawText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (rawText) {
                    const markdown = extractMarkdownFromText(rawText);
                    const candidate = markdown
                        .split('\n')
                        .map(line => line.trim())
                        .find(line => line.length);
                    if (candidate) {
                        return candidate.replace(/^[-#*\d\.\s]+/, '').trim();
                    }
                }
            } catch (err) {
                console.error('Concise Title Generation Error:', err);
            }
            if (fallback && fallback.trim()) return fallback.trim();
            return source.slice(0, 20);
        }

        function addTableCopyButtons(container) {
            container.querySelectorAll('table').forEach(table => {
                if (table.previousElementSibling && table.previousElementSibling.classList && table.previousElementSibling.classList.contains('copy-table-btn')) return;
                const btn = document.createElement('button');
                btn.className = 'copy-table-btn';
                btn.textContent = 'í‘œ ë³µì‚¬';
                table.parentNode.insertBefore(btn, table);
            });
        }

        function showToast(message) {
            toast.textContent = message;
            toast.classList.remove('opacity-0');
            setTimeout(() => {
                toast.classList.add('opacity-0');
            }, 2000);
        }

        async function saveCurrentSummary(markdown) {
            currentPlanSummaryMarkdown = markdown;
            const user = auth.currentUser;
            if (!user || !currentPlanId) return;
            try {
                await updateDoc(doc(db, "users", user.uid, "plans", currentPlanId), {
                    summaryContent: markdown,
                    summaryUpdatedAt: serverTimestamp()
                });
            } catch (err) {
                console.error('Summary Save Error:', err);
            }
        }

        function showSummaryPopup(summaryMarkdown) {
            if (!summaryMarkdown) return;
            const html = parseMarkdown(summaryMarkdown);
            if (!summaryPopupWindow || summaryPopupWindow.closed) {
                summaryPopupWindow = window.open('', '_blank', 'width=800,height=600,scrollbars=yes');
            }
            if (!summaryPopupWindow) return;

            const popupDoc = summaryPopupWindow.document;
            const baseStyles = "body{font-family:'Noto Sans KR',sans-serif;margin:0;padding:0;background:#f8fafc;color:#0f172a;} .summary-container{position:relative;max-width:960px;margin:0 auto;padding:48px 32px 32px;} .summary-actions{position:absolute;top:16px;right:16px;display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;} .summary-actions button{background:#1d4ed8;color:#ffffff;border:none;border-radius:24px;padding:10px 20px;font-size:14px;font-weight:600;cursor:pointer;box-shadow:0 4px 12px rgba(29,78,216,0.25);transition:background 0.2s ease,transform 0.2s ease;} .summary-actions button:hover{background:#1e40af;transform:translateY(-1px);} .summary-actions button:active{transform:translateY(0);} .summary-content{background:#ffffff;border-radius:12px;box-shadow:0 10px 30px rgba(15,23,42,0.08);padding:32px;line-height:1.7;} .manual-edit-area{width:100%;min-height:180px;margin-bottom:16px;padding:16px;border:1px solid #cbd5f5;border-radius:12px;font-size:15px;font-family:'Noto Sans KR',sans-serif;box-shadow:inset 0 1px 3px rgba(15,23,42,0.08);} .manual-edit-area:focus{outline:2px solid #2563eb;outline-offset:2px;} .hidden{display:none;} @media (max-width:600px){.summary-container{padding:40px 16px 24px;} .summary-content{padding:24px;} .summary-actions{top:12px;right:12px;} .summary-actions button{padding:8px 16px;font-size:13px;} .manual-edit-area{font-size:14px;}}";

            popupDoc.open();
            popupDoc.write('<!DOCTYPE html><html lang="ko"><head><meta charset="UTF-8"><title>ìš”ì•½ë³¸</title></head><body></body></html>');
            popupDoc.close();

            const styleTag = popupDoc.createElement('style');
            styleTag.textContent = baseStyles;
            popupDoc.head.appendChild(styleTag);

            const container = popupDoc.createElement('div');
            container.className = 'summary-container';
            container.innerHTML = `
                <div class="summary-actions">
                    <button id="toggle-edit-btn">ìˆ˜ë™ í¸ì§‘</button>
                    <button id="regenerate-summary-btn">ì¬ìƒì„±</button>
                    <button id="copy-summary-btn">ì „ë¬¸ ë³µì‚¬</button>
                </div>
                <textarea id="manual-edit-area" class="manual-edit-area hidden" placeholder="ìš”ì•½ë³¸ì„ ì§ì ‘ ìˆ˜ì •í•˜ì„¸ìš”."></textarea>
                <div id="summary-content" class="summary-content">${html}</div>
            `;
            popupDoc.body.appendChild(container);

            let currentMarkdown = summaryMarkdown;
            const summaryContent = popupDoc.getElementById('summary-content');
            const editArea = popupDoc.getElementById('manual-edit-area');
            const toggleEditBtn = popupDoc.getElementById('toggle-edit-btn');
            const copyBtn = popupDoc.getElementById('copy-summary-btn');
            const regenerateBtn = popupDoc.getElementById('regenerate-summary-btn');
            let isEditing = false;

            const renderMarkdown = (markdown) => parseMarkdown(markdown);
            const applyManualEdit = () => {
                if (!editArea) return;
                currentMarkdown = editArea.value;
                if (summaryContent) {
                    summaryContent.innerHTML = renderMarkdown(currentMarkdown);
                }
            };

            if (editArea) {
                editArea.addEventListener('input', () => {
                    currentMarkdown = editArea.value;
                    if (summaryContent) {
                        summaryContent.innerHTML = renderMarkdown(currentMarkdown);
                    }
                });
            }

            if (toggleEditBtn && editArea) {
                toggleEditBtn.addEventListener('click', () => {
                    if (!isEditing) {
                        isEditing = true;
                        toggleEditBtn.textContent = 'í¸ì§‘ ì™„ë£Œ';
                        editArea.value = currentMarkdown;
                        editArea.classList.remove('hidden');
                        editArea.focus();
                    } else {
                        applyManualEdit();
                        isEditing = false;
                        toggleEditBtn.textContent = 'ìˆ˜ë™ í¸ì§‘';
                        editArea.classList.add('hidden');
                    }
                });
            }

            const copyMarkdown = async () => {
                try {
                    if (summaryPopupWindow.navigator?.clipboard && summaryPopupWindow.isSecureContext) {
                        await summaryPopupWindow.navigator.clipboard.writeText(currentMarkdown);
                        return true;
                    }
                } catch (err) {
                    console.error('Clipboard copy failed:', err);
                }

                const textarea = popupDoc.createElement('textarea');
                textarea.value = currentMarkdown;
                textarea.style.position = 'fixed';
                textarea.style.left = '-9999px';
                popupDoc.body.appendChild(textarea);
                textarea.focus();
                textarea.select();
                let success = false;
                try {
                    if (typeof summaryPopupWindow.document.execCommand === 'function') {
                        success = summaryPopupWindow.document.execCommand('copy');
                    }
                } catch (err) {
                    success = false;
                }
                popupDoc.body.removeChild(textarea);
                return success;
            };

            if (copyBtn) {
                copyBtn.addEventListener('click', async () => {
                    try {
                        if (isEditing && editArea) {
                            applyManualEdit();
                            isEditing = false;
                            if (toggleEditBtn) {
                                toggleEditBtn.textContent = 'ìˆ˜ë™ í¸ì§‘';
                            }
                            editArea.classList.add('hidden');
                        }
                        const copied = await copyMarkdown();
                        if (copied) {
                            copyBtn.textContent = 'ë³µì‚¬ ì™„ë£Œ';
                            summaryPopupWindow.setTimeout(() => {
                                copyBtn.textContent = 'ì „ë¬¸ ë³µì‚¬';
                            }, 1500);
                        } else {
                            summaryPopupWindow.alert('ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                        }
                    } catch (err) {
                        console.error('Copy failed:', err);
                        summaryPopupWindow.alert('ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                    }
                });
            }

            if (regenerateBtn) {
                const openerWindow = summaryPopupWindow.opener && !summaryPopupWindow.opener.closed ? summaryPopupWindow.opener : null;
                const regenerateHandler = openerWindow && openerWindow.generatePlanSummaryFromPopup ? openerWindow.generatePlanSummaryFromPopup : null;
                if (regenerateHandler) {
                    const originalText = regenerateBtn.textContent;
                    regenerateBtn.addEventListener('click', async () => {
                        regenerateBtn.disabled = true;
                        regenerateBtn.textContent = 'ì¬ìƒì„± ì¤‘...';
                        try {
                            const newMarkdown = await regenerateHandler();
                            if (typeof newMarkdown === 'string' && newMarkdown.trim()) {
                                currentMarkdown = newMarkdown;
                                if (summaryContent) {
                                    summaryContent.innerHTML = renderMarkdown(currentMarkdown);
                                }
                                if (editArea && !editArea.classList.contains('hidden')) {
                                    editArea.value = currentMarkdown;
                                }
                            } else {
                                summaryPopupWindow.alert('ìš”ì•½ë³¸ ì¬ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                            }
                        } catch (err) {
                            console.error('Regenerate failed:', err);
                            summaryPopupWindow.alert('ìš”ì•½ë³¸ ì¬ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                        } finally {
                            regenerateBtn.disabled = false;
                            regenerateBtn.textContent = originalText;
                        }
                    });
                } else {
                    regenerateBtn.style.display = 'none';
                }
            }

            summaryPopupWindow.focus();
        }

        async function summarizeDetailSections(detailSections) {
            if (!detailSections.length) return new Map();
            let prompt = `ë‹¤ìŒì€ í•™êµ ì—…ë¬´ ê³„íšì„œì˜ 'ì„¸ë¶€ ì¶”ì§„ ê³„íš' ì„¹ì…˜ ì›ë¬¸ì´ë‹¤.\n`;
            prompt += `- ê° ì„¹ì…˜ ì œëª©ì€ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•´.\n`;
            prompt += `- ê° ì„¹ì…˜ì€ ì•„ë˜ í˜•ì‹ì„ ì§€ì¼œ ì‘ì„±í•´.\n`;
            prompt += `  ## ì œëª©\n  - í•µì‹¬ ë‚´ìš©\n  - í•µì‹¬ ë‚´ìš©\n`;
            prompt += `- ë¶ˆë¦¿ì€ '-'ë¡œ ì‹œì‘í•˜ê³  ê°„ê²°í•œ í•œ ë¬¸ì¥ìœ¼ë¡œë§Œ ì‘ì„±í•´.\n`;
            prompt += `- 'í•­ëª©:' ê°™ì€ ì ‘ë‘ì–´ëŠ” ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ë§ˆ.\n`;
            prompt += `- ê° ì„¹ì…˜ë³„ ë¶ˆë¦¿ ìˆ˜ëŠ” ìµœëŒ€ 3ê°œë¡œ ì œí•œí•´.\n`;
            prompt += `- ê° ë¶ˆë¦¿ì€ 30ì ì´ë‚´ë¡œ ìš”ì•½í•´ í•µì‹¬ë§Œ ì „ë‹¬í•´.\n`;
            prompt += `- ë‹¤ë¥¸ ì„¤ëª…ì´ë‚˜ ì¶”ê°€ ë¬¸êµ¬ ì—†ì´ ì„¹ì…˜ë³„ ê²°ê³¼ë§Œ ì¶œë ¥í•´.\n`;
            detailSections.forEach(({ title, content }) => {
                prompt += `\n[ì„¹ì…˜ ì‹œì‘]\nì œëª©: ${title}\në‚´ìš©:\n${content}\n[ì„¹ì…˜ ì¢…ë£Œ]\n`;
            });
            try {
                const response = await fetch('/.netlify/functions/generatePlan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt, model: GEMINI_MODEL })
                });
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                const summaryMap = new Map();
                if (text) {
                    const markdown = extractMarkdownFromText(text);
                    const blocks = markdown.match(/## [^\n]+(?:\n[^#][^\n]*)*/g) || [];
                    blocks.forEach(block => {
                        const lines = block.trim().split('\n');
                        const titleLine = lines.shift() || '';
                        const title = titleLine.replace(/^##\s*/, '').trim();
                        const content = lines.join('\n').trim();
                        if (title) {
                            const rebuilt = [`## ${title}`, content].filter(Boolean).join('\n');
                            summaryMap.set(title, rebuilt.trim());
                        }
                    });
                    if (summaryMap.size) return summaryMap;
                }
            } catch (err) {
                console.error('Detail Summary Generation Error:', err);
            }
            return new Map();
        }

        async function generatePlanSummary(options = {}) {
            const { openPopup = true, showToastMessage = true } = options;
            if (isSummaryGenerating) return null;
            const sections = planContainer ? planContainer.querySelectorAll('.plan-section') : [];
            if (!sections || !sections.length) return null;
            isSummaryGenerating = true;
            if (showToastMessage) {
                showToast('ìš”ì•½ë³¸ ìƒì„± ì¤‘ì…ë‹ˆë‹¤..');
            }
            try {
                const sectionData = Array.from(sections).map(sec => {
                    const title = sec.querySelector('h3').textContent;
                    const content = sec.dataset.markdownContent || sec.querySelector('.plan-section-content').innerText.trim();
                    return {
                        title,
                        content,
                        isDetail: title.includes('ì„¸ë¶€ ì¶”ì§„ ê³„íš')
                    };
                });
                const detailSections = sectionData.filter(sec => sec.isDetail);
                const detailSummaryMap = await summarizeDetailSections(detailSections);
                const summaryParts = sectionData.map(({ title, content, isDetail }) => {
                    if (isDetail) {
                        const summarized = detailSummaryMap.get(title);
                        if (summarized) {
                            return summarized.replace(/-\s*í•­ëª©:\s*/g, '- ').trim();
                        }
                    }
                    return `## ${title}\n${content}`.trim();
                });
                const summaryMarkdown = summaryParts.filter(Boolean).join('\n\n').trim();
                await saveCurrentSummary(summaryMarkdown);
                if (openPopup) {
                    showSummaryPopup(summaryMarkdown);
                }
                return summaryMarkdown;
            } catch (err) {
                console.error('Summary Error:', err);
                return null;
            } finally {
                isSummaryGenerating = false;
            }
        }

async function saveCurrentPlan() {
            const user = auth.currentUser;
            if (!user || !currentPlanId) return;
            let rawContent = `TITLE: ${planTitle.textContent}\n\n`;
            planContainer.querySelectorAll('.plan-section').forEach(section => {
                const title = section.querySelector('h3').textContent;
                const markdown = section.dataset.markdownContent;
                rawContent += `## ${title}\n${markdown}\n\n`;
            });
            try {
                await updateDoc(doc(db, "users", user.uid, "plans", currentPlanId), {
                    title: planTitle.textContent,
                    rawContent
                });
            } catch (err) {
                console.error('Plan Save Error:', err);
            }
        }

        if (planModifyForm) {
            planModifyForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!currentPlanId) return;
                const userPrompt = planModifyPrompt.value.trim();
                if (!userPrompt) return;
                showToast('ìˆ˜ì • ì¤‘ì…ë‹ˆë‹¤..');
                const target = planModifyTarget.value;
                let prompt;
                if (target === 'ì „ì²´') {
                    let rawContent = `TITLE: ${planTitle.textContent}\n\n`;
                    planContainer.querySelectorAll('.plan-section').forEach(section => {
                        const title = section.querySelector('h3').textContent;
                        const markdown = section.dataset.markdownContent;
                        rawContent += `## ${title}\n${markdown}\n\n`;
                    });
                    prompt = `ë‹¤ìŒ ìš´ì˜ê³„íšì„œë¥¼ ì‚¬ìš©ìì˜ ìš”ì²­ì— ë§ê²Œ ìˆ˜ì •í•´ì¤˜.\n${rawContent}\n\nìš”ì²­: ${userPrompt}\n\n' TITLE:'ìœ¼ë¡œ ì‹œì‘í•˜ëŠ” ë™ì¼í•œ í˜•ì‹ì˜ ë§ˆí¬ë‹¤ìš´ìœ¼ë¡œë§Œ ê²°ê³¼ë¥¼ ì¶œë ¥í•´ì¤˜.`;
                } else {
                    const section = Array.from(planContainer.querySelectorAll('.plan-section')).find(sec => sec.querySelector('h3').textContent.includes(target));
                    if (!section) return;
                    const secTitle = section.querySelector('h3').textContent;
                    const secMarkdown = section.dataset.markdownContent;
                    prompt = `ë‹¤ìŒ ìš´ì˜ê³„íšì„œì˜ '${secTitle}' ë¶€ë¶„ì„ ì‚¬ìš©ìì˜ ìš”ì²­ì— ë”°ë¼ ìˆ˜ì •í•´ì¤˜.\n## ${secTitle}\n${secMarkdown}\n\nìš”ì²­: ${userPrompt}\n\nìˆ˜ì •ëœ '${secTitle}' ë¶€ë¶„ë§Œ '## ${secTitle}' í˜•ì‹ì˜ ë§ˆí¬ë‹¤ìš´ìœ¼ë¡œ ì¶œë ¥í•´ì¤˜.`;
                }
                try {
                    const response = await fetch('/.netlify/functions/generatePlan', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt, model: GEMINI_MODEL })
                    });
                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                        if (text) {
                            const markdown = extractMarkdownFromText(text);
                            if (target === 'ì „ì²´') {
                                displayContent(markdown, planTitle.textContent);
                                await saveCurrentSummary(null);
                            } else {
                                const section = Array.from(planContainer.querySelectorAll('.plan-section')).find(sec => sec.querySelector('h3').textContent.includes(target));
                                if (section) {
                                    const lines = markdown.split('\n');
                                    if (lines[0].startsWith('##')) lines.shift();
                                let newContent = lines.join('\n').trim();
                                newContent = newContent
                                    .replace(/í•©ë‹ˆë‹¤\./gm, 'í•œë‹¤.')
                                    .replace(/í•©ë‹ˆë‹¤$/gm, 'í•œë‹¤')
                                    .replace(/í•¨\./gm, 'í•œë‹¤.')
                                    .replace(/í•¨$/gm, 'í•œë‹¤');
                                section.dataset.markdownContent = newContent;
                                const contentDiv = section.querySelector('.plan-section-content');
                                const isDetailSection = section.querySelector('h3').textContent.includes('ì„¸ë¶€ ì¶”ì§„ ê³„íš');
                                renderSectionContent(contentDiv, newContent, { isDetail: isDetailSection });
                            }
                        }
                        saveCurrentPlan();
                        planModifyPrompt.value = '';
                    }
                } catch (err) {
                    console.error('Plan Modify Error:', err);
                }
            });
        }

        async function saveCurrentTable() {
            const user = auth.currentUser;
            if (!user || !currentTableId) return;
            try {
                await updateDoc(doc(db, "users", user.uid, "tables", currentTableId), {
                    rawContent: currentTableMarkdown
                });
            } catch (err) {
                console.error('Table Save Error:', err);
            }
        }

        async function saveCurrentOfficial() {
            const user = auth.currentUser;
            if (!user || !currentOfficialId) return;
            try {
                await updateDoc(doc(db, "users", user.uid, "officials", currentOfficialId), {
                    title: currentOfficialTitle,
                    rawContent: currentOfficialMarkdown
                });
            } catch (err) {
                console.error('Official Save Error:', err);
            }
        }

        async function saveCurrentLetter() {
            const user = auth.currentUser;
            if (!user || !currentLetterId) return;
            try {
                await updateDoc(doc(db, "users", user.uid, "letters", currentLetterId), {
                    rawContent: currentLetterMarkdown
                });
            } catch (err) {
                console.error('Letter Save Error:', err);
            }
        }

        planContainer.addEventListener('click', async function(e) {
            const button = e.target.closest('button');
            if (!button) return;

            const sectionDiv = button.closest('.plan-section');
            const contentDiv = sectionDiv.querySelector('.plan-section-content');

            if (button.classList.contains('generate-detail-btn') || button.classList.contains('regenerate-detail-btn')) {
                const sections = planContainer.querySelectorAll('.plan-section');
                let otherSections = '';
                sections.forEach(sec => {
                    const title = sec.querySelector('h3').textContent;
                    if (!title.includes('ì„¸ë¶€ ì¶”ì§„ ê³„íš')) {
                        const content = sec.dataset.markdownContent || '';
                        otherSections += `## ${title}\n${content}\n\n`;
                    }
                });
                let prompt = `ë‹¤ìŒ ì£¼ì œì™€ ë‹¤ë¥¸ í•­ëª© ë‚´ìš©ì„ ì°¸ê³ í•˜ì—¬ ì„¸ë¶€ ì¶”ì§„ ê³„íšì„ ì‘ì„±í•´ì¤˜.\nì£¼ì œ: ${planTitle.textContent}\n\n`;
                if (otherSections) {
                    prompt += `ë‹¤ë¥¸ í•­ëª© ë‚´ìš©:\n${otherSections}`;
                }
                if (detailPlanExamples) {
                    prompt += `ì„¸ë¶€ ì¶”ì§„ ê³„íš ì˜ˆì‹œ:\n${detailPlanExamples}\n\n`;
                }
                if (planExamples) {
                    prompt += `ë¶€í˜¸ ë° êµ¬ì¡° ì˜ˆì‹œ:\n${planExamples}\n\n`;
                }
                if (exampleFiles.length) {
                    prompt += `ì˜ˆì‹œ ìë£Œ:\n`;
                    exampleFiles.forEach((file, idx) => {
                        prompt += `ì˜ˆì‹œ ${idx + 1} (${file.name}):\n${file.text}\n\n`;
                    });
                }
                prompt += `'ì„¸ë¶€ ì¶”ì§„ ê³„íš'ì„ Markdown í‘œ í˜•ì‹ìœ¼ë¡œ ì¶œë ¥í•´ì¤˜. í‘œì—ëŠ” 'ëª©í‘œ', 'ì¶”ì§„ë°©í–¥', 'ì¶”ì§„ ì¼ì •', 'ì˜ˆì‚° ê´€ë ¨', 'ì˜ˆì‚° ìš´ìš© ê³„íš', 'ê¸°ëŒ€íš¨ê³¼' í•­ëª©ì€ í¬í•¨í•˜ì§€ ë§ˆ.`;
                try {
                    showToast('ì„¸ë¶€ ì¶”ì§„ ê³„íš ìƒì„± ì¤‘ì…ë‹ˆë‹¤..');
                    const response = await fetch('/.netlify/functions/generatePlan', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt, model: GEMINI_MODEL })
                    });
                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (text) {
                        const markdown = extractMarkdownFromText(text);
                        const lines = markdown.split('\n');
                        if (lines[0].startsWith('##')) lines.shift();
                        let newContent = lines.join('\n').trim();
                        newContent = newContent.replace(/í•©ë‹ˆë‹¤\./gm, 'í•œë‹¤.').replace(/í•©ë‹ˆë‹¤$/gm, 'í•œë‹¤').replace(/í•¨\./gm, 'í•œë‹¤.').replace(/í•¨$/gm, 'í•œë‹¤');
                        newContent = removeBudgetInfo(newContent);
                        sectionDiv.dataset.markdownContent = newContent;
                        renderSectionContent(contentDiv, newContent, { isDetail: true });

                        const oldControls = sectionDiv.querySelector('.absolute.top-4.right-4');
                        if (oldControls) oldControls.remove();

                        const controlsDiv = document.createElement('div');
                        controlsDiv.className = 'absolute top-4 right-4 flex gap-2';

                        const regenBtn = document.createElement('button');
                        regenBtn.className = 'regenerate-detail-btn';
                        regenBtn.textContent = 'ì¬ìƒì„±';

                        const expandBtn = document.createElement('button');
                        expandBtn.className = 'expand-btn';
                        expandBtn.textContent = 'ë‚´ìš© ëŠ˜ë¦¬ê¸°';

                        const detailBtn = document.createElement('button');
                        detailBtn.className = 'detail-btn';
                        detailBtn.textContent = 'ìì„¸í•˜ê²Œ';

                        const editBtn = document.createElement('button');
                        editBtn.className = 'edit-btn';
                        editBtn.textContent = 'í¸ì§‘';

                        const copyBtn = document.createElement('button');
                        copyBtn.className = 'copy-section-btn';
                        copyBtn.textContent = 'ë³µì‚¬';

                        controlsDiv.appendChild(regenBtn);
                        controlsDiv.appendChild(expandBtn);
                        controlsDiv.appendChild(detailBtn);
                        controlsDiv.appendChild(editBtn);
                        controlsDiv.appendChild(copyBtn);
                        sectionDiv.insertBefore(controlsDiv, sectionDiv.firstChild);
                        await saveCurrentPlan();
                    }
                } catch (err) {
                    console.error('Detail Plan Generate Error:', err);
                }
            } else if (button.classList.contains('regenerate-section-btn')) {
                const secTitle = sectionDiv.querySelector('h3').textContent;
                const previousMarkdown = sectionDiv.dataset.markdownContent || '';
                const sections = planContainer.querySelectorAll('.plan-section');
                let otherSections = '';
                sections.forEach(sec => {
                    const title = sec.querySelector('h3').textContent;
                    if (title !== secTitle) {
                        const content = sec.dataset.markdownContent || '';
                        otherSections += `## ${title}\n${content}\n\n`;
                    }
                });
                let prompt = `ë‹¤ìŒ ê³„íšì„œì˜ ë‹¤ë¥¸ í•­ëª©ì„ ì°¸ê³ í•˜ì—¬ ${secTitle}ì„ ì‘ì„±í•´ì¤˜.\nì£¼ì œ: ${planTitle.textContent}\n\n`;
                if (otherSections) {
                    prompt += `ë‹¤ë¥¸ í•­ëª© ë‚´ìš©:\n${otherSections}`;
                }
                let referencePurposeBullets = [];
                let desiredEffectBulletCount = null;
                if (secTitle.includes('ê¸°ëŒ€íš¨ê³¼')) {
                    const purposeSection = Array.from(sections).find(sec => sec.querySelector('h3').textContent.includes('ì¶”ì§„ ëª©ì '));
                    if (purposeSection) {
                        const purposeContent = purposeSection.dataset.markdownContent || '';
                        referencePurposeBullets = extractBulletItems(purposeContent);
                        prompt += `ì¶”ì§„ ëª©ì :\n${purposeContent}\n\n`;
                        if (referencePurposeBullets.length) {
                            desiredEffectBulletCount = referencePurposeBullets.length;
                            prompt += `ì¶œë ¥ì€ ë°˜ë“œì‹œ '-'ë¡œ ì‹œì‘í•˜ëŠ” ë§ˆí¬ë‹¤ìš´ ë¶ˆë¦¿ í¬ì¸íŠ¸ ${referencePurposeBullets.length}ê°œë¡œ ì‘ì„±í•˜ê³ , ê° í•­ëª©ì€ ìœ„ ì¶”ì§„ ëª©ì  ê°ê°ì— ëŒ€ì‘ë˜ëŠ” ê¸°ëŒ€ íš¨ê³¼ë¥¼ ëª…ì‚¬í˜• í‘œí˜„ìœ¼ë¡œ ì •ë¦¬í•´ì¤˜.`;
                        } else {
                            prompt += `ì¶œë ¥ì€ ë°˜ë“œì‹œ '-'ë¡œ ì‹œì‘í•˜ëŠ” ë§ˆí¬ë‹¤ìš´ ë¶ˆë¦¿ í¬ì¸íŠ¸ í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•˜ê³ , ê° í•­ëª©ì€ ëª…ì‚¬í˜• í‘œí˜„ìœ¼ë¡œ ëë‚˜ê²Œ í•´ì¤˜.`;
                        }
                    } else {
                        prompt += `ì¶œë ¥ì€ ë°˜ë“œì‹œ '-'ë¡œ ì‹œì‘í•˜ëŠ” ë§ˆí¬ë‹¤ìš´ ë¶ˆë¦¿ í¬ì¸íŠ¸ í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•˜ê³ , ê° í•­ëª©ì€ ëª…ì‚¬í˜• í‘œí˜„ìœ¼ë¡œ ëë‚˜ê²Œ í•´ì¤˜.`;
                    }
                } else if (secTitle.includes('ì¶”ì§„ ëª©ì ')) {
                    prompt += `ì¶œë ¥ì€ ë°˜ë“œì‹œ '-'ë¡œ ì‹œì‘í•˜ëŠ” ë§ˆí¬ë‹¤ìš´ ë¶ˆë¦¿ í¬ì¸íŠ¸ í˜•ì‹ì„ ìœ ì§€í•˜ê³ , ê° í•­ëª©ì€ ëª…ì‚¬í˜• í‘œí˜„ìœ¼ë¡œ ì‘ì„±í•´ì¤˜.`;
                }
                try {
                    showToast('ì¬ìƒì„± ì¤‘ì…ë‹ˆë‹¤..');
                    const response = await fetch('/.netlify/functions/generatePlan', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt, model: GEMINI_MODEL })
                    });
                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (text) {
                        const markdown = extractMarkdownFromText(text);
                        const lines = markdown.split('\n');
                        if (lines[0].startsWith('##')) lines.shift();
                        let newContent = lines.join('\n').trim();
                        if (secTitle.includes('ê¸°ëŒ€íš¨ê³¼')) {
                            const referenceItems = referencePurposeBullets.length ? referencePurposeBullets : extractBulletItems(previousMarkdown);
                            const referenceSuffix = referencePurposeBullets.length ? ' ê´€ë ¨ ê¸°ëŒ€ íš¨ê³¼' : '';
                            newContent = normalizeBulletList(newContent, {
                                desiredCount: desiredEffectBulletCount,
                                referenceItems,
                                referenceSuffix
                            });
                        } else if (secTitle.includes('ì¶”ì§„ ëª©ì ')) {
                            const existingBullets = extractBulletItems(previousMarkdown);
                            newContent = normalizeBulletList(newContent, {
                                desiredCount: existingBullets.length || null,
                                referenceItems: existingBullets
                            });
                        }
                        sectionDiv.dataset.markdownContent = newContent;
                                const isDetailSection = section.querySelector('h3').textContent.includes('ì„¸ë¶€ ì¶”ì§„ ê³„íš');
                                renderSectionContent(contentDiv, newContent, { isDetail: isDetailSection });
                        addTableCopyButtons(contentDiv);
                        await saveCurrentPlan();
                    }
                } catch (err) {
                    console.error('Section Regenerate Error:', err);
                }
            } else if (button.classList.contains('copy-section-btn')) {
                const tempDiv = contentDiv.cloneNode(true);
                tempDiv.querySelectorAll('table').forEach(t => t.remove());
                copyToClipboard(tempDiv.innerText.trim(), false);
            } else if (button.classList.contains('copy-table-btn')) {
                let table = button.nextElementSibling;
                if (!table || table.tagName !== 'TABLE') table = button.previousElementSibling;
                if (table && table.tagName === 'TABLE') {
                    const htmlToCopy = htmlTableToHtmlClipboard(table);
                    if (!htmlToCopy || !htmlToCopy.trim() || !/<table[\s>]/i.test(htmlToCopy)) return;
                    copyToClipboard(htmlToCopy, true, 'í‘œê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
                }
            } else if (button.classList.contains('edit-btn')) {
                if (button.textContent === 'í¸ì§‘') { // Start editing
                    button.textContent = 'ì™„ë£Œ';
                    button.classList.add('bg-green-500', 'text-white');
                    const currentMarkdown = sectionDiv.dataset.markdownContent;
                    const textarea = document.createElement('textarea');
                    textarea.className = 'w-full h-48 p-2 border rounded-md font-mono text-sm';
                    textarea.value = currentMarkdown;
                    contentDiv.replaceWith(textarea);
                } else { // Finish editing
                    button.textContent = 'í¸ì§‘';
                    button.classList.remove('bg-green-500', 'text-white');
                    const textarea = sectionDiv.querySelector('textarea');
                    const newMarkdown = textarea.value;
                    sectionDiv.dataset.markdownContent = newMarkdown;
                    const newContentDiv = document.createElement('div');
                    const isDetailSection = sectionDiv.querySelector('h3').textContent.includes('ì„¸ë¶€ ì¶”ì§„ ê³„íš');
                    renderSectionContent(newContentDiv, newMarkdown, { isDetail: isDetailSection });
                    textarea.replaceWith(newContentDiv);
                    saveCurrentPlan();
                }
            } else if (button.classList.contains('expand-btn') || button.classList.contains('detail-btn')) {
                if (!contentDiv) return;
                const isExpand = button.classList.contains('expand-btn');
                const secTitle = sectionDiv.querySelector('h3').textContent;
                const secMarkdown = sectionDiv.dataset.markdownContent;
                const sections = planContainer.querySelectorAll('.plan-section');
                let prompt;
                if (button.classList.contains('detail-btn') && secTitle.includes('ì„¸ë¶€ ì¶”ì§„ ê³„íš')) {
                    let otherSections = '';
                    sections.forEach(sec => {
                        const title = sec.querySelector('h3').textContent;
                        if (title !== secTitle) {
                            const content = sec.dataset.markdownContent || '';
                            otherSections += `## ${title}\n${content}\n\n`;
                        }
                    });
                    prompt = `ë‹¤ìŒ ì£¼ì œì™€ ë‹¤ë¥¸ í•­ëª© ë‚´ìš©ì„ ì°¸ê³ í•˜ì—¬ ì„¸ë¶€ ì¶”ì§„ ê³„íšì„ ì‘ì„±í•´ì¤˜.\nì£¼ì œ: ${planTitle.textContent}\n\n`;
                    if (otherSections) {
                        prompt += `ë‹¤ë¥¸ í•­ëª© ë‚´ìš©:\n${otherSections}`;
                    }
                    if (detailPlanExamples) {
                        prompt += `ì„¸ë¶€ ì¶”ì§„ ê³„íš ì˜ˆì‹œ:\n${detailPlanExamples}\n\n`;
                    }
                    if (planExamples) {
                        prompt += `ë¶€í˜¸ ë° êµ¬ì¡° ì˜ˆì‹œ:\n${planExamples}\n\n`;
                    }
                    if (exampleFiles.length) {
                        prompt += `ì˜ˆì‹œ ìë£Œ:\n`;
                        exampleFiles.forEach((file, idx) => {
                            prompt += `ì˜ˆì‹œ ${idx + 1} (${file.name}):\n${file.text}\n\n`;
                        });
                    }
                    prompt += `'ì„¸ë¶€ ì¶”ì§„ ê³„íš'ì„ Markdown í‘œ í˜•ì‹ìœ¼ë¡œ ì¶œë ¥í•´ì¤˜. í‘œì—ëŠ” 'ëª©í‘œ', 'ì¶”ì§„ë°©í–¥', 'ì¶”ì§„ ì¼ì •', 'ì˜ˆì‚° ê´€ë ¨', 'ì˜ˆì‚° ìš´ìš© ê³„íš', 'ê¸°ëŒ€íš¨ê³¼' í•­ëª©ì€ í¬í•¨í•˜ì§€ ë§ˆ.`;
                } else if (isExpand) {
                    if (secTitle.includes('ì¶”ì§„ ë°°ê²½') || secTitle.includes('ë°©í–¥') || secTitle.includes('ë°©ì¹¨')) {
                        prompt = `ë‹¤ìŒ ê³„íšì„œ í•­ëª©ì˜ ë‚´ìš©ì„ í™•ì¥í•´ì¤˜. ê¸°ì¡´ì˜ ë¶ˆë¦¿ ë¦¬ìŠ¤íŠ¸ëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€í•˜ê³  í•­ëª©ì˜ ê°œìˆ˜ë¥¼ ëŠ˜ë¦¬ì§€ ë§ì•„ì¤˜. ëŒ€ì‹  ê° ë¶ˆë¦¿ì˜ í‘œí˜„ì„ ë”ìš± êµ¬ì²´ì ìœ¼ë¡œ ì‘ì„±í•´ì¤˜. ê° í•­ëª©ì€ ì£¼ì œë‚˜ í•­ëª©ëª…ì„ ì“°ì§€ ë§ê³  ë°”ë¡œ ë‚´ìš©ì„ ì‹œì‘í•˜ë©° ë¬¸ì¥ì´ ì•„ë‹Œ ëª…ì‚¬í˜• í‘œí˜„ìœ¼ë¡œ ëë‚˜ê²Œ í•´ì¤˜.\n## ${secTitle}\n${secMarkdown}\n\n'## ${secTitle}' í˜•ì‹ì˜ ë§ˆí¬ë‹¤ìš´ìœ¼ë¡œ ì¶œë ¥í•´ì¤˜.`;
                    } else if (secTitle.includes('ì¶”ì§„ ëª©ì ') || secTitle.includes('ê¸°ëŒ€íš¨ê³¼')) {
                        const bulletCount = (secMarkdown.match(/^- /gm) || []).length;
                        const targetCount = Math.ceil(bulletCount * 1.5);
                        prompt = `ë‹¤ìŒ ê³„íšì„œ í•­ëª©ì˜ ë‚´ìš©ì„ í™•ì¥í•´ì¤˜. ê¸°ì¡´ì˜ ë¶ˆë¦¿ í•­ëª©ë“¤ì„ ìœ ì§€í•˜ë©´ì„œ ìƒˆë¡œìš´ ë¶ˆë¦¿ì„ ì¶”ê°€í•´ ì „ì²´ í•­ëª© ìˆ˜ê°€ ì•½ ${targetCount}ê°œê°€ ë˜ë„ë¡ í•´ì¤˜. ê° í•­ëª©ì€ ë¬¸ì¥ì´ ì•„ë‹Œ ëª…ì‚¬í˜• í‘œí˜„ìœ¼ë¡œ ëë‚˜ê²Œ í•´ì¤˜. ëª¨ë“  í•­ëª©ì€ '- 'ë¡œ ì‹œì‘í•˜ëŠ” ë§ˆí¬ë‹¤ìš´ ë¶ˆë¦¿ í¬ì¸íŠ¸ í˜•ì‹ìœ¼ë¡œ ì¶œë ¥í•´ì¤˜.\n## ${secTitle}\n${secMarkdown}\n\n'## ${secTitle}' í˜•ì‹ì˜ ë§ˆí¬ë‹¤ìš´ìœ¼ë¡œ ì¶œë ¥í•´ì¤˜.`;
                    } else {
                        prompt = `ë‹¤ìŒ ê³„íšì„œ í•­ëª©ì˜ ë‚´ìš©ì„ í™•ì¥í•´ì¤˜. ê¸°ì¡´ì˜ ë¶ˆë¦¿ ë¦¬ìŠ¤íŠ¸ë‚˜ í‘œ í˜•ì‹ì€ ê·¸ëŒ€ë¡œ ìœ ì§€í•˜ë˜, í•­ëª©ì˜ ê°œìˆ˜ë¥¼ ëŠ˜ë ¤ì¤˜. ìì„¸í•œ ì„¤ëª…ì„ ì¶”ê°€í•˜ëŠ” ëŒ€ì‹  ìƒˆë¡œìš´ ë¶ˆë¦¿ì´ë‚˜ í‘œ í–‰ì„ ì¶”ê°€í•´ì¤˜.\n## ${secTitle}\n${secMarkdown}\n\n'## ${secTitle}' í˜•ì‹ì˜ ë§ˆí¬ë‹¤ìš´ìœ¼ë¡œ ì¶œë ¥í•´ì¤˜.`;
                    }
                } else {
                    if (secTitle.includes('ì¶”ì§„ ëª©ì ') || secTitle.includes('ê¸°ëŒ€íš¨ê³¼')) {
                        prompt = `ë‹¤ìŒ ê³„íšì„œ í•­ëª©ì˜ ë‚´ìš©ì„ êµ¬ì²´ì ìœ¼ë¡œ ì‘ì„±í•´ì¤˜. ê¸°ì¡´ì˜ ë¶ˆë¦¿ ë¦¬ìŠ¤íŠ¸ëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€í•˜ê³ , í•­ëª©ì˜ ê°œìˆ˜ëŠ” ëŠ˜ë¦¬ì§€ ë§ë©° ê° í•­ëª©ì˜ ì„¤ëª…ì„ ë”ìš± ìì„¸í•˜ê²Œ í•´ì¤˜. ëª¨ë“  í•­ëª©ì€ '- 'ë¡œ ì‹œì‘í•˜ëŠ” ë§ˆí¬ë‹¤ìš´ ë¶ˆë¦¿ í¬ì¸íŠ¸ í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•˜ê³  ë¬¸ì¥ì´ ì•„ë‹Œ ëª…ì‚¬í˜• í‘œí˜„ìœ¼ë¡œ ëë‚˜ê²Œ í•´ì¤˜.\n## ${secTitle}\n${secMarkdown}\n\n'## ${secTitle}' í˜•ì‹ì˜ ë§ˆí¬ë‹¤ìš´ìœ¼ë¡œ ì¶œë ¥í•´ì¤˜.`;
                    } else {
                        prompt = `ë‹¤ìŒ ê³„íšì„œ í•­ëª©ì˜ ë‚´ìš©ì„ êµ¬ì²´ì ìœ¼ë¡œ ì‘ì„±í•´ì¤˜. ê¸°ì¡´ì˜ ë¶ˆë¦¿ ë¦¬ìŠ¤íŠ¸ë‚˜ í‘œ í˜•ì‹ì€ ê·¸ëŒ€ë¡œ ìœ ì§€í•˜ê³ , í•­ëª©ì˜ ê°œìˆ˜ëŠ” ëŠ˜ë¦¬ì§€ ë§ë©° ê° í•­ëª©ì˜ ì„¤ëª…ì„ ë”ìš± ìì„¸í•˜ê²Œ í•´ì¤˜.\n## ${secTitle}\n${secMarkdown}\n\n'## ${secTitle}' í˜•ì‹ì˜ ë§ˆí¬ë‹¤ìš´ìœ¼ë¡œ ì¶œë ¥í•´ì¤˜.`;
                    }
                }
                try {
                    showToast(isExpand ? 'ë‚´ìš© ëŠ˜ë¦¬ëŠ” ì¤‘ì…ë‹ˆë‹¤..' : 'ìì„¸í•˜ê²Œ ì‘ì„± ì¤‘ì…ë‹ˆë‹¤..');
                    const response = await fetch('/.netlify/functions/generatePlan', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt, model: GEMINI_MODEL })
                    });
                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (text) {
                        const markdown = extractMarkdownFromText(text);
                        const lines = markdown.split('\n');
                        if (lines[0].startsWith('##')) lines.shift();
                        let newContent = lines.join('\n').trim();
                        if (!secTitle.includes('ì¶”ì§„ ë°°ê²½') && !secTitle.includes('ì¶”ì§„ ëª©ì ') && !secTitle.includes('ê¸°ëŒ€íš¨ê³¼') && !secTitle.includes('ë°©í–¥') && !secTitle.includes('ë°©ì¹¨')) {
                            newContent = newContent.replace(/í•©ë‹ˆë‹¤\./gm, 'í•œë‹¤.').replace(/í•©ë‹ˆë‹¤$/gm, 'í•œë‹¤').replace(/í•¨\./gm, 'í•œë‹¤.').replace(/í•¨$/gm, 'í•œë‹¤');
                        }
                        newContent = removeBudgetInfo(newContent);
                        if (secTitle.includes('ì¶”ì§„ ëª©ì ') || secTitle.includes('ê¸°ëŒ€íš¨ê³¼')) {
                            const baseReference = extractBulletItems(secMarkdown);
                            const options = { referenceItems: baseReference };
                            if (!isExpand && baseReference.length) {
                                options.desiredCount = baseReference.length;
                            }
                            if (secTitle.includes('ê¸°ëŒ€íš¨ê³¼')) {
                                const purposeSection = Array.from(sections).find(sec => sec.querySelector('h3').textContent.includes('ì¶”ì§„ ëª©ì '));
                                const purposeBullets = extractBulletItems(purposeSection ? purposeSection.dataset.markdownContent || '' : '');
                                if (purposeBullets.length) {
                                    options.referenceItems = baseReference.length ? baseReference : purposeBullets;
                                    if (!isExpand && !options.desiredCount) {
                                        options.desiredCount = purposeBullets.length;
                                    }
                                    options.referenceSuffix = ' ê´€ë ¨ ê¸°ëŒ€ íš¨ê³¼';
                                }
                            }
                            newContent = normalizeBulletList(newContent, options);
                        }
                        sectionDiv.dataset.markdownContent = newContent;
                        const isDetailSection = secTitle.includes('ì„¸ë¶€ ì¶”ì§„ ê³„íš');
                        renderSectionContent(contentDiv, newContent, { isDetail: isDetailSection });
                        await saveCurrentPlan();
                    }
                } catch (err) {
                    console.error('Section Update Error:', err);
                }
            }
        });

        if (mergePlanBtn) {
            mergePlanBtn.addEventListener('click', async () => {
                if (currentPlanSummaryMarkdown && !isSummaryGenerating) {
                    showSummaryPopup(currentPlanSummaryMarkdown);
                    return;
                }
                const markdown = await generatePlanSummary({ openPopup: true, showToastMessage: true });
                if (!markdown && !isSummaryGenerating) {
                    showToast('ìš”ì•½ë³¸ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            });
        }

        window.generatePlanSummaryFromPopup = async () => {
            const markdown = await generatePlanSummary({ openPopup: false, showToastMessage: true });
            return markdown;
        };

        editTitleBtn.addEventListener('click', () => {
            const isEditing = editTitleBtn.textContent === 'ì™„ë£Œ';
            if (isEditing) {
                planTitle.textContent = planTitleInput.value;
                planTitle.classList.remove('hidden');
                planTitleInput.classList.add('hidden');
                editTitleBtn.textContent = 'í¸ì§‘';
                editTitleBtn.classList.remove('bg-green-500', 'text-white');
                saveCurrentPlan();
            } else {
                planTitleInput.value = planTitle.textContent;
                planTitle.classList.add('hidden');
                planTitleInput.classList.remove('hidden');
                planTitleInput.focus();
                editTitleBtn.textContent = 'ì™„ë£Œ';
                editTitleBtn.classList.add('bg-green-500', 'text-white');
            }
        });

        // --- INITIALIZATION ---
    </script>
</body>
</html>
